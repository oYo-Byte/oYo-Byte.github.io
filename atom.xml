<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>oYo-Byte</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://oyo-byte.github.io/"/>
  <updated>2018-10-11T02:42:57.165Z</updated>
  <id>https://oyo-byte.github.io/</id>
  
  <author>
    <name>oYo-Byte</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>在CentOS7上安装ZFS</title>
    <link href="https://oyo-byte.github.io/2018/10/10/install_zfs_on_centos7/"/>
    <id>https://oyo-byte.github.io/2018/10/10/install_zfs_on_centos7/</id>
    <published>2018-10-10T08:56:37.518Z</published>
    <updated>2018-10-11T02:42:57.165Z</updated>
    
    <content type="html"><![CDATA[<p>ZFS是Linux上非常流行的文件系统。它是一个128位的文件系统。这意味着ZFS可以变得非常大。它支持逻辑卷，raid，快照和许多其他高级文件系统功能。但让ZFS在CentOS 7上运行并不是那么简单。在本文中，我将向您展示如何在CentOS 7.4上安装和执行ZFS的基本配置。</p><h3 id="安装ZFS文件系统"><a href="#安装ZFS文件系统" class="headerlink" title="安装ZFS文件系统"></a>安装ZFS文件系统</h3><p>在CentOS 7上默认不启用ZFS文件系统支持。这不是唯一的问题。ZFS在CentOS 7的官方软件包存储库中不可用。你必须从ZFS的官方软件包存储库中安装它。。你可以查看<a href="https://github.com/zfsonlinux/zfs/wiki/RHEL-and-CentOS" target="_blank" rel="noopener">这里</a>了解更多详情。</p><p>首先检查一下CentOS 7的版本：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 7.4.1708 (Core)</span><br></pre></td></tr></table></figure></p><p>然后使用一下命令添加ZFS的官方存储库：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install http://download.zfsonlinux.org/epel/zfs-release.el7_4.noarch.rpm</span><br></pre></td></tr></table></figure></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">zfs-release.el7_4.noarch.rpm                                                                                                                                                  | 5.2 kB  00:00:00     </span><br><span class="line">Examining /var/tmp/yum-root-YssJaZ/zfs-release.el7_4.noarch.rpm: zfs-release-1-5.el7_4.noarch</span><br><span class="line">Marking /var/tmp/yum-root-YssJaZ/zfs-release.el7_4.noarch.rpm to be installed</span><br><span class="line">Resolving Dependencies</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package zfs-release.noarch 0:1-5.el7_4 will be installed</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">=====================================================================================================================================================================================================</span><br><span class="line"> Package                                      Arch                                    Version                                       Repository                                                  Size</span><br><span class="line">=====================================================================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> zfs-release                                  noarch                                  1-5.el7_4                                     /zfs-release.el7_4.noarch                                  2.9 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=====================================================================================================================================================================================================</span><br><span class="line">Install  1 Package</span><br><span class="line"></span><br><span class="line">Total size: 2.9 k</span><br><span class="line">Installed size: 2.9 k</span><br><span class="line">Is this ok [y/d/N]:</span><br><span class="line">Downloading packages:</span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded</span><br><span class="line">Running transaction</span><br><span class="line">Warning: RPMDB altered outside of yum.</span><br><span class="line">  Installing : zfs-release-1-5.el7_4.noarch                                                                                                                                                      1/1 </span><br><span class="line">  Verifying  : zfs-release-1-5.el7_4.noarch                                                                                                                                                      1/1 </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  zfs-release.noarch 0:1-5.el7_4                                                                                                                                                                     </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure><p>ZFS模块可以通过两种方式加载到内核，DKMS和kABI。它们之间的区别在于，如果您安装基于DKMS的ZFS模块，然后由于某种原因更新了操作系统的内核，则必须再次重新编译ZFS内核模块。否则它将无法工作。但是基于kABI的ZFS模块的优势在于，如果更新操作系统的内核，则不需要重新编译。</p><p>在本文中，我将安装基于DKMS的ZFS内核模块（由于安装基于kABI时报错，google未果，因此放弃此安装方式）。</p><p>在CentOS 7上安装ZFS存储库时，默认情况下会启用基于DKMS的存储库。</p><p>DKMS安装方式需要先安装dkms<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span><br></pre></td></tr></table></figure></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">epel-release-latest-7.noarch.rpm                                                                                                      |  15 kB  00:00:00     </span><br><span class="line">Examining /var/tmp/yum-root-YssJaZ/epel-release-latest-7.noarch.rpm: epel-release-7-11.noarch</span><br><span class="line">Marking /var/tmp/yum-root-YssJaZ/epel-release-latest-7.noarch.rpm to be installed</span><br><span class="line">Resolving Dependencies</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package epel-release.noarch 0:7-11 will be installed</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">=============================================================================================================================================================</span><br><span class="line"> Package                             Arch                          Version                        Repository                                            Size</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> epel-release                        noarch                        7-11                           /epel-release-latest-7.noarch                         24 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line">Install  1 Package</span><br><span class="line"></span><br><span class="line">Total size: 24 k</span><br><span class="line">Installed size: 24 k</span><br><span class="line">Is this ok [y/d/N]: y</span><br><span class="line">Downloading packages:</span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded</span><br><span class="line">Running transaction</span><br><span class="line">Warning: RPMDB altered outside of yum.</span><br><span class="line">  Installing : epel-release-7-11.noarch                                                                                                                  1/1 </span><br><span class="line">  Verifying  : epel-release-7-11.noarch                                                                                                                  1/1 </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  epel-release.noarch 0:7-11                                                                                                                                 </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure><p>安装dkms：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install dkms</span><br></pre></td></tr></table></figure></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">base                                                                                                                                  | 3.6 kB  00:00:00     </span><br><span class="line">epel/x86_64/metalink                                                                                                                  | 8.9 kB  00:00:00     </span><br><span class="line">epel                                                                                                                                  | 3.2 kB  00:00:00     </span><br><span class="line">extras                                                                                                                                | 3.4 kB  00:00:00     </span><br><span class="line">mysql-connectors-community                                                                                                            | 2.5 kB  00:00:00     </span><br><span class="line">mysql-tools-community                                                                                                                 | 2.5 kB  00:00:00     </span><br><span class="line">mysql56-community                                                                                                                     | 2.5 kB  00:00:00     </span><br><span class="line">updates                                                                                                                               | 3.4 kB  00:00:00     </span><br><span class="line">(1/3): epel/x86_64/group_gz                                                                                                           |  88 kB  00:00:00     </span><br><span class="line">(2/3): epel/x86_64/updateinfo                                                                                                         | 948 kB  00:00:00     </span><br><span class="line">(3/3): epel/x86_64/primary                                                                                                            | 3.6 MB  00:00:01     </span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.163.com</span><br><span class="line"> * epel: mirror01.idc.hinet.net</span><br><span class="line"> * extras: mirrors.163.com</span><br><span class="line"> * updates: mirrors.163.com</span><br><span class="line">epel                                                                                                                                             12723/12723</span><br><span class="line">Resolving Dependencies</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package dkms.noarch 0:2.6.1-1.el7 will be installed</span><br><span class="line">--&gt; Processing Dependency: elfutils-libelf-devel <span class="keyword">for</span> package: dkms-2.6.1-1.el7.noarch</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package elfutils-libelf-devel.x86_64 0:0.170-4.el7 will be installed</span><br><span class="line">--&gt; Processing Dependency: elfutils-libelf(x86-64) = 0.170-4.el7 <span class="keyword">for</span> package: elfutils-libelf-devel-0.170-4.el7.x86_64</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package elfutils-libelf.x86_64 0:0.168-8.el7 will be updated</span><br><span class="line">--&gt; Processing Dependency: elfutils-libelf(x86-64) = 0.168-8.el7 <span class="keyword">for</span> package: elfutils-libs-0.168-8.el7.x86_64</span><br><span class="line">---&gt; Package elfutils-libelf.x86_64 0:0.170-4.el7 will be an update</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package elfutils-libs.x86_64 0:0.168-8.el7 will be updated</span><br><span class="line">---&gt; Package elfutils-libs.x86_64 0:0.170-4.el7 will be an update</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">=============================================================================================================================================================</span><br><span class="line"> Package                                         Arch                             Version                               Repository                      Size</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> dkms                                            noarch                           2.6.1-1.el7                           epel                            75 k</span><br><span class="line">Installing <span class="keyword">for</span> dependencies:</span><br><span class="line"> elfutils-libelf-devel                           x86_64                           0.170-4.el7                           base                            38 k</span><br><span class="line">Updating <span class="keyword">for</span> dependencies:</span><br><span class="line"> elfutils-libelf                                 x86_64                           0.170-4.el7                           base                           195 k</span><br><span class="line"> elfutils-libs                                   x86_64                           0.170-4.el7                           base                           267 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line">Install  1 Package  (+1 Dependent package)</span><br><span class="line">Upgrade             ( 2 Dependent packages)</span><br><span class="line"></span><br><span class="line">Total download size: 575 k</span><br><span class="line">Is this ok [y/d/N]: y</span><br><span class="line">Downloading packages:</span><br><span class="line">Delta RPMs disabled because /usr/bin/applydeltarpm not installed.</span><br><span class="line">(1/4): elfutils-libelf-devel-0.170-4.el7.x86_64.rpm                                                                                   |  38 kB  00:00:00     </span><br><span class="line">(2/4): elfutils-libelf-0.170-4.el7.x86_64.rpm                                                                                         | 195 kB  00:00:00     </span><br><span class="line">(3/4): elfutils-libs-0.170-4.el7.x86_64.rpm                                                                                           | 267 kB  00:00:00     </span><br><span class="line">warning: /var/cache/yum/x86_64/7/epel/packages/dkms-2.6.1-1.el7.noarch.rpm: Header V3 RSA/SHA256 Signature, key ID 352c64e5: NOKEYB/s | 500 kB  --:--:-- ETA </span><br><span class="line">Public key <span class="keyword">for</span> dkms-2.6.1-1.el7.noarch.rpm is not installed</span><br><span class="line">(4/4): dkms-2.6.1-1.el7.noarch.rpm                                                                                                    |  75 kB  00:00:00     </span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">Total                                                                                                                        814 kB/s | 575 kB  00:00:00     </span><br><span class="line">Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</span><br><span class="line">Importing GPG key 0x352C64E5:</span><br><span class="line"> Userid     : <span class="string">"Fedora EPEL (7) &lt;epel@fedoraproject.org&gt;"</span></span><br><span class="line"> Fingerprint: 91e9 7d7c 4a5e 96f1 7f3e 888f 6a2f aea2 352c 64e5</span><br><span class="line"> Package    : epel-release-7-11.noarch (installed)</span><br><span class="line"> From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</span><br><span class="line">Is this ok [y/N]: y</span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  Updating   : elfutils-libelf-0.170-4.el7.x86_64                                                                                                        1/6 </span><br><span class="line">  Installing : elfutils-libelf-devel-0.170-4.el7.x86_64                                                                                                  2/6 </span><br><span class="line">  Installing : dkms-2.6.1-1.el7.noarch                                                                                                                   3/6 </span><br><span class="line">  Updating   : elfutils-libs-0.170-4.el7.x86_64                                                                                                          4/6 </span><br><span class="line">  Cleanup    : elfutils-libs-0.168-8.el7.x86_64                                                                                                          5/6 </span><br><span class="line">  Cleanup    : elfutils-libelf-0.168-8.el7.x86_64                                                                                                        6/6 </span><br><span class="line">  Verifying  : dkms-2.6.1-1.el7.noarch                                                                                                                   1/6 </span><br><span class="line">  Verifying  : elfutils-libs-0.170-4.el7.x86_64                                                                                                          2/6 </span><br><span class="line">  Verifying  : elfutils-libelf-devel-0.170-4.el7.x86_64                                                                                                  3/6 </span><br><span class="line">  Verifying  : elfutils-libelf-0.170-4.el7.x86_64                                                                                                        4/6 </span><br><span class="line">  Verifying  : elfutils-libs-0.168-8.el7.x86_64                                                                                                          5/6 </span><br><span class="line">  Verifying  : elfutils-libelf-0.168-8.el7.x86_64                                                                                                        6/6 </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  dkms.noarch 0:2.6.1-1.el7                                                                                                                                  </span><br><span class="line"></span><br><span class="line">Dependency Installed:</span><br><span class="line">  elfutils-libelf-devel.x86_64 0:0.170-4.el7                                                                                                                 </span><br><span class="line"></span><br><span class="line">Dependency Updated:</span><br><span class="line">  elfutils-libelf.x86_64 0:0.170-4.el7                                           elfutils-libs.x86_64 0:0.170-4.el7                                          </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure><p>安装ZFS：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install zfs</span><br></pre></td></tr></table></figure></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.163.com</span><br><span class="line"> * epel: mirror01.idc.hinet.net</span><br><span class="line"> * extras: mirrors.163.com</span><br><span class="line"> * updates: mirrors.163.com</span><br><span class="line">Resolving Dependencies</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package zfs.x86_64 0:0.7.11-1.el7_4 will be installed</span><br><span class="line">--&gt; Processing Dependency: zfs-kmod = 0.7.11 <span class="keyword">for</span> package: zfs-0.7.11-1.el7_4.x86_64</span><br><span class="line">--&gt; Processing Dependency: spl = 0.7.11 <span class="keyword">for</span> package: zfs-0.7.11-1.el7_4.x86_64</span><br><span class="line">--&gt; Processing Dependency: libzpool2 = 0.7.11 <span class="keyword">for</span> package: zfs-0.7.11-1.el7_4.x86_64</span><br><span class="line">--&gt; Processing Dependency: libzfs2 = 0.7.11 <span class="keyword">for</span> package: zfs-0.7.11-1.el7_4.x86_64</span><br><span class="line">--&gt; Processing Dependency: libuutil1 = 0.7.11 <span class="keyword">for</span> package: zfs-0.7.11-1.el7_4.x86_64</span><br><span class="line">--&gt; Processing Dependency: libnvpair1 = 0.7.11 <span class="keyword">for</span> package: zfs-0.7.11-1.el7_4.x86_64</span><br><span class="line">--&gt; Processing Dependency: libzpool.so.2()(64bit) <span class="keyword">for</span> package: zfs-0.7.11-1.el7_4.x86_64</span><br><span class="line">--&gt; Processing Dependency: libzfs_core.so.1()(64bit) <span class="keyword">for</span> package: zfs-0.7.11-1.el7_4.x86_64</span><br><span class="line">--&gt; Processing Dependency: libzfs.so.2()(64bit) <span class="keyword">for</span> package: zfs-0.7.11-1.el7_4.x86_64</span><br><span class="line">--&gt; Processing Dependency: libuutil.so.1()(64bit) <span class="keyword">for</span> package: zfs-0.7.11-1.el7_4.x86_64</span><br><span class="line">--&gt; Processing Dependency: libnvpair.so.1()(64bit) <span class="keyword">for</span> package: zfs-0.7.11-1.el7_4.x86_64</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package libnvpair1.x86_64 0:0.7.11-1.el7_4 will be installed</span><br><span class="line">---&gt; Package libuutil1.x86_64 0:0.7.11-1.el7_4 will be installed</span><br><span class="line">---&gt; Package libzfs2.x86_64 0:0.7.11-1.el7_4 will be installed</span><br><span class="line">---&gt; Package libzpool2.x86_64 0:0.7.11-1.el7_4 will be installed</span><br><span class="line">---&gt; Package spl.x86_64 0:0.7.11-1.el7_4 will be installed</span><br><span class="line">--&gt; Processing Dependency: spl-kmod = 0.7.11 <span class="keyword">for</span> package: spl-0.7.11-1.el7_4.x86_64</span><br><span class="line">---&gt; Package zfs-dkms.noarch 0:0.7.11-1.el7_4 will be installed</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package spl-dkms.noarch 0:0.7.11-1.el7_4 will be installed</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">=============================================================================================================================================================</span><br><span class="line"> Package                                Arch                               Version                                     Repository                       Size</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> zfs                                    x86_64                             0.7.11-1.el7_4                              zfs                             414 k</span><br><span class="line">Installing <span class="keyword">for</span> dependencies:</span><br><span class="line"> libnvpair1                             x86_64                             0.7.11-1.el7_4                              zfs                              31 k</span><br><span class="line"> libuutil1                              x86_64                             0.7.11-1.el7_4                              zfs                              36 k</span><br><span class="line"> libzfs2                                x86_64                             0.7.11-1.el7_4                              zfs                             131 k</span><br><span class="line"> libzpool2                              x86_64                             0.7.11-1.el7_4                              zfs                             594 k</span><br><span class="line"> spl                                    x86_64                             0.7.11-1.el7_4                              zfs                              29 k</span><br><span class="line"> spl-dkms                               noarch                             0.7.11-1.el7_4                              zfs                             457 k</span><br><span class="line"> zfs-dkms                               noarch                             0.7.11-1.el7_4                              zfs                             4.9 M</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line">Install  1 Package (+7 Dependent packages)</span><br><span class="line"></span><br><span class="line">Total download size: 6.5 M</span><br><span class="line">Installed size: 30 M</span><br><span class="line">Is this ok [y/d/N]: y</span><br><span class="line">Downloading packages:</span><br><span class="line">(1/8): libuutil1-0.7.11-1.el7_4.x86_64.rpm                                                                                            |  36 kB  00:00:02     </span><br><span class="line">(2/8): libnvpair1-0.7.11-1.el7_4.x86_64.rpm                                                                                           |  31 kB  00:00:02     </span><br><span class="line">(3/8): libzfs2-0.7.11-1.el7_4.x86_64.rpm                                                                                              | 131 kB  00:00:00     </span><br><span class="line">(4/8): spl-0.7.11-1.el7_4.x86_64.rpm                                                                                                  |  29 kB  00:00:00     </span><br><span class="line">(5/8): spl-dkms-0.7.11-1.el7_4.noarch.rpm                                                                                             | 457 kB  00:00:00     </span><br><span class="line">(6/8): zfs-0.7.11-1.el7_4.x86_64.rpm                                                                                                  | 414 kB  00:00:00     </span><br><span class="line">(7/8): zfs-dkms-0.7.11-1.el7_4.noarch.rpm                                                                                             | 4.9 MB  00:00:02     </span><br><span class="line">(8/8): libzpool2-0.7.11-1.el7_4.x86_64.rpm                                                                                            | 594 kB  00:00:25     </span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">Total                                                                                                                        238 kB/s | 6.5 MB  00:00:28     </span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  Installing : libuutil1-0.7.11-1.el7_4.x86_64                                                                                                           1/8 </span><br><span class="line">  Installing : libnvpair1-0.7.11-1.el7_4.x86_64                                                                                                          2/8 </span><br><span class="line">  Installing : libzpool2-0.7.11-1.el7_4.x86_64                                                                                                           3/8 </span><br><span class="line">  Installing : spl-dkms-0.7.11-1.el7_4.noarch                                                                                                            4/8 </span><br><span class="line">Loading new spl-0.7.11 DKMS files...</span><br><span class="line">Building <span class="keyword">for</span> 3.10.0-693.el7.x86_64</span><br><span class="line">Building initial module <span class="keyword">for</span> 3.10.0-693.el7.x86_64</span><br><span class="line">Done.</span><br><span class="line"></span><br><span class="line">spl.ko.xz:</span><br><span class="line">Running module version sanity check.</span><br><span class="line"> - Original module</span><br><span class="line">   - No original module exists within this kernel</span><br><span class="line"> - Installation</span><br><span class="line">   - Installing to /lib/modules/3.10.0-693.el7.x86_64/extra/</span><br><span class="line"></span><br><span class="line">splat.ko.xz:</span><br><span class="line">Running module version sanity check.</span><br><span class="line"> - Original module</span><br><span class="line">   - No original module exists within this kernel</span><br><span class="line"> - Installation</span><br><span class="line">   - Installing to /lib/modules/3.10.0-693.el7.x86_64/extra/</span><br><span class="line">Adding any weak-modules</span><br><span class="line"></span><br><span class="line">depmod....</span><br><span class="line"></span><br><span class="line">DKMS: install completed.</span><br><span class="line">  Installing : zfs-dkms-0.7.11-1.el7_4.noarch                                                                                                            5/8 </span><br><span class="line">Loading new zfs-0.7.11 DKMS files...</span><br><span class="line">Building <span class="keyword">for</span> 3.10.0-693.el7.x86_64</span><br><span class="line">Building initial module <span class="keyword">for</span> 3.10.0-693.el7.x86_64</span><br><span class="line">Done.</span><br><span class="line"></span><br><span class="line">zavl.ko.xz:</span><br><span class="line">Running module version sanity check.</span><br><span class="line"> - Original module</span><br><span class="line">   - No original module exists within this kernel</span><br><span class="line"> - Installation</span><br><span class="line">   - Installing to /lib/modules/3.10.0-693.el7.x86_64/extra/</span><br><span class="line"></span><br><span class="line">znvpair.ko.xz:</span><br><span class="line">Running module version sanity check.</span><br><span class="line"> - Original module</span><br><span class="line">   - No original module exists within this kernel</span><br><span class="line"> - Installation</span><br><span class="line">   - Installing to /lib/modules/3.10.0-693.el7.x86_64/extra/</span><br><span class="line"></span><br><span class="line">zunicode.ko.xz:</span><br><span class="line">Running module version sanity check.</span><br><span class="line"> - Original module</span><br><span class="line">   - No original module exists within this kernel</span><br><span class="line"> - Installation</span><br><span class="line">   - Installing to /lib/modules/3.10.0-693.el7.x86_64/extra/</span><br><span class="line"></span><br><span class="line">zcommon.ko.xz:</span><br><span class="line">Running module version sanity check.</span><br><span class="line"> - Original module</span><br><span class="line">   - No original module exists within this kernel</span><br><span class="line"> - Installation</span><br><span class="line">   - Installing to /lib/modules/3.10.0-693.el7.x86_64/extra/</span><br><span class="line"></span><br><span class="line">zfs.ko.xz:</span><br><span class="line">Running module version sanity check.</span><br><span class="line"> - Original module</span><br><span class="line">   - No original module exists within this kernel</span><br><span class="line"> - Installation</span><br><span class="line">   - Installing to /lib/modules/3.10.0-693.el7.x86_64/extra/</span><br><span class="line"></span><br><span class="line">zpios.ko.xz:</span><br><span class="line">Running module version sanity check.</span><br><span class="line"> - Original module</span><br><span class="line">   - No original module exists within this kernel</span><br><span class="line"> - Installation</span><br><span class="line">   - Installing to /lib/modules/3.10.0-693.el7.x86_64/extra/</span><br><span class="line"></span><br><span class="line">icp.ko.xz:</span><br><span class="line">Running module version sanity check.</span><br><span class="line"> - Original module</span><br><span class="line">   - No original module exists within this kernel</span><br><span class="line"> - Installation</span><br><span class="line">   - Installing to /lib/modules/3.10.0-693.el7.x86_64/extra/</span><br><span class="line">Adding any weak-modules</span><br><span class="line"></span><br><span class="line">depmod....</span><br><span class="line"></span><br><span class="line">DKMS: install completed.</span><br><span class="line">  Installing : spl-0.7.11-1.el7_4.x86_64                                                                                                                 6/8 </span><br><span class="line">  Installing : libzfs2-0.7.11-1.el7_4.x86_64                                                                                                             7/8 </span><br><span class="line">  Installing : zfs-0.7.11-1.el7_4.x86_64                                                                                                                 8/8 </span><br><span class="line">  Verifying  : zfs-dkms-0.7.11-1.el7_4.noarch                                                                                                            1/8 </span><br><span class="line">  Verifying  : spl-0.7.11-1.el7_4.x86_64                                                                                                                 2/8 </span><br><span class="line">  Verifying  : zfs-0.7.11-1.el7_4.x86_64                                                                                                                 3/8 </span><br><span class="line">  Verifying  : libzfs2-0.7.11-1.el7_4.x86_64                                                                                                             4/8 </span><br><span class="line">  Verifying  : spl-dkms-0.7.11-1.el7_4.noarch                                                                                                            5/8 </span><br><span class="line">  Verifying  : libnvpair1-0.7.11-1.el7_4.x86_64                                                                                                          6/8 </span><br><span class="line">  Verifying  : libzpool2-0.7.11-1.el7_4.x86_64                                                                                                           7/8 </span><br><span class="line">  Verifying  : libuutil1-0.7.11-1.el7_4.x86_64                                                                                                           8/8 </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  zfs.x86_64 0:0.7.11-1.el7_4                                                                                                                                </span><br><span class="line"></span><br><span class="line">Dependency Installed:</span><br><span class="line">  libnvpair1.x86_64 0:0.7.11-1.el7_4      libuutil1.x86_64 0:0.7.11-1.el7_4      libzfs2.x86_64 0:0.7.11-1.el7_4       libzpool2.x86_64 0:0.7.11-1.el7_4     </span><br><span class="line">  spl.x86_64 0:0.7.11-1.el7_4             spl-dkms.noarch 0:0.7.11-1.el7_4       zfs-dkms.noarch 0:0.7.11-1.el7_4     </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure><p>重启系统：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure></p><p>重启完毕，检查是否已加载ZFS内核模块：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep zfs</span><br></pre></td></tr></table></figure></p><p>如果没有任何输出，则ZFS内核没有加载，需要手工加载：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe zfs</span><br></pre></td></tr></table></figure></p><p>此时再次检查是否已加载ZFS：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># lsmod | grep zfs</span></span><br><span class="line">zfs                  3560372  0 </span><br><span class="line">zunicode              331170  1 zfs</span><br><span class="line">zavl                   15236  1 zfs</span><br><span class="line">icp                   270148  1 zfs</span><br><span class="line">zcommon                73440  1 zfs</span><br><span class="line">znvpair                89131  2 zfs,zcommon</span><br><span class="line">spl                   102369  4 icp,zfs,zcommon,znvpair</span><br></pre></td></tr></table></figure></p><h3 id="ZFS基本配置"><a href="#ZFS基本配置" class="headerlink" title="ZFS基本配置"></a>ZFS基本配置</h3><p>现在需要一个可用磁盘驱动器或分区来配置ZFS，检查已有的磁盘：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># lsblk</span></span><br><span class="line">NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda               8:0    0   30G  0 disk </span><br><span class="line">├─sda1            8:1    0    1G  0 part /boot</span><br><span class="line">└─sda2            8:2    0   29G  0 part </span><br><span class="line">  ├─centos-root 253:0    0   27G  0 lvm  /</span><br><span class="line">  └─centos-swap 253:1    0    2G  0 lvm  [SWAP]</span><br><span class="line">sdb               8:16   0   50G  0 disk </span><br><span class="line">sdc               8:32   0   50G  0 disk </span><br><span class="line">sr0              11:0    1 1024M  0 rom</span><br></pre></td></tr></table></figure></p><p>现在我又sdb和sdc磁盘可用，每个都是50GB大小，我将使用sdb来创建ZFS。</p><p>现在必须创建一个ZFSchi。可以将ZFS池命名为任何名称。将会在根目录下创建同名的目录。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zpool create zfsdata /dev/sdb</span><br></pre></td></tr></table></figure></p><p>创建完毕后，查看系统可用的ZFS池：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># zpool list</span></span><br><span class="line">NAME      SIZE  ALLOC   FREE  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT</span><br><span class="line">zfsdata  49.8G   106K  49.7G         -     0%     0%  1.00x  ONLINE  -</span><br></pre></td></tr></table></figure></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># df -h</span></span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/centos-root   27G   21G  6.5G  77% /</span><br><span class="line">devtmpfs                 1.9G     0  1.9G   0% /dev</span><br><span class="line">tmpfs                    1.9G   52K  1.9G   1% /dev/shm</span><br><span class="line">tmpfs                    1.9G  8.7M  1.9G   1% /run</span><br><span class="line">tmpfs                    1.9G     0  1.9G   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1               1014M  142M  872M  15% /boot</span><br><span class="line">.host:/                  300G   97G  204G  33% /mnt/hgfs</span><br><span class="line">tmpfs                    378M     0  378M   0% /run/user/1001</span><br><span class="line">tmpfs                    378M     0  378M   0% /run/user/0</span><br><span class="line">zfsdata                   49G     0   49G   0% /zfsdata</span><br></pre></td></tr></table></figure><p>至此，ZFS基本安装完成，后续可以快乐的使用ZFS这个文件系统了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ZFS是Linux上非常流行的文件系统。它是一个128位的文件系统。这意味着ZFS可以变得非常大。它支持逻辑卷，raid，快照和许多其他高级文件系统功能。但让ZFS在CentOS 7上运行并不是那么简单。在本文中，我将向您展示如何在CentOS 7.4上安装和执行ZFS的基
      
    
    </summary>
    
      <category term="Linux" scheme="https://oyo-byte.github.io/categories/Linux/"/>
    
    
      <category term="CentOS" scheme="https://oyo-byte.github.io/tags/CentOS/"/>
    
      <category term="ZFS" scheme="https://oyo-byte.github.io/tags/ZFS/"/>
    
  </entry>
  
  <entry>
    <title>如何编写一个PG的FDW</title>
    <link href="https://oyo-byte.github.io/2018/10/07/how_to_write_a_pg_fdw/"/>
    <id>https://oyo-byte.github.io/2018/10/07/how_to_write_a_pg_fdw/</id>
    <published>2018-10-07T15:03:46.114Z</published>
    <updated>2018-10-08T15:49:49.607Z</updated>
    
    <content type="html"><![CDATA[<p>之前写了那么多学习FDW的记录，最终还是需要通过写一个FDW来验证学习的成果。本次暂时实现的是查询的FDW。修改方面的还待后续继续深入。<br>根据之前的学习记录：<a href="https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/">学习PostgreSQL的FDW(#1)</a>，我们知道即使要实现一个最简单的FDW，也要实现其中7个回调函数：<code>GetForeignRelSize</code>，<code>GetForeignPaths</code>，<code>GetForeignPlan</code>， <code>BeginForeignScan</code>，<code>IterateForeignScan</code>，<code>ReScanForeignScan</code>，<code>EndForeignScan</code>。而他们的作用，之前的文章已详细解释过，这里就不再详述了。</p><h2 id="control文件"><a href="#control文件" class="headerlink" title="control文件"></a>control文件</h2><p>因为FDW实质是也是PG的一个扩展，因此也是需要有control文件的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">comment = &apos;sample fdw&apos; # FDW 的描述</span><br><span class="line">default_version = &apos;0.0.1&apos; # FDW 的版本号</span><br><span class="line">module_pathname = &apos;$libdir/sample_fdw&apos; # fdw的路径</span><br><span class="line">relocatable = true</span><br></pre></td></tr></table></figure></p><h2 id="sql文件"><a href="#sql文件" class="headerlink" title="sql文件"></a>sql文件</h2><p>同上，之前也说过需要实现fdw_handler函数和选择性实现fdw_validator函数。因此需要在sql文件中定义这些函数<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> sample_fdw_handler()</span><br><span class="line"><span class="keyword">RETURNS</span> fdw_handler</span><br><span class="line"><span class="keyword">AS</span> <span class="string">'MODULE_PATHNAME'</span></span><br><span class="line"><span class="keyword">LANGUAGE</span> C <span class="keyword">STRICT</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> sample_fdw_validator(<span class="built_in">text</span>[], <span class="keyword">oid</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">void</span></span><br><span class="line"><span class="keyword">AS</span> <span class="string">'MODULE_PATHNAME'</span></span><br><span class="line"><span class="keyword">LANGUAGE</span> C <span class="keyword">STRICT</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> FOREIGN <span class="keyword">DATA</span> WRAPPER sample_fdw</span><br><span class="line">  <span class="keyword">HANDLER</span> sample_fdw_handler</span><br><span class="line">  VALIDATOR sample_fdw_validator;</span><br></pre></td></tr></table></figure></p><h2 id="在C文件中实现fdw-handler函数和选择性实现fdw-validator函数"><a href="#在C文件中实现fdw-handler函数和选择性实现fdw-validator函数" class="headerlink" title="在C文件中实现fdw_handler函数和选择性实现fdw_validator函数"></a>在C文件中实现fdw_handler函数和选择性实现fdw_validator函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Datum</span><br><span class="line">sample_fdw_handler(PG_FUNCTION_ARGS)</span><br><span class="line">&#123;</span><br><span class="line">FdwRoutine *fdwroutine = makeNode(FdwRoutine);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* these are required */</span></span><br><span class="line">fdwroutine-&gt;GetForeignRelSize = sampleGetForeignRelSize; <span class="comment">/* S U D */</span></span><br><span class="line">fdwroutine-&gt;GetForeignPaths = sampleGetForeignPaths;<span class="comment">/* S U D */</span></span><br><span class="line">fdwroutine-&gt;GetForeignPlan = sampleGetForeignPlan;<span class="comment">/* S U D */</span></span><br><span class="line">fdwroutine-&gt;BeginForeignScan = sampleBeginForeignScan;<span class="comment">/* S U D */</span></span><br><span class="line">fdwroutine-&gt;IterateForeignScan = sampleIterateForeignScan;<span class="comment">/* S */</span></span><br><span class="line">fdwroutine-&gt;ReScanForeignScan = sampleReScanForeignScan; <span class="comment">/* S */</span></span><br><span class="line">fdwroutine-&gt;EndForeignScan = sampleEndForeignScan;<span class="comment">/* S U D */</span></span><br><span class="line"></span><br><span class="line">PG_RETURN_POINTER(fdwroutine);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Datum</span><br><span class="line">infocycle_fdw_validator(PG_FUNCTION_ARGS)</span><br><span class="line">&#123;</span><br><span class="line">Datum    optionArray = PG_GETARG_DATUM(<span class="number">0</span>);</span><br><span class="line">Oid      optionContextId = PG_GETARG_OID(<span class="number">1</span>);</span><br><span class="line">List     *optionList = untransformRelOptions(optionArray);</span><br><span class="line">ListCell *optionCell = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 其中做一些校验FDW的配置是否正确，比如options是否符合要求</span></span><br><span class="line">PG_RETURN_VOID();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7个回调函数"><a href="#7个回调函数" class="headerlink" title="7个回调函数"></a>7个回调函数</h2><h3 id="GetForeignRelSize-PlannerInfo-root-RelOptInfo-baserel-Oid-foreigntableid"><a href="#GetForeignRelSize-PlannerInfo-root-RelOptInfo-baserel-Oid-foreigntableid" class="headerlink" title="GetForeignRelSize(PlannerInfo root, RelOptInfo baserel, Oid foreigntableid)"></a>GetForeignRelSize(PlannerInfo <em>root, RelOptInfo </em>baserel, Oid foreigntableid)</h3><p>该函数提供外部表对于计算访问代价所需的基础数据。需要更新baserel的rows字段，即是告诉PG，此外部表的估算行数。也可以选择性更新baserel的width字段，即行宽。<br>实现此函数，只需根据自己要实现的外部表的数据源来更新baserel-&gt;rows即可。不要是完全准确的值。</p><h3 id="GetForeignPaths-PlannerInfo-root-RelOptInfo-baserel-Oid-foreigntableid"><a href="#GetForeignPaths-PlannerInfo-root-RelOptInfo-baserel-Oid-foreigntableid" class="headerlink" title="GetForeignPaths(PlannerInfo root, RelOptInfo baserel, Oid foreigntableid)"></a>GetForeignPaths(PlannerInfo <em>root, RelOptInfo </em>baserel, Oid foreigntableid)</h3><p>该函数用于生成对目标外部表的访问路径，必须至少提供以后访问路径。可以使用PG提供的函数<code>create_foreignscan_path</code>来生成，我们只需把这个函数的所需的参数传进去即可，可以生成多个路径，并使用<code>add_path</code>将这些路径加入到PG的访问路径列表中。<code>create_foreignscan_path</code>函数声明如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ForeignPath *</span><br><span class="line">create_foreignscan_path(PlannerInfo *root, RelOptInfo *rel,</span><br><span class="line">PathTarget *target,</span><br><span class="line"><span class="keyword">double</span> rows, Cost startup_cost, Cost total_cost,</span><br><span class="line">List *pathkeys,</span><br><span class="line">Relids required_outer,</span><br><span class="line">Path *fdw_outerpath,</span><br><span class="line">List *fdw_private)</span><br></pre></td></tr></table></figure></p><p>root和rel分别是<code>GetForeignPaths</code>的入参root和baserel，target可以设置成NULL使用默认的pathtarget。rows是<code>GetForeignRelSize</code>中计算的外部表的行数，可以从baserel-&gt;rows获取。startup_cost是这个路径的起始代价，total_cost是这个路径的总代价，如果有多条路径，需要根据每一条访问路径计算其代价。pathkeys如提供此参数，即代表此路径是预排序好的结果。fdw_outerpath<em>暂未知用途</em>，fdw_private是此fdw的私有信息，这种信息被用来标识想要使用的指定扫描方法。</p><h3 id="GetForeignPlan-PlannerInfo-root-RelOptInfo-baserel-Oid-foreigntableid-ForeignPath-best-path-List-tlist-List-scan-clauses-Plan-outer-plan"><a href="#GetForeignPlan-PlannerInfo-root-RelOptInfo-baserel-Oid-foreigntableid-ForeignPath-best-path-List-tlist-List-scan-clauses-Plan-outer-plan" class="headerlink" title="GetForeignPlan(PlannerInfo root, RelOptInfo baserel,Oid foreigntableid, ForeignPath best_path, List tlist, List scan_clauses, Plan outer_plan)"></a>GetForeignPlan(PlannerInfo <em>root, RelOptInfo </em>baserel,Oid foreigntableid, ForeignPath <em>best_path, List </em>tlist, List <em>scan_clauses, Plan </em>outer_plan)</h3><p>此函数用于生成访问目标外部表的ForeignScan计划节点。可以使用PG提供的函数<code>make_foreignscan</code>来生成。<code>make_foreignscan</code>函数声明如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ForeignScan *</span><br><span class="line">make_foreignscan(List *qptlist,</span><br><span class="line">List *qpqual,</span><br><span class="line">Index scanrelid,</span><br><span class="line">List *fdw_exprs,</span><br><span class="line">List *fdw_private,</span><br><span class="line">List *fdw_scan_tlist,</span><br><span class="line">List *fdw_recheck_quals,</span><br><span class="line">Plan *outer_plan)</span><br></pre></td></tr></table></figure></p><p>qptlist查询目标列表，直接传入<code>GetForeignPlan</code>的入参tlist；qpqual是查询语句，可以使用PG提供的函数<code>extract_actual_clauses</code>对scan_clauses进行提取；scanrelid如果是单表，即是baserel-&gt;relid，如果baserel是Join relation 或者 upper relation 设置scanrelid为0；fdw_exprs额外的表达式，没有可传NIL；fdw_private是FDW的私有信息；可提供过执行器调用的回调函数中使用；fdw_scan_tlist<em>暂未知具体用途</em>，可传NIL；fdw_recheck_quals<em>暂未知具体用途</em>，可传NIL；outer_plan<em>暂未知具体用途</em>，可传NULL；其中fdw_exprs，fdw_scan_tlist，fdw_recheck_quals，outer_plan主要作用于Join relation 或者 upper relation。</p><h3 id="BeginForeignScan-ForeignScanState-node-int-eflags"><a href="#BeginForeignScan-ForeignScanState-node-int-eflags" class="headerlink" title="BeginForeignScan(ForeignScanState *node, int eflags)"></a>BeginForeignScan(ForeignScanState *node, int eflags)</h3><p>获取执行ForeignScan算子所需的信息，并将它们组织并保存在ForeignScanState中，比如说外部数据库的连接，或者是打开文件的句柄等资源信息都可以保存在ForeignScanState中，供<code>IterateForeignScan</code>使用。不需要在<code>IterateForeignScan</code>里面重复申请。</p><h3 id="IterateForeignScan-ForeignScanState-node"><a href="#IterateForeignScan-ForeignScanState-node" class="headerlink" title="IterateForeignScan(ForeignScanState *node)"></a>IterateForeignScan(ForeignScanState *node)</h3><p>读取外部数据源的一行数据，并将它组织为PG中的TupleTableSlot。这个函数是最关键的函数，因为最终SQL执行后返回的数据都是通过这个函数来组织的，因此一行数据是如何获取到的，我们可以根据自己的需求灵活控制。基本的实现逻辑如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot      *tupleSlot = node-&gt;ss.ss_ScanTupleSlot; <span class="comment">//从node中获取元组槽</span></span><br><span class="line">Datum               *columnValues = tupleSlot-&gt;tts_values;<span class="comment">//获取元组槽中的values数组</span></span><br><span class="line"><span class="keyword">bool</span>                *columnNulls = tupleSlot-&gt;tts_isnull;<span class="comment">//获取元组槽中的isnull数组</span></span><br><span class="line">ExecClearTuple(tupleSlot);<span class="comment">//执行此函数对元组槽进行一些清理工作，并标记此元组槽是空的</span></span><br><span class="line"><span class="keyword">if</span>(<span class="comment">/* 判断是否能获取到新的一行数据 */</span>)&#123;</span><br><span class="line"><span class="comment">// 对columnValues和columnNulls数组进行赋值</span></span><br><span class="line">ExecStoreVirtualTuple(tupleSlot);<span class="comment">//标记此元组槽是有效的</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> tupleSlot;<span class="comment">//最后返回元组槽</span></span><br></pre></td></tr></table></figure></p><p>其中对columnValues和columnNulls数组进行赋值必须按照创建表时，字段的顺序来进行赋值，否则数据将会错乱或者返回结果失败。由于PG的数据是用PG自己定义的Datum类型存储数据的，因此我们在对columnValues数组赋值前，必须要先将数据转成Datum类型再进行赋值，而这一转换，其实可以直接使用PG已实现的一套转换函数：<code>PointerGetDatum</code>，<code>CStringGetDatum</code>，<code>Int32GetDatum</code>，<code>UInt32GetDatum</code>，<code>CharGetDatum</code>，<code>BoolGetDatum</code>，<code>ObjectIdGetDatum</code>等等。</p><h3 id="ReScanForeignScan-ForeignScanState-node"><a href="#ReScanForeignScan-ForeignScanState-node" class="headerlink" title="ReScanForeignScan(ForeignScanState *node)"></a>ReScanForeignScan(ForeignScanState *node)</h3><p>将外部数据源的读取位置重置回最初的起始位置，比如说将文件的游标重置回起始位置，或者是迭代器之类的重置回起始位置。</p><h3 id="EndForeignScan-ForeignScanState-node"><a href="#EndForeignScan-ForeignScanState-node" class="headerlink" title="EndForeignScan(ForeignScanState *node)"></a>EndForeignScan(ForeignScanState *node)</h3><p>释放整个ForeignScan算子执行过程中占用的外部资源或FDW中的资源，即把在<code>BeginForeignScan</code>里申请的资源进行释放。</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>在实现以上回调函数，难免会用到一些PG已经实现的函数或者数据结构，只有我们在源代码中引入PG相应的头文件即可，因为在编译安装FDW的时候，需要知道pg_config的，因此会自动编译进我们的so文件中。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;之前写了那么多学习FDW的记录，最终还是需要通过写一个FDW来验证学习的成果。本次暂时实现的是查询的FDW。修改方面的还待后续继续深入。&lt;br&gt;根据之前的学习记录：&lt;a href=&quot;https://oyo-byte.github.io/2018/08/03/learn_ab
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
  </entry>
  
  <entry>
    <title>使用sysbench测试infocycle_fdw查询性能</title>
    <link href="https://oyo-byte.github.io/2018/09/29/sysbench_benchmark_infocycle_fdw/"/>
    <id>https://oyo-byte.github.io/2018/09/29/sysbench_benchmark_infocycle_fdw/</id>
    <published>2018-09-29T06:49:09.062Z</published>
    <updated>2018-10-08T09:41:53.687Z</updated>
    
    <content type="html"><![CDATA[<p>测试机器： 原有的InfoCycle虚拟机  </p><table><thead><tr><th>信息</th><th></th></tr></thead><tbody><tr><td>操作系统</td><td>CentOS6.9</td></tr><tr><td>内存</td><td>8G</td></tr><tr><td>CPU</td><td>2核4线程</td></tr><tr><td>硬盘</td><td>机械硬盘</td></tr><tr><td>网络</td><td>千兆</td></tr><tr><td>PosgtreSQL版本</td><td>11beta3</td></tr><tr><td>测试数据量</td><td>576000行</td></tr></tbody></table><p>sysbench使用的测试脚本：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env sysbench</span></span><br><span class="line"></span><br><span class="line">require(<span class="string">"oltp_common"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> prepare_statements()</span><br><span class="line">   -- We <span class="keyword">do</span> not use prepared statements here, but oltp_common.sh expects this</span><br><span class="line">   -- <span class="keyword">function</span> to be defined</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> event(thread_id)</span><br><span class="line">          <span class="built_in">local</span> begin_query = <span class="string">"BEGIN"</span></span><br><span class="line">          <span class="built_in">local</span> commit_query = <span class="string">"COMMIT"</span></span><br><span class="line">          math.randomseed(os.time())</span><br><span class="line">          <span class="built_in">local</span> begin_pos = math.random(1,9)</span><br><span class="line">          <span class="built_in">local</span> end_pos = math.random(begin_pos,10)</span><br><span class="line">          db_query(begin_query)</span><br><span class="line">          con:query(string.format(<span class="string">"SELECT * FROM ecs2 WHERE station='%s' limit 100"</span>,begin_pos))</span><br><span class="line">          con:query(string.format(<span class="string">"SELECT * FROM ecs2 WHERE station BETWEEN '%s' AND '%s' limit 100"</span>,begin_pos, end_pos))</span><br><span class="line">          con:query(string.format(<span class="string">"SELECT * FROM ecs2 WHERE station BETWEEN '%s' AND '%s' ORDER BY archivetime desc limit 100"</span>,begin_pos, end_pos))</span><br><span class="line">          db_query(commit_query)</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure></p><p>本次测试1-8个线程，每个线程重复测试3次。每次压测时间为120秒。</p><p>样本数据：</p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180929161420.png" alt=""></p><p>使用的测试脚本：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> i <span class="keyword">in</span> 1 2 3 4 5 6 7 8;</span><br><span class="line"> <span class="keyword">do</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> 1 2 3;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"doing <span class="variable">$i</span> the <span class="variable">$j</span> times"</span></span><br><span class="line">/appdb/sysbench/bin/sysbench --db-driver=pgsql --pgsql-host=192.168.10.82 --pgsql-port=5432 --pgsql-user=atlasdb --pgsql-password=123456 --pgsql-db=infocycle --time=120 --report-interval=5 --threads=<span class="variable">$i</span> /appdb/sysbench/share/sysbench/pgotlp.lua  run &gt;&gt; /data/sysbench.log ;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"sleeping"</span>;</span><br><span class="line">sleep 10;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">done</span></span><br></pre></td></tr></table></figure></p><p>将sysbench输出结果输出到csv：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat sysbench.log | egrep <span class="string">" cat|threads:|transactions|queries:|read:|write:|other:|total:|min:|avg:|max:|percentile:"</span> | tr -d <span class="string">"\n"</span> | sed <span class="string">'s/Number of threads: /\n/g'</span> | sed <span class="string">'s/\[/\n/g'</span> |sed <span class="string">'s/[A-Za-z\/]\&#123;1,\&#125;://g'</span>| sed <span class="string">'s/ \.//g'</span> | sed -e <span class="string">'s/read\/write//g'</span> -e <span class="string">'s/approx\. 95//g'</span> -e <span class="string">'s/per sec.)//g'</span> -e <span class="string">'s/ms//g'</span> -e <span class="string">'s/(//g'</span> -e <span class="string">'s/^.*cat //g'</span> |sed <span class="string">'s/ \&#123;1,\&#125;/,/g'</span></span><br></pre></td></tr></table></figure></p><p>测试结果：</p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180929153737.png" alt=""></p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180929161130.png" alt=""></p><h3 id="以上结果不可信"><a href="#以上结果不可信" class="headerlink" title="以上结果不可信"></a>以上结果不可信</h3><p>发现以上结果的QPS有点高，不太可信，所以重新验证一下，发现上面的测试场景中，后面2条的SQL执行要不就是没有返回，要不就是执行出错，并且把事务的开关QPS都算进里面了，导致sysbench测试结果有误。</p><h3 id="重测"><a href="#重测" class="headerlink" title="重测"></a>重测</h3><p>于是重新整理测试场景，重新测试，这次测试是1-8个线程，每个线程重复测试5次。每次压测时间为120秒。</p><h4 id="场景1：查询某个station的某个type的某个时间的记录"><a href="#场景1：查询某个station的某个type的某个时间的记录" class="headerlink" title="场景1：查询某个station的某个type的某个时间的记录"></a>场景1：查询某个station的某个type的某个时间的记录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env sysbench</span></span><br><span class="line">require(<span class="string">"oltp_common"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> prepare_statements()</span><br><span class="line">   -- We <span class="keyword">do</span> not use prepared statements here, but oltp_common.sh expects this</span><br><span class="line">   -- <span class="keyword">function</span> to be defined</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> event(thread_id)</span><br><span class="line">  math.randomseed(os.time())</span><br><span class="line">  <span class="built_in">local</span> station_random = math.random(1, 10)</span><br><span class="line">  <span class="built_in">local</span> type_random = math.random(1, 4)</span><br><span class="line">  <span class="built_in">local</span> time_random = 1533225600 + 180 * math.random(0, 4799) </span><br><span class="line">  con:query(string.format(<span class="string">"SELECT * FROM ecs2 WHERE station='%s' AND type='%s' AND time='%s'"</span>,station_random, type_random, time_random))</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>测试时服务器的情况：</p><p>1线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180930160822.png" alt=""></p><p>2线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180930161802.png" alt=""></p><p>3线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180930162828.png" alt=""></p><p>4线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180930163950.png" alt=""></p><p>5线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180930165025.png" alt=""></p><p>6线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180930170407.png" alt=""></p><p>7线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180930171226.png" alt=""></p><p>8线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180930172301.png" alt=""></p><p>测试结果：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180930173922.png" alt=""></p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180930174008.png" alt=""></p><h4 id="场景2：查询某个station的某个type的某一天所有的记录"><a href="#场景2：查询某个station的某个type的某一天所有的记录" class="headerlink" title="场景2：查询某个station的某个type的某一天所有的记录"></a>场景2：查询某个station的某个type的某一天所有的记录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env sysbench</span></span><br><span class="line">require(<span class="string">"oltp_common"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> prepare_statements()</span><br><span class="line">   -- We <span class="keyword">do</span> not use prepared statements here, but oltp_common.sh expects this</span><br><span class="line">   -- <span class="keyword">function</span> to be defined</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> event(thread_id)</span><br><span class="line">  math.randomseed(os.time())</span><br><span class="line">  <span class="built_in">local</span> station_random = math.random(1,10)</span><br><span class="line">  <span class="built_in">local</span> type_random = math.random(1,4)</span><br><span class="line">  <span class="built_in">local</span> time_random = 1533225600 + 180 * math.random(0, 4798) </span><br><span class="line">  <span class="built_in">local</span> time_end_random = time_random + 86400 -- 加一天的范围</span><br><span class="line">  con:query(string.format(<span class="string">"SELECT * FROM ecs2 WHERE station='%s' AND type='%s' AND time BETWEEN '%s' AND '%s'"</span>,station_random, type_random, time_random, time_end_random))</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>测试时服务器的情况：</p><p>1线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20181008153411.png" alt=""></p><p>2线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20181008154856.png" alt=""></p><p>3线程时：（忘截图了）</p><p>4线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20181008160818.png" alt=""></p><p>5线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20181008162557.png" alt=""></p><p>6线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20181008163606.png" alt=""></p><p>7线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20181008164724.png" alt=""></p><p>8线程时：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20181008170027.png" alt=""></p><p>测试结果：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20181008172242.png" alt=""></p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20181008173144.png" alt=""></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>目前实现的FDW的随线程数增多，QPS也增大，在7和8个线程时，基本不再增长，此时基本达到网卡的上限100MB+/s。<br>注：由于测试环境中，同一个station同一个type的同一时间里是有3条数据返回的，但实际的环境应该是只有一条的，因此两个场景查询得到的数据量是实际的3倍，如果在实际环境上QPS应该还是有差异的（提升？）。</p><h4 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h4><p>由于一开始对测试的需求不太理解，以自己的想法去弄，导致测试结果完全是错误的。还有就是对于不熟悉的工具，还是需要花一点时间去熟悉，不然只会走更多的弯路。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;测试机器： 原有的InfoCycle虚拟机  &lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;信息&lt;/th&gt;
&lt;th&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;操作系统&lt;/td&gt;
&lt;td&gt;CentOS6.9&lt;/td&gt;
&lt;/tr&gt;
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
      <category term="sysbench" scheme="https://oyo-byte.github.io/tags/sysbench/"/>
    
  </entry>
  
  <entry>
    <title>使用Jmeter的JDBC连接PostgreSQL进行压力测试</title>
    <link href="https://oyo-byte.github.io/2018/09/27/use_jmeter_connect_postgresql/"/>
    <id>https://oyo-byte.github.io/2018/09/27/use_jmeter_connect_postgresql/</id>
    <published>2018-09-27T08:06:54.529Z</published>
    <updated>2018-09-27T09:13:04.265Z</updated>
    
    <content type="html"><![CDATA[<h3 id="添加驱动"><a href="#添加驱动" class="headerlink" title="添加驱动"></a>添加驱动</h3><p>使用Jmeter的JDBC功能时，需要添加对应的数据库驱动，将下载好的jar包放到Jmeter安装目录下的lib目录中，然后重启Jmeter使其生效。<br>PostgreSQL的JDBC驱动下载地址：<a href="https://jdbc.postgresql.org/download.html" target="_blank" rel="noopener">PostgreSQL驱动</a></p><h3 id="在测试计划中添加线程组"><a href="#在测试计划中添加线程组" class="headerlink" title="在测试计划中添加线程组"></a>在测试计划中添加线程组</h3><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180927162544.png" alt=""></p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180927162607.png" alt=""></p><p>可以设置线程数以及循环次数</p><h3 id="在线程组中添加数据库连接配置"><a href="#在线程组中添加数据库连接配置" class="headerlink" title="在线程组中添加数据库连接配置"></a>在线程组中添加数据库连接配置</h3><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180927162825.png" alt=""></p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180927163605.png" alt=""></p><h3 id="添加JDBC请求"><a href="#添加JDBC请求" class="headerlink" title="添加JDBC请求"></a>添加JDBC请求</h3><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180927164543.png" alt=""></p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180927164839.png" alt=""></p><h3 id="添加监听器"><a href="#添加监听器" class="headerlink" title="添加监听器"></a>添加监听器</h3><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180927164946.png" alt=""></p><h3 id="执行线程"><a href="#执行线程" class="headerlink" title="执行线程"></a>执行线程</h3><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180927171236.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;添加驱动&quot;&gt;&lt;a href=&quot;#添加驱动&quot; class=&quot;headerlink&quot; title=&quot;添加驱动&quot;&gt;&lt;/a&gt;添加驱动&lt;/h3&gt;&lt;p&gt;使用Jmeter的JDBC功能时，需要添加对应的数据库驱动，将下载好的jar包放到Jmeter安装目录下的lib目录中，然后
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="Jmeter" scheme="https://oyo-byte.github.io/tags/Jmeter/"/>
    
  </entry>
  
  <entry>
    <title>学习PostgreSQL的FDW(#6)-file_fdw源码分析</title>
    <link href="https://oyo-byte.github.io/2018/08/10/learn_about_pgfdw_part6/"/>
    <id>https://oyo-byte.github.io/2018/08/10/learn_about_pgfdw_part6/</id>
    <published>2018-08-10T06:31:43.897Z</published>
    <updated>2018-08-17T08:27:08.522Z</updated>
    
    <content type="html"><![CDATA[<p>之前文章介绍了实现FDW的函数，现在来看看PostgreSQL实现的文件的FDW是怎么的吧。<br>PostgreSQL实现的file_fdw的源码可以在PostgreSQL的源码目录下contrib目录下找到。</p><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>file_fdw支持的数据文件必须是<code>COPY FROM</code>可读格式（text,csv[逗号分隔值],binary）.<br>用这个包装器创建的一个外部表可以有下列选项：</p><table><thead><tr><th style="text-align:left">参数</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">filename</td><td style="text-align:left">指定要被读取的文件。必须是一个绝对路径名。 必须指定filename或program， 但不能同时指定两个。</td></tr><tr><td style="text-align:left">program</td><td style="text-align:left">指定要执行的命令。该命令的标准输出将被读取， 就像使用COPY FROM PROGRAM一样。必须指定program 或filename，但不能同时指定两个。</td></tr><tr><td style="text-align:left">format</td><td style="text-align:left">指定数据的格式，和COPY的FORMAT选项相同。即text,csv（逗号分隔值）,binary</td></tr><tr><td style="text-align:left">header</td><td style="text-align:left">指定文件包含标题行，其中有每一列的名称。在输出时，第一行包含 来自表的列名。在输入时，第一行会被忽略。只有使用 CSV格式时才允许这个选项。</td></tr><tr><td style="text-align:left">delimiter</td><td style="text-align:left">指定分隔文件每行中各列的字符。文本格式中默认是一个制表符， 而CSV格式中默认是一个逗号。这必须是一个单一 的单字节字符。使用binary格式时不允许这个选项。</td></tr><tr><td style="text-align:left">quote</td><td style="text-align:left">指定一个数据值被引用时使用的引用字符。默认是双引号。 这必须是一个单一的单字节字符。只有使用 CSV格式时才允许这个选项。</td></tr><tr><td style="text-align:left">escape</td><td style="text-align:left">指定应该出现在一个匹配quote值的数据字符之前 的字符。默认和quote值一样（这样如果引用字符 出现在数据中，它会被双写）。这必须是一个单一的单字节字符。 只有使用CSV格式时才允许这个选项。</td></tr><tr><td style="text-align:left">null</td><td style="text-align:left">指定表示一个空值的字符串。文本格式中默认是 \N（反斜线-N），CSV格式中默认 是一个未加引用的空串。在你不想区分空值和空串的情况下，即使在文本 格式中你也可能更喜欢空串。使用binary格式时不允许这 个选项。</td></tr><tr><td style="text-align:left">encoding</td><td style="text-align:left">指定文件被以encoding_name编码。如果省略这个选项，将使用当前的客户端编码。</td></tr></tbody></table><h3 id="添加file-fdw扩展"><a href="#添加file-fdw扩展" class="headerlink" title="添加file_fdw扩展"></a>添加file_fdw扩展</h3><p>检查PG安装目录的lib/postgresql目录下是否存在file_fdw.so文件，确保安装时已经编译安装了file_fdw扩展。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fdw=# create extension file_fdw ;</span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION</span><br><span class="line">fdw=# \dx</span><br><span class="line">                               <span class="keyword">List</span> <span class="keyword">of</span> installed extensions</span><br><span class="line">     <span class="keyword">Name</span>     | <span class="keyword">Version</span> |   <span class="keyword">Schema</span>   |                    Description                     </span><br><span class="line"><span class="comment">--------------+---------+------------+----------------------------------------------------</span></span><br><span class="line"> file_fdw     | <span class="number">1.0</span>     | <span class="keyword">public</span>     | foreign-<span class="keyword">data</span> wrapper <span class="keyword">for</span> flat <span class="keyword">file</span> <span class="keyword">access</span></span><br><span class="line"> plpgsql      | <span class="number">1.0</span>     | pg_catalog | PL/pgSQL <span class="keyword">procedural</span> <span class="keyword">language</span></span><br><span class="line"> postgres_fdw | <span class="number">1.0</span>     | <span class="keyword">public</span>     | foreign-<span class="keyword">data</span> wrapper <span class="keyword">for</span> remote PostgreSQL servers</span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure><h3 id="测试file-fdw"><a href="#测试file-fdw" class="headerlink" title="测试file_fdw"></a>测试file_fdw</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">fdw=# --创建测试表，并添加数据</span><br><span class="line">fdw=# create table tb1(id int,name varchar,password varchar);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">fdw=# <span class="keyword">insert</span> <span class="keyword">into</span> tb1 <span class="keyword">select</span> generate_series(<span class="number">1</span>,<span class="number">50</span>),<span class="string">'oYo'</span>,<span class="keyword">md5</span>(random()::<span class="built_in">text</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">50</span></span><br><span class="line">fdw=# <span class="comment">--通过copy拷贝数据到文件</span></span><br><span class="line">fdw=# copy tb1 <span class="keyword">to</span> <span class="string">'/data/file_fdw/tb1.csv'</span>;</span><br><span class="line">COPY 50</span><br><span class="line">fdw=# --创建外部服务器</span><br><span class="line">fdw=# create server file_fdw_server foreign data wrapper file_fdw ;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">SERVER</span></span><br><span class="line">fdw=# \des</span><br><span class="line">            <span class="keyword">List</span> <span class="keyword">of</span> foreign servers</span><br><span class="line">      <span class="keyword">Name</span>       | Owner | Foreign-<span class="keyword">data</span> wrapper </span><br><span class="line"><span class="comment">-----------------+-------+----------------------</span></span><br><span class="line"> file_fdw_server | <span class="keyword">xdb</span>   | file_fdw</span><br><span class="line"> pg_117_56       | <span class="keyword">xdb</span>   | postgres_fdw</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br><span class="line">fdw=# <span class="comment">--创建外部表</span></span><br><span class="line">fdw=# <span class="keyword">create</span> foreign <span class="keyword">table</span> tb1_fdw(<span class="keyword">id</span> <span class="built_in">int</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>,<span class="keyword">password</span> <span class="built_in">varchar</span>) <span class="keyword">server</span> file_fdw_server options(filename <span class="string">'/data/file_fdw/tb1.csv'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> FOREIGN <span class="keyword">TABLE</span></span><br><span class="line">fdw=# \d tb1_fdw </span><br><span class="line">                       Foreign <span class="keyword">table</span> <span class="string">"public.tb1_fdw"</span></span><br><span class="line">  <span class="keyword">Column</span>  |       <span class="keyword">Type</span>        | <span class="keyword">Collation</span> | Nullable | <span class="keyword">Default</span> | FDW options </span><br><span class="line"><span class="comment">----------+-------------------+-----------+----------+---------+-------------</span></span><br><span class="line"> <span class="keyword">id</span>       | <span class="built_in">integer</span>           |           |          |         | </span><br><span class="line"> <span class="keyword">name</span>     | <span class="built_in">character</span> <span class="built_in">varying</span> |           |          |         | </span><br><span class="line"> <span class="keyword">password</span> | <span class="built_in">character</span> <span class="built_in">varying</span> |           |          |         | </span><br><span class="line"><span class="keyword">Server</span>: file_fdw_server</span><br><span class="line">FDW options: (filename <span class="string">'/data/file_fdw/tb1.csv'</span>)</span><br><span class="line"></span><br><span class="line">fdw=# <span class="keyword">select</span> * <span class="keyword">from</span> tb1_fdw <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">limit</span> <span class="number">10</span>;</span><br><span class="line"> id | name |             password             </span><br><span class="line"><span class="comment">----+------+----------------------------------</span></span><br><span class="line">  1 | oYo  | 99c0aa4a3ad2128e6ea55522012d8806</span><br><span class="line">  2 | oYo  | a126e01cfdfd4717a1d79b45a42a3bb6</span><br><span class="line">  3 | oYo  | f031835b6c57d4a8781309e05542eb18</span><br><span class="line">  4 | oYo  | 7bea90889b4aa3d0fe67ddbdba68be8e</span><br><span class="line">  5 | oYo  | 01e38c84d7ca2e140f00efc9a9d7a767</span><br><span class="line">  6 | oYo  | 28269e1942431e7970c638023953f43b</span><br><span class="line">  7 | oYo  | fcf45570efa8616e4081b81e6d514433</span><br><span class="line">  8 | oYo  | 5c90103b272cc172d052d7fabb748188</span><br><span class="line">  9 | oYo  | cb8b46761425c64390f77cf1557bb1ae</span><br><span class="line"> 10 | oYo  | 634404bf272dd5610e1b7caf7e1a1542</span><br><span class="line">(10 rows)</span><br><span class="line"></span><br><span class="line">fdw=# --执行计划</span><br><span class="line">fdw=# explain select * from tb1_fdw order by id limit 10;</span><br><span class="line">                               QUERY PLAN                                </span><br><span class="line"><span class="comment">-------------------------------------------------------------------------</span></span><br><span class="line"> Limit  (cost=3.55..3.58 rows=10 width=68)</span><br><span class="line">   -&gt;  Sort  (cost=3.55..3.61 rows=21 width=68)</span><br><span class="line">         Sort Key: id</span><br><span class="line">         -&gt;  Foreign Scan on tb1_fdw  (cost=0.00..3.10 rows=21 width=68)</span><br><span class="line">               Foreign File: /data/file_fdw/tb1.csv</span><br><span class="line">               Foreign File Size: 1991 b</span><br><span class="line">(6 rows)</span><br></pre></td></tr></table></figure><h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><ul><li>FileFdwOption</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Describes the valid options for objects that use this wrapper.</span></span><br><span class="line"><span class="comment"> *  此外部器可用的选项对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FileFdwOption</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *optname;</span><br><span class="line">Oidoptcontext;<span class="comment">/* Oid of catalog in which option may appear */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Valid options for file_fdw.</span></span><br><span class="line"><span class="comment"> * 可以的选项</span></span><br><span class="line"><span class="comment"> * These options are based on the options for the COPY FROM command.</span></span><br><span class="line"><span class="comment"> * But note that force_not_null and force_null are handled as boolean options</span></span><br><span class="line"><span class="comment"> * attached to a column, not as table options.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">Note:</span> If you are adding new option for user mapping, you need to modify</span></span><br><span class="line"><span class="comment">        * fileGetOptions(), which currently doesn't bother to look at user mappings.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">FileFdwOption</span> <span class="title">valid_options</span>[] = &#123;</span></span><br><span class="line">        <span class="comment">/* Data source options */</span></span><br><span class="line">        &#123;<span class="string">"filename"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"program"</span>, ForeignTableRelationId&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Format options */</span></span><br><span class="line">        <span class="comment">/* oids option is not supported */</span></span><br><span class="line">        &#123;<span class="string">"format"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"header"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"delimiter"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"quote"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"escape"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"null"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"encoding"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"force_not_null"</span>, AttributeRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"force_null"</span>, AttributeRelationId&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * force_quote is not supported by file_fdw because it's for COPY TO.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Sentinel */</span></span><br><span class="line">        &#123;<span class="literal">NULL</span>, InvalidOid&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>FileFdwPlanState</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * FDW-specific information for RelOptInfo.fdw_private.</span></span><br><span class="line"><span class="comment"> * 此FDW优化阶段的fdw_private的数据结构体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FileFdwPlanState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">char</span>   *filename;<span class="comment">/*需要读取的文件或程序 file or program to read from */</span></span><br><span class="line"><span class="keyword">bool</span>is_program;<span class="comment">/*是否是程序 true if filename represents an OS command */</span></span><br><span class="line">List   *options;<span class="comment">/*其他选项 merged COPY options, excluding filename and</span></span><br><span class="line"><span class="comment"> * is_program */</span></span><br><span class="line">BlockNumber pages;<span class="comment">/*物理文件的估算大小 estimate of file's physical size */</span></span><br><span class="line"><span class="keyword">double</span>ntuples;<span class="comment">/*数据行的估算数量 estimate of number of data rows */</span></span><br><span class="line">&#125; FileFdwPlanState;</span><br></pre></td></tr></table></figure><ul><li>FileFdwExecutionState</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * FDW-specific information for ForeignScanState.fdw_state.</span></span><br><span class="line"><span class="comment"> * 执行时的fdw_state的结构体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FileFdwExecutionState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">char</span>   *filename;<span class="comment">/* file or program to read from */</span></span><br><span class="line"><span class="keyword">bool</span>is_program;<span class="comment">/* true if filename represents an OS command */</span></span><br><span class="line">List   *options;<span class="comment">/* merged COPY options, excluding filename and</span></span><br><span class="line"><span class="comment"> * is_program */</span></span><br><span class="line">CopyStatecstate;<span class="comment">/*COPY命令执行时的状态 COPY execution state */</span></span><br><span class="line">&#125; FileFdwExecutionState;</span><br></pre></td></tr></table></figure><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><ul><li>fileIsForeignScanParallelSafe</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * fileIsForeignScanParallelSafe</span></span><br><span class="line"><span class="comment"> *Reading a file, or external program, in a parallel worker should work</span></span><br><span class="line"><span class="comment"> *just the same as reading it in the leader, so mark scans safe.</span></span><br><span class="line"><span class="comment"> *    是否能多并发读取文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">fileIsForeignScanParallelSafe(PlannerInfo *root, RelOptInfo *rel,</span><br><span class="line">  RangeTblEntry *rte)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>fileGetForeignRelSize</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * fileGetForeignRelSize</span></span><br><span class="line"><span class="comment"> *Obtain relation size estimates for a foreign table</span></span><br><span class="line"><span class="comment"> *  获取外部表的估计大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">fileGetForeignRelSize(PlannerInfo *root,</span><br><span class="line">  RelOptInfo *baserel,</span><br><span class="line">  Oid foreigntableid)</span><br><span class="line">&#123;</span><br><span class="line">FileFdwPlanState *fdw_private;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Fetch options.  We only need filename (or program) at this point, but</span></span><br><span class="line"><span class="comment"> * we might as well get everything and not need to re-fetch it later in</span></span><br><span class="line"><span class="comment"> * planning.</span></span><br><span class="line"><span class="comment"> * 获取fdw的选项参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">fdw_private = (FileFdwPlanState *) palloc(<span class="keyword">sizeof</span>(FileFdwPlanState));</span><br><span class="line">fileGetOptions(foreigntableid,</span><br><span class="line">   &amp;fdw_private-&gt;filename,</span><br><span class="line">   &amp;fdw_private-&gt;is_program,</span><br><span class="line">   &amp;fdw_private-&gt;options);</span><br><span class="line">baserel-&gt;fdw_private = (<span class="keyword">void</span> *) fdw_private;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*估算表大小 Estimate relation size */</span></span><br><span class="line">estimate_size(root, baserel, fdw_private);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>estimate_size</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Estimate size of a foreign table.</span></span><br><span class="line"><span class="comment"> * 估算外部表大小</span></span><br><span class="line"><span class="comment"> * The main result is returned in baserel-&gt;rows.  We also set</span></span><br><span class="line"><span class="comment"> * fdw_private-&gt;pages and fdw_private-&gt;ntuples for later use in the cost</span></span><br><span class="line"><span class="comment"> * calculation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">estimate_size(PlannerInfo *root, RelOptInfo *baserel,</span><br><span class="line">  FileFdwPlanState *fdw_private)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">stat_buf</span>;</span></span><br><span class="line">BlockNumber pages;</span><br><span class="line"><span class="keyword">double</span>ntuples;</span><br><span class="line"><span class="keyword">double</span>nrows;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 如果是程序或者获取文件失败，则设置默认值</span></span><br><span class="line"><span class="comment"> * Get size of the file.  It might not be there at plan time, though, in</span></span><br><span class="line"><span class="comment"> * which case we have to use a default estimate.  We also have to fall</span></span><br><span class="line"><span class="comment"> * back to the default if using a program as the input.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (fdw_private-&gt;is_program || stat(fdw_private-&gt;filename, &amp;stat_buf) &lt; <span class="number">0</span>)</span><br><span class="line">stat_buf.st_size = <span class="number">10</span> * BLCKSZ;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 将大小转换成页数</span></span><br><span class="line"><span class="comment"> * Convert size to pages for use in I/O cost estimate later.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">pages = (stat_buf.st_size + (BLCKSZ - <span class="number">1</span>)) / BLCKSZ;</span><br><span class="line"><span class="keyword">if</span> (pages &lt; <span class="number">1</span>)</span><br><span class="line">pages = <span class="number">1</span>;</span><br><span class="line">fdw_private-&gt;pages = pages;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Estimate the number of tuples in the file.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (baserel-&gt;pages &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* 如果已经执行过ANALYZE，则baserel-&gt;pages的值大于0，直接进行行数计算</span></span><br><span class="line"><span class="comment"> * We have # of pages and # of tuples from pg_class (that is, from a</span></span><br><span class="line"><span class="comment"> * previous ANALYZE), so compute a tuples-per-page estimate and scale</span></span><br><span class="line"><span class="comment"> * that by the current file size.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">double</span>density;</span><br><span class="line"></span><br><span class="line">density = baserel-&gt;tuples / (<span class="keyword">double</span>) baserel-&gt;pages;# <span class="comment">// 计算每页的行数密度</span></span><br><span class="line">ntuples = clamp_row_est(density * (<span class="keyword">double</span>) pages); <span class="comment">//估算行数</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Otherwise we have to fake it.  We back into this estimate using the</span></span><br><span class="line"><span class="comment"> * planner's idea of the relation width; which is bogus if not all</span></span><br><span class="line"><span class="comment"> * columns are being read, not to mention that the text representation</span></span><br><span class="line"><span class="comment"> * of a row probably isn't the same size as its internal</span></span><br><span class="line"><span class="comment"> * representation.  Possibly we could do something better, but the</span></span><br><span class="line"><span class="comment"> * real answer to anyone who complains is "ANALYZE" ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span>tuple_width;</span><br><span class="line"></span><br><span class="line">tuple_width = MAXALIGN(baserel-&gt;reltarget-&gt;width) +</span><br><span class="line">MAXALIGN(SizeofHeapTupleHeader);<span class="comment">// 计算行宽</span></span><br><span class="line">ntuples = clamp_row_est((<span class="keyword">double</span>) stat_buf.st_size /</span><br><span class="line">(<span class="keyword">double</span>) tuple_width);<span class="comment">//数据量大小除行宽估算行数</span></span><br><span class="line">&#125;</span><br><span class="line">fdw_private-&gt;ntuples = ntuples;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 加上提供baserestrictinfo信息扫描后的结果估算行数</span></span><br><span class="line"><span class="comment"> * Now estimate the number of rows returned by the scan after applying the</span></span><br><span class="line"><span class="comment"> * baserestrictinfo quals.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">nrows = ntuples *</span><br><span class="line">clauselist_selectivity(root,</span><br><span class="line">   baserel-&gt;baserestrictinfo,</span><br><span class="line">   <span class="number">0</span>,</span><br><span class="line">   JOIN_INNER,</span><br><span class="line">   <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">nrows = clamp_row_est(nrows);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Save the output-rows estimate for the planner */</span></span><br><span class="line">baserel-&gt;rows = nrows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>fileGetForeignPaths</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * fileGetForeignPaths</span></span><br><span class="line"><span class="comment"> *Create possible access paths for a scan on the foreign table</span></span><br><span class="line"><span class="comment"> *  创建扫描外部表的访问路径</span></span><br><span class="line"><span class="comment"> *Currently we don't support any push-down feature, so there is only one</span></span><br><span class="line"><span class="comment"> *possible access path, which simply returns all records in the order in</span></span><br><span class="line"><span class="comment"> *the data file.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">fileGetForeignPaths(PlannerInfo *root,</span><br><span class="line">RelOptInfo *baserel,</span><br><span class="line">Oid foreigntableid)</span><br><span class="line">&#123;</span><br><span class="line">FileFdwPlanState *fdw_private = (FileFdwPlanState *) baserel-&gt;fdw_private;</span><br><span class="line">Coststartup_cost;</span><br><span class="line">Costtotal_cost;</span><br><span class="line">List   *columns;</span><br><span class="line">List   *coptions = NIL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 决定是否有选择地执行二进制转换 Decide whether to selectively perform binary conversion */</span></span><br><span class="line"><span class="keyword">if</span> (check_selective_binary_conversion(baserel,</span><br><span class="line">  foreigntableid,</span><br><span class="line">  &amp;columns))</span><br><span class="line">coptions = list_make1(makeDefElem(<span class="string">"convert_selectively"</span>,</span><br><span class="line">  (Node *) columns, <span class="number">-1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 估算代价 Estimate costs */</span></span><br><span class="line">estimate_costs(root, baserel, fdw_private,</span><br><span class="line">   &amp;startup_cost, &amp;total_cost);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 创建外部路径节点并添加到路径列表中</span></span><br><span class="line"><span class="comment"> * Create a ForeignPath node and add it as only possible path.  We use the</span></span><br><span class="line"><span class="comment"> * fdw_private list of the path to carry the convert_selectively option;</span></span><br><span class="line"><span class="comment"> * it will be propagated into the fdw_private list of the Plan node.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">add_path(baserel, (Path *)</span><br><span class="line"> create_foreignscan_path(root, baserel,</span><br><span class="line"> <span class="literal">NULL</span>,<span class="comment">/* default pathtarget */</span></span><br><span class="line"> baserel-&gt;rows,</span><br><span class="line"> startup_cost,</span><br><span class="line"> total_cost,</span><br><span class="line"> NIL,<span class="comment">/* no pathkeys */</span></span><br><span class="line"> <span class="literal">NULL</span>,<span class="comment">/* no outer rel either */</span></span><br><span class="line"> <span class="literal">NULL</span>,<span class="comment">/* no extra plan */</span></span><br><span class="line"> coptions));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If data file was sorted, and we knew it somehow, we could insert</span></span><br><span class="line"><span class="comment"> * appropriate pathkeys into the ForeignPath node to tell the planner</span></span><br><span class="line"><span class="comment"> * that.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>estimate_costs </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Estimate costs of scanning a foreign table.</span></span><br><span class="line"><span class="comment"> * 估算代价</span></span><br><span class="line"><span class="comment"> * Results are returned in *startup_cost and *total_cost.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">estimate_costs(PlannerInfo *root, RelOptInfo *baserel,</span><br><span class="line">   FileFdwPlanState *fdw_private,</span><br><span class="line">   Cost *startup_cost, Cost *total_cost)</span><br><span class="line">&#123;</span><br><span class="line">BlockNumber pages = fdw_private-&gt;pages;</span><br><span class="line"><span class="keyword">double</span>ntuples = fdw_private-&gt;ntuples;</span><br><span class="line">Costrun_cost = <span class="number">0</span>;</span><br><span class="line">Costcpu_per_tuple;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We estimate costs almost the same way as cost_seqscan(), thus assuming</span></span><br><span class="line"><span class="comment"> * that I/O costs are equivalent to a regular table file of the same size.</span></span><br><span class="line"><span class="comment"> * However, we take per-tuple CPU costs as 10x of a seqscan, to account</span></span><br><span class="line"><span class="comment"> * for the cost of parsing records.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * In the case of a program source, this calculation is even more divorced</span></span><br><span class="line"><span class="comment"> * from reality, but we have no good alternative; and it's not clear that</span></span><br><span class="line"><span class="comment"> * the numbers we produce here matter much anyway, since there's only one</span></span><br><span class="line"><span class="comment"> * access path for the rel.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">run_cost += seq_page_cost * pages;</span><br><span class="line"></span><br><span class="line">*startup_cost = baserel-&gt;baserestrictcost.startup;</span><br><span class="line">cpu_per_tuple = cpu_tuple_cost * <span class="number">10</span> + baserel-&gt;baserestrictcost.per_tuple;</span><br><span class="line">run_cost += cpu_per_tuple * ntuples;</span><br><span class="line">*total_cost = *startup_cost + run_cost;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>fileGetForeignPlan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * fileGetForeignPlan</span></span><br><span class="line"><span class="comment"> *Create a ForeignScan plan node for scanning the foreign table</span></span><br><span class="line"><span class="comment"> *  创建外部扫描计划</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> ForeignScan *</span><br><span class="line">fileGetForeignPlan(PlannerInfo *root,</span><br><span class="line">   RelOptInfo *baserel,</span><br><span class="line">   Oid foreigntableid,</span><br><span class="line">   ForeignPath *best_path,</span><br><span class="line">   List *tlist,</span><br><span class="line">   List *scan_clauses,</span><br><span class="line">   Plan *outer_plan)</span><br><span class="line">&#123;</span><br><span class="line">Indexscan_relid = baserel-&gt;relid;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We have no native ability to evaluate restriction clauses, so we just</span></span><br><span class="line"><span class="comment"> * put all the scan_clauses into the plan node's qual list for the</span></span><br><span class="line"><span class="comment"> * executor to check.  So all we have to do here is strip RestrictInfo</span></span><br><span class="line"><span class="comment"> * nodes from the clauses and ignore pseudoconstants (which will be</span></span><br><span class="line"><span class="comment"> * handled elsewhere).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">scan_clauses = extract_actual_clauses(scan_clauses, <span class="literal">false</span>);<span class="comment">// 去掉约束语句</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*创建ForeignScan节点 Create the ForeignScan node */</span></span><br><span class="line"><span class="keyword">return</span> make_foreignscan(tlist,</span><br><span class="line">scan_clauses,</span><br><span class="line">scan_relid,</span><br><span class="line">NIL,<span class="comment">/* no expressions to evaluate */</span></span><br><span class="line">best_path-&gt;fdw_private,</span><br><span class="line">NIL,<span class="comment">/* no custom tlist */</span></span><br><span class="line">NIL,<span class="comment">/* no remote quals */</span></span><br><span class="line">outer_plan);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><br></p><p><em>未完待续</em></p><!--根据file_fdw.c里实现了的回调函数，使用gdb去追踪执行情况：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Datum</span><br><span class="line">file_fdw_handler(PG_FUNCTION_ARGS)</span><br><span class="line">&#123;</span><br><span class="line">FdwRoutine *fdwroutine = makeNode(FdwRoutine);</span><br><span class="line"></span><br><span class="line">fdwroutine-&gt;GetForeignRelSize = fileGetForeignRelSize;</span><br><span class="line">fdwroutine-&gt;GetForeignPaths = fileGetForeignPaths;</span><br><span class="line">fdwroutine-&gt;GetForeignPlan = fileGetForeignPlan;</span><br><span class="line">fdwroutine-&gt;ExplainForeignScan = fileExplainForeignScan;</span><br><span class="line">fdwroutine-&gt;BeginForeignScan = fileBeginForeignScan;</span><br><span class="line">fdwroutine-&gt;IterateForeignScan = fileIterateForeignScan;</span><br><span class="line">fdwroutine-&gt;ReScanForeignScan = fileReScanForeignScan;</span><br><span class="line">fdwroutine-&gt;EndForeignScan = fileEndForeignScan;</span><br><span class="line">fdwroutine-&gt;AnalyzeForeignTable = fileAnalyzeForeignTable;</span><br><span class="line">fdwroutine-&gt;IsForeignScanParallelSafe = fileIsForeignScanParallelSafe;</span><br><span class="line"></span><br><span class="line">PG_RETURN_POINTER(fdwroutine);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fdw=# select pg_backend_pid();</span><br><span class="line"> pg_backend_pid </span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line">           1421</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># gdb -p 1421</span></span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-110.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-redhat-linux-gnu"</span>.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Attaching to process 1421</span><br><span class="line">...</span><br><span class="line">(gdb) b fileGetForeignRelSize</span><br><span class="line">Breakpoint 1 at 0x7f223f2cc8a0: file file_fdw.c, line 506.</span><br><span class="line">(gdb) b fileGetForeignPaths</span><br><span class="line">Breakpoint 2 at 0x7f223f2cc600: file file_fdw.c, line 537.</span><br><span class="line">(gdb) b fileGetForeignPlan</span><br><span class="line">Breakpoint 3 at 0x7f223f2cc5b0: file file_fdw.c, line 590.</span><br><span class="line">(gdb) b fileExplainForeignScan</span><br><span class="line">Breakpoint 4 at 0x7f223f2cc500: file file_fdw.c, line 619.</span><br><span class="line">(gdb) b fileBeginForeignScan</span><br><span class="line">Breakpoint 5 at 0x7f223f2cc2f0: file file_fdw.c, line 651.</span><br><span class="line">(gdb) b fileIterateForeignScan</span><br><span class="line">Breakpoint 6 at 0x7f223f2cc480: file file_fdw.c, line 704.</span><br><span class="line">(gdb) b fileReScanForeignScan</span><br><span class="line">Breakpoint 7 at 0x7f223f2cbc50: file file_fdw.c, line 747.</span><br><span class="line">(gdb) b fileEndForeignScan</span><br><span class="line">Breakpoint 8 at 0x7f223f2cbc30: file file_fdw.c, line 768.</span><br><span class="line">(gdb) b fileAnalyzeForeignTable</span><br><span class="line">Breakpoint 9 at 0x7f223f2cc3a0: file file_fdw.c, line 783.</span><br><span class="line">(gdb) b fileIsForeignScanParallelSafe</span><br><span class="line">Breakpoint 10 at 0x7f223f2cbc20: file file_fdw.c, line 835.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先来看看这个sql语句的解析`explain select * from tb1_fdw order by id limit 10;`</span></span><br><span class="line"><span class="comment"># 切换至psql</span></span><br><span class="line">fdw=<span class="comment"># explain select * from tb1_fdw order by id limit 10;</span></span><br><span class="line"><span class="comment"># （挂起）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换会gdb</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 10, fileIsForeignScanParallelSafe (root=0x16ea238, rel=0x1724fc8, rte=0x16e9958)</span><br><span class="line">    at file_fdw.c:835</span><br><span class="line">835&#125;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  fileIsForeignScanParallelSafe (root=0x16ea238, rel=0x1724fc8, rte=0x16e9958) at file_fdw.c:835</span></span><br><span class="line"><span class="comment">#1  0x000000000065df1b in set_rel_consider_parallel (root=root@entry=0x16ea238, rel=rel@entry=0x1724fc8, rte=rte@entry=0x16e9958) at allpaths.c:597</span></span><br><span class="line"><span class="comment">#2  0x00000000006609c3 in set_base_rel_sizes (root=&lt;optimized out&gt;) at allpaths.c:279</span></span><br><span class="line"><span class="comment">#3  make_one_rel (root=root@entry=0x16ea238, joinlist=joinlist@entry=0x1719a08) at allpaths.c:179</span></span><br><span class="line"><span class="comment">#4  0x000000000067de9e in query_planner (root=root@entry=0x16ea238, tlist=tlist@entry=0x16ea708, qp_callback=qp_callback@entry=0x67f290 &lt;standard_qp_callback&gt;, qp_extra=qp_extra@entry=0x7ffe9f3f4fc0) at planmain.c:259</span></span><br><span class="line"><span class="comment">#5  0x0000000000681f43 in grouping_planner (root=root@entry=0x16ea238, inheritance_update=inheritance_update@entry=false, tuple_fraction=&lt;optimized out&gt;, tuple_fraction@entry=0) at planner.c:1897</span></span><br><span class="line"><span class="comment">#6  0x0000000000684218 in subquery_planner (glob=glob@entry=0x16ea1a8, parse=parse@entry=0x17251d8, parent_root=parent_root@entry=0x0, hasRecursion=hasRecursion@entry=false, tuple_fraction=tuple_fraction@entry=0) at planner.c:966</span></span><br><span class="line"><span class="comment">#7  0x0000000000685236 in standard_planner (parse=0x17251d8, cursorOptions=256, boundParams=0x0)at planner.c:405</span></span><br><span class="line"><span class="comment">#8  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x17251d8, cursorOptions=&lt;optimized out&gt;, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#9  0x0000000000595a0a in ExplainOneQuery (query=0x17251d8, cursorOptions=&lt;optimized out&gt;, into=0x0, es=0x1724f38, queryString=0x1627810 "explain select * from tb1_fdw order by id limit 10;", params=0x0, queryEnv=0x0) at explain.c:365</span></span><br><span class="line"><span class="comment">#10 0x0000000000595f54 in ExplainQuery (pstate=pstate@entry=0x1724db8, stmt=stmt@entry=0x16286f0, queryString=queryString@entry=0x1627810 "explain select * from tb1_fdw order by id limit 10;", params=params@entry=0x0, queryEnv=queryEnv@entry=0x0, dest=dest@entry=0x1724d28) at explain.c:254</span></span><br><span class="line"><span class="comment">#11 0x0000000000726ead in standard_ProcessUtility (pstmt=0x16287a0, queryString=0x1627810 "explain select * from tb1_fdw order by id limit 10;", context=PROCESS_UTILITY_TOPLEVEL, params=0x0, queryEnv=0x0, dest=0x1724d28, completionTag=0x7ffe9f3f5470 "") at utility.c:672</span></span><br><span class="line"><span class="comment">#12 0x0000000000724476 in PortalRunUtility (portal=0x168cf10, pstmt=0x16287a0, isTopLevel=&lt;optimized out&gt;, setHoldSnapshot=&lt;optimized out&gt;, dest=0x1724d28, completionTag=0x7ffe9f3f5470 "") at pquery.c:1178</span></span><br><span class="line"><span class="comment">#13 0x0000000000725182 in FillPortalStore (portal=portal@entry=0x168cf10, isTopLevel=isTopLevel@entry=true) at pquery.c:1038</span></span><br><span class="line"><span class="comment">#14 0x0000000000725b90 in PortalRun (portal=portal@entry=0x168cf10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x1629528, altdest=altdest@entry=0x1629528, completionTag=completionTag@entry=0x7ffe9f3f5680 "") at pquery.c:768</span></span><br><span class="line"><span class="comment">#15 0x0000000000721bb7 in exec_simple_query (query_string=0x1627810 "explain select * from tb1_fdw order by id limit 10;")at postgres.c:1122</span></span><br><span class="line"><span class="comment">#16 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1651528, dbname=0x1651410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#17 0x000000000047a861 in BackendRun (port=0x16493f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#18 BackendStartup (port=0x16493f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#19 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#20 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x16223c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#21 0x000000000047b2a1 in main (argc=3, argv=0x16223c0) at main.c:228</span></span><br></pre></td></tr></table></figure><p>–&gt; </p>-->]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;之前文章介绍了实现FDW的函数，现在来看看PostgreSQL实现的文件的FDW是怎么的吧。&lt;br&gt;PostgreSQL实现的file_fdw的源码可以在PostgreSQL的源码目录下contrib目录下找到。&lt;/p&gt;
&lt;h3 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; 
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
      <category term="file_fdw" scheme="https://oyo-byte.github.io/tags/file-fdw/"/>
    
  </entry>
  
  <entry>
    <title>学习PostgreSQL的FDW(#5)-辅助函数介绍</title>
    <link href="https://oyo-byte.github.io/2018/08/10/learn_about_pgfdw_part5/"/>
    <id>https://oyo-byte.github.io/2018/08/10/learn_about_pgfdw_part5/</id>
    <published>2018-08-10T06:29:20.579Z</published>
    <updated>2018-08-16T17:24:58.054Z</updated>
    
    <content type="html"><![CDATA[<p>PG核心服务器提供了多个辅助函数，是外部包装器的开发者们能很容易地访问到FDW相关对象的属性，例如FDW选项。使用这些函数，只需在源文件中引入foreign/foreign.h头文件即可。</p><table><thead><tr><th style="text-align:left">函数</th><th style="text-align:left">代码</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">GetForeignDataWrapper</td><td style="text-align:left">ForeignDataWrapper * GetForeignDataWrapper(Oid fdwid);</td><td style="text-align:left">为具有给定 OID 的外部数据包装器返回一个ForeignDataWrapper对象。一个ForeignDataWrapper对象包含该FDW的特性</td></tr><tr><td style="text-align:left">GetForeignServer</td><td style="text-align:left">ForeignServer * GetForeignServer(Oid serverid);</td><td style="text-align:left">为一个具有给定 OID 的外部服务器返回ForeignServer对象。一个ForeignServer对象包含该服务器的特性</td></tr><tr><td style="text-align:left">GetUserMapping</td><td style="text-align:left">UserMapping * GetUserMapping(Oid userid, Oid serverid);</td><td style="text-align:left">为在给定服务器上的给定角色的用户映射返回UserMapping对象（如果指定用户没有映射，它将返回PUBLIC的映射，如果也没有则抛出错误）。一个UserMapping对象包含该用户映射的特性</td></tr><tr><td style="text-align:left">GetForeignTable</td><td style="text-align:left">ForeignTable * GetForeignTable(Oid relid);</td><td style="text-align:left">为一个具有给定 OID 的外部表返回ForeignTable对象。一个ForeignTable对象包含该外部表的特性</td></tr><tr><td style="text-align:left">GetForeignColumnOptions</td><td style="text-align:left">List * GetForeignColumnOptions(Oid relid, AttrNumber attnum);</td><td style="text-align:left">为一个具有给定外部表 OID 和属性号的列返回针对每一列的FDW选项，形式为一个DefElem列表。如果该列没有选项则返回 NIL。</td></tr><tr><td style="text-align:left">GetForeignDataWrapperByName</td><td style="text-align:left">ForeignDataWrapper <em> GetForeignDataWrapperByName(const char </em>name, bool missing_ok);</td><td style="text-align:left">为一个具有给定名称的外部数据包装器返回ForeignDataWrapper对象。如果包装器没有找到，在missing_ok为真时返回 NULL，否则抛出一个错误。</td></tr><tr><td style="text-align:left">GetForeignServerByName</td><td style="text-align:left">ForeignServer <em> GetForeignServerByName(const char </em>name, bool missing_ok);</td><td style="text-align:left">为一个具有给定名称的外部服务器返回ForeignServer对象。如果该服务器没有被找到，在missing_ok为真时返回 NULL，否则抛出一个错误。</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;PG核心服务器提供了多个辅助函数，是外部包装器的开发者们能很容易地访问到FDW相关对象的属性，例如FDW选项。使用这些函数，只需在源文件中引入foreign/foreign.h头文件即可。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-a
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
  </entry>
  
  <entry>
    <title>学习PostgreSQL的FDW(#4)-其他函数说明 II</title>
    <link href="https://oyo-byte.github.io/2018/08/08/learn_about_pgfdw_part4/"/>
    <id>https://oyo-byte.github.io/2018/08/08/learn_about_pgfdw_part4/</id>
    <published>2018-08-08T09:52:34.432Z</published>
    <updated>2018-08-08T10:00:12.436Z</updated>
    
    <content type="html"><![CDATA[<p>继上篇<a href="https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part3/">学习PostgreSQL的FDW(#3)-其他函数说明 I</a>，继续说说其余回调函数</p><h2 id="用于行锁定的FDW回调函数"><a href="#用于行锁定的FDW回调函数" class="headerlink" title="用于行锁定的FDW回调函数"></a>用于行锁定的FDW回调函数</h2><p>如果一个FDW 希望支持<em>后期行锁定</em>，必须提供以下回调函数：</p><ul><li>GetForeignRowMarkType</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RowMarkType</span><br><span class="line">GetForeignRowMarkType (RangeTblEntry *rte,</span><br><span class="line">                       LockClauseStrength strength);</span><br></pre></td></tr></table></figure><p>报告要对一个外部表使用哪个行标记选项。rte是该表的RangeTblEntry节点，而strength描述FOR UPDATE/SHARE子句（如果有）所要求的锁长度。结果必须是RowMarkType枚举类型的一个成员。</p><p>这个函数在查询规划期间会为每一个出现在UPDATE、DELETE或者SELECT FOR UPDATE/SHARE查询中的外部表调用，并且该外部表不是UPDATE和DELETE的目标。</p><p>如果<code>GetForeignRowMarkType</code>指针被设置为NULL，将总是使用ROW_MARK_COPY选项（这意味着将不会调用RefetchForeignRow，因此也不必提供它）。</p><ul><li>RefetchForeignRow </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HeapTuple</span><br><span class="line">RefetchForeignRow(EState *estate,</span><br><span class="line">                  ExecRowMark *erm,</span><br><span class="line">                  Datum rowid,</span><br><span class="line">                  <span class="keyword">bool</span> *updated);</span><br></pre></td></tr></table></figure><p>从外部表中重新取得一个元组，如有必要先锁定它。estate是该查询的全局执行状态。erm是描述目标外部表以及要获取的行锁类型（如果有）的ExecRowMark结构。rowid标识要取得的元组。updated是一个输出参数。</p><p>这个函数应该返回被取得的元组的一个已经分配内存的拷贝，如果无法得到行锁则返回NULL。要获得的行锁由erm-&gt;markType定义，它是之前由<code>GetForeignRowMarkType</code>返回的值（ROW_MARK_REFERENCE标识只重新取得元组但不获得任何锁，这个例程将不会看到ROW_MARK_COPY）。</p><p>此外，如果取得的是一个更新过的版本而不是之前获得的同一版本，*updated应被设置为true（如果 FDW 无法确定这一点，推荐总是返回true）。</p><p>注意在默认情况下，获取行锁失败应该导致产生错误。如果erm-&gt;waitPolicy指定了SKIP LOCKED，只有返回NULL才是合适的。</p><p>rowid是要被重新取得的行之前读到的ctid值。尽管rowid值被作为Datum传递，但是目前它只能被读作tid。选择该函数 API 是希望未来能允许其他的行 ID 数据类型。</p><p>如果<code>RefetchForeignRow</code>指针被设置为NULL，重新取得行的尝试将会失败并伴随有一个错误消息。</p><ul><li>RecheckForeignScan </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span></span><br><span class="line">RecheckForeignScan(ForeignScanState *node,</span><br><span class="line">                   TupleTableSlot *slot);</span><br></pre></td></tr></table></figure><p>重新检查之前返回的元组是否仍然匹配相关的扫描和连接条件，并且可能提供该元组的一个修改版本。对于不执行连接下推的外部数据包装器，通常把这设置为NULL并且恰当地设置fdw_recheck_quals会更方便。不过当外部连接被下推时，把与所有基表相关的检查重新应用在结果元组上是不够的，即便所有需要的属性都存在也是如此，因为匹配某个条件失败可能会导致某些属性变成 NULL，而不是没有元组被返回。<code>RecheckForeignScan</code>能够重新检查条件，并且在它们仍然满足时返回真，否则返回假，但是它也能够在提供的槽中存储一个替换元组。</p><p>要实现连接下推，外部数据包装器通常将构造一个可替代的本地连接计划，它只被用来做重新检查。这将变成ForeignScan的外子计划。在需要一次重新检查时，这个子计划可以被执行并且结果元组可以被存储在槽中。这个计划不需要效率很高，因为不会有基表返回超过一行。例如，它可以把所有的连接实现为嵌套循环。函数<code>GetExistingLocalJoinPath</code>可以被用来在已有的路径中搜索合适的本地连接路径，它可以被用作替换的本地连接计划。<code>GetExistingLocalJoinPath</code>会在指定连接关系的路径列表中搜索一个非参数化路径（如果没有找到这样的路径，它会返回 NULL，这种情况下外部数据包装器可以自行构造本地路径或者可以选择不为这个连接创建访问路径）。</p><h2 id="EXPLAIN-相关FDW回调函数"><a href="#EXPLAIN-相关FDW回调函数" class="headerlink" title="EXPLAIN 相关FDW回调函数"></a>EXPLAIN 相关FDW回调函数</h2><ul><li>ExplainForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ExplainForeignScan(ForeignScanState *node,</span><br><span class="line">                   ExplainState *es);</span><br></pre></td></tr></table></figure><p>为一个外部表扫描打印额外的EXPLAIN输出。这个函数可以调用ExplainPropertyText和相关函数来向EXPLAIN输出中增加域。es中的标志域可以被用来决定什么将被打印，并且ForeignScanState节点的状态可以被检查来为EXPLAIN ANALYZE提供运行时统计数据。</p><p>如果<code>ExplainForeignScan</code>指针被设置为NULL，在EXPLAIN期间不会打印任何额外的信息。</p><ul><li>ExplainForeignModify </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ExplainForeignModify(ModifyTableState *mtstate,</span><br><span class="line">                     ResultRelInfo *rinfo,</span><br><span class="line">                     List *fdw_private,</span><br><span class="line">                     <span class="keyword">int</span> subplan_index,</span><br><span class="line">                     struct ExplainState *es);</span><br></pre></td></tr></table></figure><p>为一个外部表更新打印额外的EXPLAIN输出。这个函数可以调用ExplainPropertyText和相关函数来向EXPLAIN输出中增加域。es中的标志域可以被用来决定什么将被打印，并且ModifyTableState节点的状态可以被检查来为EXPLAIN ANALYZE提供运行时统计数据。前四个参数和<code>BeginForeignModify</code>相同。</p><p>如果<code>ExplainForeignModify</code>指针被设置为NULL，在EXPLAIN期间不会打印任何额外的信息。</p><ul><li>ExplainDirectModify</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ExplainDirectModify(ForeignScanState *node,</span><br><span class="line">                    ExplainState *es);</span><br></pre></td></tr></table></figure><p>为远程服务器上的直接修改打印额外的EXPLAIN输出。这个函数可以调用ExplainPropertyText和相关函数来为EXPLAIN输出增加域。es中的标志域可以被用来判断要打印什么，并且在EXPLAIN ANALYZE情况中可以观察ForeignScanState节点的状态来提供运行时统计信息。</p><p>如果<code>ExplainDirectModify</code>指针被设置为NULL，EXPLAIN期间不会打印出额外的信息。</p><h2 id="ANALYZE-相关FDW回调函数"><a href="#ANALYZE-相关FDW回调函数" class="headerlink" title="ANALYZE 相关FDW回调函数"></a>ANALYZE 相关FDW回调函数</h2><ul><li>AnalyzeForeignTable</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span></span><br><span class="line">AnalyzeForeignTable (Relation relation,</span><br><span class="line">                     AcquireSampleRowsFunc *func,</span><br><span class="line">                     BlockNumber *totalpages);</span><br></pre></td></tr></table></figure><p>当ANALYZE被执行在一个外部表上时会调用这个函数。如果FDW可以为这个外部表收集统计信息，它会返回true并提供一个函数指针，该函数将将从func中的表上收集采样行，外加totalpages中页面中的表尺寸估计值。否则，返回false。</p><p>如果FDW不支持为任何表收集统计信息，<code>AnalyzeForeignTable</code>指针可以被设置为NULL。</p><p>如果提供，采样收集函数必须具有签名</p><ul><li>AcquireSampleRowsFunc</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">AcquireSampleRowsFunc(Relation relation,</span><br><span class="line">                      <span class="keyword">int</span> elevel,</span><br><span class="line">                      HeapTuple *rows,</span><br><span class="line">                      <span class="keyword">int</span> targrows,</span><br><span class="line">                      <span class="keyword">double</span> *totalrows,</span><br><span class="line">                      <span class="keyword">double</span> *totaldeadrows);</span><br></pre></td></tr></table></figure><p>应该从该表上收集最多targrows行的一个随机采样并将它存放到调用者提供的rows数组中。实际被收集的行的数量必须被返回。另外，将表中有效行和死亡行的总数存储到输出参数totalrows和totaldeadrows中（如果FDW没有死亡行的概念，将totaldeadrows设置为 0 ）。</p><h2 id="IMPORT-FOREIGN-SCHEMA-回调函数"><a href="#IMPORT-FOREIGN-SCHEMA-回调函数" class="headerlink" title="IMPORT FOREIGN SCHEMA 回调函数"></a>IMPORT FOREIGN SCHEMA 回调函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List *</span><br><span class="line">ImportForeignSchema (ImportForeignSchemaStmt *stmt, Oid serverOid);</span><br></pre></td></tr></table></figure><p>取得一个外部表创建命令的列表。在执行<code>IMPORT FOREIGN SCHEMA</code>时会调用这个函数，并且会把该语句的解析树以及要使用的外部服务器的 OID 传递给它。它应该返回一个 C 字符串的列表，每一个必须包含一个<code>CREATE FOREIGN TABLE</code>命令。这些命令将被核心服务器所解析和执行。</p><p>在ImportForeignSchemaStmt结构中，remote_schema是要从其中导入这些表的远程模式的名称。list_type标识如何过滤表名：FDW_IMPORT_SCHEMA_ALL表示该远程模式中的所有表都应该被导入（这种情况下table_list为空），FDW_IMPORT_SCHEMA_LIMIT_TO表示只包括table_list中列出的表，而FDW_IMPORT_SCHEMA_EXCEPT则表示排除table_list中列出的表。options是一个用于该导入处理的选项列表。选项的含义由 FDW 决定。例如，一个 FDW 可以用一个选项来定义是否应该导入列的NOT NULL属性。这些选项不需要与那些 FDW 支持的数据库对象选项有什么关系。</p><p>FDW 可能会忽略ImportForeignSchemaStmt的local_schema域，因为核心服务器会自动地向解析好的<code>CREATE FOREIGN TABLE</code>命令中插入本地模式的名称。</p><p>FDW 也不必担心实现list_type以及table_list所指定的过滤，因为核心服务器将自动根据那些选项跳过为被排除的表所返回的命令。不过，起初就避免为被排除的表创建命令当然更好。函数<code>IsImportableForeignTable()</code>可以用来测试一个给定的外部表名是否能通过该过滤器。</p><p>如果 FDW 不支持导入表定义，<code>ImportForeignSchema</code>指针可以被设置为NULL。</p><h2 id="并行执行-回调函数"><a href="#并行执行-回调函数" class="headerlink" title="并行执行 回调函数"></a>并行执行 回调函数</h2><p>ForeignScan节点可以选择支持并行执行。一个并行的 ForeignScan将在多个进程中执行， 并且在相互合作的进程中每个行必须只被返回一次。要做到这样， 进程可以通过动态共享内存的固定尺寸块来协作。并不保证在每一个进程中这部份共享内存都被映射到相同的地址， 因此必须不能包含指针。下面的函数都是可选的，但是如果要支持并行执行需要提供大多数函数。</p><ul><li>IsForeignScanParallelSafe<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span></span><br><span class="line">IsForeignScanParallelSafe(PlannerInfo *root, RelOptInfo *rel,</span><br><span class="line">                          RangeTblEntry *rte);</span><br></pre></td></tr></table></figure></li></ul><p>测试一个扫描是否可以在一个并行工作者中被执行。只有当规划器相信可以使用并行计划时才会调用这个函数，如果该扫描在并行工作者中可以安全运行这个函数应该返回真。如果远程数据源具有事务语义，情况通常都不是这样，除非工作者到数据的连接能够以某种方式共享与领导者相同的事务环境。</p><p>如果没有定义这个函数，则假定该扫描必须被放置在并行领导者中。注意返回真并不意味着该扫描本身可以被并行完成，只是说明该扫描可以在一个并行工作者中执行。因此，即便当不支持并行执行时，定义这个方法也是有用的。</p><ul><li>EstimateDSMForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Size</span><br><span class="line">EstimateDSMForeignScan(ForeignScanState *node, ParallelContext *pcxt);</span><br></pre></td></tr></table></figure><p>估算并行操作所需的动态共享内存的数量。这可能比实际要用的数量更大，但是绝不能更小。返回值的单位是字节。该函数是可选的，如果不需要可以省略；但是如果省略它， 接下来的三个函数也必须省略，因为没有分配共享内存将给FDW使用。</p><ul><li>InitializeDSMForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">InitializeDSMForeignScan(ForeignScanState *node, ParallelContext *pcxt,</span><br><span class="line">                         <span class="keyword">void</span> *coordinate);</span><br></pre></td></tr></table></figure><p>初始化并行操作所需的动态共享内存。coordinate指向共享内存区域， 其大小等于EstimateDSMForeignScan的返回值。 该函数是可选的，如果不需要可以省略。</p><ul><li>ReInitializeDSMForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ReInitializeDSMForeignScan(ForeignScanState *node, ParallelContext *pcxt,</span><br><span class="line">                           <span class="keyword">void</span> *coordinate);</span><br></pre></td></tr></table></figure><p>当外部扫描计划节点即将被重新扫描时，重新初始化并行操作所需的动态共享内存。该函数是可选的，如果不需要可以省略。推荐的做法是此函数仅重置共享状态， 而<code>ReScanForeignScan</code>函数仅重置本地状态。目前， 这个函数会在<code>ReScanForeignScan</code>之前调用，但最好不要依赖这个顺序。</p><ul><li>InitializeWorkerForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">InitializeWorkerForeignScan(ForeignScanState *node, shm_toc *toc,</span><br><span class="line">                            <span class="keyword">void</span> *coordinate);</span><br></pre></td></tr></table></figure><p>基于<code>InitializeDSMForeignScan</code>期间领导者设置的共享状态初始化并行工作者的本地状态。这个函数是可选的， 如果不需要可以省略。</p><ul><li>ShutdownForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ShutdownForeignScan(ForeignScanState *node);</span><br></pre></td></tr></table></figure><p>预计节点将不会执行完成时释放资源。这在所有情况下都不被调用；有时， <code>EndForeignScan</code>可能会在没有先调用此函数的情况下调用。由于并行查询使用的DSM段在调用此回调后即被销毁， 因此希望在DSM段消失之前采取某些操作的外部数据包装器应实现此方法。</p><h2 id="用于路径重新参数化-的回调函数"><a href="#用于路径重新参数化-的回调函数" class="headerlink" title="用于路径重新参数化 的回调函数"></a>用于路径重新参数化 的回调函数</h2><ul><li>ReparameterizeForeignPathByChild</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List *</span><br><span class="line">ReparameterizeForeignPathByChild(PlannerInfo *root, List *fdw_private,</span><br><span class="line">                                 RelOptInfo *child_rel);</span><br></pre></td></tr></table></figure><p>在将由给定子关系child_rel的最顶层父级参数化的路径转换为由子关系参数化时，调用此函数。该函数用于重新参数化任何路径或转换保存在给定ForeignPath节点的fdw_private 成员中的任何表达式。回调根据需要使用reparameterize_path_by_child，adjust_appendrel_attrs也可以adjust_appendrel_attrs_multilevel。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;继上篇&lt;a href=&quot;https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part3/&quot;&gt;学习PostgreSQL的FDW(#3)-其他函数说明 I&lt;/a&gt;，继续说说其余回调函数&lt;/p&gt;
&lt;h2 id=&quot;用于行锁
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
  </entry>
  
  <entry>
    <title>学习PostgreSQL的FDW(#3)-其他函数说明 I</title>
    <link href="https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part3/"/>
    <id>https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part3/</id>
    <published>2018-08-07T09:47:21.871Z</published>
    <updated>2018-08-09T08:17:19.893Z</updated>
    
    <content type="html"><![CDATA[<p>上两篇文章主要介绍了实现FDW的7个必须实现的扫描相关的回调函数，<a href="https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/">学习PostgreSQL的FDW(#1)</a>，<br><a href="https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part2/">学习PostgreSQL的FDW(#2)-源码跟踪</a>，这边就继续说说其余32个回调函数</p><h2 id="用于扫描外部连接的回调函数"><a href="#用于扫描外部连接的回调函数" class="headerlink" title="用于扫描外部连接的回调函数"></a>用于扫描外部连接的回调函数</h2><p>如果一个 FDW 支持远程执行外部连接（而不是先把两个表的数据取到本地然后做本地连接），它应该提供这个回调函数:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">GetForeignJoinPaths (PlannerInfo *root,</span><br><span class="line">                     RelOptInfo *joinrel,</span><br><span class="line">                     RelOptInfo *outerrel,</span><br><span class="line">                     RelOptInfo *innerrel,</span><br><span class="line">                     JoinType jointype,</span><br><span class="line">                     JoinPathExtraData *extra);</span><br></pre></td></tr></table></figure></p><p>它为两个（或更多）同属于一台外部服务器的外部表的连接创建可能的访问路径。这个可选的函数会在查询规划过程中被调用。和<code>GetForeignPaths</code>一样，这个函数应该为提供的joinrel生成ForeignPath路径，并且调用add_path把这些路径加入到该连接应该考虑的路径集合中。但是和<code>GetForeignPaths</code>不一样的是，不需要这个函数产生最少一个路径，因为涉及本地连接的路径总是可用的。</p><p>注意的是，对于相同的连接关系，将会重复调用此函数来生成内外关系的不同组合。FDW需要负责最小化其中重复的工作。</p><p>如果一个ForeignPath路径被选中用于该连接，它将在整个连接处理中存在，为其中的成分表和子连接产生的路径将不会被使用。后续对该连接路径的处理大部分和扫描单个外部表的路径一样。一点不同是ForeignScan计划节点的scanrelid应该被设置为零，因为它表示的不是单个关系，而是用ForeignScan节点的fs_relids属性来表示被连接的关系集合（fs_relids会被核心规划器代码自动设置，不需要由 FDW 填充）。另一点不同是，由于一个远程连接的列的列表无法在系统目录中找到，FDW必须用一个合适的TargetEntry节点列表来填充fdw_scan_tlist，表示运行时它返回的元组中提供的列的集合。</p><h2 id="用于规划扫描-连接-后处理的回调函数"><a href="#用于规划扫描-连接-后处理的回调函数" class="headerlink" title="用于规划扫描/连接 后处理的回调函数"></a>用于规划扫描/连接 后处理的回调函数</h2><p>如果一个FDW支持执行远程的扫描/连接 后处理，例如远程聚集，应该事先这个回调函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">GetForeignUpperPaths(PlannerInfo *root,</span><br><span class="line">                     UpperRelationKind stage,</span><br><span class="line">                     RelOptInfo *input_rel,</span><br><span class="line">                     RelOptInfo *output_rel,</span><br><span class="line">                     <span class="keyword">void</span> *extra);</span><br></pre></td></tr></table></figure></p><p>为<em>上层关系</em>处理创建可能的访问路径，这是规划器针对所有扫描/连接后查询处理的术语，例如聚集、窗口函数、排序和表更新。在查询规划期间会调用这个可选的函数。当前，只有当该查询中涉及的所有基本关系都属于同一个 FDW 时才会调用这个函数。这个函数应该让 FDW 知道如何远程执行的任何扫描/连接 后处理生成ForeignPath路径，并且调用add_path把这些路径加入到上层关系中。就GetForeignJoinPaths来说，并不要求这个函数在创建任何路径时都能成功，因为涉及本地处理的路径总是可行的。</p><p>stage参数表示当前正在考虑的是哪一个扫描/连接后处理步骤。output_rel是接收表示这一个步骤的路径的上层关系，而input_rel是表示这个步骤输入的关系。extra参数提供了其他详细信息。目前，它仅能设置成UPPERREL_PARTIAL_GROUP_AGG或UPPERREL_GROUP_AGG，在这种情况下，它指向的是GroupPathExtraData结构体。（注意被加入到output_rel中的ForeignPath路径通常对input_rel的路径没有直接的依赖，因为它们的处理被认为是在外部处理的。不过，检查为前一个处理步骤生成的路径有助于避免冗余的规划工作）。</p><p>使用gdb追踪调用情况<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b postgresGetForeignUpperPaths</span><br><span class="line">Breakpoint 1 at 0x7f2cea563a20: file postgres_fdw.c, line 5437.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, postgresGetForeignUpperPaths (root=0xf7ce50, stage=UPPERREL_GROUP_AGG, </span><br><span class="line">    input_rel=0xf7d3d0, output_rel=0x1063910, extra=0x7ffc84ff94e0) at postgres_fdw.c:5437</span><br><span class="line">5437<span class="keyword">if</span> (!input_rel-&gt;fdw_private ||</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresGetForeignUpperPaths (root=0xf7ce50, stage=UPPERREL_GROUP_AGG, input_rel=0xf7d3d0, output_rel=0x1063910, extra=0x7ffc84ff94e0) at postgres_fdw.c:5437</span></span><br><span class="line"><span class="comment">#1  0x00000000006807bf in create_ordinary_grouping_paths (root=root@entry=0xf7ce50, input_rel=input_rel@entry=0xf7d3d0, grouped_rel=grouped_rel@entry=0x1063910, agg_costs=agg_costs@entry=0x7ffc84ff94b0, gd=gd@entry=0x0, extra=extra@entry=0x7ffc84ff94e0, partially_grouped_rel_p=partially_grouped_rel_p@entry=0x7ffc84ff9488) at planner.c:4059</span></span><br><span class="line"><span class="comment">#2  0x00000000006831e9 in create_grouping_paths (gd=0x0, agg_costs=0x7ffc84ff94b0, target_parallel_safe=true, target=0x1063768, input_rel=0xf7d3d0, root=0xf7ce50) at planner.c:3783</span></span><br><span class="line"><span class="comment">#3  grouping_planner (root=root@entry=0xf7ce50, inheritance_update=inheritance_update@entry=false, tuple_fraction=&lt;optimized out&gt;, tuple_fraction@entry=0) at planner.c:2037</span></span><br><span class="line"><span class="comment">#4  0x0000000000684218 in subquery_planner (glob=glob@entry=0xf7cdc0, parse=parse@entry=0xf7c6a8, parent_root=parent_root@entry=0x0, hasRecursion=hasRecursion@entry=false, tuple_fraction=tuple_fraction@entry=0) at planner.c:966</span></span><br><span class="line"><span class="comment">#5  0x0000000000685236 in standard_planner (parse=0xf7c6a8, cursorOptions=256, boundParams=0x0) at planner.c:405</span></span><br><span class="line"><span class="comment">#6  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0xf7c6a8, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#7  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#8  0x0000000000721cda in exec_simple_query (query_string=0xf7b810 "select count(*) from t_fdw ;") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0xfa5528, dbname=0xfa5410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0xf9d3f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0xf9d3f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0xf763c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0xf763c0) at main.c:228</span></span><br></pre></td></tr></table></figure></p><h2 id="更新外部表的回调函数"><a href="#更新外部表的回调函数" class="headerlink" title="更新外部表的回调函数"></a>更新外部表的回调函数</h2><table><thead><tr><th style="text-align:left">回调函数</th><th style="text-align:left">作用</th></tr></thead><tbody><tr><td style="text-align:left">AddForeignUpdateTargets</td><td style="text-align:left">保证FDW能够找到要更新或删除的准确行</td></tr><tr><td style="text-align:left">PlanForeignModify</td><td style="text-align:left">执行外部表上插入、更新或删除所需的任何附加规划动作</td></tr><tr><td style="text-align:left">BeginForeignModify</td><td style="text-align:left">开始执行一个外部表修改操作，执行任何先于实际表修改的初始化工作</td></tr><tr><td style="text-align:left">ExecForeignInsert</td><td style="text-align:left">插入一个元组到外部表</td></tr><tr><td style="text-align:left">ExecForeignUpdate</td><td style="text-align:left">更新外部表中的一个元组</td></tr><tr><td style="text-align:left">ExecForeignDelete</td><td style="text-align:left">从外部表删除一个元组</td></tr><tr><td style="text-align:left">EndForeignModify</td><td style="text-align:left">结束表更新并释放资源</td></tr><tr><td style="text-align:left">BeginForeignInsert</td><td style="text-align:left">开始在外表上执行插入操作(分区表或COPY FROM命令)，在实际插入之前执行所需的任何初始化</td></tr><tr><td style="text-align:left">EndForeignInsert</td><td style="text-align:left">结束表插入并释放资源(分区表或COPY FROM命令)</td></tr><tr><td style="text-align:left">IsForeignRelUpdatable</td><td style="text-align:left">报告指定的外部表支持哪些更新操作</td></tr><tr><td style="text-align:left">PlanDirectModify</td><td style="text-align:left">决定在远程服务器上执行直接修改是否安全</td></tr><tr><td style="text-align:left">BeginDirectModify</td><td style="text-align:left">准备在远程服务器上执行一次直接修改，执行直接修改所需的任何初始化工作</td></tr><tr><td style="text-align:left">IterateDirectModify</td><td style="text-align:left">执行直接修改操作</td></tr><tr><td style="text-align:left">EndDirectModify</td><td style="text-align:left">在远程服务器上的直接修改后进行清理</td></tr></tbody></table><p><br><br>如果一个FDW支持可写的外部表，根据FDW的需要和功能，应该提供以下某些或者全部回调函数：</p><ul><li>AddForeignUpdateTargets  </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">AddForeignUpdateTargets(Query *parsetree,</span><br><span class="line">                        RangeTblEntry *target_rte,</span><br><span class="line">                        Relation target_relation);</span><br></pre></td></tr></table></figure><p>UPDATE和DELETE操作是在之前由表扫描函数取出的行上被执行的。FDW可能需要额外的信息（例如一个行ID或主键列的值）来保证它能够找到要更新或删除的准确行。要支持这些要求，这个函数可以向列列表中增加额外的隐藏或“junk”的目标列，它们在一个UPDATE或DELETE期间会被从外部表中获取。</p><p>要做到这一点，向parsetree-&gt;targetList中增加TargetEntry项，它们包含要被获取的额外值的表达式。每一个这样的项必须被标记为resjunk = true，并且必须有一个可区分的resname用于在执行期间标识它。请避免使用匹配ctidN、wholerow或wholerowN的名字，因为核心系统可能会生成使用这些名字的junk列。如果额外的表达式比简单的Vars更复杂，在将它们添加到目标列表之前，必须通过eval_const_expressions运行它们。</p><p>这个函数在重写器中被调用，而不是在规划器中，因此可用的信息与在规划例程中的有点区别。parsetree是UPDATE或DELETE命令的分析树，而target_rte和target_relation描述目标外部表。</p><p>如果<code>AddForeignUpdateTargets</code>指针被设置为NULL，则不会有额外的目标表达式被加入（这将使得我们不可能实现DELETE操作，而UPDATE则还有可能是可行的，前提是FDW依赖一个未改变的主键来标识行）。</p><ul><li>PlanForeignModify  </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List *</span><br><span class="line">PlanForeignModify(PlannerInfo *root,</span><br><span class="line">                  ModifyTable *plan,</span><br><span class="line">                  Index resultRelation,</span><br><span class="line">                  <span class="keyword">int</span> subplan_index);</span><br></pre></td></tr></table></figure><p>执行外部表上插入、更新或删除所需的任何附加规划动作。这个函数生成FDW私有信息，该信息将被附加到执行该更新动作的ModifyTable计划节点。这个私有信息的形式必须是一个List，并将会在执行阶段被传递给BeginForeignModify。</p><p>root是规划器关于该查询的全局信息。plan是ModifyTable计划节点，它除了fdwPrivLists属性之外是完整的。resultRelation通过目标外部表的范围表索引来标识它。subplan_index标识这是ModifyTable计划节点的哪个目标，从零开始计数；如果你希望索引到plan-&gt;plans或其他plan节点的子结构中，请使用它。</p><p>如果<code>PlanForeignModify</code>指针被设置为NULL，则不会有额外的计划时动作被执行，并且传递给BeginForeignModify的fdw_private列表也将为 NIL。</p><ul><li>BeginForeignModify  </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">BeginForeignModify (ModifyTableState *mtstate,</span><br><span class="line">                    ResultRelInfo *rinfo,</span><br><span class="line">                    List *fdw_private,</span><br><span class="line">                    <span class="keyword">int</span> subplan_index,</span><br><span class="line">                    <span class="keyword">int</span> eflags);</span><br></pre></td></tr></table></figure><p>开始执行一个外部表修改操作。这个函数在执行器启动期间被调用。它应该执行任何先于实际表修改的初始化工作。随后，<code>ExecForeignInsert</code>、<code>ExecForeignUpdate</code>或<code>ExecForeignDelete</code>将被为每一个将被插入、更新或删除的元组调用。</p><p>mtstate是要被执行的ModifyTable计划节点的状态信息；通过这个结构可以得到关于规划和执行阶段的全局数据。rinfo是描述目标外部表的ResultRelInfo结构（ResultRelInfo的ri_FdwState属性用于FDW来存储它在此操作中需要的任何私有状态）。fdw_private包含<code>PlanForeignModify</code>生成的私有数据。subplan_index标识这是ModifyTable计划节点的哪个目标。eflags包含描述执行器对该计划节点操作模式的标志位。</p><p>注意当(eflags &amp; EXEC_FLAG_EXPLAIN_ONLY)为真，这个函数不应执行任何外部可见的动作；它只应该做最少的工作来创建<code>ExplainForeignModify</code>和<code>EndForeignModify</code>可用的节点状态。</p><p>如果<code>BeginForeignModify</code>指针被设置为NULL，在执行器启动期间将不会采取任何动作。</p><ul><li>ExecForeignInsert</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">ExecForeignInsert(EState *estate,</span><br><span class="line">                  ResultRelInfo *rinfo,</span><br><span class="line">                  TupleTableSlot *slot,</span><br><span class="line">                  TupleTableSlot *planSlot);</span><br></pre></td></tr></table></figure><p>插入一个元组到外部表。estate是查询的全局执行状态。rinfo是描述目标外部表的ResultRelInfo结构。slot包含要被插入的元组；它将匹配外部表的行类型定义。planSlot包含由ModifyTable计划节点的子计划生成的元组；它与slot不同，它可能包含额外的“junk”列（INSERT情况通常不关心planSlot，但是为了完整性还是在这里提供它）。</p><p>返回值可以是一个包含实际被插入的数据的槽（这可能会和所提供的数据不同，例如一个触发器动作的结果），或者为 NULL 表示实际没有插入行（还是触发器的结果）。被传入的slot可以被重用于这个目的。</p><p>在返回槽中的数据只有在INSERT查询具有一个RETURNING子句或者外部表具有一个AFTER ROW触发器时才被使用。触发器要求所有的列，但是 FDW 应该选择优化成根据RETURNING子句的内容返回某些或全部列。不管怎样，某些槽必须被返回来指示成功，否则查询报告的行计数将会是错误的。</p><p>如果<code>ExecForeignInsert</code>指针被设置为NULL，尝试向外部表插入将会失败并报告一个错误消息。</p><ul><li>ExecForeignUpdate</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">ExecForeignUpdate(EState *estate,</span><br><span class="line">                  ResultRelInfo *rinfo,</span><br><span class="line">                  TupleTableSlot *slot,</span><br><span class="line">                  TupleTableSlot *planSlot);</span><br></pre></td></tr></table></figure><p>更新外部表中的一个元组。estate是查询的全局执行状态。rinfo是描述目标外部表的ResultRelInfo结构。slot包含元组的新数据；它将匹配外部表的行类型定义。planSlot包含由ModifyTable计划节点的子计划生成的元组；它与slot不同，它可能包含额外的“junk”列。特殊地，任何<code>AddForeignUpdateTargets</code>所要求的junk列在这个槽中都是有效的。</p><p>返回值可以是一个包含实际被更新的数据的槽（这可能会和所提供的数据不同，例如一个触发器动作的结果），或者为 NULL 表示实际没有更新行（还是触发器的结果）。被传入的slot可以被重用于这个目的。</p><p>在返回槽中的数据只有在UPDATE查询具有一个RETURNING子句或者外部表具有一个AFTER ROW触发器时才被使用。触发器要求所有的列，但是 FDW 应该选择优化成根据RETURNING子句的内容返回某些或全部列。不管怎样，某些槽必须被返回来指示成功，否则查询报告的行计数将会是错误的。</p><p>如果<code>ExecForeignUpdate</code>指针被设置为NULL，尝试更新外部表将会失败并报告一个错误消息。</p><ul><li>ExecForeignDelete </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">ExecForeignDelete(EState *estate,</span><br><span class="line">                  ResultRelInfo *rinfo,</span><br><span class="line">                  TupleTableSlot *slot,</span><br><span class="line">                  TupleTableSlot *planSlot);</span><br></pre></td></tr></table></figure><p>从外部表删除一个元组。estate是查询的全局执行状态。rinfo是描述目标外部表的ResultRelInfo结构。slot在调用时不包含任何有用的东西，但是可以被用于保持被返回的元组。planSlot包含由ModifyTable计划节点的子计划生成的元组；特殊地，它将携带AddForeignUpdateTargets所要求的任意junk列。junk列被用来标识要被删除的元组。</p><p>返回值可以是一个包含实际被删除的数据的槽，或者为 NULL 表示实际没有删除行（还是触发器的结果）。被传入的slot可以被重用于这个目的。</p><p>在返回槽中的数据只有在DELETE查询具有一个RETURNING子句或者外部表具有一个AFTER ROW触发器时才被使用。触发器要求所有的列，但是 FDW 应该选择优化成根据RETURNING子句的内容返回某些或全部列。不管怎样，某些槽必须被返回来指示成功，否则查询报告的行计数将会是错误的。</p><p>如果<code>ExecForeignDelete</code>指针被设置为NULL，尝试从外部表中删除将会失败并报告一个错误消息。</p><ul><li>EndForeignModify</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">EndForeignModify(EState *estate,</span><br><span class="line">                 ResultRelInfo *rinfo);</span><br></pre></td></tr></table></figure><p>结束表更新并释放资源。通常释放palloc的内存并不重要，但是打开的文件和到远程服务器的连接等应当被清除。</p><p>如果<code>EndForeignModify</code>指针被设置为NULL，在执行器关闭期间不会采取任何动作。</p><p><br><br>通过INSERT或COPY FROM插入分区表的元组将路由到分区。如果FDW支持可路由的外表分区，它还应提供以下回调函数。在外部表上执行COPY FROM时也会调用这些函数：</p><ul><li>BeginForeignInsert</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">BeginForeignInsert(ModifyTableState *mtstate,</span><br><span class="line">                   ResultRelInfo *rinfo);</span><br></pre></td></tr></table></figure><p>开始在外表上执行插入操作。在将第一个元组插入到外表中之前，当它是为元组路由选择的分区和在COPY FROM命令中指定的目标时，就会调用此例程。它应该在实际插入之前执行所需的任何初始化。随后，将调用<code>ExecForeignInsert</code>以将每个元组插入到外表中。</p><p>mtstate是要被执行的ModifyTable计划节点的状态信息；通过这个结构可以得到关于规划和执行阶段的全局数据。rinfo是描述目标外部表的ResultRelInfo结构（ResultRelInfo的ri_FdwState属性用于FDW来存储它在此操作中需要的任何私有状态）。</p><p>当通过COPY FROM命令调用此方法时，不提供mtstate中与计划相关的全局数据，并且随后为每个插入的元组调用的<code>ExecForeignInsert</code>的planSlot参数为NULL，无论外表是为元组路由选择的分区还是在命令中指定的目标。</p><p>如果<code>BeginForeignInsert</code>指针设置为NULL，则不会对初始化执行任何操作。</p><ul><li>EndForeignInsert</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">EndForeignInsert(EState *estate,</span><br><span class="line">                 ResultRelInfo *rinfo);</span><br></pre></td></tr></table></figure><p>结束表插入并释放资源。通常释放palloc的内存并不重要，但是打开的文件和到远程服务器的连接等应当被清除。</p><p>如果<code>EndForeignInsert</code>指针被设置为NULL，在执行器关闭期间不会采取任何动作。</p><p><br></p><ul><li>IsForeignRelUpdatable</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">IsForeignRelUpdatable(Relation rel);</span><br></pre></td></tr></table></figure><p>报告指定的外部表支持哪些更新操作。返回值应该是一个规则事件编号的位掩码，它指示了哪些操作被外部表支持，它使用CmdType枚举，即：(1 &lt;&lt; CMD_UPDATE) = 4表示UPDATE、 (1 &lt;&lt; CMD_INSERT) = 8表示INSERT以及 (1 &lt;&lt; CMD_DELETE) = 16表示DELETE。</p><p>如果<code>IsForeignRelUpdatable</code>指针被设置为NULL，而FDW提供了<code>ExecForeignInsert</code>、<code>ExecForeignUpdate</code>或<code>ExecForeignDelete</code>，则外部表分别被假定为可插入、可更新或可删除。</p><p><br><br>一些对于外部表的插入、更新和删除可以通过实现另一组接口来优化。普通的插入、更新和删除接口会从远程服务器取得行，然后一次修改其中一行。在某些情况下，这种逐行的方式是必要的，但是可能效率不高。如果有可能让外部服务器判断哪些行可以直接修改而无需先检索它们并且没有本地触发器会影响该操作，那么可以让整个操作在远程服务器上执行。下面介绍的接口能让这种做法变成可能。</p><ul><li>PlanDirectModify</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span></span><br><span class="line">PlanDirectModify(PlannerInfo *root,</span><br><span class="line">                 ModifyTable *plan,</span><br><span class="line">                 Index resultRelation,</span><br><span class="line">                 <span class="keyword">int</span> subplan_index);</span><br></pre></td></tr></table></figure><p>决定在远程服务器上执行直接修改是否安全。如果安全，执行所需的规划动作然后返回true,否则返回false。这个可选的函数在查询规划期间被调用。如果这个函数成功，在执行阶段将会调用<code>BeginDirectModify</code>、<code>IterateDirectModify</code>和<code>EndDirectModify</code>。否则，对表的修改将采用上文描述的表更新函数来执行。参数和<code>PlanForeignModify</code>的相同。</p><p>要在远程服务器上执行直接修改，这个函数必须用一个ForeignScan计划节点（它在远程服务器上执行直接修改）重写目标子计划。ForeignScan的operation域必须被合适地设置为CmdType枚举值，即CMD_UPDATE表示UPDATE、CMD_INSERT表示INSERT而CMD_DELETE表示DELETE。</p><p>如果<code>PlanDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p><ul><li>BeginDirectModify </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">BeginDirectModify(ForeignScanState *node,</span><br><span class="line">                  <span class="keyword">int</span> eflags);</span><br></pre></td></tr></table></figure><p>准备在远程服务器上执行一次直接修改。这个函数会在执行器启动时被调用。它应该执行直接修改所需的任何初始化工作（应该在第一次<code>IterateDirectModify</code>调用之前完成）。ForeignScanState节点已经被创建，但是它的fdw_state属性仍然为 NULL。有关要被修改的表的信息可以访问ForeignScanState节点（具体地，从底层的ForeignScan计划节点，它包含了PlanDirectModify提供的 FDW-私有信息）。eflags包含描述执行器对于这个计划节点操作模式的标志位。</p><p>注意当(eflags &amp; EXEC_FLAG_EXPLAIN_ONLY)为真时，这个函数不应该执行任何外部可见的动作。它应当只做最少的工作让该节点状态对<code>ExplainDirectModify</code>和<code>EndDirectModify</code>有效。</p><p>如果<code>BeginDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p><ul><li>IterateDirectModify</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">IterateDirectModify(ForeignScanState *node);</span><br></pre></td></tr></table></figure><p>当INSERT、UPDATE或者DELETE查询没有RETURNING子句时，完成远程服务器上的直接修改后返回 NULL。当查询有该子句时，取出一个包含RETURNING计算所需数据的结果，用一个元组表槽返回它（节点的ScanTupleSlot应被用于这一目的）。实际被插入、更新或者删除的数据必须被存储在该节点的EState的es_result_relation_info-&gt;ri_projectReturning-&gt;pi_exprContext-&gt;ecxt_scantuple中。如果没有更多行可用，则返回 NULL。注意这个函数会在一个短期生存的内存上下文中被调用，该上下文会在两次调用之间被重置。如果需要一个长期存在的存储，可以在<code>BeginDirectModify</code>中创建一个内存上下文，或者使用该节点的EState中的es_query_cxt。</p><p>如果提供了fdw_scan_tlist目标列表，则被返回的行必须匹配它。否则，被返回的行必须匹配被更新的外部表的行类型。如果选择优化掉RETURNING计算不需要的列，应该在这些列的位置上插入空值，或者生成一个忽略这些列的fdw_scan_tlist列表。</p><p>不管该查询是否具有RETURNING子句，查询所报告的行计数必须由 FDW 本身增加。当查询没有该子句时，FDW 还必须为EXPLAIN ANALYZE情况下的ForeignScanState节点增加行计数。</p><p>如果<code>IterateDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p><ul><li>EndDirectModify </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">EndDirectModify(ForeignScanState *node);</span><br></pre></td></tr></table></figure><p>在远程服务器上的直接修改后进行清理。通常释放用 palloc 分配的内存并不重要，但是诸如打开的文件和到远程服务器的连接应该被清除。</p><p>如果<code>EndDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p><p><br><br><br><br>在外部表插入一条数据<code>insert into t_fdw values(11,&#39;1&#39;,&#39;2&#39;);</code><br>执行insert语句的调用顺序<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180809144759.png" alt=""></p><p>使用gdb追踪<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b postgresAddForeignUpdateTargets</span><br><span class="line">Breakpoint 1 at 0x7fee88320260: file postgres_fdw.c, line 1541.</span><br><span class="line">(gdb) b postgresPlanForeignModify</span><br><span class="line">Breakpoint 2 at 0x7fee883203a0: file postgres_fdw.c, line 1579.</span><br><span class="line">(gdb) b postgresBeginForeignModify</span><br><span class="line">Breakpoint 3 at 0x7fee88321e20: file postgres_fdw.c, line 1698.</span><br><span class="line">(gdb) b postgresExecForeignInsert</span><br><span class="line">Breakpoint 4 at 0x7fee88323000: file postgres_fdw.c, line 1750.</span><br><span class="line">(gdb) b postgresExecForeignUpdate</span><br><span class="line">Breakpoint 5 at 0x7fee88322e40: file postgres_fdw.c, line 1814.</span><br><span class="line">(gdb) b postgresExecForeignDelete</span><br><span class="line">Breakpoint 6 at 0x7fee88322c80: file postgres_fdw.c, line 1890.</span><br><span class="line">(gdb) b postgresEndForeignModify</span><br><span class="line">Breakpoint 7 at 0x7fee88321010: file postgres_fdw.c, line 1965.</span><br><span class="line">(gdb) b postgresBeginForeignInsert</span><br><span class="line">Breakpoint 8 at 0x7fee88321c10: file postgres_fdw.c, line 1982.</span><br><span class="line">(gdb) b postgresEndForeignInsert</span><br><span class="line">Breakpoint 9 at 0x7fee88320ff0: file postgres_fdw.c, line 2074.</span><br><span class="line">(gdb) b postgresIsForeignRelUpdatable</span><br><span class="line">Breakpoint 10 at 0x7fee8831e900: file postgres_fdw.c, line 2089.</span><br><span class="line">(gdb) b postgresPlanDirectModify</span><br><span class="line">Breakpoint 11 at 0x7fee883213b0: file postgres_fdw.c, line 2167.</span><br><span class="line">(gdb) b postgresBeginDirectModify</span><br><span class="line">Breakpoint 12 at 0x7fee8831fd80: file postgres_fdw.c, line 2360.</span><br><span class="line">(gdb) b postgresIterateDirectModify</span><br><span class="line">Breakpoint 13 at 0x7fee883227f0: file postgres_fdw.c, line 2479.</span><br><span class="line">(gdb) b postgresEndDirectModify</span><br><span class="line">Breakpoint 14 at 0x7fee8831fb60: file postgres_fdw.c, line 2523.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换至psql，执行插入语句</span></span><br><span class="line">fdw=<span class="comment"># insert into t_fdw values(11,'1','2');</span></span><br><span class="line"><span class="comment"># （挂起）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换回gdb</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 11, postgresPlanDirectModify (root=0x2113f08, plan=0x2115680, resultRelation=1, </span><br><span class="line">    subplan_index=0) at postgres_fdw.c:2167</span><br><span class="line">2167&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresPlanDirectModify (root=0x2113f08, plan=0x2115680, resultRelation=1, subplan_index=0) at postgres_fdw.c:2167</span></span><br><span class="line"><span class="comment">#1  0x00000000006790a1 in make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;) at createplan.c:6680</span></span><br><span class="line"><span class="comment">#2  create_modifytable_plan (best_path=0x20635e0, root=&lt;optimized out&gt;) at createplan.c:2479</span></span><br><span class="line"><span class="comment">#3  create_plan_recurse (root=root@entry=0x2113f08, best_path=0x20635e0, flags=flags@entry=1) at createplan.c:492</span></span><br><span class="line"><span class="comment">#4  0x0000000000679dc9 in create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;) at createplan.c:327</span></span><br><span class="line"><span class="comment">#5  0x0000000000685264 in standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0) at planner.c:412</span></span><br><span class="line"><span class="comment">#6  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x20636f0, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#7  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#8  0x0000000000721cda in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(11,'1','2');") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0)</span></span><br><span class="line">    at postmaster.c:1379</span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresPlanDirectModify (root=0x2113f08, plan=0x2115680, </span></span><br><span class="line">    resultRelation=1, subplan_index=0) at postgres_fdw.c:2167</span><br><span class="line">make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, </span><br><span class="line">    rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6681</span><br><span class="line">6681<span class="keyword">if</span> (direct_modify)</span><br><span class="line">Value returned is <span class="variable">$15</span> = <span class="literal">false</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, </span></span><br><span class="line">    rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6681</span><br><span class="line"></span><br><span class="line">Breakpoint 2, postgresPlanForeignModify (root=0x2113f08, plan=plan@entry=0x2115680, </span><br><span class="line">    resultRelation=1, subplan_index=subplan_index@entry=0) at postgres_fdw.c:1579</span><br><span class="line">1579&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresPlanForeignModify (root=0x2113f08, plan=plan@entry=0x2115680, resultRelation=1, subplan_index=subplan_index@entry=0) at postgres_fdw.c:1579</span></span><br><span class="line"><span class="comment">#1  0x0000000000677001 in make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;) at createplan.c:6687</span></span><br><span class="line"><span class="comment">#2  create_modifytable_plan (best_path=0x20635e0, root=&lt;optimized out&gt;) at createplan.c:2479</span></span><br><span class="line"><span class="comment">#3  create_plan_recurse (root=root@entry=0x2113f08, best_path=0x20635e0, flags=flags@entry=1) at createplan.c:492</span></span><br><span class="line"><span class="comment">#4  0x0000000000679dc9 in create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;) at createplan.c:327</span></span><br><span class="line"><span class="comment">#5  0x0000000000685264 in standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0) at planner.c:412</span></span><br><span class="line"><span class="comment">#6  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x20636f0, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#7  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#8  0x0000000000721cda in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresPlanForeignModify (root=0x2113f08, plan=plan@entry=0x2115680, </span></span><br><span class="line">    resultRelation=1, subplan_index=subplan_index@entry=0) at postgres_fdw.c:1579</span><br><span class="line">0x0000000000677001 <span class="keyword">in</span> make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, </span><br><span class="line">    rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6687</span><br><span class="line">6687fdw_private = fdwroutine-&gt;PlanForeignModify(subroot, node, rti, i);</span><br><span class="line">Value returned is <span class="variable">$16</span> = (List *) 0x218b810</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000677001 in make_modifytable (epqParam=&lt;optimized out&gt;, </span></span><br><span class="line">    onconflict=&lt;optimized out&gt;, rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6687</span><br><span class="line">create_plan_recurse (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;, flags=flags@entry=1)</span><br><span class="line">    at createplan.c:492</span><br><span class="line">492plan = (Plan *) create_modifytable_plan(root,</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_plan_recurse (root=root@entry=0x2113f08, </span></span><br><span class="line">    best_path=&lt;optimized out&gt;, flags=flags@entry=1) at createplan.c:492</span><br><span class="line">create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;) at createplan.c:336</span><br><span class="line">336<span class="keyword">if</span> (!IsA(plan, ModifyTable))</span><br><span class="line">Value returned is <span class="variable">$17</span> = (Plan *) 0x2115680</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;)</span></span><br><span class="line">    at createplan.c:336</span><br><span class="line">standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0) at planner.c:418</span><br><span class="line">418<span class="keyword">if</span> (cursorOptions &amp; CURSOR_OPT_SCROLL)</span><br><span class="line">Value returned is <span class="variable">$18</span> = (Plan *) 0x2115680</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0)</span></span><br><span class="line">    at planner.c:418</span><br><span class="line">pg_plan_query (querytree=querytree@entry=0x20636f0, cursorOptions=cursorOptions@entry=256, </span><br><span class="line">    boundParams=boundParams@entry=0x0) at postgres.c:811</span><br><span class="line">811<span class="keyword">if</span> (log_planner_stats)</span><br><span class="line">Value returned is <span class="variable">$19</span> = (PlannedStmt *) 0x218bb60</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  pg_plan_query (querytree=querytree@entry=0x20636f0, </span></span><br><span class="line">    cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:811</span><br><span class="line">0x000000000072186e <span class="keyword">in</span> pg_plan_queries (querytrees=&lt;optimized out&gt;, </span><br><span class="line">    cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span><br><span class="line">875stmt = pg_plan_query(query, cursorOptions, boundParams);</span><br><span class="line">Value returned is <span class="variable">$20</span> = (PlannedStmt *) 0x218bb60</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, </span></span><br><span class="line">    cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span><br><span class="line">0x0000000000721cda <span class="keyword">in</span> exec_simple_query (</span><br><span class="line">    query_string=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>) at postgres.c:1050</span><br><span class="line">1050plantree_list = pg_plan_queries(querytree_list,</span><br><span class="line">Value returned is <span class="variable">$21</span> = (List *) 0x218bc90</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000721cda in exec_simple_query (</span></span><br><span class="line">    query_string=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>) at postgres.c:1050</span><br><span class="line"></span><br><span class="line">Breakpoint 10, postgresIsForeignRelUpdatable (rel=0x7feed1ad1358) at postgres_fdw.c:2089</span><br><span class="line">2089&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresIsForeignRelUpdatable (rel=0x7feed1ad1358) at postgres_fdw.c:2089</span></span><br><span class="line"><span class="comment">#1  0x00000000005f0820 in CheckValidResultRel (resultRelInfo=resultRelInfo@entry=0x20885c0, operation=operation@entry=CMD_INSERT) at execMain.c:1187</span></span><br><span class="line"><span class="comment">#2  0x00000000006123a8 in ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2242</span></span><br><span class="line"><span class="comment">#3  0x00000000005f6838 in ExecInitNode (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at execProcnode.c:174</span></span><br><span class="line"><span class="comment">#4  0x00000000005f11c5 in InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1049</span></span><br><span class="line"><span class="comment">#5  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=0) at execMain.c:264</span></span><br><span class="line"><span class="comment">#6  0x0000000000724d26 in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(12,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "") at pquery.c:156</span></span><br><span class="line"><span class="comment">#7  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#8  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:799</span></span><br><span class="line"><span class="comment">#9  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#10 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#11 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#12 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#13 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#14 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#15 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresIsForeignRelUpdatable (rel=0x7feed1ad1358) at postgres_fdw.c:2089</span></span><br><span class="line">CheckValidResultRel (resultRelInfo=resultRelInfo@entry=0x20885c0, </span><br><span class="line">    operation=operation@entry=CMD_INSERT) at execMain.c:1186</span><br><span class="line">1186<span class="keyword">if</span> (fdwroutine-&gt;IsForeignRelUpdatable != NULL &amp;&amp;</span><br><span class="line">Value returned is <span class="variable">$22</span> = 28</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  CheckValidResultRel (resultRelInfo=resultRelInfo@entry=0x20885c0, </span></span><br><span class="line">    operation=operation@entry=CMD_INSERT) at execMain.c:1186</span><br><span class="line">ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, </span><br><span class="line">    eflags=eflags@entry=0) at nodeModifyTable.c:2253</span><br><span class="line">2253<span class="keyword">if</span> (resultRelInfo-&gt;ri_RelationDesc-&gt;rd_rel-&gt;relhasindex &amp;&amp;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecInitModifyTable (node=node@entry=0x2115680, </span></span><br><span class="line">    estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2253</span><br><span class="line"></span><br><span class="line">Breakpoint 3, postgresBeginForeignModify (mtstate=0x20888e0, resultRelInfo=0x20885c0, </span><br><span class="line">    fdw_private=0x218b810, subplan_index=0, eflags=0) at postgres_fdw.c:1698</span><br><span class="line">1698&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresBeginForeignModify (mtstate=0x20888e0, resultRelInfo=0x20885c0, fdw_private=0x218b810, subplan_index=0, eflags=0) at postgres_fdw.c:1698</span></span><br><span class="line"><span class="comment">#1  0x0000000000612458 in ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2280</span></span><br><span class="line"><span class="comment">#2  0x00000000005f6838 in ExecInitNode (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at execProcnode.c:174</span></span><br><span class="line"><span class="comment">#3  0x00000000005f11c5 in InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1049</span></span><br><span class="line"><span class="comment">#4  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=0) at execMain.c:264</span></span><br><span class="line"><span class="comment">#5  0x0000000000724d26 in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(13,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "") at pquery.c:156</span></span><br><span class="line"><span class="comment">#6  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#7  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:799</span></span><br><span class="line"><span class="comment">#8  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(13,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresBeginForeignModify (mtstate=0x20888e0, resultRelInfo=0x20885c0, </span></span><br><span class="line">    fdw_private=0x218b810, subplan_index=0, eflags=0) at postgres_fdw.c:1698</span><br><span class="line">ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, </span><br><span class="line">    eflags=eflags@entry=0) at nodeModifyTable.c:2231</span><br><span class="line">2231foreach(l, node-&gt;plans)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecInitModifyTable (node=node@entry=0x2115680, </span></span><br><span class="line">    estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2231</span><br><span class="line">0x00000000005f6838 <span class="keyword">in</span> ExecInitNode (node=node@entry=0x2115680, estate=estate@entry=0x2088380, </span><br><span class="line">    eflags=eflags@entry=0) at execProcnode.c:174</span><br><span class="line">174result = (PlanState *) ExecInitModifyTable((ModifyTable *) node,</span><br><span class="line">Value returned is <span class="variable">$23</span> = (ModifyTableState *) 0x20888e0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x00000000005f6838 in ExecInitNode (node=node@entry=0x2115680, </span></span><br><span class="line">    estate=estate@entry=0x2088380, eflags=eflags@entry=0) at execProcnode.c:174</span><br><span class="line">InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1054</span><br><span class="line">1054tupType = ExecGetResultType(planstate);</span><br><span class="line">Value returned is <span class="variable">$24</span> = (PlanState *) 0x20888e0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1054</span></span><br><span class="line">266MemoryContextSwitchTo(oldcontext);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=0)</span></span><br><span class="line">    at execMain.c:266</span><br><span class="line">ProcessQuery (plan=&lt;optimized out&gt;, </span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:161</span><br><span class="line">161ExecutorRun(queryDesc, ForwardScanDirection, 0L, <span class="literal">true</span>);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ProcessQuery (plan=&lt;optimized out&gt;, </span></span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:161</span><br><span class="line"></span><br><span class="line">Breakpoint 4, postgresExecForeignInsert (estate=0x2088380, resultRelInfo=0x20885c0, </span><br><span class="line">    slot=0x2089628, planSlot=0x2089628) at postgres_fdw.c:1750</span><br><span class="line">1750&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresExecForeignInsert (estate=0x2088380, resultRelInfo=0x20885c0, slot=0x2089628, planSlot=0x2089628) at postgres_fdw.c:1750</span></span><br><span class="line"><span class="comment">#1  0x0000000000610d8b in ExecInsert (mtstate=mtstate@entry=0x20888e0, slot=0x2089628, planSlot=planSlot@entry=0x2089628, estate=estate@entry=0x2088380, canSetTag=&lt;optimized out&gt;) at nodeModifyTable.c:346</span></span><br><span class="line"><span class="comment">#2  0x0000000000612119 in ExecModifyTable (pstate=0x20888e0) at nodeModifyTable.c:2126</span></span><br><span class="line"><span class="comment">#3  0x00000000005f000a in ExecProcNode (node=0x20888e0) at ../../../src/include/executor/executor.h:237</span></span><br><span class="line"><span class="comment">#4  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x218bcc0, direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=false, operation=CMD_INSERT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x20888e0, estate=0x2088380) at execMain.c:1726</span></span><br><span class="line"><span class="comment">#5  standard_ExecutorRun (queryDesc=0x21413a0, direction=&lt;optimized out&gt;, count=0, execute_once=&lt;optimized out&gt;) at execMain.c:363</span></span><br><span class="line"><span class="comment">#6  0x0000000000724d3a in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(12,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "") at pquery.c:161</span></span><br><span class="line"><span class="comment">#7  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#8  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:799</span></span><br><span class="line"><span class="comment">#9  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#10 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#11 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#12 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#13 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#14 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#15 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresExecForeignInsert (estate=0x2088380, resultRelInfo=0x20885c0, </span></span><br><span class="line">    slot=0x2089628, planSlot=0x2089628) at postgres_fdw.c:1750</span><br><span class="line">ExecInsert (mtstate=mtstate@entry=0x20888e0, slot=0x2089628, planSlot=planSlot@entry=0x2089628, </span><br><span class="line">    estate=estate@entry=0x2088380, canSetTag=&lt;optimized out&gt;) at nodeModifyTable.c:351</span><br><span class="line">351<span class="keyword">if</span> (slot == NULL)/* <span class="string">"do nothing"</span> */</span><br><span class="line">Value returned is <span class="variable">$25</span> = (TupleTableSlot *) 0x2089628</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecInsert (mtstate=mtstate@entry=0x20888e0, slot=0x2089628, </span></span><br><span class="line">    planSlot=planSlot@entry=0x2089628, estate=estate@entry=0x2088380, canSetTag=&lt;optimized out&gt;)</span><br><span class="line">    at nodeModifyTable.c:351</span><br><span class="line">0x0000000000612119 <span class="keyword">in</span> ExecModifyTable (pstate=0x20888e0) at nodeModifyTable.c:2126</span><br><span class="line">2126slot = ExecInsert(node, slot, planSlot,</span><br><span class="line">Value returned is <span class="variable">$26</span> = (TupleTableSlot *) 0x0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000612119 in ExecModifyTable (pstate=0x20888e0)</span></span><br><span class="line">    at nodeModifyTable.c:2126</span><br><span class="line">ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x218bcc0, direction=&lt;optimized out&gt;, </span><br><span class="line">    numberTuples=0, sendTuples=<span class="literal">false</span>, operation=CMD_INSERT, use_parallel_mode=&lt;optimized out&gt;, </span><br><span class="line">    planstate=0x20888e0, estate=0x2088380) at execMain.c:1732</span><br><span class="line">1732<span class="keyword">if</span> (TupIsNull(slot))</span><br><span class="line">Value returned is <span class="variable">$27</span> = (TupleTableSlot *) 0x0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x218bcc0, </span></span><br><span class="line">    direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=<span class="literal">false</span>, operation=CMD_INSERT, </span><br><span class="line">    use_parallel_mode=&lt;optimized out&gt;, planstate=0x20888e0, estate=0x2088380) at execMain.c:1732</span><br><span class="line">377<span class="keyword">if</span> (sendTuples)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorRun (queryDesc=0x21413a0, direction=&lt;optimized out&gt;, </span></span><br><span class="line">    count=0, execute_once=&lt;optimized out&gt;) at execMain.c:377</span><br><span class="line">ProcessQuery (plan=&lt;optimized out&gt;, </span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:166</span><br><span class="line">166<span class="keyword">if</span> (completionTag)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ProcessQuery (plan=&lt;optimized out&gt;, </span></span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:166</span><br><span class="line"></span><br><span class="line">Breakpoint 7, postgresEndForeignModify (estate=0x2088380, resultRelInfo=0x20885c0)</span><br><span class="line">    at postgres_fdw.c:1965</span><br><span class="line">1965PgFdwModifyState *fmstate = (PgFdwModifyState *) resultRelInfo-&gt;ri_FdwState;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresEndForeignModify (estate=0x2088380, resultRelInfo=0x20885c0) at postgres_fdw.c:1965</span></span><br><span class="line"><span class="comment">#1  0x0000000000612c7b in ExecEndModifyTable (node=0x20888e0) at nodeModifyTable.c:2664</span></span><br><span class="line"><span class="comment">#2  0x00000000005f16ad in ExecEndPlan (estate=0x2088380, planstate=&lt;optimized out&gt;) at execMain.c:1612</span></span><br><span class="line"><span class="comment">#3  standard_ExecutorEnd (queryDesc=0x21413a0) at execMain.c:495</span></span><br><span class="line"><span class="comment">#4  0x0000000000724d90 in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(12,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "INSERT 0 1") at pquery.c:206</span></span><br><span class="line"><span class="comment">#5  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "INSERT 0 1") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#6  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "INSERT 0 1") at pquery.c:799</span></span><br><span class="line"><span class="comment">#7  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#8  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#9  0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#10 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#11 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#12 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#13 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 后续执行结束</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>在外部表更新数据 <code>update t_fdw set c1=&#39;11&#39; where id=11;</code><br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180809152932.png" alt=""></p><p>在外部表删除数据，使用gdb跟踪调用流程，发现和update语句的流程是一样的，查看相关代码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * postgresIterateDirectModify</span></span><br><span class="line"><span class="comment"> *Execute a direct foreign table modification</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> TupleTableSlot *</span><br><span class="line">postgresIterateDirectModify(ForeignScanState *node)</span><br><span class="line">&#123;</span><br><span class="line">PgFdwDirectModifyState *dmstate = (PgFdwDirectModifyState *) node-&gt;fdw_state;</span><br><span class="line">EState   *estate = node-&gt;ss.ps.state;</span><br><span class="line">ResultRelInfo *resultRelInfo = estate-&gt;es_result_relation_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If this is the first call after Begin, execute the statement.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (dmstate-&gt;num_tuples == <span class="number">-1</span>)</span><br><span class="line">execute_dml_stmt(node);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If the local query doesn't specify RETURNING, just clear tuple slot.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!resultRelInfo-&gt;ri_projectReturning)</span><br><span class="line">&#123;</span><br><span class="line">TupleTableSlot *slot = node-&gt;ss.ss_ScanTupleSlot;</span><br><span class="line">Instrumentation *instr = node-&gt;ss.ps.instrument;</span><br><span class="line"></span><br><span class="line">Assert(!dmstate-&gt;has_returning);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Increment the command es_processed count if necessary. */</span></span><br><span class="line"><span class="keyword">if</span> (dmstate-&gt;set_processed)</span><br><span class="line">estate-&gt;es_processed += dmstate-&gt;num_tuples;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Increment the tuple count for EXPLAIN ANALYZE if necessary. */</span></span><br><span class="line"><span class="keyword">if</span> (instr)</span><br><span class="line">instr-&gt;tuplecount += dmstate-&gt;num_tuples;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ExecClearTuple(slot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Get the next RETURNING tuple.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">return</span> get_returning_data(node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Execute a direct UPDATE/DELETE statement.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">execute_dml_stmt(ForeignScanState *node)</span><br><span class="line">&#123;</span><br><span class="line">PgFdwDirectModifyState *dmstate = (PgFdwDirectModifyState *) node-&gt;fdw_state;</span><br><span class="line">ExprContext *econtext = node-&gt;ss.ps.ps_ExprContext;</span><br><span class="line"><span class="keyword">int</span>numParams = dmstate-&gt;numParams;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> **values = dmstate-&gt;param_values;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Construct array of query parameter values in text format.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (numParams &gt; <span class="number">0</span>)</span><br><span class="line">process_query_params(econtext,</span><br><span class="line"> dmstate-&gt;param_flinfo,</span><br><span class="line"> dmstate-&gt;param_exprs,</span><br><span class="line"> values);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Notice that we pass NULL for paramTypes, thus forcing the remote server</span></span><br><span class="line"><span class="comment"> * to infer types for all parameters.  Since we explicitly cast every</span></span><br><span class="line"><span class="comment"> * parameter (see deparse.c), the "inference" is trivial and will produce</span></span><br><span class="line"><span class="comment"> * the desired result.  This allows us to avoid assuming that the remote</span></span><br><span class="line"><span class="comment"> * server has the same OIDs we do for the parameters' types.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!PQsendQueryParams(dmstate-&gt;conn, dmstate-&gt;query, numParams,</span><br><span class="line">   <span class="literal">NULL</span>, values, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">pgfdw_report_error(ERROR, <span class="literal">NULL</span>, dmstate-&gt;conn, <span class="literal">false</span>, dmstate-&gt;query);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Get the result, and check for success.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We don't use a PG_TRY block here, so be careful not to throw error</span></span><br><span class="line"><span class="comment"> * without releasing the PGresult.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dmstate-&gt;result = pgfdw_get_result(dmstate-&gt;conn, dmstate-&gt;query);</span><br><span class="line"><span class="keyword">if</span> (PQresultStatus(dmstate-&gt;result) !=</span><br><span class="line">(dmstate-&gt;has_returning ? PGRES_TUPLES_OK : PGRES_COMMAND_OK))</span><br><span class="line">pgfdw_report_error(ERROR, dmstate-&gt;result, dmstate-&gt;conn, <span class="literal">true</span>,</span><br><span class="line">   dmstate-&gt;query);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get the number of rows affected. */</span></span><br><span class="line"><span class="keyword">if</span> (dmstate-&gt;has_returning)</span><br><span class="line">dmstate-&gt;num_tuples = PQntuples(dmstate-&gt;result);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">dmstate-&gt;num_tuples = atoi(PQcmdTuples(dmstate-&gt;result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到，<code>postgresIterateDirectModify</code> 调用了<code>execute_dml_stmt</code>执行直接UPDATE/DELETE语句的。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;上两篇文章主要介绍了实现FDW的7个必须实现的扫描相关的回调函数，&lt;a href=&quot;https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/&quot;&gt;学习PostgreSQL的FDW(#1)&lt;/a&gt;，&lt;br&gt;&lt;a href=
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
  </entry>
  
  <entry>
    <title>学习PostgreSQL的FDW(#2)-源码跟踪</title>
    <link href="https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part2/"/>
    <id>https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part2/</id>
    <published>2018-08-07T02:15:45.504Z</published>
    <updated>2018-08-07T17:14:59.861Z</updated>
    
    <content type="html"><![CDATA[<p>上篇大概介绍了FDW必须实现的7个回调函数<a href="https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/">学习PostgreSQL的FDW(#1)</a>，本篇将从源码跟踪，这7个回调函数的调用时机，以PostgreSQL11beta2的postgres_fdw为例，分析PostgreSQL在查询外部表时，究竟做了什么。</p><h2 id="测试前准备"><a href="#测试前准备" class="headerlink" title="测试前准备"></a>测试前准备</h2><p>IP为192.168.117.56的虚拟机安装了PostgreSQL10；<br>IP为192.168.118.56的虚拟机安装了PostgreSQL11beta2<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">testdb=# -- 在117.56中创建测试表</span><br><span class="line">testdb=# create table t_fdw(id int,c1 char(10),c2 varchar(10));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">2</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">3</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">4</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">5</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">6</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">7</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">8</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">9</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">10</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">fdw=# -- 在118.56中创建postgres_fdw扩展</span><br><span class="line">fdw=# create extension postgres_fdw ;</span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION</span><br><span class="line">fdw=# \dx;</span><br><span class="line">                               List of installed extensions</span><br><span class="line">     Name     | Version |   Schema   |                    Description                     </span><br><span class="line"><span class="comment">--------------+---------+------------+----------------------------------------------------</span></span><br><span class="line"> plpgsql      | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br><span class="line"> postgres_fdw | 1.0     | public     | foreign-data wrapper for remote PostgreSQL servers</span><br><span class="line">(2 rows)</span><br><span class="line">fdw=# -- 创建外部服务器</span><br><span class="line">fdw=# create server pg_117_56 foreign data wrapper postgres_fdw options (host '192.168.117.56',port '5432',dbname 'testdb');</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">SERVER</span></span><br><span class="line">fdw=# \des</span><br><span class="line">         <span class="keyword">List</span> <span class="keyword">of</span> foreign servers</span><br><span class="line">   <span class="keyword">Name</span>    | Owner | Foreign-<span class="keyword">data</span> wrapper </span><br><span class="line"><span class="comment">-----------+-------+----------------------</span></span><br><span class="line"> pg_117_56 | <span class="keyword">xdb</span>   | postgres_fdw</span><br><span class="line">(<span class="number">1</span> <span class="keyword">row</span>)</span><br><span class="line"></span><br><span class="line">fdw=# <span class="comment">--创建用户映射</span></span><br><span class="line">fdw=# <span class="keyword">create</span> <span class="keyword">user</span> <span class="keyword">MAPPING</span> <span class="keyword">FOR</span> <span class="keyword">PUBLIC</span> <span class="keyword">server</span> pg_117_56 options (<span class="keyword">user</span> <span class="string">'xdb'</span>,<span class="keyword">password</span> <span class="string">'test'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="keyword">MAPPING</span></span><br><span class="line">fdw=# \deu+</span><br><span class="line">                  <span class="keyword">List</span> <span class="keyword">of</span> <span class="keyword">user</span> mappings</span><br><span class="line">  <span class="keyword">Server</span>   | <span class="keyword">User</span> <span class="keyword">name</span> |           FDW options           </span><br><span class="line"><span class="comment">-----------+-----------+---------------------------------</span></span><br><span class="line"> pg_117_56 | <span class="keyword">public</span>    | (<span class="string">"user"</span> <span class="string">'xdb'</span>, <span class="keyword">password</span> <span class="string">'test'</span>)</span><br><span class="line">(<span class="number">1</span> <span class="keyword">row</span>)</span><br><span class="line">fdw=# <span class="comment">-- 创建外部表</span></span><br><span class="line"><span class="keyword">create</span> foreign <span class="keyword">table</span> t_fdw(<span class="keyword">id</span> <span class="built_in">int</span>, c1 <span class="built_in">char</span>(<span class="number">10</span>),c2 <span class="built_in">varchar</span>(<span class="number">10</span>)) <span class="keyword">server</span> pg_117_56 options(schema_name <span class="string">'public'</span>,table_name <span class="string">'t_fdw'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> FOREIGN <span class="keyword">TABLE</span></span><br><span class="line">fdw=# \d</span><br><span class="line">           <span class="keyword">List</span> <span class="keyword">of</span> relations</span><br><span class="line"> <span class="keyword">Schema</span> | <span class="keyword">Name</span>  |     <span class="keyword">Type</span>      | Owner </span><br><span class="line"><span class="comment">--------+-------+---------------+-------</span></span><br><span class="line"> <span class="keyword">public</span> | t_fdw | foreign <span class="keyword">table</span> | <span class="keyword">xdb</span></span><br><span class="line">(<span class="number">1</span> <span class="keyword">row</span>)</span><br></pre></td></tr></table></figure><h2 id="跟踪分析"><a href="#跟踪分析" class="headerlink" title="跟踪分析"></a>跟踪分析</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fdw=# select pg_backend_pid();</span><br><span class="line"> pg_backend_pid </span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line">           2382</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><p>使用gdb跟踪查询过程：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># gdb -p 2382</span></span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-110.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-redhat-linux-gnu"</span>.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Attaching to process 2382</span><br><span class="line">...</span><br><span class="line">(gdb) </span><br><span class="line"><span class="comment"># 设置断点</span></span><br><span class="line">(gdb) b postgresGetForeignRelSize</span><br><span class="line">Function <span class="string">"postgresGetForeignRelSize"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 1 (postgresGetForeignRelSize) pending.</span><br><span class="line">(gdb) b postgresGetForeignPaths</span><br><span class="line">Function <span class="string">"postgresGetForeignPaths"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 2 (postgresGetForeignPaths) pending.</span><br><span class="line">(gdb) b postgresGetForeignPlan</span><br><span class="line">Function <span class="string">"postgresGetForeignPlan"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 3 (postgresGetForeignPlan) pending.</span><br><span class="line">(gdb) b postgresBeginForeignScan</span><br><span class="line">Function <span class="string">"postgresBeginForeignScan"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 4 (postgresBeginForeignScan) pending.</span><br><span class="line">(gdb) b postgresIterateForeignScan</span><br><span class="line">Function <span class="string">"postgresIterateForeignScan"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 5 (postgresIterateForeignScan) pending.</span><br><span class="line">(gdb) b postgresReScanForeignScan</span><br><span class="line">Function <span class="string">"postgresReScanForeignScan"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 6 (postgresReScanForeignScan) pending.</span><br><span class="line">(gdb) b postgresEndForeignScan</span><br><span class="line">Function <span class="string">"postgresEndForeignScan"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 7 (postgresEndForeignScan) pending.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到psql，执行查询语句</span></span><br><span class="line">fdw=<span class="comment"># select * from t_fdw;</span></span><br><span class="line"><span class="comment"># （挂起状态）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换回gdb</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, postgresGetForeignRelSize (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:522</span><br><span class="line">522&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresGetForeignRelSize (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:522</span></span><br><span class="line"><span class="comment">#1  0x000000000065fde5 in set_foreign_size (rte=0x130f778, rel=0x13349e8, root=0x13342e8) at allpaths.c:839</span></span><br><span class="line"><span class="comment">#2  set_rel_size (root=root@entry=0x13342e8, rel=rel@entry=0x13349e8, rti=rti@entry=1, rte=0x130f778) at allpaths.c:351</span></span><br><span class="line"><span class="comment">#3  0x000000000066097d in set_base_rel_sizes (root=&lt;optimized out&gt;) at allpaths.c:281</span></span><br><span class="line"><span class="comment">#4  make_one_rel (root=root@entry=0x13342e8, joinlist=joinlist@entry=0x1334e50) at allpaths.c:179</span></span><br><span class="line"><span class="comment">#5  0x000000000067de9e in query_planner (root=root@entry=0x13342e8, tlist=tlist@entry=0x1334788, qp_callback=qp_callback@entry=0x67f290 &lt;standard_qp_callback&gt;, qp_extra=qp_extra@entry=0x7fff8c772f00) at planmain.c:259</span></span><br><span class="line"><span class="comment">#6  0x0000000000681f43 in grouping_planner (root=root@entry=0x13342e8, inheritance_update=inheritance_update@entry=false, tuple_fraction=&lt;optimized out&gt;, tuple_fraction@entry=0) at planner.c:1897</span></span><br><span class="line"><span class="comment">#7  0x0000000000684218 in subquery_planner (glob=glob@entry=0x130fc38, parse=parse@entry=0x130f668, parent_root=parent_root@entry=0x0, hasRecursion=hasRecursion@entry=false, tuple_fraction=tuple_fraction@entry=0) at planner.c:966</span></span><br><span class="line"><span class="comment">#8  0x0000000000685236 in standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:405</span></span><br><span class="line"><span class="comment">#9  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x130f668, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#10 0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#11 0x0000000000721cda in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#12 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#13 0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#14 BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#15 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#16 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#17 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line"></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresGetForeignRelSize (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:535</span></span><br><span class="line">set_foreign_size (rte=0x130f778, rel=0x13349e8, root=0x13342e8) at allpaths.c:842</span><br><span class="line">842rel-&gt;rows = clamp_row_est(rel-&gt;rows);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  set_foreign_size (rte=0x130f778, rel=0x13349e8, root=0x13342e8) at allpaths.c:842</span></span><br><span class="line">415&#125;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  set_rel_size (root=root@entry=0x13342e8, rel=rel@entry=0x13349e8, rti=rti@entry=1, rte=&lt;optimized out&gt;)</span></span><br><span class="line">    at allpaths.c:415</span><br><span class="line">set_base_rel_sizes (root=&lt;optimized out&gt;) at allpaths.c:253</span><br><span class="line">253<span class="keyword">for</span> (rti = 1; rti &lt; root-&gt;simple_rel_array_size; rti++)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  set_base_rel_sizes (root=&lt;optimized out&gt;) at allpaths.c:253</span></span><br><span class="line">180set_base_rel_pathlists(root);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  make_one_rel (root=root@entry=0x13342e8, joinlist=joinlist@entry=0x1334e50) at allpaths.c:180</span></span><br><span class="line"></span><br><span class="line">Breakpoint 2, postgresGetForeignPaths (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:921</span><br><span class="line">921&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresGetForeignPaths (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:921</span></span><br><span class="line"><span class="comment">#1  0x0000000000660452 in set_foreign_pathlist (rte=0x130f778, rel=0x13349e8, root=0x13342e8) at allpaths.c:853</span></span><br><span class="line"><span class="comment">#2  set_rel_pathlist (root=root@entry=0x13342e8, rel=0x13349e8, rti=rti@entry=1, rte=0x130f778) at allpaths.c:442</span></span><br><span class="line"><span class="comment">#3  0x0000000000660a30 in set_base_rel_pathlists (root=&lt;optimized out&gt;) at allpaths.c:310</span></span><br><span class="line"><span class="comment">#4  make_one_rel (root=root@entry=0x13342e8, joinlist=joinlist@entry=0x1334e50) at allpaths.c:180</span></span><br><span class="line"><span class="comment">#5  0x000000000067de9e in query_planner (root=root@entry=0x13342e8, tlist=tlist@entry=0x1334788, qp_callback=qp_callback@entry=0x67f290 &lt;standard_qp_callback&gt;, qp_extra=qp_extra@entry=0x7fff8c772f00) at planmain.c:259</span></span><br><span class="line"><span class="comment">#6  0x0000000000681f43 in grouping_planner (root=root@entry=0x13342e8, inheritance_update=inheritance_update@entry=false, tuple_fraction=&lt;optimized out&gt;, tuple_fraction@entry=0) at planner.c:1897</span></span><br><span class="line"><span class="comment">#7  0x0000000000684218 in subquery_planner (glob=glob@entry=0x130fc38, parse=parse@entry=0x130f668, parent_root=parent_root@entry=0x0, hasRecursion=hasRecursion@entry=false, tuple_fraction=tuple_fraction@entry=0) at planner.c:966</span></span><br><span class="line"><span class="comment">#8  0x0000000000685236 in standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:405</span></span><br><span class="line"><span class="comment">#9  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x130f668, cursorOptions=cursorOptions@entry=256,  boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#10 0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#11 0x0000000000721cda in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#12 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw",   username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#13 0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#14 BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#15 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#16 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#17 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresGetForeignPaths (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:921</span></span><br><span class="line">0x0000000000660452 <span class="keyword">in</span> set_foreign_pathlist (rte=0x130f778, rel=0x13349e8, root=0x13342e8) at allpaths.c:853</span><br><span class="line">853rel-&gt;fdwroutine-&gt;GetForeignPaths(root, rel, rte-&gt;relid);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000660452 in set_foreign_pathlist (rte=0x130f778, rel=0x13349e8, root=0x13342e8)</span></span><br><span class="line">    at allpaths.c:853</span><br><span class="line">495<span class="keyword">if</span> (rel-&gt;reloptkind == RELOPT_BASEREL &amp;&amp;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  set_rel_pathlist (root=root@entry=0x13342e8, rel=0x13349e8, rti=rti@entry=1, rte=0x130f778)</span></span><br><span class="line">    at allpaths.c:495</span><br><span class="line">0x0000000000660a30 <span class="keyword">in</span> set_base_rel_pathlists (root=&lt;optimized out&gt;) at allpaths.c:310</span><br><span class="line">310set_rel_pathlist(root, rel, rti, root-&gt;simple_rte_array[rti]);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000660a30 in set_base_rel_pathlists (root=&lt;optimized out&gt;) at allpaths.c:310</span></span><br><span class="line">185rel = make_rel_from_joinlist(root, joinlist);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  make_one_rel (root=root@entry=0x13342e8, joinlist=joinlist@entry=0x1334e50) at allpaths.c:185</span></span><br><span class="line">query_planner (root=root@entry=0x13342e8, tlist=tlist@entry=0x1334788, </span><br><span class="line">    qp_callback=qp_callback@entry=0x67f290 &lt;standard_qp_callback&gt;, qp_extra=qp_extra@entry=0x7fff8c772f00) at planmain.c:262</span><br><span class="line">262<span class="keyword">if</span> (!final_rel || !final_rel-&gt;cheapest_total_path ||</span><br><span class="line">Value returned is <span class="variable">$3</span> = (RelOptInfo *) 0x13349e8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  query_planner (root=root@entry=0x13342e8, tlist=tlist@entry=0x1334788, </span></span><br><span class="line">    qp_callback=qp_callback@entry=0x67f290 &lt;standard_qp_callback&gt;, qp_extra=qp_extra@entry=0x7fff8c772f00) at planmain.c:262</span><br><span class="line">grouping_planner (root=root@entry=0x13342e8, inheritance_update=inheritance_update@entry=<span class="literal">false</span>, tuple_fraction=&lt;optimized out&gt;, </span><br><span class="line">    tuple_fraction@entry=0) at planner.c:1907</span><br><span class="line">1907final_target = create_pathtarget(root, tlist);</span><br><span class="line">Value returned is <span class="variable">$4</span> = (RelOptInfo *) 0x13349e8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  grouping_planner (root=root@entry=0x13342e8, inheritance_update=inheritance_update@entry=false, </span></span><br><span class="line">    tuple_fraction=&lt;optimized out&gt;, tuple_fraction@entry=0) at planner.c:1907</span><br><span class="line">subquery_planner (glob=glob@entry=0x130fc38, parse=parse@entry=0x130f668, parent_root=parent_root@entry=0x0, </span><br><span class="line">    hasRecursion=hasRecursion@entry=<span class="literal">false</span>, tuple_fraction=tuple_fraction@entry=0) at planner.c:972</span><br><span class="line">972SS_identify_outer_params(root);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  subquery_planner (glob=glob@entry=0x130fc38, parse=parse@entry=0x130f668, </span></span><br><span class="line">    parent_root=parent_root@entry=0x0, hasRecursion=hasRecursion@entry=<span class="literal">false</span>, tuple_fraction=tuple_fraction@entry=0)</span><br><span class="line">    at planner.c:972</span><br><span class="line">standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:409</span><br><span class="line">409final_rel = fetch_upper_rel(root, UPPERREL_FINAL, NULL);</span><br><span class="line">Value returned is <span class="variable">$5</span> = (PlannerInfo *) 0x13342e8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:409</span></span><br><span class="line"></span><br><span class="line">Breakpoint 3, postgresGetForeignPlan (root=0x13342e8, foreignrel=0x13349e8, foreigntableid=16392, best_path=0x1334dc0, </span><br><span class="line">    tlist=0x13cbdd8, scan_clauses=0x0, outer_plan=0x0) at postgres_fdw.c:1131</span><br><span class="line">1131&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresGetForeignPlan (root=0x13342e8, foreignrel=0x13349e8, foreigntableid=16392, best_path=0x1334dc0, tlist=0x13cbdd8, scan_clauses=0x0, outer_plan=0x0) at postgres_fdw.c:1131</span></span><br><span class="line"><span class="comment">#1  0x000000000067a0c1 in create_foreignscan_plan (scan_clauses=&lt;optimized out&gt;, tlist=0x13cbdd8, best_path=0x1334dc0, root=0x13342e8) at createplan.c:3597</span></span><br><span class="line"><span class="comment">#2  create_scan_plan (root=root@entry=0x13342e8, best_path=best_path@entry=0x1334dc0, flags=&lt;optimized out&gt;, flags@entry=1)  at createplan.c:714</span></span><br><span class="line"><span class="comment">#3  0x0000000000677557 in create_plan_recurse (root=root@entry=0x13342e8, best_path=0x1334dc0, flags=flags@entry=1) at createplan.c:390</span></span><br><span class="line"><span class="comment">#4  0x0000000000679dc9 in create_plan (root=root@entry=0x13342e8, best_path=&lt;optimized out&gt;) at createplan.c:327</span></span><br><span class="line"><span class="comment">#5  0x0000000000685264 in standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:412</span></span><br><span class="line"><span class="comment">#6  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x130f668, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#7  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#8  0x0000000000721cda in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresGetForeignPlan (root=0x13342e8, foreignrel=0x13349e8, foreigntableid=16392, best_path=0x1334dc0, </span></span><br><span class="line">    tlist=0x13cbdd8, scan_clauses=0x0, outer_plan=0x0) at postgres_fdw.c:1131</span><br><span class="line">create_foreignscan_plan (scan_clauses=&lt;optimized out&gt;, tlist=0x13cbdd8, best_path=0x1334dc0, root=0x13342e8) at createplan.c:3603</span><br><span class="line">3603copy_generic_path_info(&amp;scan_plan-&gt;scan.plan, &amp;best_path-&gt;path);</span><br><span class="line">Value returned is <span class="variable">$6</span> = (ForeignScan *) 0x13105b0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_foreignscan_plan (scan_clauses=&lt;optimized out&gt;, tlist=0x13cbdd8, best_path=0x1334dc0, </span></span><br><span class="line">    root=0x13342e8) at createplan.c:3603</span><br><span class="line">718<span class="built_in">break</span>;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_scan_plan (root=root@entry=0x13342e8, best_path=best_path@entry=0x1334dc0, flags=&lt;optimized out&gt;, </span></span><br><span class="line">    flags@entry=1) at createplan.c:718</span><br><span class="line">0x0000000000677557 <span class="keyword">in</span> create_plan_recurse (root=root@entry=0x13342e8, best_path=0x1334dc0, flags=flags@entry=1)</span><br><span class="line">    at createplan.c:390</span><br><span class="line">390plan = create_scan_plan(root, best_path, flags);</span><br><span class="line">Value returned is <span class="variable">$7</span> = (Plan *) 0x13105b0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000677557 in create_plan_recurse (root=root@entry=0x13342e8, best_path=0x1334dc0, </span></span><br><span class="line">    flags=flags@entry=1) at createplan.c:390</span><br><span class="line">create_plan (root=root@entry=0x13342e8, best_path=&lt;optimized out&gt;) at createplan.c:336</span><br><span class="line">336<span class="keyword">if</span> (!IsA(plan, ModifyTable))</span><br><span class="line">Value returned is <span class="variable">$8</span> = (Plan *) 0x13105b0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_plan (root=root@entry=0x13342e8, best_path=&lt;optimized out&gt;) at createplan.c:336</span></span><br><span class="line">standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:418</span><br><span class="line">418<span class="keyword">if</span> (cursorOptions &amp; CURSOR_OPT_SCROLL)</span><br><span class="line">Value returned is <span class="variable">$9</span> = (Plan *) 0x13105b0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:418</span></span><br><span class="line">pg_plan_query (querytree=querytree@entry=0x130f668, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0)</span><br><span class="line">    at postgres.c:811</span><br><span class="line">811<span class="keyword">if</span> (log_planner_stats)</span><br><span class="line">Value returned is <span class="variable">$10</span> = (PlannedStmt *) 0x130f8d8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  pg_plan_query (querytree=querytree@entry=0x130f668, cursorOptions=cursorOptions@entry=256, </span></span><br><span class="line">    boundParams=boundParams@entry=0x0) at postgres.c:811</span><br><span class="line">0x000000000072186e <span class="keyword">in</span> pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, </span><br><span class="line">    boundParams=boundParams@entry=0x0) at postgres.c:875</span><br><span class="line">875stmt = pg_plan_query(query, cursorOptions, boundParams);</span><br><span class="line">Value returned is <span class="variable">$11</span> = (PlannedStmt *) 0x130f8d8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, </span></span><br><span class="line">    boundParams=boundParams@entry=0x0) at postgres.c:875</span><br><span class="line">0x0000000000721cda <span class="keyword">in</span> exec_simple_query (query_string=0x130e810 <span class="string">"select * from t_fdw;"</span>) at postgres.c:1050</span><br><span class="line">1050plantree_list = pg_plan_queries(querytree_list,</span><br><span class="line">Value returned is <span class="variable">$12</span> = (List *) 0x13cc7d8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000721cda in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1050</span></span><br><span class="line"></span><br><span class="line">Breakpoint 4, postgresBeginForeignScan (node=0x13bf120, eflags=16) at postgres_fdw.c:1314</span><br><span class="line">1314&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresBeginForeignScan (node=0x13bf120, eflags=16) at postgres_fdw.c:1314</span></span><br><span class="line"><span class="comment">#1  0x00000000006190fc in ExecInitForeignScan (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, eflags=eflags@entry=16) at nodeForeignscan.c:229</span></span><br><span class="line"><span class="comment">#2  0x00000000005f6694 in ExecInitNode (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, eflags=eflags@entry=16) at execProcnode.c:277</span></span><br><span class="line"><span class="comment">#3  0x00000000005f11c5 in InitPlan (eflags=16, queryDesc=&lt;optimized out&gt;) at execMain.c:1049</span></span><br><span class="line"><span class="comment">#4  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=16) at execMain.c:264</span></span><br><span class="line"><span class="comment">#5  0x00000000007255e2 in PortalStart (portal=portal@entry=0x1373f50, params=params@entry=0x0, eflags=eflags@entry=0, snapshot=snapshot@entry=0x0) at pquery.c:520</span></span><br><span class="line"><span class="comment">#6  0x0000000000721b42 in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1083</span></span><br><span class="line"><span class="comment">#7  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#8  0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#9  BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#10 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#11 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#12 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresBeginForeignScan (node=0x13bf120, eflags=16) at postgres_fdw.c:1314</span></span><br><span class="line">0x00000000006190fc <span class="keyword">in</span> ExecInitForeignScan (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, eflags=eflags@entry=16)</span><br><span class="line">    at nodeForeignscan.c:229</span><br><span class="line">229fdwroutine-&gt;BeginForeignScan(scanstate, eflags);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x00000000006190fc in ExecInitForeignScan (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, </span></span><br><span class="line">    eflags=eflags@entry=16) at nodeForeignscan.c:229</span><br><span class="line">0x00000000005f6694 <span class="keyword">in</span> ExecInitNode (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, eflags=eflags@entry=16)</span><br><span class="line">    at execProcnode.c:277</span><br><span class="line">277result = (PlanState *) ExecInitForeignScan((ForeignScan *) node,</span><br><span class="line">Value returned is <span class="variable">$13</span> = (ForeignScanState *) 0x13bf120</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x00000000005f6694 in ExecInitNode (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, </span></span><br><span class="line">    eflags=eflags@entry=16) at execProcnode.c:277</span><br><span class="line">InitPlan (eflags=16, queryDesc=&lt;optimized out&gt;) at execMain.c:1054</span><br><span class="line">1054tupType = ExecGetResultType(planstate);</span><br><span class="line">Value returned is <span class="variable">$14</span> = (PlanState *) 0x13bf120</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  InitPlan (eflags=16, queryDesc=&lt;optimized out&gt;) at execMain.c:1054</span></span><br><span class="line">266MemoryContextSwitchTo(oldcontext);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=16) at execMain.c:266</span></span><br><span class="line">PortalStart (portal=portal@entry=0x1373f50, params=params@entry=0x0, eflags=eflags@entry=0, snapshot=snapshot@entry=0x0)</span><br><span class="line">    at pquery.c:525</span><br><span class="line">525portal-&gt;queryDesc = queryDesc;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  PortalStart (portal=portal@entry=0x1373f50, params=params@entry=0x0, eflags=eflags@entry=0, </span></span><br><span class="line">    snapshot=snapshot@entry=0x0) at pquery.c:525</span><br><span class="line">exec_simple_query (query_string=0x130e810 <span class="string">"select * from t_fdw;"</span>) at postgres.c:1092</span><br><span class="line">1092<span class="keyword">if</span> (IsA(parsetree-&gt;stmt, FetchStmt))</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1092</span></span><br><span class="line"></span><br><span class="line">Breakpoint 5, postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span><br><span class="line">1418&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span></span><br><span class="line"><span class="comment">#1  0x0000000000618f6b in ForeignNext (node=node@entry=0x13bf120) at nodeForeignscan.c:54</span></span><br><span class="line"><span class="comment">#2  0x00000000005f7b2a in ExecScanFetch (recheckMtd=0x618e40 &lt;ForeignRecheck&gt;, accessMtd=0x618ed0 &lt;ForeignNext&gt;, node=0x13bf120) at execScan.c:95</span></span><br><span class="line"><span class="comment">#3  ExecScan (node=0x13bf120, accessMtd=0x618ed0 &lt;ForeignNext&gt;, recheckMtd=0x618e40 &lt;ForeignRecheck&gt;) at execScan.c:145</span></span><br><span class="line"><span class="comment">#4  0x00000000005f000a in ExecProcNode (node=0x13bf120) at ../../../src/include/executor/executor.h:237</span></span><br><span class="line"><span class="comment">#5  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x1335d78, direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=true, operation=CMD_SELECT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x13bf120, estate=0x13bef10) at execMain.c:1726</span></span><br><span class="line"><span class="comment">#6  standard_ExecutorRun (queryDesc=0x1330130, direction=&lt;optimized out&gt;, count=0, execute_once=&lt;optimized out&gt;) at execMain.c:363</span></span><br><span class="line"><span class="comment">#7  0x00000000007247fb in PortalRunSelect (portal=portal@entry=0x1373f50, forward=forward@entry=true, count=0, count@entry=9223372036854775807, dest=dest@entry=0x1335d78) at pquery.c:932</span></span><br><span class="line"><span class="comment">#8  0x0000000000725b10 in PortalRun (portal=portal@entry=0x1373f50, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x1335d78, altdest=altdest@entry=0x1335d78, completionTag=completionTag@entry=0x7fff8c773240 "") at pquery.c:773</span></span><br><span class="line"><span class="comment">#9  0x0000000000721bb7 in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#10 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#11 0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#12 BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#13 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#14 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#15 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span></span><br><span class="line">0x0000000000618f6b <span class="keyword">in</span> ForeignNext (node=node@entry=0x13bf120) at nodeForeignscan.c:54</span><br><span class="line">54slot = node-&gt;fdwroutine-&gt;IterateForeignScan(node);</span><br><span class="line">Value returned is <span class="variable">$15</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000618f6b in ForeignNext (node=node@entry=0x13bf120) at nodeForeignscan.c:54</span></span><br><span class="line">0x00000000005f7b2a <span class="keyword">in</span> ExecScanFetch (recheckMtd=0x618e40 &lt;ForeignRecheck&gt;, accessMtd=0x618ed0 &lt;ForeignNext&gt;, node=0x13bf120)</span><br><span class="line">    at execScan.c:95</span><br><span class="line">95<span class="built_in">return</span> (*accessMtd) (node);</span><br><span class="line">Value returned is <span class="variable">$16</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x00000000005f7b2a in ExecScanFetch (recheckMtd=0x618e40 &lt;ForeignRecheck&gt;, </span></span><br><span class="line">    accessMtd=0x618ed0 &lt;ForeignNext&gt;, node=0x13bf120) at execScan.c:95</span><br><span class="line">219&#125;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecScan (node=&lt;optimized out&gt;, accessMtd=0x618ed0 &lt;ForeignNext&gt;, recheckMtd=0x618e40 &lt;ForeignRecheck&gt;)</span></span><br><span class="line">    at execScan.c:219</span><br><span class="line">ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x1335d78, direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=<span class="literal">true</span>, </span><br><span class="line">    operation=CMD_SELECT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x13bf120, estate=0x13bef10) at execMain.c:1732</span><br><span class="line">1732<span class="keyword">if</span> (TupIsNull(slot))</span><br><span class="line">Value returned is <span class="variable">$17</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x1335d78, direction=&lt;optimized out&gt;, numberTuples=0, </span></span><br><span class="line">    sendTuples=<span class="literal">true</span>, operation=CMD_SELECT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x13bf120, estate=0x13bef10)</span><br><span class="line">    at execMain.c:1732</span><br><span class="line">363ExecutePlan(estate,</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorRun (queryDesc=0x1330130, direction=&lt;optimized out&gt;, count=0, </span></span><br><span class="line">    execute_once=&lt;optimized out&gt;) at execMain.c:363</span><br><span class="line"></span><br><span class="line">Breakpoint 5, postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span><br><span class="line">1418&#123;</span><br><span class="line"><span class="comment"># 再次进入postgresIterateForeignScan.后续跳过中间的8次，</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Breakpoint 5, postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span><br><span class="line">1418&#123;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span></span><br><span class="line">0x0000000000618f6b <span class="keyword">in</span> ForeignNext (node=node@entry=0x13bf120) at nodeForeignscan.c:54</span><br><span class="line">54slot = node-&gt;fdwroutine-&gt;IterateForeignScan(node);</span><br><span class="line">Value returned is <span class="variable">$45</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000618f6b in ForeignNext (node=node@entry=0x13bf120) at nodeForeignscan.c:54</span></span><br><span class="line">0x00000000005f7b2a <span class="keyword">in</span> ExecScanFetch (recheckMtd=0x618e40 &lt;ForeignRecheck&gt;, accessMtd=0x618ed0 &lt;ForeignNext&gt;, node=0x13bf120)</span><br><span class="line">    at execScan.c:95</span><br><span class="line">95<span class="built_in">return</span> (*accessMtd) (node);</span><br><span class="line">Value returned is <span class="variable">$46</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x00000000005f7b2a in ExecScanFetch (recheckMtd=0x618e40 &lt;ForeignRecheck&gt;, </span></span><br><span class="line">    accessMtd=0x618ed0 &lt;ForeignNext&gt;, node=0x13bf120) at execScan.c:95</span><br><span class="line">219&#125;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecScan (node=&lt;optimized out&gt;, accessMtd=0x618ed0 &lt;ForeignNext&gt;, recheckMtd=0x618e40 &lt;ForeignRecheck&gt;)</span></span><br><span class="line">    at execScan.c:219</span><br><span class="line">ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x1335d78, direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=<span class="literal">true</span>, </span><br><span class="line">    operation=CMD_SELECT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x13bf120, estate=0x13bef10) at execMain.c:1732</span><br><span class="line">1732<span class="keyword">if</span> (TupIsNull(slot))</span><br><span class="line">Value returned is <span class="variable">$47</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x1335d78, direction=&lt;optimized out&gt;, numberTuples=0, </span></span><br><span class="line">    sendTuples=<span class="literal">true</span>, operation=CMD_SELECT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x13bf120, estate=0x13bef10)</span><br><span class="line">    at execMain.c:1732</span><br><span class="line">377<span class="keyword">if</span> (sendTuples)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorRun (queryDesc=0x1330130, direction=&lt;optimized out&gt;, count=0, </span></span><br><span class="line">    execute_once=&lt;optimized out&gt;) at execMain.c:377</span><br><span class="line">PortalRunSelect (portal=portal@entry=0x1373f50, forward=forward@entry=<span class="literal">true</span>, count=0, count@entry=9223372036854775807, </span><br><span class="line">    dest=dest@entry=0x1335d78) at pquery.c:934</span><br><span class="line">934nprocessed = queryDesc-&gt;estate-&gt;es_processed;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  PortalRunSelect (portal=portal@entry=0x1373f50, forward=forward@entry=true, count=0, </span></span><br><span class="line">    count@entry=9223372036854775807, dest=dest@entry=0x1335d78) at pquery.c:934</span><br><span class="line">PortalRun (portal=portal@entry=0x1373f50, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=<span class="literal">true</span>, </span><br><span class="line">    run_once=run_once@entry=<span class="literal">true</span>, dest=dest@entry=0x1335d78, altdest=altdest@entry=0x1335d78, </span><br><span class="line">    completionTag=completionTag@entry=0x7fff8c773240 <span class="string">""</span>) at pquery.c:780</span><br><span class="line">780<span class="keyword">if</span> (completionTag &amp;&amp; portal-&gt;commandTag)</span><br><span class="line">Value returned is <span class="variable">$48</span> = 10</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  PortalRun (portal=portal@entry=0x1373f50, count=count@entry=9223372036854775807, </span></span><br><span class="line">    isTopLevel=isTopLevel@entry=<span class="literal">true</span>, run_once=run_once@entry=<span class="literal">true</span>, dest=dest@entry=0x1335d78, altdest=altdest@entry=0x1335d78, </span><br><span class="line">    completionTag=completionTag@entry=0x7fff8c773240 <span class="string">""</span>) at pquery.c:780</span><br><span class="line">exec_simple_query (query_string=0x130e810 <span class="string">"select * from t_fdw;"</span>) at postgres.c:1130</span><br><span class="line">1130receiver-&gt;rDestroy(receiver);</span><br><span class="line">Value returned is <span class="variable">$49</span> = <span class="literal">true</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1130</span></span><br><span class="line"></span><br><span class="line">Breakpoint 7, postgresEndForeignScan (node=0x13bf120) at postgres_fdw.c:1515</span><br><span class="line">1515&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresEndForeignScan (node=0x13bf120) at postgres_fdw.c:1515</span></span><br><span class="line"><span class="comment">#1  0x0000000000619173 in ExecEndForeignScan (node=0x13bf120) at nodeForeignscan.c:249</span></span><br><span class="line"><span class="comment">#2  0x00000000005f16ad in ExecEndPlan (estate=0x13bef10, planstate=&lt;optimized out&gt;) at execMain.c:1612</span></span><br><span class="line"><span class="comment">#3  standard_ExecutorEnd (queryDesc=0x1330130) at execMain.c:495</span></span><br><span class="line"><span class="comment">#4  0x00000000005abfc4 in PortalCleanup (portal=&lt;optimized out&gt;) at portalcmds.c:301</span></span><br><span class="line"><span class="comment">#5  0x000000000084445a in PortalDrop (portal=0x1373f50, isTopCommit=&lt;optimized out&gt;) at portalmem.c:499</span></span><br><span class="line"><span class="comment">#6  0x0000000000721bc8 in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1132</span></span><br><span class="line"><span class="comment">#7  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#8  0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#9  BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#10 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#11 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#12 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresEndForeignScan (node=0x13bf120) at postgres_fdw.c:1515</span></span><br><span class="line">0x0000000000619173 <span class="keyword">in</span> ExecEndForeignScan (node=0x13bf120) at nodeForeignscan.c:249</span><br><span class="line">249node-&gt;fdwroutine-&gt;EndForeignScan(node);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000619173 in ExecEndForeignScan (node=0x13bf120) at nodeForeignscan.c:249</span></span><br><span class="line">ExecEndPlan (estate=0x13bef10, planstate=&lt;optimized out&gt;) at execMain.c:1617</span><br><span class="line">1617foreach(l, estate-&gt;es_subplanstates)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecEndPlan (estate=0x13bef10, planstate=&lt;optimized out&gt;) at execMain.c:1617</span></span><br><span class="line">498UnregisterSnapshot(estate-&gt;es_snapshot);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorEnd (queryDesc=0x1330130) at execMain.c:498</span></span><br><span class="line">PortalCleanup (portal=&lt;optimized out&gt;) at portalcmds.c:302</span><br><span class="line">302FreeQueryDesc(queryDesc);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  PortalCleanup (portal=&lt;optimized out&gt;) at portalcmds.c:302</span></span><br><span class="line">PortalDrop (portal=0x1373f50, isTopCommit=&lt;optimized out&gt;) at portalmem.c:500</span><br><span class="line">500portal-&gt;cleanup = NULL;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  PortalDrop (portal=0x1373f50, isTopCommit=&lt;optimized out&gt;) at portalmem.c:500</span></span><br><span class="line">exec_simple_query (query_string=0x130e810 <span class="string">"select * from t_fdw;"</span>) at postgres.c:1134</span><br><span class="line">1134<span class="keyword">if</span> (lnext(parsetree_item) == NULL)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1134</span></span><br><span class="line">0x0000000000722e62 <span class="keyword">in</span> PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 <span class="string">"fdw"</span>, </span><br><span class="line">    username=&lt;optimized out&gt;) at postgres.c:4153</span><br><span class="line">4153exec_simple_query(query_string);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, </span></span><br><span class="line">    dbname=0x1338450 <span class="string">"fdw"</span>, username=&lt;optimized out&gt;) at postgres.c:4153</span><br><span class="line"></span><br><span class="line"><span class="comment"># 说明，postgresIterateForeignScan一共调用了11次，因为外部表总行数是10行，postgresIterateForeignScan最后一次调用返回NULL，用于结束迭代。</span></span><br><span class="line">fdw=<span class="comment"># insert into t_test values(2,'1');</span></span><br><span class="line">INSERT 0 1</span><br><span class="line">fdw=<span class="comment"># select * from t_fdw;</span></span><br><span class="line"> id |     c1     | c2 </span><br><span class="line">----+------------+----</span><br><span class="line">  1 | 1          | 2</span><br><span class="line">  2 | 1          | 2</span><br><span class="line">  3 | 1          | 2</span><br><span class="line">  4 | 1          | 2</span><br><span class="line">  5 | 1          | 2</span><br><span class="line">  6 | 1          | 2</span><br><span class="line">  7 | 1          | 2</span><br><span class="line">  8 | 1          | 2</span><br><span class="line">  9 | 1          | 2</span><br><span class="line"> 10 | 1          | 2</span><br><span class="line">(10 rows)</span><br></pre></td></tr></table></figure><p>根据以上的代码跟踪，可以更好的理解实现FDW的7个必须回调函数的调用时机，如果对PostgreSQL的查询机制更加熟悉的话，或许对于如何实现这个7个回调函数跟有帮助。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;上篇大概介绍了FDW必须实现的7个回调函数&lt;a href=&quot;https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/&quot;&gt;学习PostgreSQL的FDW(#1)&lt;/a&gt;，本篇将从源码跟踪，这7个回调函数的调用时机，以P
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
      <category term="gdb" scheme="https://oyo-byte.github.io/tags/gdb/"/>
    
  </entry>
  
  <entry>
    <title>学习PostgreSQL的查询机制</title>
    <link href="https://oyo-byte.github.io/2018/08/03/learn_about_pg_query_processing/"/>
    <id>https://oyo-byte.github.io/2018/08/03/learn_about_pg_query_processing/</id>
    <published>2018-08-03T10:10:45.600Z</published>
    <updated>2018-08-17T08:26:32.716Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在PostgreSQL中，查询语句经过以下5个子系统处理：</p><ol><li><p>Parser<br>用于将文本式的SQL命令转换成解析树</p></li><li><p>Analyzer/Analyser<br>用于执行解析树的语义分析并生成查询树</p></li><li>Rewriter<br>重写器用于根据规则系统中已存在的规则转换查询树</li><li>Planner<br>规划器生成可以从查询树中最有效地执行的计划树</li><li>Executor<br>执行器通过按计划树创建的顺序访问表和索引来执行查询</li></ol><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180806173200.png" alt=""></p><h3 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a>Parser</h3><p><br><br><em>未完待续</em></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;在PostgreSQL中，查询语句经过以下5个子系统处理：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;Parser&lt;br&gt;用于将文本式的SQL命令转换
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>学习PostgreSQL的FDW(#1)</title>
    <link href="https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/"/>
    <id>https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/</id>
    <published>2018-08-03T07:52:42.563Z</published>
    <updated>2018-08-07T17:14:45.415Z</updated>
    
    <content type="html"><![CDATA[<p>实现一个FDW的核心是实现一组回调函数，有了这些回调函数的帮助, 在查询外部表对象的执行过程中就可以将运行逻辑切换至自定义的扩展代码中, 进而遵照PG的内部机制实现对外部数据源的访问。</p><p>目前PostgreSQL11 beta2，提供的FDW回调函数接口有39个。FDW的实现者需要根据外部数据源自身的能力（比如是否支持写操作，以及是否支持在外部数据源端执行join操作等等）对这些接口有选择地予以实现。</p><p>这些接口中, 最核心的接口有7个。无论外部数据源自身能力如何, 这7个接口是实现通过外部表对象访问该数据源的必须接口。它们的接口定义如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*GetForeignRelSize_function)</span> <span class="params">(PlannerInfo *root, RelOptInfo *baserel, Oid foreigntableid)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*GetForeignPaths_function)</span> <span class="params">(PlannerInfo *root, RelOptInfo *baserel, Oid foreigntableid)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ForeignScan *(*GetForeignPlan_function) (PlannerInfo *root, RelOptInfo *baserel,Oid foreigntableid, ForeignPath *best_path, List *tlist, List *scan_clauses, Plan *outer_plan);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*BeginForeignScan_function)</span> <span class="params">(ForeignScanState *node, <span class="keyword">int</span> eflags)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> TupleTableSlot *(*IterateForeignScan_function) (ForeignScanState *node);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*ReScanForeignScan_function)</span> <span class="params">(ForeignScanState *node)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*EndForeignScan_function)</span> <span class="params">(ForeignScanState *node)</span></span>;</span><br></pre></td></tr></table></figure><p>在PG中，查询语句经过以下5个子系统处理：</p><ol><li><p>Parser<br>用于将文本式的SQL命令转换成解析树</p></li><li><p>Analyzer/Analyser<br>用于执行解析树的语义分析并生成查询树</p></li><li>Rewriter<br>重写器用于根据规则系统中已存在的规则转换查询树</li><li>Planner<br>规划器生成可以从查询树中最有效地执行的计划树</li><li>Executor<br>执行器通过按计划树创建的顺序访问表和索引来执行查询</li></ol><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180806173200.png" alt=""></p><p>可以整合成三个大阶段：  </p><ul><li>Parser: 包含对SQL的语法解析，语义校验，查询重写</li><li>Optimizer：生成查询计划</li><li>Executor：按照火山模型执行查询计划的算子并向上返回数据</li></ul><p>PG的FDW所需的7个回调函数主要是在Optimizer和Executor阶段进行“介入”:<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180806173225.png" alt=""></p><p>这7个回调函数详细的调用时机以及作用：</p><table><thead><tr><th style="text-align:left">回调函数</th><th style="text-align:left">在PG中的调用时机</th><th style="text-align:left">作用</th><th style="text-align:left">详细描述</th></tr></thead><tbody><tr><td style="text-align:left">GetForeignRelSize</td><td style="text-align:left">优化器生成访问路径的过程中对外部表估算访问代价时</td><td style="text-align:left">提供外部表对于计算访问代价所需的基础数据，如表的元组数以及元组的平均长度,并将这些数据保存在输入参数baserel的字段”rows”以及”width”中</td><td style="text-align:left"><code>void GetForeignRelSize (PlannerInfo *root, RelOptInfo *baserel, Oid foreigntableid);</code>  <br>root是规划器的关于该查询的全局信息；baserel是规划器的关于该表的信息；foreigntableid是外部表在pg_class中的 OID （foreigntableid可以从规划器的数据结构中获得，但是为了减少工作量，这里直接显式地将它传递给函数）；<br>这个函数应该更新baserel-&gt;rows为表扫描根据限制条件完成了过滤后将返回的预期行数。baserel-&gt;rows的初始值只是一个常数的默认估计值，应该尽可能把它替换掉。如果该函数能够计算出一个平均结果行宽度的更好的估计值，该函数也可能选择更新baserel-&gt;width。</td></tr><tr><td style="text-align:left">GetForeignPaths</td><td style="text-align:left">生成对外部表的访问路径时</td><td style="text-align:left">生成对目标外部表的访问路径(通过PG中的接口createforeignscanpath()生成)</td><td style="text-align:left"><code>void GetForeignPaths (PlannerInfo *root, RelOptInfo *baserel, Oid foreigntableid);</code><br>参数和GetForeignRelSize相同；<br>这个函数必须为外部表上的扫描生成至少一个访问路径（ForeignPath节点），并且必须调用add_path把每一个这样的路径加入到baserel-&gt;pathlist中。我们推荐使用create_foreignscan_path来建立ForeignPath节点。该函数可以生成多个访问路径，例如一个具有合法pathkeys的路径表示一个预排序好的结果。每一个访问路径必须包含代价估计，并且能包含任何FDW的私有信息，这种信息被用来标识想要使用的指定扫描方法。</td></tr><tr><td style="text-align:left">GetForeignPlan</td><td style="text-align:left">优化器生成扫描外部表的查询计划节点时</td><td style="text-align:left">生成访问目标外部表的ForeignScan计划节点(通过PG中的接口make_foreignscan())</td><td style="text-align:left"><code>ForeignScan * GetForeignPlan (PlannerInfo *root, RelOptInfo *baserel, Oid foreigntableid, ForeignPath *best_path, List *tlist, List *scan_clauses, Plan *outer_plan);</code><br>参数和GetForeignRelSize的一样，外加选中的ForeignPath（在前面由GetForeignPaths、GetForeignJoinPaths或者GetForeignUpperPaths产生）、被计划节点发出的目标列表以及计划节点强制的限制子句以及被RecheckForeignScan执行的复查所使用的ForeignScan的外子计划（如果该路径是用于一个连接而非基本关系，则foreigntableid是InvalidOid）；<br>这个函数必须创建并返回一个ForeignScan计划节点，推荐使用make_foreignscan来建立ForeignScan节点。</td></tr><tr><td style="text-align:left">BeginForeignScan</td><td style="text-align:left">执行器即将开始执行ForeignScan算子，进行该算子相关的初始化时</td><td style="text-align:left">获取执行ForeignScan算子所需的信息，并将它们组织并保存在ForeignScanState中</td><td style="text-align:left"><code>void BeginForeignScan (ForeignScanState *node, int eflags);</code><br>它应该执行任何在扫描能够开始之前需要完成的初始化工作，但是并不开始执行真正的扫描（会在第一次调用IterateForeignScan时完成）。ForeignScanState节点已经被创建好了，但是它的fdw_state属性仍然为 NULL。关于要被扫描的表的信息可以通过ForeignScanState节点访问（特殊地，从底层的ForeignScan计划节点，它包含任何由GetForeignPlan提供的FDW私有信息）。eflags包含描述执行器对该计划节点操作模式的标志位。<br>注意当(eflags &amp; EXEC_FLAG_EXPLAIN_ONLY)为真时，这个函数不应该执行任何外部可见的动作；它应当只做最少的事情来创建对ExplainForeignScan 和EndForeignScan有效的节点状态</td></tr><tr><td style="text-align:left">IterateForeignScan</td><td style="text-align:left">执行ForeignScan算子过程中需要获取下一元组时</td><td style="text-align:left">读取外部数据源的一行数据，并将它组织为PG中的Tuple(即TupleTableSlot). 当该回调函数返回一个空的TupleTableSlot结构时, 迭代器停止迭代</td><td style="text-align:left"><code>TupleTableSlot * IterateForeignScan (ForeignScanState *node);</code><br>从外部源获得一行，将它放在一个元组表槽中返回（节点的ScanTupleSlot应当被用于此目的）。如果没有更多的行可用则返回 NULL。元组表槽设施允许一个物理的或者虚拟的元组被返回；在大部分情况下出于性能的考虑会倾向于选择后者。注意这是在一个短期存在的内存上下文中被调用的，该内存上下文会在调用之间被重置。如果需要长期存在的存储，需要在BeginForeignScan中创建内存上下文，或者使用节点的EState中的es_query_cxt。<br>如果提供了fdw_scan_tlist目标列表，被返回的行必须匹配它，如果没有提供则它们必须匹配被扫描的外部表的行类型。如果选择优化掉不需要的列，你应该在那些列的位置上插入控制或者生成一个忽略了那些列的fdw_scan_tlist列表。<br>注意PostgreSQL的执行器并不在乎被返回的行是否违背了定义在该外部表上的任何约束 — 但是规划器会在乎这一点，并且如果在外部表中有可见行不满足一个约束，规划器可能会错误地优化查询。如果当用户已经声明一个约束应该为真时它却被违背，最合适的处理可能是产生一个错误（就像在数据类型失配的情况下所作的那样）</td></tr><tr><td style="text-align:left">ReScanForeignScan</td><td style="text-align:left">执行Nested Loop过程中需要重置Inner Scan时(即Outter Scan需要向前推进一行时)</td><td style="text-align:left">将外部数据源的读取位置重置回最初的起始位置</td><td style="text-align:left"><code>void ReScanForeignScan (ForeignScanState *node);</code><br>注意扫描所依赖的任何参数可能已经改变了值，因此新扫描不一定会返回完全相同的行。</td></tr><tr><td style="text-align:left">EndForeignScan</td><td style="text-align:left">ForeignScan算子执行完成时</td><td style="text-align:left">释放整个ForeignScan算子执行过程中占用的外部资源或FDW中的资源</td><td style="text-align:left"><code>void EndForeignScan (ForeignScanState *node);</code><br>通常释放palloc过的内存并不重要，但是打开的文件和到远程服务器的连接等应该被清理。</td></tr></tbody></table><p>以上是必须实现的扫描相关的回调函数</p><p><br><br><br></p><p>参考：</p><p><a href="http://www.interdb.jp/pg/pgsql03.html" target="_blank" rel="noopener">http://www.interdb.jp/pg/pgsql03.html</a><br><a href="https://xiaowing.github.io/post/20180513_write_pgfdw_in_golang_part02/" target="_blank" rel="noopener">https://xiaowing.github.io/post/20180513_write_pgfdw_in_golang_part02/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;实现一个FDW的核心是实现一组回调函数，有了这些回调函数的帮助, 在查询外部表对象的执行过程中就可以将运行逻辑切换至自定义的扩展代码中, 进而遵照PG的内部机制实现对外部数据源的访问。&lt;/p&gt;
&lt;p&gt;目前PostgreSQL11 beta2，提供的FDW回调函数接口有39个
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
  </entry>
  
  <entry>
    <title>解读C语言声明</title>
    <link href="https://oyo-byte.github.io/2018/07/26/%E8%A7%A3%E8%AF%BBC%E8%AF%AD%E8%A8%80%E5%A3%B0%E6%98%8E/"/>
    <id>https://oyo-byte.github.io/2018/07/26/解读C语言声明/</id>
    <published>2018-07-26T03:18:23.922Z</published>
    <updated>2018-08-07T15:50:27.959Z</updated>
    
    <content type="html"><![CDATA[<p>C语言所有复杂的指针声明，都是由各种声明嵌套构成的。如何解读复杂指针声明呢？</p><p>右左法则（既著名又常用的方法 ）</p><p>右左法则英文原文：</p><blockquote><p>The right-left rule: Start reading the declaration from the innermost parentheses, go right, and then go left. When you encounter parentheses, the direction should be reversed. Once everything in the parentheses has been parsed, jump out of it. Continue till the whole declaration has been parsed.</p></blockquote><p>翻译如下：</p><p>右左法则：首先从最里面的圆括号看起，然后往右看，再往左看。每当遇到圆括号时，就应该掉转阅读方向。一旦解析完圆括号里面所有的东西，就跳出圆括号。重复这个过程直到整个声明解析完毕。</p><p>这时就会有个疑惑：怎样判断那个括号是最里面的呢？</p><p>因此需要对这个法则进行修改，结合《C专家编程》里提到的分析方法，应该是从未定义的标识符开始阅读，而不是从括号读起，之所以是未定义的标识符，是因为一个声明里面可能有多个标识符，但未定义的标识符只会有一个。</p><p>分析C语言的声明步骤：</p><ul><li>第1步：从左至右，找到第一个未定义的标识符。</li><li>第2步：查看标识符右边的符号，并确定是一个数组还是函数。</li><li>第3步：查看左边的符号。</li><li>第3步a：如果是左括号则将处理过的部分结合到一起直到遇到右括号作为标识符返回第2步。</li><li>第3步b：如果是<code>const</code>，<code>volatile</code>，<code>*</code>其中之一则继续向左直到不是这三个符号之一。</li><li>第4步：剩下的符号构成声明的基本类型。</li></ul><p>感觉还是有点晕？</p><p>结合例子说明：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> (*(*x[<span class="number">3</span>])())[<span class="number">5</span>];</span><br></pre></td></tr></table></figure><ul><li>第1步：从左到右找到第一个标识符x。</li><li>第2步：查看标识符右边的符号是<code>[</code>，说明x是一个具有3个元素的数组。</li><li>第3步：查看左边的符号是<code>*</code>，转至第3步b。</li><li>第3步b：说明数组中的元素都是指针，向左就是左括号了，将这个左括号结合到对应的右括号（也就是<code>(*x[3])</code>）作为新的标识符返回第2步 。</li><li>第2步：查看右边的符号是<code>(</code>，说明指针是指向参数列表为空的函数的指针。</li><li>查看左边的符号，是<code>*</code>, 转至第3步b。</li><li>说明函数的返回值是指针，向左是左括号，将这个左括号结合到对应的右括号（也就是<code>(*(*x[3])())</code>）作为新的标识符返回第2步。</li><li>第2步：查看右边的符号是<code>[</code>，所以是指向具有五个元素的数组的指针。</li><li>第3步：查看左边的括号，既不是a情况，也不是b情况，跳至第4步。</li><li>第4步：数组的类型为char。</li></ul><p>所以以上的声明表示的是x是一个具有3个元素的数组，数组的每个元素都是一个指向函数的指针，函数的参数列表为空，返回值是指向一个具有5个元素的指针，元素的类型为char。</p><p>来个程序验证一下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> *</span><br><span class="line">func()&#123;</span><br><span class="line">    <span class="keyword">char</span> arr[<span class="number">5</span>] = &#123;<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>&#125;;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> (*(*x[<span class="number">3</span>])())[<span class="number">5</span>]; <span class="comment">// x是一个长度为3的数组，元素是一个函数指针，函数的返回值是指向一个长度为5的char型数组指针。</span></span><br><span class="line"></span><br><span class="line">    x[<span class="number">0</span>] = &amp;func;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"x的总长度：%d \n"</span>,<span class="keyword">sizeof</span>(x));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"x元素的长度：%d \n"</span>,<span class="keyword">sizeof</span>(x[<span class="number">0</span>]));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"函数指针的长度：%d \n"</span>,<span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"x的元素个数：%d \n"</span>,<span class="keyword">sizeof</span>(x)/<span class="keyword">sizeof</span>(x[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> (*c)[<span class="number">5</span>] = (x[<span class="number">0</span>])();<span class="comment">//c是一个指向长度为5的char型数组的指针</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"c的总长度：%d \n"</span>,<span class="keyword">sizeof</span>(*c));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"c元素的长度：%d \n"</span>,<span class="keyword">sizeof</span>((*c)[<span class="number">0</span>]));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"char型的长度：%d \n"</span>,<span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"c的第4个元素是：%c \n"</span>,(*c)[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"整体调用，第4个元素是：%c \n"</span>,(*(x[<span class="number">0</span>])())[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">x的总长度：24</span><br><span class="line">x元素的长度：8</span><br><span class="line">函数指针的长度：8</span><br><span class="line">x的元素个数：3</span><br><span class="line">c的总长度：5</span><br><span class="line">c元素的长度：1</span><br><span class="line">chart性的长度：1</span><br><span class="line">c的第4个元素是：4</span><br><span class="line">整体调用，结果的第4个元素是：4</span><br></pre></td></tr></table></figure></p><p>Try:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="keyword">char</span> *(*c[<span class="number">10</span>])(<span class="keyword">int</span> **p)</span><br></pre></td></tr></table></figure><p><br></p><p><br></p><p>Clockwise/Spiral Rule（顺时针/螺旋法则）</p><p>三步：</p><ol><li><p>从未定义标识符开始，以顺时针方向移动，当遇到以下元素时，用相应的语言陈述替换它们：</p><p>​    <code>[X]</code> or <code>[]</code> =&gt;  Array X size of… or Array undefined size of…</p><p>​    <code>(type1, type2)</code> =&gt; function passing type1 and type2 returning…</p><p>​    <code>*</code> =&gt;  pointer(s) to…</p></li><li><p>继续以上步骤，直至覆盖所有的字符。</p></li><li><p>首先解决括号中的内容。</p></li></ol><p>例1：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *str[<span class="number">10</span>];</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">     +-------+</span><br><span class="line">     | +-+   |</span><br><span class="line">     | ^ |   |</span><br><span class="line"><span class="keyword">char</span> *str[<span class="number">10</span>];</span><br><span class="line"> ^   ^   |   |</span><br><span class="line"> |   +---+   |</span><br><span class="line"> +-----------+</span><br></pre></td></tr></table></figure><ul><li><p>str是什么？</p><p>“str是一个……</p></li><li><p>从str开始以顺时针方向移动，遇到<code>[</code>，这意味着是一个数组</p><p>“str是一个长度为10的数组，元素是……</p></li><li><p>继续移动，遇到<code>*</code>,说明是指针</p><p>“str是一个长度为10的数组，元素是指向……的指针</p></li><li><p>继续遇到了<code>;</code>，然后继续移动，遇到<code>char</code></p><p>“str是一个长度为10的数组，元素是指向char的指针”</p></li><li><p>遍历完所有字符，解析完毕</p></li></ul><p>以上的<code>char (*(*x[3])())[5];</code>亦可这样去处理<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">      +----------+</span><br><span class="line">      | +-----+  |</span><br><span class="line">      | |++   |  |</span><br><span class="line">      | |^|   |  |</span><br><span class="line"><span class="keyword">char</span> (*(*x[<span class="number">3</span>])())[<span class="number">5</span>];</span><br><span class="line"> ^    ^ ^ |   |  |</span><br><span class="line"> |    | +-+   |  |</span><br><span class="line"> |    +-------+  |</span><br><span class="line"> +---------------+</span><br></pre></td></tr></table></figure></p><ul><li>x是什么？<br>“x是一个……</li><li>从x开始以顺时针方向移动，遇到<code>[</code>，这意味着是一个数组<br>“x是一个长度为3的数组，元素是……</li><li>继续移动，遇到<code>*</code>,说明是指针<br>“x是一个长度为3的数组，元素是指向……的指针</li><li>继续遇到<code>(</code>,说明是函数<br>“x是一个长度为3的数组，元素是指向函数的指针，函数是……</li><li>继续遇到<code>*</code>，说明是指针<br>“x是一个长度为3的数组，元素是指向函数的指针，函数是参数列表为空，返回值是指向……的指针</li><li>继续遇到<code>[</code>，说明是数组<br>“x是一个长度为3的数组，元素是指向函数的指针，函数是参数列表为空，返回值是指向长度为5的……类型元素的数组的指针</li><li>继续遇到<code>char</code>,说明元素是char型<br>“x是一个长度为3的数组，元素是指向函数的指针，函数是参数列表为空，返回值是指向长度为5的char类型元素的数组的指针”</li><li>遍历完毕</li></ul><p>Try:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span>  <span class="keyword">char</span> *(*fp)( <span class="keyword">int</span>, <span class="keyword">float</span> *);</span><br><span class="line"><span class="number">3.</span>  <span class="keyword">void</span> (*signal(<span class="keyword">int</span>, <span class="keyword">void</span> (*fp)(<span class="keyword">int</span>)))(<span class="keyword">int</span>);</span><br></pre></td></tr></table></figure><p> <br> <br> <br> <br> <br> <br> <br> <br></p><p>Answer：</p><ol><li>c是一个具有10个元素的数组，数组的元素都是函数指针，其所指向的函数是接受一个指向整型指针的指针，返回值是指向char的指针。</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">     +-----------------+</span><br><span class="line">     | +------+     +-+|</span><br><span class="line">     | |++    |     |++|</span><br><span class="line">     | |^|    |     |^||</span><br><span class="line"><span class="keyword">char</span> *(*c[<span class="number">10</span>])(<span class="keyword">int</span> **p);</span><br><span class="line">  ^  ^ ^ |    |    ^^ ||</span><br><span class="line">  |  | +-+    |    |+-+|</span><br><span class="line">  |  +--------+    +--+|</span><br><span class="line">  +--------------------+</span><br></pre></td></tr></table></figure><ol start="2"><li>fp是一个函数指针，该函数接受一个整型和一个浮点型指针入参，返回值是指向char的指针。</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">     +--------------------+</span><br><span class="line">     | +---+              |</span><br><span class="line">     | |+-+|              |</span><br><span class="line">     | |^ ||              |</span><br><span class="line"><span class="keyword">char</span> *(*fp)( <span class="keyword">int</span>, <span class="keyword">float</span> *);</span><br><span class="line"> ^   ^ ^  ||              |</span><br><span class="line"> |   | +--+|              |</span><br><span class="line"> |   +-----+              |</span><br><span class="line"> +------------------------+</span><br></pre></td></tr></table></figure><ol start="3"><li>signal是一个函数，该函数值一个接受一个整型和一个函数指针（该函数是入参是整型，返回值为空void），返回值是指向一个入参是整型，返回值是空void的函数指针。</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">      +-----------------------------+</span><br><span class="line">      |                  +---+      |</span><br><span class="line">      |  +---+           |+-+|      |</span><br><span class="line">      |  ^   |           |^ ||      |</span><br><span class="line"><span class="keyword">void</span> (*signal(<span class="keyword">int</span>, <span class="keyword">void</span> (*fp)(<span class="keyword">int</span>)))(<span class="keyword">int</span>);</span><br><span class="line"> ^    ^      |      ^    ^  ||      |</span><br><span class="line"> |    +------+      |    +--+|      |</span><br><span class="line"> |                  +--------+      |</span><br><span class="line"> +----------------------------------+</span><br></pre></td></tr></table></figure><p><br><br><br></p><p>参考：</p><p><a href="https://blog.csdn.net/wangweixaut061/article/details/6549768" target="_blank" rel="noopener">C语言复杂声明解析</a></p><p><a href="https://blog.csdn.net/jixuxjixu3/article/details/5824431" target="_blank" rel="noopener">c语言声明的分析方法</a></p><p><a href="http://c-faq.com/decl/spiral.anderson.html" target="_blank" rel="noopener">The Clockwise/Spiral Rule</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;C语言所有复杂的指针声明，都是由各种声明嵌套构成的。如何解读复杂指针声明呢？&lt;/p&gt;
&lt;p&gt;右左法则（既著名又常用的方法 ）&lt;/p&gt;
&lt;p&gt;右左法则英文原文：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The right-left rule: Start reading th
      
    
    </summary>
    
      <category term="C" scheme="https://oyo-byte.github.io/categories/C/"/>
    
    
  </entry>
  
  <entry>
    <title>PostgreSQL使用oracle_fdw与Oracle查询性能对比</title>
    <link href="https://oyo-byte.github.io/2018/07/25/PostgreSQL%E4%BD%BF%E7%94%A8oracle_fdw%E4%B8%8EOracle%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94/"/>
    <id>https://oyo-byte.github.io/2018/07/25/PostgreSQL使用oracle_fdw与Oracle查询性能对比/</id>
    <published>2018-07-25T03:29:52.892Z</published>
    <updated>2018-08-07T17:24:14.317Z</updated>
    
    <content type="html"><![CDATA[<h3 id="在PostgreSQL中使用oracle-fdw"><a href="#在PostgreSQL中使用oracle-fdw" class="headerlink" title="在PostgreSQL中使用oracle_fdw"></a>在PostgreSQL中使用oracle_fdw</h3><h4 id="安装oracle-fdw插件"><a href="#安装oracle-fdw插件" class="headerlink" title="安装oracle_fdw插件"></a>安装oracle_fdw插件</h4><ol><li>安装前要求：</li></ol><ul><li>全部功能要求PostgreSQL9.3及以上</li><li>Oracle client要求10.1以上</li><li>确保PostgreSQL配置了<code>--without-ldap</code></li><li>确保<code>pg_config</code>在PATH中(用 <code>pg_config --pgxs</code>测试)</li><li>设置了ORACLE_HOME环境变量</li></ul><p><a href="https://github.com/laurenz/oracle_fdw" target="_blank" rel="noopener">下载oracle_fdw源代码</a>,<br>并解压到某个目录下，进入文件目录，执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> make</span><br><span class="line"><span class="meta">$</span> make install</span><br></pre></td></tr></table></figure><p>安装完毕后，使用psql连接到PostgreSQL；<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> psql -d testdb;</span><br></pre></td></tr></table></figure></p><p>使用PostgreSQL的超级用户配置oralce_fdw:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">testdb=# create extension oracle_fdw;</span><br><span class="line">testdb=# create server oracle_121_56 foreign data wrapper oracle_fdw options (dbserver '//192.168.121.56:1521/orcl');</span><br><span class="line">testdb=# create user mapping for public server oracle_121_56 options (user 'dbuser' password 'test');</span><br></pre></td></tr></table></figure><h3 id="简单查询，无索引"><a href="#简单查询，无索引" class="headerlink" title="简单查询，无索引"></a>简单查询，无索引</h3><p>生成测试数据，创建一个表，并同时添加1百万条数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_table <span class="keyword">as</span> <span class="keyword">select</span> <span class="keyword">rownum</span> <span class="keyword">as</span> <span class="keyword">id</span>,to_char(<span class="keyword">sysdate</span> + <span class="keyword">rownum</span>/<span class="number">24</span>/<span class="number">3600</span>, <span class="string">'yyyy-mm-dd hh24:mi:ss'</span>) <span class="keyword">as</span> inc_datetime,trunc(dbms_random.value(<span class="number">0</span>, <span class="number">100</span>)) <span class="keyword">as</span> random_id,dbms_random.string(<span class="string">'x'</span>, <span class="number">20</span>) random_string <span class="keyword">from</span> dual <span class="keyword">connect</span> <span class="keyword">by</span> <span class="keyword">level</span> &lt;= <span class="number">1000000</span>;</span><br></pre></td></tr></table></figure><p>创建完表后，在原来表的基础上追加记录<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_table (<span class="keyword">ID</span>, INC_DATETIME,RANDOM_ID,RANDOM_STRING) <span class="keyword">select</span> <span class="keyword">rownum</span> <span class="keyword">as</span> <span class="keyword">id</span>,  to_char(<span class="keyword">sysdate</span> + <span class="keyword">rownum</span>, <span class="string">'yyyy-mm-dd hh24:mi:ss'</span>) <span class="keyword">as</span> inc_datetime,trunc(dbms_random.value(<span class="number">0</span>, <span class="number">100</span>)) <span class="keyword">as</span> random_id, dbms_random.string(<span class="string">'x'</span>, <span class="number">20</span>) random_string  <span class="keyword">from</span> dual  <span class="keyword">connect</span> <span class="keyword">by</span> <span class="keyword">level</span> &lt;= <span class="number">1000000</span>;</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure></p><p>上面SQL是利用了Oracle数据库语法的几个实用小技巧实现的:</p><ol><li><p>利用Oracle特有的“connect by”树形连接语法生成测试记录，“level &lt;= 10”表示要生成10记录；</p></li><li><p>利用rownum虚拟列生成递增的整数数据；</p></li><li><p>利用sysdate函数加一些简单运算来生成日期数据，本例中是每条记录的时间加1秒；</p></li><li><p>利用dbms_random.value函数生成随机的数值型数据，本例中是生成0到100之间的随机整数；</p></li><li><p>利用dbms_random.string函数生成随机的字符型数据，本例中是生成长度为20的随机字符串，字符串中可以包括字符或数字。</p></li><li><p>to_char(sysdate + rownum, ‘yyyy-mm-dd hh24:mi:ss’) 这里是转换为字符串，如果该字段的类型为TimeStamp时间戳，那这里可以改写一下方法，转换为时间戳 to_timestamp(sysdate + rownum, ‘yyyy-mm-dd hh24:mi:ss’)</p></li></ol><p>PostgreSQL 创建相应的外部表</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testdb=# create foreign table test_table(id int, inc_datetime varchar(19), random_id int, random_string varchar(4000)) server oracle_121_56 options (schema 'DBUSER', table 'TEST_TABLE');</span><br></pre></td></tr></table></figure><ol><li>查询表的行数</li></ol><ul><li>sqlplus</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sqlplus dbuser/test@//192.168.121.56:1521/orcl</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select count(*) from test_table;</span><br><span class="line"> COUNT(*)</span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">2000000</span><br><span class="line">Elapsed: 00:00:00.13</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select count(*) from test_table;</span><br><span class="line">count</span><br><span class="line"><span class="comment">---------</span></span><br><span class="line">2000000</span><br><span class="line">(1 row)</span><br><span class="line">Time: 5264.299 ms (00:05.264)</span><br></pre></td></tr></table></figure><p>查看oracle session中真正执行的sql语句，红框为oracle_fdw执行时，oracle session中执行的sql：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731143023.png" alt=""></p><p>在psql中查看<code>select count(*) from test_table;</code>的执行计划：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731143351.png" alt=""></p><p>可见oracle处理的sql即是查询计划中的oracle query后面的sql</p><p>查看网络流量<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731114417.png" alt=""><br>oracle_fdw的网络流量明显比sqlplus要高出很多。</p><ol start="2"><li>查询某条记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table where id= 50;</span><br><span class="line"></span><br><span class="line">ID  INC_DATETIME   RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">-------- -------------------- ------------ -----------------------------</span></span><br><span class="line">50  2018-07-25 01:13:38       212VMPGE0K6Y293T9WRT7G</span><br><span class="line">50  2018-09-13 01:49:31       51RGUV1BJJNSTNXDMXMVRL</span><br><span class="line">Elapsed: 00:00:00.05</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table where id= 50;</span><br><span class="line"> id |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">----+---------------------+-----------+----------------------</span></span><br><span class="line"> 50 | 2018-07-25 01:13:38 |        21 | 2VMPGE0K6Y293T9WRT7G</span><br><span class="line"> 50 | 2018-09-13 01:49:31 |        51 | RGUV1BJJNSTNXDMXMVRL</span><br><span class="line">(2 rows)</span><br><span class="line"></span><br><span class="line">Time: 56.811 ms</span><br></pre></td></tr></table></figure><ol start="3"><li>使用orderby id获取前5行记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table order by id offset 0 rows fetch next 5 rows only;</span><br><span class="line"></span><br><span class="line">ID  INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">-------- ------------------- ---------- ----------------------</span></span><br><span class="line"> 1  2018-07-25 01:12:49       175SPF1INUG6S2L1ZSTU7R</span><br><span class="line"> 1  2018-07-26 01:49:31       63BIO3ZOV104VLNKZWGDZN</span><br><span class="line"> 2  2018-07-25 01:12:50       95HJFAWH9L7SF85YSPNDHV</span><br><span class="line"> 2  2018-07-27 01:49:31       862PNXP02ZYWYYUZQFWVVN</span><br><span class="line"> 3  2018-07-25 01:12:51       86T3UQBBMP3O02LGO6ONPF</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.32</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table order by id offset 0 rows fetch next 5 rows only;</span><br><span class="line"> id |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">----+---------------------+-----------+----------------------</span></span><br><span class="line">  1 | 2018-07-25 01:12:49 |        17 | 5SPF1INUG6S2L1ZSTU7R</span><br><span class="line">  1 | 2018-07-26 01:49:31 |        63 | BIO3ZOV104VLNKZWGDZN</span><br><span class="line">  2 | 2018-07-27 01:49:31 |        86 | 2PNXP02ZYWYYUZQFWVVN</span><br><span class="line">  2 | 2018-07-25 01:12:50 |        95 | HJFAWH9L7SF85YSPNDHV</span><br><span class="line">  3 | 2018-07-25 01:12:51 |        86 | T3UQBBMP3O02LGO6ONPF</span><br><span class="line">(5 rows)</span><br><span class="line"></span><br><span class="line">Time: 1169.874 ms (00:01.170)</span><br></pre></td></tr></table></figure><ol start="4"><li>使用orderby random_string获取前5行记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test_table <span class="keyword">order</span> <span class="keyword">by</span> random_string <span class="keyword">offset</span> <span class="number">0</span> <span class="keyword">rows</span> <span class="keyword">fetch</span> <span class="keyword">next</span> <span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">only</span>;</span><br><span class="line"></span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- --------------------------------</span></span><br><span class="line">    938145 2018-08-04 21:48:33       8600008E7XPHROOHEPUYRC</span><br><span class="line">    686337 2018-08-01 23:51:45       3100008JW9S5PXE19F4W4M</span><br><span class="line">     19954 2073-03-12 01:49:31       690000G3A2KNDLVN61WOSH</span><br><span class="line">    382404 3065-07-20 01:49:31       410000JDLZP2J8VZFOJ44J</span><br><span class="line">    234567 2660-10-14 01:49:31       78000142EWU0B3GMIPA2AL</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.33</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table order by random_string offset 0 rows fetch next 5 rows only;</span><br><span class="line">   id   |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">--------+---------------------+-----------+----------------------</span></span><br><span class="line"> 938145 | 2018-08-04 21:48:33 |        86 | 00008E7XPHROOHEPUYRC</span><br><span class="line"> 686337 | 2018-08-01 23:51:45 |        31 | 00008JW9S5PXE19F4W4M</span><br><span class="line">  19954 | 2073-03-12 01:49:31 |        69 | 0000G3A2KNDLVN61WOSH</span><br><span class="line"> 382404 | 3065-07-20 01:49:31 |        41 | 0000JDLZP2J8VZFOJ44J</span><br><span class="line"> 234567 | 2660-10-14 01:49:31 |        78 | 000142EWU0B3GMIPA2AL</span><br><span class="line">(5 rows)</span><br><span class="line"></span><br><span class="line">Time: 13275.162 ms (00:13.275)</span><br></pre></td></tr></table></figure><p>oracle_fdw执行时,oracle session中执行的sql</p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731145032.png" alt=""></p><p>psql中查看执行计划<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731145127.png" alt=""></p><p>网络流量对比<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731144752.png" alt=""></p><h3 id="简单查询，带索引"><a href="#简单查询，带索引" class="headerlink" title="简单查询，带索引"></a>简单查询，带索引</h3><p>创建id索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> test_id <span class="keyword">on</span> test_table(<span class="keyword">id</span>);</span><br></pre></td></tr></table></figure><ol><li>查询某条记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table where id = 8222;</span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- -----------------------------</span></span><br><span class="line">      8222 2018-07-25 03:29:50       680VJJSTBAN6RAINSTWQAB</span><br><span class="line">      8222 2041-01-27 01:49:31       423SAYJV50LNDHURP5FU0K</span><br><span class="line">Elapsed: 00:00:00.07</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table where id = 8222;</span><br><span class="line">  id  |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">------+---------------------+-----------+----------------------</span></span><br><span class="line"> 8222 | 2018-07-25 03:29:50 |        68 | 0VJJSTBAN6RAINSTWQAB</span><br><span class="line"> 8222 | 2041-01-27 01:49:31 |        42 | 3SAYJV50LNDHURP5FU0K</span><br><span class="line">(2 rows)</span><br><span class="line">Time: 6.565 ms</span><br></pre></td></tr></table></figure><ol start="2"><li>使用orderby id获取前5行记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table order by id offset 0 rows fetch next 5 rows only;</span><br><span class="line"></span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- ----------------------------</span></span><br><span class="line"> 1 2018-07-25 01:12:49       175SPF1INUG6S2L1ZSTU7R</span><br><span class="line"> 1 2018-07-26 01:49:31       63BIO3ZOV104VLNKZWGDZN</span><br><span class="line"> 2 2018-07-25 01:12:50       95HJFAWH9L7SF85YSPNDHV</span><br><span class="line"> 2 2018-07-27 01:49:31       862PNXP02ZYWYYUZQFWVVN</span><br><span class="line"> 3 2018-07-25 01:12:51       86T3UQBBMP3O02LGO6ONPF</span><br><span class="line">Elapsed: 00:00:00.33</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table order by id offset 0 rows fetch next 5 rows only;</span><br><span class="line"> id |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">----+---------------------+-----------+----------------------</span></span><br><span class="line">  1 | 2018-07-25 01:12:49 |        17 | 5SPF1INUG6S2L1ZSTU7R</span><br><span class="line">  1 | 2018-07-26 01:49:31 |        63 | BIO3ZOV104VLNKZWGDZN</span><br><span class="line">  2 | 2018-07-27 01:49:31 |        86 | 2PNXP02ZYWYYUZQFWVVN</span><br><span class="line">  2 | 2018-07-25 01:12:50 |        95 | HJFAWH9L7SF85YSPNDHV</span><br><span class="line">  3 | 2018-07-25 01:12:51 |        86 | T3UQBBMP3O02LGO6ONPF</span><br><span class="line">(5 rows)</span><br><span class="line">Time: 1345.988 ms (00:01.346)</span><br></pre></td></tr></table></figure><p>创建random_string索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> test_string <span class="keyword">on</span> test_table(random_string);</span><br></pre></td></tr></table></figure><ol><li>查询某条记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table where random_string='GMX0VD9WY4YPN8T4XDML';</span><br><span class="line"></span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- -------------------------------</span></span><br><span class="line">       871 2018-07-25 01:27:19       45GMX0VD9WY4YPN8T4XDML</span><br><span class="line">Elapsed: 00:00:00.01</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table where random_string='GMX0VD9WY4YPN8T4XDML';</span><br><span class="line"> id  |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">-----+---------------------+-----------+----------------------</span></span><br><span class="line"> 871 | 2018-07-25 01:27:19 |        45 | GMX0VD9WY4YPN8T4XDML</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 118.376 ms</span><br></pre></td></tr></table></figure><ol start="2"><li>使用order by random_string获取前5条记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table order by random_string offset 0 rows fetch next 5 rows only;</span><br><span class="line"></span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- ----------------------------------</span></span><br><span class="line">    938145 2018-08-04 21:48:33       8600008E7XPHROOHEPUYRC</span><br><span class="line">    686337 2018-08-01 23:51:45       3100008JW9S5PXE19F4W4M</span><br><span class="line">     19954 2073-03-12 01:49:31       690000G3A2KNDLVN61WOSH</span><br><span class="line">    382404 3065-07-20 01:49:31       410000JDLZP2J8VZFOJ44J</span><br><span class="line">    234567 2660-10-14 01:49:31       78000142EWU0B3GMIPA2AL</span><br><span class="line">Elapsed: 00:00:00.36</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table order by random_string offset 0 rows fetch next 5 rows only;</span><br><span class="line">   id   |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">--------+---------------------+-----------+----------------------</span></span><br><span class="line"> 938145 | 2018-08-04 21:48:33 |        86 | 00008E7XPHROOHEPUYRC</span><br><span class="line"> 686337 | 2018-08-01 23:51:45 |        31 | 00008JW9S5PXE19F4W4M</span><br><span class="line">  19954 | 2073-03-12 01:49:31 |        69 | 0000G3A2KNDLVN61WOSH</span><br><span class="line"> 382404 | 3065-07-20 01:49:31 |        41 | 0000JDLZP2J8VZFOJ44J</span><br><span class="line"> 234567 | 2660-10-14 01:49:31 |        78 | 000142EWU0B3GMIPA2AL</span><br><span class="line">(5 rows)</span><br><span class="line">Time: 12848.595 ms (00:12.849)</span><br></pre></td></tr></table></figure><p>创建random_id,random_string复合索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> test_id_string <span class="keyword">on</span> test_table(random_id,random_string);</span><br></pre></td></tr></table></figure><ol><li>查询某条记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table where random_id=74 and random_string='6PP2R3M0K4ARK411VFC3';</span><br><span class="line"></span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- -------------------------------------</span></span><br><span class="line">      4067 2018-07-25 02:20:35       746PP2R3M0K4ARK411VFC3</span><br><span class="line">Elapsed: 00:00:00.00</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table where random_id=74 and random_string='6PP2R3M0K4ARK411VFC3';</span><br><span class="line">  id  |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">------+---------------------+-----------+----------------------</span></span><br><span class="line"> 4067 | 2018-07-25 02:20:35 |        74 | 6PP2R3M0K4ARK411VFC3</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 10.488 ms</span><br></pre></td></tr></table></figure><ol start="2"><li>orderby</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table order by random_id,random_string offset 0 rows fetch next 5 rows only;</span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- ------------------------------</span></span><br><span class="line">    231792 2018-07-27 17:36:000000LENLB2SJ8M8AZKTOD</span><br><span class="line">    691626 2018-08-02 01:19:540003GODBKGMRMZC3LTK8Z</span><br><span class="line">    582719 3613-12-29 01:49:3100052V1U6439AGAAAW3QZ</span><br><span class="line">    762898 2018-08-02 21:07:4600081R0VHHHJTRTPTL8RG</span><br><span class="line">    141007 2404-08-17 01:49:310008PFJM81W6NR83WFNXQ</span><br><span class="line">Elapsed: 00:00:00.33</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table order by random_id,random_string offset 0 rows fetch next 5 rows only;</span><br><span class="line">   id   |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">--------+---------------------+-----------+----------------------</span></span><br><span class="line"> 231792 | 2018-07-27 17:36:00 |         0 | 000LENLB2SJ8M8AZKTOD</span><br><span class="line"> 691626 | 2018-08-02 01:19:54 |         0 | 003GODBKGMRMZC3LTK8Z</span><br><span class="line"> 582719 | 3613-12-29 01:49:31 |         0 | 0052V1U6439AGAAAW3QZ</span><br><span class="line"> 762898 | 2018-08-02 21:07:46 |         0 | 0081R0VHHHJTRTPTL8RG</span><br><span class="line"> 141007 | 2404-08-17 01:49:31 |         0 | 008PFJM81W6NR83WFNXQ</span><br><span class="line">(5 rows)</span><br><span class="line"></span><br><span class="line">Time: 12857.763 ms (00:12.858)</span><br></pre></td></tr></table></figure><h3 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h3><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.user_name,b.fee <span class="keyword">from</span> <span class="keyword">users</span> a,phone_fee b <span class="keyword">where</span> a.user_id=b.user_id <span class="keyword">and</span> a.user_id=<span class="number">4999998</span>;</span><br><span class="line"></span><br><span class="line">USER_NAME  FEE</span><br><span class="line"><span class="comment">-------------------------------------------------- ----------</span></span><br><span class="line">C58IV8Z0HKYO       297.78</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.27</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select a.user_name,b.fee from users a,phone_fee b where a.user_id=b.user_id and a.user_id=4999998;</span><br><span class="line">  user_name   |  fee</span><br><span class="line"><span class="comment">--------------+--------</span></span><br><span class="line"> C58IV8Z0HKYO | 297.78</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 139.633 ms</span><br></pre></td></tr></table></figure><p>psql的执行计划<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">testdb=# explain select a.user_name,b.fee from users a,phone_fee b where a.user_id=b.user_id and a.user_id=4999998;</span><br><span class="line">                                                                         QUERY PLAN</span><br><span class="line"></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-------------------------------------------------------------</span></span><br><span class="line"> Nested Loop  (cost=20000.00..52502.50 rows=1000000 width=134)</span><br><span class="line">   -&gt;  Foreign Scan on users a  (cost=10000.00..20000.00 rows=1000 width=134)</span><br><span class="line">         Oracle query: <span class="keyword">SELECT</span> <span class="comment">/*f121f12a8cbc233ce7f3a1c56794af92*/</span> r1.<span class="string">"USER_ID"</span>, r1.<span class="string">"USER_NAME"</span></span><br><span class="line"> <span class="keyword">FROM</span> <span class="string">"DBUSER"</span>.<span class="string">"USERS"</span> r1 <span class="keyword">WHERE</span> (r1.<span class="string">"USER_ID"</span> = <span class="number">4999998</span>)</span><br><span class="line">   -&gt;  Materialize  (<span class="keyword">cost</span>=<span class="number">10000.00</span>.<span class="number">.20005</span><span class="number">.00</span> <span class="keyword">rows</span>=<span class="number">1000</span> width=<span class="number">32</span>)</span><br><span class="line">         -&gt;  Foreign <span class="keyword">Scan</span> <span class="keyword">on</span> phone_fee b  (<span class="keyword">cost</span>=<span class="number">10000.00</span>.<span class="number">.20000</span><span class="number">.00</span> <span class="keyword">rows</span>=<span class="number">1000</span> width=<span class="number">32</span>)</span><br><span class="line">               <span class="keyword">Oracle</span> <span class="keyword">query</span>: <span class="keyword">SELECT</span> <span class="comment">/*d1bc90927d98c625ddda179fef4df315*/</span> r2.<span class="string">"USER_ID"</span>, r2.<span class="string">"FEE"</span></span><br><span class="line"> <span class="keyword">FROM</span> <span class="string">"DBUSER"</span>.<span class="string">"PHONE_FEE"</span> r2 <span class="keyword">WHERE</span> (r2.<span class="string">"USER_ID"</span> = <span class="number">4999998</span>)</span><br><span class="line">(<span class="number">6</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure></p><p>orderby</p><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select users.user_id,phone_fee.fee,phone_fee.fee_date from users ,phone_fee where users.user_id=phone_fee.user_id order by users.user_id desc  offset 0 rows fetch next 5 rows only;</span><br><span class="line"></span><br><span class="line">   USER_ID  FEE FEE_DATE</span><br><span class="line"><span class="comment">---------- ---------- ---------</span></span><br><span class="line">   4999998     297.78 30-APR-15</span><br><span class="line">   4999997     243.36 31-MAY-15</span><br><span class="line">   499999669.79 29-JAN-12</span><br><span class="line">   499999291.03 07-OCT-17</span><br><span class="line">   4999992     268.93 01-FEB-15</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.71</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select users.user_id,phone_fee.fee,phone_fee.fee_date from users ,phone_fee where users.user_id=phone_fee.user_id order by users.user_id desc  offset 0 rows fetch next 5 rows only;</span><br><span class="line"> user_id |  fee   |  fee_date</span><br><span class="line"><span class="comment">---------+--------+------------</span></span><br><span class="line"> 4999998 | 297.78 | 2015-04-30</span><br><span class="line"> 4999997 | 243.36 | 2015-05-31</span><br><span class="line"> 4999996 |  69.79 | 2012-01-29</span><br><span class="line"> 4999992 |  91.03 | 2017-10-07</span><br><span class="line"> 4999992 | 268.93 | 2015-02-01</span><br><span class="line">(5 rows)</span><br><span class="line"></span><br><span class="line">Time: 27477.661 ms (00:27.478)</span><br></pre></td></tr></table></figure><p>psql的执行计划<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">testdb=# explain select users.user_id,phone_fee.fee,phone_fee.fee_date from users ,phone_fee where users.user_id=phone_fee.user_id order by users.user_id desc  offset 0 rows fetch next 5 rows only;</span><br><span class="line"></span><br><span class="line">   QUERY PLAN</span><br><span class="line"></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line"> Limit  (cost=20016.61..20016.62 rows=5 width=36)</span><br><span class="line">   -&gt;  Sort  (cost=20016.61..20019.11 rows=1000 width=36)</span><br><span class="line">         Sort Key: users.user_id DESC</span><br><span class="line">         -&gt;  Foreign Scan  (cost=10000.00..20000.00 rows=1000 width=36)</span><br><span class="line">               Oracle query: <span class="keyword">SELECT</span> <span class="comment">/*c6de86645f2edcce90957e3283ade08d*/</span> r1.<span class="string">"USER_ID"</span>, r2.<span class="string">"FEE"</span></span><br><span class="line">, r2.<span class="string">"FEE_DATE"</span> <span class="keyword">FROM</span> (<span class="string">"DBUSER"</span>.<span class="string">"USERS"</span> r1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="string">"DBUSER"</span>.<span class="string">"PHONE_FEE"</span> r2 <span class="keyword">ON</span> (r1.<span class="string">"USER_ID"</span> =</span><br><span class="line"> r2.<span class="string">"USER_ID"</span>))</span><br><span class="line">(<span class="number">5</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure></p><p>oracle session中执行的sql</p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180802105716.png" alt=""></p><p>流量情况</p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180802105550.png" alt=""></p><p>可见oracle_fdw实质上发送的是连接sql，拿到oracle返回的结果，再进行排序的。因此中间消耗的时间里，网络传输数据的消耗是占很大部分的。</p><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>oracle_fdw的查询效率主要受发送给oracle的sql查询结果集的数据量影响的，结果集越大，网络IO消耗越多，对查询的影响越大。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;在PostgreSQL中使用oracle-fdw&quot;&gt;&lt;a href=&quot;#在PostgreSQL中使用oracle-fdw&quot; class=&quot;headerlink&quot; title=&quot;在PostgreSQL中使用oracle_fdw&quot;&gt;&lt;/a&gt;在PostgreSQL中使用
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
      <category term="oracle" scheme="https://oyo-byte.github.io/tags/oracle/"/>
    
  </entry>
  
</feed>
