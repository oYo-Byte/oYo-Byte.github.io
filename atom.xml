<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>oYo-Byte</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://oyo-byte.github.io/"/>
  <updated>2018-08-08T10:00:12.436Z</updated>
  <id>https://oyo-byte.github.io/</id>
  
  <author>
    <name>oYo-Byte</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>学习PostgreSQL的FDW(#4)-其他函数说明 II</title>
    <link href="https://oyo-byte.github.io/2018/08/08/learn_about_pgfdw_part4/"/>
    <id>https://oyo-byte.github.io/2018/08/08/learn_about_pgfdw_part4/</id>
    <published>2018-08-08T09:52:34.432Z</published>
    <updated>2018-08-08T10:00:12.436Z</updated>
    
    <content type="html"><![CDATA[<p>继上篇<a href="https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part3/">学习PostgreSQL的FDW(#3)-其他函数说明 I</a>，继续说说其余回调函数</p><h2 id="用于行锁定的FDW回调函数"><a href="#用于行锁定的FDW回调函数" class="headerlink" title="用于行锁定的FDW回调函数"></a>用于行锁定的FDW回调函数</h2><p>如果一个FDW 希望支持<em>后期行锁定</em>，必须提供以下回调函数：</p><ul><li>GetForeignRowMarkType</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RowMarkType</span><br><span class="line">GetForeignRowMarkType (RangeTblEntry *rte,</span><br><span class="line">                       LockClauseStrength strength);</span><br></pre></td></tr></table></figure><p>报告要对一个外部表使用哪个行标记选项。rte是该表的RangeTblEntry节点，而strength描述FOR UPDATE/SHARE子句（如果有）所要求的锁长度。结果必须是RowMarkType枚举类型的一个成员。</p><p>这个函数在查询规划期间会为每一个出现在UPDATE、DELETE或者SELECT FOR UPDATE/SHARE查询中的外部表调用，并且该外部表不是UPDATE和DELETE的目标。</p><p>如果<code>GetForeignRowMarkType</code>指针被设置为NULL，将总是使用ROW_MARK_COPY选项（这意味着将不会调用RefetchForeignRow，因此也不必提供它）。</p><ul><li>RefetchForeignRow </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HeapTuple</span><br><span class="line">RefetchForeignRow(EState *estate,</span><br><span class="line">                  ExecRowMark *erm,</span><br><span class="line">                  Datum rowid,</span><br><span class="line">                  <span class="keyword">bool</span> *updated);</span><br></pre></td></tr></table></figure><p>从外部表中重新取得一个元组，如有必要先锁定它。estate是该查询的全局执行状态。erm是描述目标外部表以及要获取的行锁类型（如果有）的ExecRowMark结构。rowid标识要取得的元组。updated是一个输出参数。</p><p>这个函数应该返回被取得的元组的一个已经分配内存的拷贝，如果无法得到行锁则返回NULL。要获得的行锁由erm-&gt;markType定义，它是之前由<code>GetForeignRowMarkType</code>返回的值（ROW_MARK_REFERENCE标识只重新取得元组但不获得任何锁，这个例程将不会看到ROW_MARK_COPY）。</p><p>此外，如果取得的是一个更新过的版本而不是之前获得的同一版本，*updated应被设置为true（如果 FDW 无法确定这一点，推荐总是返回true）。</p><p>注意在默认情况下，获取行锁失败应该导致产生错误。如果erm-&gt;waitPolicy指定了SKIP LOCKED，只有返回NULL才是合适的。</p><p>rowid是要被重新取得的行之前读到的ctid值。尽管rowid值被作为Datum传递，但是目前它只能被读作tid。选择该函数 API 是希望未来能允许其他的行 ID 数据类型。</p><p>如果<code>RefetchForeignRow</code>指针被设置为NULL，重新取得行的尝试将会失败并伴随有一个错误消息。</p><ul><li>RecheckForeignScan </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span></span><br><span class="line">RecheckForeignScan(ForeignScanState *node,</span><br><span class="line">                   TupleTableSlot *slot);</span><br></pre></td></tr></table></figure><p>重新检查之前返回的元组是否仍然匹配相关的扫描和连接条件，并且可能提供该元组的一个修改版本。对于不执行连接下推的外部数据包装器，通常把这设置为NULL并且恰当地设置fdw_recheck_quals会更方便。不过当外部连接被下推时，把与所有基表相关的检查重新应用在结果元组上是不够的，即便所有需要的属性都存在也是如此，因为匹配某个条件失败可能会导致某些属性变成 NULL，而不是没有元组被返回。<code>RecheckForeignScan</code>能够重新检查条件，并且在它们仍然满足时返回真，否则返回假，但是它也能够在提供的槽中存储一个替换元组。</p><p>要实现连接下推，外部数据包装器通常将构造一个可替代的本地连接计划，它只被用来做重新检查。这将变成ForeignScan的外子计划。在需要一次重新检查时，这个子计划可以被执行并且结果元组可以被存储在槽中。这个计划不需要效率很高，因为不会有基表返回超过一行。例如，它可以把所有的连接实现为嵌套循环。函数<code>GetExistingLocalJoinPath</code>可以被用来在已有的路径中搜索合适的本地连接路径，它可以被用作替换的本地连接计划。<code>GetExistingLocalJoinPath</code>会在指定连接关系的路径列表中搜索一个非参数化路径（如果没有找到这样的路径，它会返回 NULL，这种情况下外部数据包装器可以自行构造本地路径或者可以选择不为这个连接创建访问路径）。</p><h2 id="EXPLAIN-相关FDW回调函数"><a href="#EXPLAIN-相关FDW回调函数" class="headerlink" title="EXPLAIN 相关FDW回调函数"></a>EXPLAIN 相关FDW回调函数</h2><ul><li>ExplainForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ExplainForeignScan(ForeignScanState *node,</span><br><span class="line">                   ExplainState *es);</span><br></pre></td></tr></table></figure><p>为一个外部表扫描打印额外的EXPLAIN输出。这个函数可以调用ExplainPropertyText和相关函数来向EXPLAIN输出中增加域。es中的标志域可以被用来决定什么将被打印，并且ForeignScanState节点的状态可以被检查来为EXPLAIN ANALYZE提供运行时统计数据。</p><p>如果<code>ExplainForeignScan</code>指针被设置为NULL，在EXPLAIN期间不会打印任何额外的信息。</p><ul><li>ExplainForeignModify </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ExplainForeignModify(ModifyTableState *mtstate,</span><br><span class="line">                     ResultRelInfo *rinfo,</span><br><span class="line">                     List *fdw_private,</span><br><span class="line">                     <span class="keyword">int</span> subplan_index,</span><br><span class="line">                     struct ExplainState *es);</span><br></pre></td></tr></table></figure><p>为一个外部表更新打印额外的EXPLAIN输出。这个函数可以调用ExplainPropertyText和相关函数来向EXPLAIN输出中增加域。es中的标志域可以被用来决定什么将被打印，并且ModifyTableState节点的状态可以被检查来为EXPLAIN ANALYZE提供运行时统计数据。前四个参数和<code>BeginForeignModify</code>相同。</p><p>如果<code>ExplainForeignModify</code>指针被设置为NULL，在EXPLAIN期间不会打印任何额外的信息。</p><ul><li>ExplainDirectModify</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ExplainDirectModify(ForeignScanState *node,</span><br><span class="line">                    ExplainState *es);</span><br></pre></td></tr></table></figure><p>为远程服务器上的直接修改打印额外的EXPLAIN输出。这个函数可以调用ExplainPropertyText和相关函数来为EXPLAIN输出增加域。es中的标志域可以被用来判断要打印什么，并且在EXPLAIN ANALYZE情况中可以观察ForeignScanState节点的状态来提供运行时统计信息。</p><p>如果<code>ExplainDirectModify</code>指针被设置为NULL，EXPLAIN期间不会打印出额外的信息。</p><h2 id="ANALYZE-相关FDW回调函数"><a href="#ANALYZE-相关FDW回调函数" class="headerlink" title="ANALYZE 相关FDW回调函数"></a>ANALYZE 相关FDW回调函数</h2><ul><li>AnalyzeForeignTable</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span></span><br><span class="line">AnalyzeForeignTable (Relation relation,</span><br><span class="line">                     AcquireSampleRowsFunc *func,</span><br><span class="line">                     BlockNumber *totalpages);</span><br></pre></td></tr></table></figure><p>当ANALYZE被执行在一个外部表上时会调用这个函数。如果FDW可以为这个外部表收集统计信息，它会返回true并提供一个函数指针，该函数将将从func中的表上收集采样行，外加totalpages中页面中的表尺寸估计值。否则，返回false。</p><p>如果FDW不支持为任何表收集统计信息，<code>AnalyzeForeignTable</code>指针可以被设置为NULL。</p><p>如果提供，采样收集函数必须具有签名</p><ul><li>AcquireSampleRowsFunc</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">AcquireSampleRowsFunc(Relation relation,</span><br><span class="line">                      <span class="keyword">int</span> elevel,</span><br><span class="line">                      HeapTuple *rows,</span><br><span class="line">                      <span class="keyword">int</span> targrows,</span><br><span class="line">                      <span class="keyword">double</span> *totalrows,</span><br><span class="line">                      <span class="keyword">double</span> *totaldeadrows);</span><br></pre></td></tr></table></figure><p>应该从该表上收集最多targrows行的一个随机采样并将它存放到调用者提供的rows数组中。实际被收集的行的数量必须被返回。另外，将表中有效行和死亡行的总数存储到输出参数totalrows和totaldeadrows中（如果FDW没有死亡行的概念，将totaldeadrows设置为 0 ）。</p><h2 id="IMPORT-FOREIGN-SCHEMA-回调函数"><a href="#IMPORT-FOREIGN-SCHEMA-回调函数" class="headerlink" title="IMPORT FOREIGN SCHEMA 回调函数"></a>IMPORT FOREIGN SCHEMA 回调函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List *</span><br><span class="line">ImportForeignSchema (ImportForeignSchemaStmt *stmt, Oid serverOid);</span><br></pre></td></tr></table></figure><p>取得一个外部表创建命令的列表。在执行<code>IMPORT FOREIGN SCHEMA</code>时会调用这个函数，并且会把该语句的解析树以及要使用的外部服务器的 OID 传递给它。它应该返回一个 C 字符串的列表，每一个必须包含一个<code>CREATE FOREIGN TABLE</code>命令。这些命令将被核心服务器所解析和执行。</p><p>在ImportForeignSchemaStmt结构中，remote_schema是要从其中导入这些表的远程模式的名称。list_type标识如何过滤表名：FDW_IMPORT_SCHEMA_ALL表示该远程模式中的所有表都应该被导入（这种情况下table_list为空），FDW_IMPORT_SCHEMA_LIMIT_TO表示只包括table_list中列出的表，而FDW_IMPORT_SCHEMA_EXCEPT则表示排除table_list中列出的表。options是一个用于该导入处理的选项列表。选项的含义由 FDW 决定。例如，一个 FDW 可以用一个选项来定义是否应该导入列的NOT NULL属性。这些选项不需要与那些 FDW 支持的数据库对象选项有什么关系。</p><p>FDW 可能会忽略ImportForeignSchemaStmt的local_schema域，因为核心服务器会自动地向解析好的<code>CREATE FOREIGN TABLE</code>命令中插入本地模式的名称。</p><p>FDW 也不必担心实现list_type以及table_list所指定的过滤，因为核心服务器将自动根据那些选项跳过为被排除的表所返回的命令。不过，起初就避免为被排除的表创建命令当然更好。函数<code>IsImportableForeignTable()</code>可以用来测试一个给定的外部表名是否能通过该过滤器。</p><p>如果 FDW 不支持导入表定义，<code>ImportForeignSchema</code>指针可以被设置为NULL。</p><h2 id="并行执行-回调函数"><a href="#并行执行-回调函数" class="headerlink" title="并行执行 回调函数"></a>并行执行 回调函数</h2><p>ForeignScan节点可以选择支持并行执行。一个并行的 ForeignScan将在多个进程中执行， 并且在相互合作的进程中每个行必须只被返回一次。要做到这样， 进程可以通过动态共享内存的固定尺寸块来协作。并不保证在每一个进程中这部份共享内存都被映射到相同的地址， 因此必须不能包含指针。下面的函数都是可选的，但是如果要支持并行执行需要提供大多数函数。</p><ul><li>IsForeignScanParallelSafe<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span></span><br><span class="line">IsForeignScanParallelSafe(PlannerInfo *root, RelOptInfo *rel,</span><br><span class="line">                          RangeTblEntry *rte);</span><br></pre></td></tr></table></figure></li></ul><p>测试一个扫描是否可以在一个并行工作者中被执行。只有当规划器相信可以使用并行计划时才会调用这个函数，如果该扫描在并行工作者中可以安全运行这个函数应该返回真。如果远程数据源具有事务语义，情况通常都不是这样，除非工作者到数据的连接能够以某种方式共享与领导者相同的事务环境。</p><p>如果没有定义这个函数，则假定该扫描必须被放置在并行领导者中。注意返回真并不意味着该扫描本身可以被并行完成，只是说明该扫描可以在一个并行工作者中执行。因此，即便当不支持并行执行时，定义这个方法也是有用的。</p><ul><li>EstimateDSMForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Size</span><br><span class="line">EstimateDSMForeignScan(ForeignScanState *node, ParallelContext *pcxt);</span><br></pre></td></tr></table></figure><p>估算并行操作所需的动态共享内存的数量。这可能比实际要用的数量更大，但是绝不能更小。返回值的单位是字节。该函数是可选的，如果不需要可以省略；但是如果省略它， 接下来的三个函数也必须省略，因为没有分配共享内存将给FDW使用。</p><ul><li>InitializeDSMForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">InitializeDSMForeignScan(ForeignScanState *node, ParallelContext *pcxt,</span><br><span class="line">                         <span class="keyword">void</span> *coordinate);</span><br></pre></td></tr></table></figure><p>初始化并行操作所需的动态共享内存。coordinate指向共享内存区域， 其大小等于EstimateDSMForeignScan的返回值。 该函数是可选的，如果不需要可以省略。</p><ul><li>ReInitializeDSMForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ReInitializeDSMForeignScan(ForeignScanState *node, ParallelContext *pcxt,</span><br><span class="line">                           <span class="keyword">void</span> *coordinate);</span><br></pre></td></tr></table></figure><p>当外部扫描计划节点即将被重新扫描时，重新初始化并行操作所需的动态共享内存。该函数是可选的，如果不需要可以省略。推荐的做法是此函数仅重置共享状态， 而<code>ReScanForeignScan</code>函数仅重置本地状态。目前， 这个函数会在<code>ReScanForeignScan</code>之前调用，但最好不要依赖这个顺序。</p><ul><li>InitializeWorkerForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">InitializeWorkerForeignScan(ForeignScanState *node, shm_toc *toc,</span><br><span class="line">                            <span class="keyword">void</span> *coordinate);</span><br></pre></td></tr></table></figure><p>基于<code>InitializeDSMForeignScan</code>期间领导者设置的共享状态初始化并行工作者的本地状态。这个函数是可选的， 如果不需要可以省略。</p><ul><li>ShutdownForeignScan</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">ShutdownForeignScan(ForeignScanState *node);</span><br></pre></td></tr></table></figure><p>预计节点将不会执行完成时释放资源。这在所有情况下都不被调用；有时， <code>EndForeignScan</code>可能会在没有先调用此函数的情况下调用。由于并行查询使用的DSM段在调用此回调后即被销毁， 因此希望在DSM段消失之前采取某些操作的外部数据包装器应实现此方法。</p><h2 id="用于路径重新参数化-的回调函数"><a href="#用于路径重新参数化-的回调函数" class="headerlink" title="用于路径重新参数化 的回调函数"></a>用于路径重新参数化 的回调函数</h2><ul><li>ReparameterizeForeignPathByChild</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List *</span><br><span class="line">ReparameterizeForeignPathByChild(PlannerInfo *root, List *fdw_private,</span><br><span class="line">                                 RelOptInfo *child_rel);</span><br></pre></td></tr></table></figure><p>在将由给定子关系child_rel的最顶层父级参数化的路径转换为由子关系参数化时，调用此函数。该函数用于重新参数化任何路径或转换保存在给定ForeignPath节点的fdw_private 成员中的任何表达式。回调根据需要使用reparameterize_path_by_child，adjust_appendrel_attrs也可以adjust_appendrel_attrs_multilevel。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;继上篇&lt;a href=&quot;https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part3/&quot;&gt;学习PostgreSQL的FDW(#3)-其他函数说明 I&lt;/a&gt;，继续说说其余回调函数&lt;/p&gt;
&lt;h2 id=&quot;用于行锁
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
  </entry>
  
  <entry>
    <title>学习PostgreSQL的FDW(#3)-其他函数说明 I</title>
    <link href="https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part3/"/>
    <id>https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part3/</id>
    <published>2018-08-07T09:47:21.871Z</published>
    <updated>2018-08-09T08:17:19.893Z</updated>
    
    <content type="html"><![CDATA[<p>上两篇文章主要介绍了实现FDW的7个必须实现的扫描相关的回调函数，<a href="https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/">学习PostgreSQL的FDW(#1)</a>，<br><a href="https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part2/">学习PostgreSQL的FDW(#2)-源码跟踪</a>，这边就继续说说其余32个回调函数</p><h2 id="用于扫描外部连接的回调函数"><a href="#用于扫描外部连接的回调函数" class="headerlink" title="用于扫描外部连接的回调函数"></a>用于扫描外部连接的回调函数</h2><p>如果一个 FDW 支持远程执行外部连接（而不是先把两个表的数据取到本地然后做本地连接），它应该提供这个回调函数:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">GetForeignJoinPaths (PlannerInfo *root,</span><br><span class="line">                     RelOptInfo *joinrel,</span><br><span class="line">                     RelOptInfo *outerrel,</span><br><span class="line">                     RelOptInfo *innerrel,</span><br><span class="line">                     JoinType jointype,</span><br><span class="line">                     JoinPathExtraData *extra);</span><br></pre></td></tr></table></figure></p><p>它为两个（或更多）同属于一台外部服务器的外部表的连接创建可能的访问路径。这个可选的函数会在查询规划过程中被调用。和<code>GetForeignPaths</code>一样，这个函数应该为提供的joinrel生成ForeignPath路径，并且调用add_path把这些路径加入到该连接应该考虑的路径集合中。但是和<code>GetForeignPaths</code>不一样的是，不需要这个函数产生最少一个路径，因为涉及本地连接的路径总是可用的。</p><p>注意的是，对于相同的连接关系，将会重复调用此函数来生成内外关系的不同组合。FDW需要负责最小化其中重复的工作。</p><p>如果一个ForeignPath路径被选中用于该连接，它将在整个连接处理中存在，为其中的成分表和子连接产生的路径将不会被使用。后续对该连接路径的处理大部分和扫描单个外部表的路径一样。一点不同是ForeignScan计划节点的scanrelid应该被设置为零，因为它表示的不是单个关系，而是用ForeignScan节点的fs_relids属性来表示被连接的关系集合（fs_relids会被核心规划器代码自动设置，不需要由 FDW 填充）。另一点不同是，由于一个远程连接的列的列表无法在系统目录中找到，FDW必须用一个合适的TargetEntry节点列表来填充fdw_scan_tlist，表示运行时它返回的元组中提供的列的集合。</p><h2 id="用于规划扫描-连接-后处理的回调函数"><a href="#用于规划扫描-连接-后处理的回调函数" class="headerlink" title="用于规划扫描/连接 后处理的回调函数"></a>用于规划扫描/连接 后处理的回调函数</h2><p>如果一个FDW支持执行远程的扫描/连接 后处理，例如远程聚集，应该事先这个回调函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">GetForeignUpperPaths(PlannerInfo *root,</span><br><span class="line">                     UpperRelationKind stage,</span><br><span class="line">                     RelOptInfo *input_rel,</span><br><span class="line">                     RelOptInfo *output_rel,</span><br><span class="line">                     <span class="keyword">void</span> *extra);</span><br></pre></td></tr></table></figure></p><p>为<em>上层关系</em>处理创建可能的访问路径，这是规划器针对所有扫描/连接后查询处理的术语，例如聚集、窗口函数、排序和表更新。在查询规划期间会调用这个可选的函数。当前，只有当该查询中涉及的所有基本关系都属于同一个 FDW 时才会调用这个函数。这个函数应该让 FDW 知道如何远程执行的任何扫描/连接 后处理生成ForeignPath路径，并且调用add_path把这些路径加入到上层关系中。就GetForeignJoinPaths来说，并不要求这个函数在创建任何路径时都能成功，因为涉及本地处理的路径总是可行的。</p><p>stage参数表示当前正在考虑的是哪一个扫描/连接后处理步骤。output_rel是接收表示这一个步骤的路径的上层关系，而input_rel是表示这个步骤输入的关系。extra参数提供了其他详细信息。目前，它仅能设置成UPPERREL_PARTIAL_GROUP_AGG或UPPERREL_GROUP_AGG，在这种情况下，它指向的是GroupPathExtraData结构体。（注意被加入到output_rel中的ForeignPath路径通常对input_rel的路径没有直接的依赖，因为它们的处理被认为是在外部处理的。不过，检查为前一个处理步骤生成的路径有助于避免冗余的规划工作）。</p><p>使用gdb追踪调用情况<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b postgresGetForeignUpperPaths</span><br><span class="line">Breakpoint 1 at 0x7f2cea563a20: file postgres_fdw.c, line 5437.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, postgresGetForeignUpperPaths (root=0xf7ce50, stage=UPPERREL_GROUP_AGG, </span><br><span class="line">    input_rel=0xf7d3d0, output_rel=0x1063910, extra=0x7ffc84ff94e0) at postgres_fdw.c:5437</span><br><span class="line">5437<span class="keyword">if</span> (!input_rel-&gt;fdw_private ||</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresGetForeignUpperPaths (root=0xf7ce50, stage=UPPERREL_GROUP_AGG, input_rel=0xf7d3d0, output_rel=0x1063910, extra=0x7ffc84ff94e0) at postgres_fdw.c:5437</span></span><br><span class="line"><span class="comment">#1  0x00000000006807bf in create_ordinary_grouping_paths (root=root@entry=0xf7ce50, input_rel=input_rel@entry=0xf7d3d0, grouped_rel=grouped_rel@entry=0x1063910, agg_costs=agg_costs@entry=0x7ffc84ff94b0, gd=gd@entry=0x0, extra=extra@entry=0x7ffc84ff94e0, partially_grouped_rel_p=partially_grouped_rel_p@entry=0x7ffc84ff9488) at planner.c:4059</span></span><br><span class="line"><span class="comment">#2  0x00000000006831e9 in create_grouping_paths (gd=0x0, agg_costs=0x7ffc84ff94b0, target_parallel_safe=true, target=0x1063768, input_rel=0xf7d3d0, root=0xf7ce50) at planner.c:3783</span></span><br><span class="line"><span class="comment">#3  grouping_planner (root=root@entry=0xf7ce50, inheritance_update=inheritance_update@entry=false, tuple_fraction=&lt;optimized out&gt;, tuple_fraction@entry=0) at planner.c:2037</span></span><br><span class="line"><span class="comment">#4  0x0000000000684218 in subquery_planner (glob=glob@entry=0xf7cdc0, parse=parse@entry=0xf7c6a8, parent_root=parent_root@entry=0x0, hasRecursion=hasRecursion@entry=false, tuple_fraction=tuple_fraction@entry=0) at planner.c:966</span></span><br><span class="line"><span class="comment">#5  0x0000000000685236 in standard_planner (parse=0xf7c6a8, cursorOptions=256, boundParams=0x0) at planner.c:405</span></span><br><span class="line"><span class="comment">#6  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0xf7c6a8, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#7  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#8  0x0000000000721cda in exec_simple_query (query_string=0xf7b810 "select count(*) from t_fdw ;") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0xfa5528, dbname=0xfa5410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0xf9d3f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0xf9d3f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0xf763c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0xf763c0) at main.c:228</span></span><br></pre></td></tr></table></figure></p><h2 id="更新外部表的回调函数"><a href="#更新外部表的回调函数" class="headerlink" title="更新外部表的回调函数"></a>更新外部表的回调函数</h2><table><thead><tr><th style="text-align:left">回调函数</th><th style="text-align:left">作用</th></tr></thead><tbody><tr><td style="text-align:left">AddForeignUpdateTargets</td><td style="text-align:left">保证FDW能够找到要更新或删除的准确行</td></tr><tr><td style="text-align:left">PlanForeignModify</td><td style="text-align:left">执行外部表上插入、更新或删除所需的任何附加规划动作</td></tr><tr><td style="text-align:left">BeginForeignModify</td><td style="text-align:left">开始执行一个外部表修改操作，执行任何先于实际表修改的初始化工作</td></tr><tr><td style="text-align:left">ExecForeignInsert</td><td style="text-align:left">插入一个元组到外部表</td></tr><tr><td style="text-align:left">ExecForeignUpdate</td><td style="text-align:left">更新外部表中的一个元组</td></tr><tr><td style="text-align:left">ExecForeignDelete</td><td style="text-align:left">从外部表删除一个元组</td></tr><tr><td style="text-align:left">EndForeignModify</td><td style="text-align:left">结束表更新并释放资源</td></tr><tr><td style="text-align:left">BeginForeignInsert</td><td style="text-align:left">开始在外表上执行插入操作(分区表或COPY FROM命令)，在实际插入之前执行所需的任何初始化</td></tr><tr><td style="text-align:left">EndForeignInsert</td><td style="text-align:left">结束表插入并释放资源(分区表或COPY FROM命令)</td></tr><tr><td style="text-align:left">IsForeignRelUpdatable</td><td style="text-align:left">报告指定的外部表支持哪些更新操作</td></tr><tr><td style="text-align:left">PlanDirectModify</td><td style="text-align:left">决定在远程服务器上执行直接修改是否安全</td></tr><tr><td style="text-align:left">BeginDirectModify</td><td style="text-align:left">准备在远程服务器上执行一次直接修改，执行直接修改所需的任何初始化工作</td></tr><tr><td style="text-align:left">IterateDirectModify</td><td style="text-align:left">执行直接修改操作</td></tr><tr><td style="text-align:left">EndDirectModify</td><td style="text-align:left">在远程服务器上的直接修改后进行清理</td></tr></tbody></table><p><br><br>如果一个FDW支持可写的外部表，根据FDW的需要和功能，应该提供以下某些或者全部回调函数：</p><ul><li>AddForeignUpdateTargets  </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">AddForeignUpdateTargets(Query *parsetree,</span><br><span class="line">                        RangeTblEntry *target_rte,</span><br><span class="line">                        Relation target_relation);</span><br></pre></td></tr></table></figure><p>UPDATE和DELETE操作是在之前由表扫描函数取出的行上被执行的。FDW可能需要额外的信息（例如一个行ID或主键列的值）来保证它能够找到要更新或删除的准确行。要支持这些要求，这个函数可以向列列表中增加额外的隐藏或“junk”的目标列，它们在一个UPDATE或DELETE期间会被从外部表中获取。</p><p>要做到这一点，向parsetree-&gt;targetList中增加TargetEntry项，它们包含要被获取的额外值的表达式。每一个这样的项必须被标记为resjunk = true，并且必须有一个可区分的resname用于在执行期间标识它。请避免使用匹配ctidN、wholerow或wholerowN的名字，因为核心系统可能会生成使用这些名字的junk列。如果额外的表达式比简单的Vars更复杂，在将它们添加到目标列表之前，必须通过eval_const_expressions运行它们。</p><p>这个函数在重写器中被调用，而不是在规划器中，因此可用的信息与在规划例程中的有点区别。parsetree是UPDATE或DELETE命令的分析树，而target_rte和target_relation描述目标外部表。</p><p>如果<code>AddForeignUpdateTargets</code>指针被设置为NULL，则不会有额外的目标表达式被加入（这将使得我们不可能实现DELETE操作，而UPDATE则还有可能是可行的，前提是FDW依赖一个未改变的主键来标识行）。</p><ul><li>PlanForeignModify  </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List *</span><br><span class="line">PlanForeignModify(PlannerInfo *root,</span><br><span class="line">                  ModifyTable *plan,</span><br><span class="line">                  Index resultRelation,</span><br><span class="line">                  <span class="keyword">int</span> subplan_index);</span><br></pre></td></tr></table></figure><p>执行外部表上插入、更新或删除所需的任何附加规划动作。这个函数生成FDW私有信息，该信息将被附加到执行该更新动作的ModifyTable计划节点。这个私有信息的形式必须是一个List，并将会在执行阶段被传递给BeginForeignModify。</p><p>root是规划器关于该查询的全局信息。plan是ModifyTable计划节点，它除了fdwPrivLists属性之外是完整的。resultRelation通过目标外部表的范围表索引来标识它。subplan_index标识这是ModifyTable计划节点的哪个目标，从零开始计数；如果你希望索引到plan-&gt;plans或其他plan节点的子结构中，请使用它。</p><p>如果<code>PlanForeignModify</code>指针被设置为NULL，则不会有额外的计划时动作被执行，并且传递给BeginForeignModify的fdw_private列表也将为 NIL。</p><ul><li>BeginForeignModify  </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">BeginForeignModify (ModifyTableState *mtstate,</span><br><span class="line">                    ResultRelInfo *rinfo,</span><br><span class="line">                    List *fdw_private,</span><br><span class="line">                    <span class="keyword">int</span> subplan_index,</span><br><span class="line">                    <span class="keyword">int</span> eflags);</span><br></pre></td></tr></table></figure><p>开始执行一个外部表修改操作。这个函数在执行器启动期间被调用。它应该执行任何先于实际表修改的初始化工作。随后，<code>ExecForeignInsert</code>、<code>ExecForeignUpdate</code>或<code>ExecForeignDelete</code>将被为每一个将被插入、更新或删除的元组调用。</p><p>mtstate是要被执行的ModifyTable计划节点的状态信息；通过这个结构可以得到关于规划和执行阶段的全局数据。rinfo是描述目标外部表的ResultRelInfo结构（ResultRelInfo的ri_FdwState属性用于FDW来存储它在此操作中需要的任何私有状态）。fdw_private包含<code>PlanForeignModify</code>生成的私有数据。subplan_index标识这是ModifyTable计划节点的哪个目标。eflags包含描述执行器对该计划节点操作模式的标志位。</p><p>注意当(eflags &amp; EXEC_FLAG_EXPLAIN_ONLY)为真，这个函数不应执行任何外部可见的动作；它只应该做最少的工作来创建<code>ExplainForeignModify</code>和<code>EndForeignModify</code>可用的节点状态。</p><p>如果<code>BeginForeignModify</code>指针被设置为NULL，在执行器启动期间将不会采取任何动作。</p><ul><li>ExecForeignInsert</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">ExecForeignInsert(EState *estate,</span><br><span class="line">                  ResultRelInfo *rinfo,</span><br><span class="line">                  TupleTableSlot *slot,</span><br><span class="line">                  TupleTableSlot *planSlot);</span><br></pre></td></tr></table></figure><p>插入一个元组到外部表。estate是查询的全局执行状态。rinfo是描述目标外部表的ResultRelInfo结构。slot包含要被插入的元组；它将匹配外部表的行类型定义。planSlot包含由ModifyTable计划节点的子计划生成的元组；它与slot不同，它可能包含额外的“junk”列（INSERT情况通常不关心planSlot，但是为了完整性还是在这里提供它）。</p><p>返回值可以是一个包含实际被插入的数据的槽（这可能会和所提供的数据不同，例如一个触发器动作的结果），或者为 NULL 表示实际没有插入行（还是触发器的结果）。被传入的slot可以被重用于这个目的。</p><p>在返回槽中的数据只有在INSERT查询具有一个RETURNING子句或者外部表具有一个AFTER ROW触发器时才被使用。触发器要求所有的列，但是 FDW 应该选择优化成根据RETURNING子句的内容返回某些或全部列。不管怎样，某些槽必须被返回来指示成功，否则查询报告的行计数将会是错误的。</p><p>如果<code>ExecForeignInsert</code>指针被设置为NULL，尝试向外部表插入将会失败并报告一个错误消息。</p><ul><li>ExecForeignUpdate</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">ExecForeignUpdate(EState *estate,</span><br><span class="line">                  ResultRelInfo *rinfo,</span><br><span class="line">                  TupleTableSlot *slot,</span><br><span class="line">                  TupleTableSlot *planSlot);</span><br></pre></td></tr></table></figure><p>更新外部表中的一个元组。estate是查询的全局执行状态。rinfo是描述目标外部表的ResultRelInfo结构。slot包含元组的新数据；它将匹配外部表的行类型定义。planSlot包含由ModifyTable计划节点的子计划生成的元组；它与slot不同，它可能包含额外的“junk”列。特殊地，任何<code>AddForeignUpdateTargets</code>所要求的junk列在这个槽中都是有效的。</p><p>返回值可以是一个包含实际被更新的数据的槽（这可能会和所提供的数据不同，例如一个触发器动作的结果），或者为 NULL 表示实际没有更新行（还是触发器的结果）。被传入的slot可以被重用于这个目的。</p><p>在返回槽中的数据只有在UPDATE查询具有一个RETURNING子句或者外部表具有一个AFTER ROW触发器时才被使用。触发器要求所有的列，但是 FDW 应该选择优化成根据RETURNING子句的内容返回某些或全部列。不管怎样，某些槽必须被返回来指示成功，否则查询报告的行计数将会是错误的。</p><p>如果<code>ExecForeignUpdate</code>指针被设置为NULL，尝试更新外部表将会失败并报告一个错误消息。</p><ul><li>ExecForeignDelete </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">ExecForeignDelete(EState *estate,</span><br><span class="line">                  ResultRelInfo *rinfo,</span><br><span class="line">                  TupleTableSlot *slot,</span><br><span class="line">                  TupleTableSlot *planSlot);</span><br></pre></td></tr></table></figure><p>从外部表删除一个元组。estate是查询的全局执行状态。rinfo是描述目标外部表的ResultRelInfo结构。slot在调用时不包含任何有用的东西，但是可以被用于保持被返回的元组。planSlot包含由ModifyTable计划节点的子计划生成的元组；特殊地，它将携带AddForeignUpdateTargets所要求的任意junk列。junk列被用来标识要被删除的元组。</p><p>返回值可以是一个包含实际被删除的数据的槽，或者为 NULL 表示实际没有删除行（还是触发器的结果）。被传入的slot可以被重用于这个目的。</p><p>在返回槽中的数据只有在DELETE查询具有一个RETURNING子句或者外部表具有一个AFTER ROW触发器时才被使用。触发器要求所有的列，但是 FDW 应该选择优化成根据RETURNING子句的内容返回某些或全部列。不管怎样，某些槽必须被返回来指示成功，否则查询报告的行计数将会是错误的。</p><p>如果<code>ExecForeignDelete</code>指针被设置为NULL，尝试从外部表中删除将会失败并报告一个错误消息。</p><ul><li>EndForeignModify</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">EndForeignModify(EState *estate,</span><br><span class="line">                 ResultRelInfo *rinfo);</span><br></pre></td></tr></table></figure><p>结束表更新并释放资源。通常释放palloc的内存并不重要，但是打开的文件和到远程服务器的连接等应当被清除。</p><p>如果<code>EndForeignModify</code>指针被设置为NULL，在执行器关闭期间不会采取任何动作。</p><p><br><br>通过INSERT或COPY FROM插入分区表的元组将路由到分区。如果FDW支持可路由的外表分区，它还应提供以下回调函数。在外部表上执行COPY FROM时也会调用这些函数：</p><ul><li>BeginForeignInsert</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">BeginForeignInsert(ModifyTableState *mtstate,</span><br><span class="line">                   ResultRelInfo *rinfo);</span><br></pre></td></tr></table></figure><p>开始在外表上执行插入操作。在将第一个元组插入到外表中之前，当它是为元组路由选择的分区和在COPY FROM命令中指定的目标时，就会调用此例程。它应该在实际插入之前执行所需的任何初始化。随后，将调用<code>ExecForeignInsert</code>以将每个元组插入到外表中。</p><p>mtstate是要被执行的ModifyTable计划节点的状态信息；通过这个结构可以得到关于规划和执行阶段的全局数据。rinfo是描述目标外部表的ResultRelInfo结构（ResultRelInfo的ri_FdwState属性用于FDW来存储它在此操作中需要的任何私有状态）。</p><p>当通过COPY FROM命令调用此方法时，不提供mtstate中与计划相关的全局数据，并且随后为每个插入的元组调用的<code>ExecForeignInsert</code>的planSlot参数为NULL，无论外表是为元组路由选择的分区还是在命令中指定的目标。</p><p>如果<code>BeginForeignInsert</code>指针设置为NULL，则不会对初始化执行任何操作。</p><ul><li>EndForeignInsert</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">EndForeignInsert(EState *estate,</span><br><span class="line">                 ResultRelInfo *rinfo);</span><br></pre></td></tr></table></figure><p>结束表插入并释放资源。通常释放palloc的内存并不重要，但是打开的文件和到远程服务器的连接等应当被清除。</p><p>如果<code>EndForeignInsert</code>指针被设置为NULL，在执行器关闭期间不会采取任何动作。</p><p><br></p><ul><li>IsForeignRelUpdatable</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">IsForeignRelUpdatable(Relation rel);</span><br></pre></td></tr></table></figure><p>报告指定的外部表支持哪些更新操作。返回值应该是一个规则事件编号的位掩码，它指示了哪些操作被外部表支持，它使用CmdType枚举，即：(1 &lt;&lt; CMD_UPDATE) = 4表示UPDATE、 (1 &lt;&lt; CMD_INSERT) = 8表示INSERT以及 (1 &lt;&lt; CMD_DELETE) = 16表示DELETE。</p><p>如果<code>IsForeignRelUpdatable</code>指针被设置为NULL，而FDW提供了<code>ExecForeignInsert</code>、<code>ExecForeignUpdate</code>或<code>ExecForeignDelete</code>，则外部表分别被假定为可插入、可更新或可删除。</p><p><br><br>一些对于外部表的插入、更新和删除可以通过实现另一组接口来优化。普通的插入、更新和删除接口会从远程服务器取得行，然后一次修改其中一行。在某些情况下，这种逐行的方式是必要的，但是可能效率不高。如果有可能让外部服务器判断哪些行可以直接修改而无需先检索它们并且没有本地触发器会影响该操作，那么可以让整个操作在远程服务器上执行。下面介绍的接口能让这种做法变成可能。</p><ul><li>PlanDirectModify</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span></span><br><span class="line">PlanDirectModify(PlannerInfo *root,</span><br><span class="line">                 ModifyTable *plan,</span><br><span class="line">                 Index resultRelation,</span><br><span class="line">                 <span class="keyword">int</span> subplan_index);</span><br></pre></td></tr></table></figure><p>决定在远程服务器上执行直接修改是否安全。如果安全，执行所需的规划动作然后返回true,否则返回false。这个可选的函数在查询规划期间被调用。如果这个函数成功，在执行阶段将会调用<code>BeginDirectModify</code>、<code>IterateDirectModify</code>和<code>EndDirectModify</code>。否则，对表的修改将采用上文描述的表更新函数来执行。参数和<code>PlanForeignModify</code>的相同。</p><p>要在远程服务器上执行直接修改，这个函数必须用一个ForeignScan计划节点（它在远程服务器上执行直接修改）重写目标子计划。ForeignScan的operation域必须被合适地设置为CmdType枚举值，即CMD_UPDATE表示UPDATE、CMD_INSERT表示INSERT而CMD_DELETE表示DELETE。</p><p>如果<code>PlanDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p><ul><li>BeginDirectModify </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">BeginDirectModify(ForeignScanState *node,</span><br><span class="line">                  <span class="keyword">int</span> eflags);</span><br></pre></td></tr></table></figure><p>准备在远程服务器上执行一次直接修改。这个函数会在执行器启动时被调用。它应该执行直接修改所需的任何初始化工作（应该在第一次<code>IterateDirectModify</code>调用之前完成）。ForeignScanState节点已经被创建，但是它的fdw_state属性仍然为 NULL。有关要被修改的表的信息可以访问ForeignScanState节点（具体地，从底层的ForeignScan计划节点，它包含了PlanDirectModify提供的 FDW-私有信息）。eflags包含描述执行器对于这个计划节点操作模式的标志位。</p><p>注意当(eflags &amp; EXEC_FLAG_EXPLAIN_ONLY)为真时，这个函数不应该执行任何外部可见的动作。它应当只做最少的工作让该节点状态对<code>ExplainDirectModify</code>和<code>EndDirectModify</code>有效。</p><p>如果<code>BeginDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p><ul><li>IterateDirectModify</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">IterateDirectModify(ForeignScanState *node);</span><br></pre></td></tr></table></figure><p>当INSERT、UPDATE或者DELETE查询没有RETURNING子句时，完成远程服务器上的直接修改后返回 NULL。当查询有该子句时，取出一个包含RETURNING计算所需数据的结果，用一个元组表槽返回它（节点的ScanTupleSlot应被用于这一目的）。实际被插入、更新或者删除的数据必须被存储在该节点的EState的es_result_relation_info-&gt;ri_projectReturning-&gt;pi_exprContext-&gt;ecxt_scantuple中。如果没有更多行可用，则返回 NULL。注意这个函数会在一个短期生存的内存上下文中被调用，该上下文会在两次调用之间被重置。如果需要一个长期存在的存储，可以在<code>BeginDirectModify</code>中创建一个内存上下文，或者使用该节点的EState中的es_query_cxt。</p><p>如果提供了fdw_scan_tlist目标列表，则被返回的行必须匹配它。否则，被返回的行必须匹配被更新的外部表的行类型。如果选择优化掉RETURNING计算不需要的列，应该在这些列的位置上插入空值，或者生成一个忽略这些列的fdw_scan_tlist列表。</p><p>不管该查询是否具有RETURNING子句，查询所报告的行计数必须由 FDW 本身增加。当查询没有该子句时，FDW 还必须为EXPLAIN ANALYZE情况下的ForeignScanState节点增加行计数。</p><p>如果<code>IterateDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p><ul><li>EndDirectModify </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">EndDirectModify(ForeignScanState *node);</span><br></pre></td></tr></table></figure><p>在远程服务器上的直接修改后进行清理。通常释放用 palloc 分配的内存并不重要，但是诸如打开的文件和到远程服务器的连接应该被清除。</p><p>如果<code>EndDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p><p><br><br><br><br>在外部表插入一条数据<code>insert into t_fdw values(11,&#39;1&#39;,&#39;2&#39;);</code><br>执行insert语句的调用顺序<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180809144759.png" alt=""></p><p>使用gdb追踪<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b postgresAddForeignUpdateTargets</span><br><span class="line">Breakpoint 1 at 0x7fee88320260: file postgres_fdw.c, line 1541.</span><br><span class="line">(gdb) b postgresPlanForeignModify</span><br><span class="line">Breakpoint 2 at 0x7fee883203a0: file postgres_fdw.c, line 1579.</span><br><span class="line">(gdb) b postgresBeginForeignModify</span><br><span class="line">Breakpoint 3 at 0x7fee88321e20: file postgres_fdw.c, line 1698.</span><br><span class="line">(gdb) b postgresExecForeignInsert</span><br><span class="line">Breakpoint 4 at 0x7fee88323000: file postgres_fdw.c, line 1750.</span><br><span class="line">(gdb) b postgresExecForeignUpdate</span><br><span class="line">Breakpoint 5 at 0x7fee88322e40: file postgres_fdw.c, line 1814.</span><br><span class="line">(gdb) b postgresExecForeignDelete</span><br><span class="line">Breakpoint 6 at 0x7fee88322c80: file postgres_fdw.c, line 1890.</span><br><span class="line">(gdb) b postgresEndForeignModify</span><br><span class="line">Breakpoint 7 at 0x7fee88321010: file postgres_fdw.c, line 1965.</span><br><span class="line">(gdb) b postgresBeginForeignInsert</span><br><span class="line">Breakpoint 8 at 0x7fee88321c10: file postgres_fdw.c, line 1982.</span><br><span class="line">(gdb) b postgresEndForeignInsert</span><br><span class="line">Breakpoint 9 at 0x7fee88320ff0: file postgres_fdw.c, line 2074.</span><br><span class="line">(gdb) b postgresIsForeignRelUpdatable</span><br><span class="line">Breakpoint 10 at 0x7fee8831e900: file postgres_fdw.c, line 2089.</span><br><span class="line">(gdb) b postgresPlanDirectModify</span><br><span class="line">Breakpoint 11 at 0x7fee883213b0: file postgres_fdw.c, line 2167.</span><br><span class="line">(gdb) b postgresBeginDirectModify</span><br><span class="line">Breakpoint 12 at 0x7fee8831fd80: file postgres_fdw.c, line 2360.</span><br><span class="line">(gdb) b postgresIterateDirectModify</span><br><span class="line">Breakpoint 13 at 0x7fee883227f0: file postgres_fdw.c, line 2479.</span><br><span class="line">(gdb) b postgresEndDirectModify</span><br><span class="line">Breakpoint 14 at 0x7fee8831fb60: file postgres_fdw.c, line 2523.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换至psql，执行插入语句</span></span><br><span class="line">fdw=<span class="comment"># insert into t_fdw values(11,'1','2');</span></span><br><span class="line"><span class="comment"># （挂起）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换回gdb</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 11, postgresPlanDirectModify (root=0x2113f08, plan=0x2115680, resultRelation=1, </span><br><span class="line">    subplan_index=0) at postgres_fdw.c:2167</span><br><span class="line">2167&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresPlanDirectModify (root=0x2113f08, plan=0x2115680, resultRelation=1, subplan_index=0) at postgres_fdw.c:2167</span></span><br><span class="line"><span class="comment">#1  0x00000000006790a1 in make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;) at createplan.c:6680</span></span><br><span class="line"><span class="comment">#2  create_modifytable_plan (best_path=0x20635e0, root=&lt;optimized out&gt;) at createplan.c:2479</span></span><br><span class="line"><span class="comment">#3  create_plan_recurse (root=root@entry=0x2113f08, best_path=0x20635e0, flags=flags@entry=1) at createplan.c:492</span></span><br><span class="line"><span class="comment">#4  0x0000000000679dc9 in create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;) at createplan.c:327</span></span><br><span class="line"><span class="comment">#5  0x0000000000685264 in standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0) at planner.c:412</span></span><br><span class="line"><span class="comment">#6  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x20636f0, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#7  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#8  0x0000000000721cda in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(11,'1','2');") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0)</span></span><br><span class="line">    at postmaster.c:1379</span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresPlanDirectModify (root=0x2113f08, plan=0x2115680, </span></span><br><span class="line">    resultRelation=1, subplan_index=0) at postgres_fdw.c:2167</span><br><span class="line">make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, </span><br><span class="line">    rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6681</span><br><span class="line">6681<span class="keyword">if</span> (direct_modify)</span><br><span class="line">Value returned is <span class="variable">$15</span> = <span class="literal">false</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, </span></span><br><span class="line">    rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6681</span><br><span class="line"></span><br><span class="line">Breakpoint 2, postgresPlanForeignModify (root=0x2113f08, plan=plan@entry=0x2115680, </span><br><span class="line">    resultRelation=1, subplan_index=subplan_index@entry=0) at postgres_fdw.c:1579</span><br><span class="line">1579&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresPlanForeignModify (root=0x2113f08, plan=plan@entry=0x2115680, resultRelation=1, subplan_index=subplan_index@entry=0) at postgres_fdw.c:1579</span></span><br><span class="line"><span class="comment">#1  0x0000000000677001 in make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;) at createplan.c:6687</span></span><br><span class="line"><span class="comment">#2  create_modifytable_plan (best_path=0x20635e0, root=&lt;optimized out&gt;) at createplan.c:2479</span></span><br><span class="line"><span class="comment">#3  create_plan_recurse (root=root@entry=0x2113f08, best_path=0x20635e0, flags=flags@entry=1) at createplan.c:492</span></span><br><span class="line"><span class="comment">#4  0x0000000000679dc9 in create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;) at createplan.c:327</span></span><br><span class="line"><span class="comment">#5  0x0000000000685264 in standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0) at planner.c:412</span></span><br><span class="line"><span class="comment">#6  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x20636f0, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#7  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#8  0x0000000000721cda in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresPlanForeignModify (root=0x2113f08, plan=plan@entry=0x2115680, </span></span><br><span class="line">    resultRelation=1, subplan_index=subplan_index@entry=0) at postgres_fdw.c:1579</span><br><span class="line">0x0000000000677001 <span class="keyword">in</span> make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, </span><br><span class="line">    rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6687</span><br><span class="line">6687fdw_private = fdwroutine-&gt;PlanForeignModify(subroot, node, rti, i);</span><br><span class="line">Value returned is <span class="variable">$16</span> = (List *) 0x218b810</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000677001 in make_modifytable (epqParam=&lt;optimized out&gt;, </span></span><br><span class="line">    onconflict=&lt;optimized out&gt;, rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6687</span><br><span class="line">create_plan_recurse (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;, flags=flags@entry=1)</span><br><span class="line">    at createplan.c:492</span><br><span class="line">492plan = (Plan *) create_modifytable_plan(root,</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_plan_recurse (root=root@entry=0x2113f08, </span></span><br><span class="line">    best_path=&lt;optimized out&gt;, flags=flags@entry=1) at createplan.c:492</span><br><span class="line">create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;) at createplan.c:336</span><br><span class="line">336<span class="keyword">if</span> (!IsA(plan, ModifyTable))</span><br><span class="line">Value returned is <span class="variable">$17</span> = (Plan *) 0x2115680</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;)</span></span><br><span class="line">    at createplan.c:336</span><br><span class="line">standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0) at planner.c:418</span><br><span class="line">418<span class="keyword">if</span> (cursorOptions &amp; CURSOR_OPT_SCROLL)</span><br><span class="line">Value returned is <span class="variable">$18</span> = (Plan *) 0x2115680</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0)</span></span><br><span class="line">    at planner.c:418</span><br><span class="line">pg_plan_query (querytree=querytree@entry=0x20636f0, cursorOptions=cursorOptions@entry=256, </span><br><span class="line">    boundParams=boundParams@entry=0x0) at postgres.c:811</span><br><span class="line">811<span class="keyword">if</span> (log_planner_stats)</span><br><span class="line">Value returned is <span class="variable">$19</span> = (PlannedStmt *) 0x218bb60</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  pg_plan_query (querytree=querytree@entry=0x20636f0, </span></span><br><span class="line">    cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:811</span><br><span class="line">0x000000000072186e <span class="keyword">in</span> pg_plan_queries (querytrees=&lt;optimized out&gt;, </span><br><span class="line">    cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span><br><span class="line">875stmt = pg_plan_query(query, cursorOptions, boundParams);</span><br><span class="line">Value returned is <span class="variable">$20</span> = (PlannedStmt *) 0x218bb60</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, </span></span><br><span class="line">    cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span><br><span class="line">0x0000000000721cda <span class="keyword">in</span> exec_simple_query (</span><br><span class="line">    query_string=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>) at postgres.c:1050</span><br><span class="line">1050plantree_list = pg_plan_queries(querytree_list,</span><br><span class="line">Value returned is <span class="variable">$21</span> = (List *) 0x218bc90</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000721cda in exec_simple_query (</span></span><br><span class="line">    query_string=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>) at postgres.c:1050</span><br><span class="line"></span><br><span class="line">Breakpoint 10, postgresIsForeignRelUpdatable (rel=0x7feed1ad1358) at postgres_fdw.c:2089</span><br><span class="line">2089&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresIsForeignRelUpdatable (rel=0x7feed1ad1358) at postgres_fdw.c:2089</span></span><br><span class="line"><span class="comment">#1  0x00000000005f0820 in CheckValidResultRel (resultRelInfo=resultRelInfo@entry=0x20885c0, operation=operation@entry=CMD_INSERT) at execMain.c:1187</span></span><br><span class="line"><span class="comment">#2  0x00000000006123a8 in ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2242</span></span><br><span class="line"><span class="comment">#3  0x00000000005f6838 in ExecInitNode (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at execProcnode.c:174</span></span><br><span class="line"><span class="comment">#4  0x00000000005f11c5 in InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1049</span></span><br><span class="line"><span class="comment">#5  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=0) at execMain.c:264</span></span><br><span class="line"><span class="comment">#6  0x0000000000724d26 in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(12,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "") at pquery.c:156</span></span><br><span class="line"><span class="comment">#7  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#8  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:799</span></span><br><span class="line"><span class="comment">#9  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#10 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#11 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#12 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#13 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#14 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#15 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresIsForeignRelUpdatable (rel=0x7feed1ad1358) at postgres_fdw.c:2089</span></span><br><span class="line">CheckValidResultRel (resultRelInfo=resultRelInfo@entry=0x20885c0, </span><br><span class="line">    operation=operation@entry=CMD_INSERT) at execMain.c:1186</span><br><span class="line">1186<span class="keyword">if</span> (fdwroutine-&gt;IsForeignRelUpdatable != NULL &amp;&amp;</span><br><span class="line">Value returned is <span class="variable">$22</span> = 28</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  CheckValidResultRel (resultRelInfo=resultRelInfo@entry=0x20885c0, </span></span><br><span class="line">    operation=operation@entry=CMD_INSERT) at execMain.c:1186</span><br><span class="line">ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, </span><br><span class="line">    eflags=eflags@entry=0) at nodeModifyTable.c:2253</span><br><span class="line">2253<span class="keyword">if</span> (resultRelInfo-&gt;ri_RelationDesc-&gt;rd_rel-&gt;relhasindex &amp;&amp;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecInitModifyTable (node=node@entry=0x2115680, </span></span><br><span class="line">    estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2253</span><br><span class="line"></span><br><span class="line">Breakpoint 3, postgresBeginForeignModify (mtstate=0x20888e0, resultRelInfo=0x20885c0, </span><br><span class="line">    fdw_private=0x218b810, subplan_index=0, eflags=0) at postgres_fdw.c:1698</span><br><span class="line">1698&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresBeginForeignModify (mtstate=0x20888e0, resultRelInfo=0x20885c0, fdw_private=0x218b810, subplan_index=0, eflags=0) at postgres_fdw.c:1698</span></span><br><span class="line"><span class="comment">#1  0x0000000000612458 in ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2280</span></span><br><span class="line"><span class="comment">#2  0x00000000005f6838 in ExecInitNode (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at execProcnode.c:174</span></span><br><span class="line"><span class="comment">#3  0x00000000005f11c5 in InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1049</span></span><br><span class="line"><span class="comment">#4  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=0) at execMain.c:264</span></span><br><span class="line"><span class="comment">#5  0x0000000000724d26 in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(13,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "") at pquery.c:156</span></span><br><span class="line"><span class="comment">#6  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#7  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:799</span></span><br><span class="line"><span class="comment">#8  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(13,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresBeginForeignModify (mtstate=0x20888e0, resultRelInfo=0x20885c0, </span></span><br><span class="line">    fdw_private=0x218b810, subplan_index=0, eflags=0) at postgres_fdw.c:1698</span><br><span class="line">ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, </span><br><span class="line">    eflags=eflags@entry=0) at nodeModifyTable.c:2231</span><br><span class="line">2231foreach(l, node-&gt;plans)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecInitModifyTable (node=node@entry=0x2115680, </span></span><br><span class="line">    estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2231</span><br><span class="line">0x00000000005f6838 <span class="keyword">in</span> ExecInitNode (node=node@entry=0x2115680, estate=estate@entry=0x2088380, </span><br><span class="line">    eflags=eflags@entry=0) at execProcnode.c:174</span><br><span class="line">174result = (PlanState *) ExecInitModifyTable((ModifyTable *) node,</span><br><span class="line">Value returned is <span class="variable">$23</span> = (ModifyTableState *) 0x20888e0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x00000000005f6838 in ExecInitNode (node=node@entry=0x2115680, </span></span><br><span class="line">    estate=estate@entry=0x2088380, eflags=eflags@entry=0) at execProcnode.c:174</span><br><span class="line">InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1054</span><br><span class="line">1054tupType = ExecGetResultType(planstate);</span><br><span class="line">Value returned is <span class="variable">$24</span> = (PlanState *) 0x20888e0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1054</span></span><br><span class="line">266MemoryContextSwitchTo(oldcontext);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=0)</span></span><br><span class="line">    at execMain.c:266</span><br><span class="line">ProcessQuery (plan=&lt;optimized out&gt;, </span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:161</span><br><span class="line">161ExecutorRun(queryDesc, ForwardScanDirection, 0L, <span class="literal">true</span>);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ProcessQuery (plan=&lt;optimized out&gt;, </span></span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:161</span><br><span class="line"></span><br><span class="line">Breakpoint 4, postgresExecForeignInsert (estate=0x2088380, resultRelInfo=0x20885c0, </span><br><span class="line">    slot=0x2089628, planSlot=0x2089628) at postgres_fdw.c:1750</span><br><span class="line">1750&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresExecForeignInsert (estate=0x2088380, resultRelInfo=0x20885c0, slot=0x2089628, planSlot=0x2089628) at postgres_fdw.c:1750</span></span><br><span class="line"><span class="comment">#1  0x0000000000610d8b in ExecInsert (mtstate=mtstate@entry=0x20888e0, slot=0x2089628, planSlot=planSlot@entry=0x2089628, estate=estate@entry=0x2088380, canSetTag=&lt;optimized out&gt;) at nodeModifyTable.c:346</span></span><br><span class="line"><span class="comment">#2  0x0000000000612119 in ExecModifyTable (pstate=0x20888e0) at nodeModifyTable.c:2126</span></span><br><span class="line"><span class="comment">#3  0x00000000005f000a in ExecProcNode (node=0x20888e0) at ../../../src/include/executor/executor.h:237</span></span><br><span class="line"><span class="comment">#4  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x218bcc0, direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=false, operation=CMD_INSERT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x20888e0, estate=0x2088380) at execMain.c:1726</span></span><br><span class="line"><span class="comment">#5  standard_ExecutorRun (queryDesc=0x21413a0, direction=&lt;optimized out&gt;, count=0, execute_once=&lt;optimized out&gt;) at execMain.c:363</span></span><br><span class="line"><span class="comment">#6  0x0000000000724d3a in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(12,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "") at pquery.c:161</span></span><br><span class="line"><span class="comment">#7  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#8  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:799</span></span><br><span class="line"><span class="comment">#9  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#10 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#11 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#12 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#13 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#14 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#15 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresExecForeignInsert (estate=0x2088380, resultRelInfo=0x20885c0, </span></span><br><span class="line">    slot=0x2089628, planSlot=0x2089628) at postgres_fdw.c:1750</span><br><span class="line">ExecInsert (mtstate=mtstate@entry=0x20888e0, slot=0x2089628, planSlot=planSlot@entry=0x2089628, </span><br><span class="line">    estate=estate@entry=0x2088380, canSetTag=&lt;optimized out&gt;) at nodeModifyTable.c:351</span><br><span class="line">351<span class="keyword">if</span> (slot == NULL)/* <span class="string">"do nothing"</span> */</span><br><span class="line">Value returned is <span class="variable">$25</span> = (TupleTableSlot *) 0x2089628</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecInsert (mtstate=mtstate@entry=0x20888e0, slot=0x2089628, </span></span><br><span class="line">    planSlot=planSlot@entry=0x2089628, estate=estate@entry=0x2088380, canSetTag=&lt;optimized out&gt;)</span><br><span class="line">    at nodeModifyTable.c:351</span><br><span class="line">0x0000000000612119 <span class="keyword">in</span> ExecModifyTable (pstate=0x20888e0) at nodeModifyTable.c:2126</span><br><span class="line">2126slot = ExecInsert(node, slot, planSlot,</span><br><span class="line">Value returned is <span class="variable">$26</span> = (TupleTableSlot *) 0x0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000612119 in ExecModifyTable (pstate=0x20888e0)</span></span><br><span class="line">    at nodeModifyTable.c:2126</span><br><span class="line">ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x218bcc0, direction=&lt;optimized out&gt;, </span><br><span class="line">    numberTuples=0, sendTuples=<span class="literal">false</span>, operation=CMD_INSERT, use_parallel_mode=&lt;optimized out&gt;, </span><br><span class="line">    planstate=0x20888e0, estate=0x2088380) at execMain.c:1732</span><br><span class="line">1732<span class="keyword">if</span> (TupIsNull(slot))</span><br><span class="line">Value returned is <span class="variable">$27</span> = (TupleTableSlot *) 0x0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x218bcc0, </span></span><br><span class="line">    direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=<span class="literal">false</span>, operation=CMD_INSERT, </span><br><span class="line">    use_parallel_mode=&lt;optimized out&gt;, planstate=0x20888e0, estate=0x2088380) at execMain.c:1732</span><br><span class="line">377<span class="keyword">if</span> (sendTuples)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorRun (queryDesc=0x21413a0, direction=&lt;optimized out&gt;, </span></span><br><span class="line">    count=0, execute_once=&lt;optimized out&gt;) at execMain.c:377</span><br><span class="line">ProcessQuery (plan=&lt;optimized out&gt;, </span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:166</span><br><span class="line">166<span class="keyword">if</span> (completionTag)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ProcessQuery (plan=&lt;optimized out&gt;, </span></span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:166</span><br><span class="line"></span><br><span class="line">Breakpoint 7, postgresEndForeignModify (estate=0x2088380, resultRelInfo=0x20885c0)</span><br><span class="line">    at postgres_fdw.c:1965</span><br><span class="line">1965PgFdwModifyState *fmstate = (PgFdwModifyState *) resultRelInfo-&gt;ri_FdwState;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresEndForeignModify (estate=0x2088380, resultRelInfo=0x20885c0) at postgres_fdw.c:1965</span></span><br><span class="line"><span class="comment">#1  0x0000000000612c7b in ExecEndModifyTable (node=0x20888e0) at nodeModifyTable.c:2664</span></span><br><span class="line"><span class="comment">#2  0x00000000005f16ad in ExecEndPlan (estate=0x2088380, planstate=&lt;optimized out&gt;) at execMain.c:1612</span></span><br><span class="line"><span class="comment">#3  standard_ExecutorEnd (queryDesc=0x21413a0) at execMain.c:495</span></span><br><span class="line"><span class="comment">#4  0x0000000000724d90 in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(12,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "INSERT 0 1") at pquery.c:206</span></span><br><span class="line"><span class="comment">#5  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "INSERT 0 1") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#6  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "INSERT 0 1") at pquery.c:799</span></span><br><span class="line"><span class="comment">#7  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#8  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#9  0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#10 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#11 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#12 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#13 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 后续执行结束</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>在外部表更新数据 <code>update t_fdw set c1=&#39;11&#39; where id=11;</code><br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180809152932.png" alt=""></p><p>在外部表删除数据，使用gdb跟踪调用流程，发现和update语句的流程是一样的，查看相关代码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * postgresIterateDirectModify</span></span><br><span class="line"><span class="comment"> *Execute a direct foreign table modification</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> TupleTableSlot *</span><br><span class="line">postgresIterateDirectModify(ForeignScanState *node)</span><br><span class="line">&#123;</span><br><span class="line">PgFdwDirectModifyState *dmstate = (PgFdwDirectModifyState *) node-&gt;fdw_state;</span><br><span class="line">EState   *estate = node-&gt;ss.ps.state;</span><br><span class="line">ResultRelInfo *resultRelInfo = estate-&gt;es_result_relation_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If this is the first call after Begin, execute the statement.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (dmstate-&gt;num_tuples == <span class="number">-1</span>)</span><br><span class="line">execute_dml_stmt(node);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If the local query doesn't specify RETURNING, just clear tuple slot.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!resultRelInfo-&gt;ri_projectReturning)</span><br><span class="line">&#123;</span><br><span class="line">TupleTableSlot *slot = node-&gt;ss.ss_ScanTupleSlot;</span><br><span class="line">Instrumentation *instr = node-&gt;ss.ps.instrument;</span><br><span class="line"></span><br><span class="line">Assert(!dmstate-&gt;has_returning);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Increment the command es_processed count if necessary. */</span></span><br><span class="line"><span class="keyword">if</span> (dmstate-&gt;set_processed)</span><br><span class="line">estate-&gt;es_processed += dmstate-&gt;num_tuples;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Increment the tuple count for EXPLAIN ANALYZE if necessary. */</span></span><br><span class="line"><span class="keyword">if</span> (instr)</span><br><span class="line">instr-&gt;tuplecount += dmstate-&gt;num_tuples;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ExecClearTuple(slot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Get the next RETURNING tuple.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">return</span> get_returning_data(node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Execute a direct UPDATE/DELETE statement.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">execute_dml_stmt(ForeignScanState *node)</span><br><span class="line">&#123;</span><br><span class="line">PgFdwDirectModifyState *dmstate = (PgFdwDirectModifyState *) node-&gt;fdw_state;</span><br><span class="line">ExprContext *econtext = node-&gt;ss.ps.ps_ExprContext;</span><br><span class="line"><span class="keyword">int</span>numParams = dmstate-&gt;numParams;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> **values = dmstate-&gt;param_values;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Construct array of query parameter values in text format.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (numParams &gt; <span class="number">0</span>)</span><br><span class="line">process_query_params(econtext,</span><br><span class="line"> dmstate-&gt;param_flinfo,</span><br><span class="line"> dmstate-&gt;param_exprs,</span><br><span class="line"> values);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Notice that we pass NULL for paramTypes, thus forcing the remote server</span></span><br><span class="line"><span class="comment"> * to infer types for all parameters.  Since we explicitly cast every</span></span><br><span class="line"><span class="comment"> * parameter (see deparse.c), the "inference" is trivial and will produce</span></span><br><span class="line"><span class="comment"> * the desired result.  This allows us to avoid assuming that the remote</span></span><br><span class="line"><span class="comment"> * server has the same OIDs we do for the parameters' types.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!PQsendQueryParams(dmstate-&gt;conn, dmstate-&gt;query, numParams,</span><br><span class="line">   <span class="literal">NULL</span>, values, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">pgfdw_report_error(ERROR, <span class="literal">NULL</span>, dmstate-&gt;conn, <span class="literal">false</span>, dmstate-&gt;query);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Get the result, and check for success.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We don't use a PG_TRY block here, so be careful not to throw error</span></span><br><span class="line"><span class="comment"> * without releasing the PGresult.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dmstate-&gt;result = pgfdw_get_result(dmstate-&gt;conn, dmstate-&gt;query);</span><br><span class="line"><span class="keyword">if</span> (PQresultStatus(dmstate-&gt;result) !=</span><br><span class="line">(dmstate-&gt;has_returning ? PGRES_TUPLES_OK : PGRES_COMMAND_OK))</span><br><span class="line">pgfdw_report_error(ERROR, dmstate-&gt;result, dmstate-&gt;conn, <span class="literal">true</span>,</span><br><span class="line">   dmstate-&gt;query);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get the number of rows affected. */</span></span><br><span class="line"><span class="keyword">if</span> (dmstate-&gt;has_returning)</span><br><span class="line">dmstate-&gt;num_tuples = PQntuples(dmstate-&gt;result);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">dmstate-&gt;num_tuples = atoi(PQcmdTuples(dmstate-&gt;result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到，<code>postgresIterateDirectModify</code> 调用了<code>execute_dml_stmt</code>执行直接UPDATE/DELETE语句的。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;上两篇文章主要介绍了实现FDW的7个必须实现的扫描相关的回调函数，&lt;a href=&quot;https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/&quot;&gt;学习PostgreSQL的FDW(#1)&lt;/a&gt;，&lt;br&gt;&lt;a href=
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
  </entry>
  
  <entry>
    <title>学习PostgreSQL的FDW(#2)-源码跟踪</title>
    <link href="https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part2/"/>
    <id>https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part2/</id>
    <published>2018-08-07T02:15:45.504Z</published>
    <updated>2018-08-07T17:14:59.861Z</updated>
    
    <content type="html"><![CDATA[<p>上篇大概介绍了FDW必须实现的7个回调函数<a href="https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/">学习PostgreSQL的FDW(#1)</a>，本篇将从源码跟踪，这7个回调函数的调用时机，以PostgreSQL11beta2的postgres_fdw为例，分析PostgreSQL在查询外部表时，究竟做了什么。</p><h2 id="测试前准备"><a href="#测试前准备" class="headerlink" title="测试前准备"></a>测试前准备</h2><p>IP为192.168.117.56的虚拟机安装了PostgreSQL10；<br>IP为192.168.118.56的虚拟机安装了PostgreSQL11beta2<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">testdb=# -- 在117.56中创建测试表</span><br><span class="line">testdb=# create table t_fdw(id int,c1 char(10),c2 varchar(10));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">2</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">3</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">4</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">5</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">6</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">7</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">8</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">9</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">testdb=# <span class="keyword">insert</span> <span class="keyword">into</span> t_fdw <span class="keyword">values</span> (<span class="number">10</span>,<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">fdw=# -- 在118.56中创建postgres_fdw扩展</span><br><span class="line">fdw=# create extension postgres_fdw ;</span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION</span><br><span class="line">fdw=# \dx;</span><br><span class="line">                               List of installed extensions</span><br><span class="line">     Name     | Version |   Schema   |                    Description                     </span><br><span class="line"><span class="comment">--------------+---------+------------+----------------------------------------------------</span></span><br><span class="line"> plpgsql      | 1.0     | pg_catalog | PL/pgSQL procedural language</span><br><span class="line"> postgres_fdw | 1.0     | public     | foreign-data wrapper for remote PostgreSQL servers</span><br><span class="line">(2 rows)</span><br><span class="line">fdw=# -- 创建外部服务器</span><br><span class="line">fdw=# create server pg_117_56 foreign data wrapper postgres_fdw options (host '192.168.117.56',port '5432',dbname 'testdb');</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">SERVER</span></span><br><span class="line">fdw=# \des</span><br><span class="line">         <span class="keyword">List</span> <span class="keyword">of</span> foreign servers</span><br><span class="line">   <span class="keyword">Name</span>    | Owner | Foreign-<span class="keyword">data</span> wrapper </span><br><span class="line"><span class="comment">-----------+-------+----------------------</span></span><br><span class="line"> pg_117_56 | <span class="keyword">xdb</span>   | postgres_fdw</span><br><span class="line">(<span class="number">1</span> <span class="keyword">row</span>)</span><br><span class="line"></span><br><span class="line">fdw=# <span class="comment">--创建用户映射</span></span><br><span class="line">fdw=# <span class="keyword">create</span> <span class="keyword">user</span> <span class="keyword">MAPPING</span> <span class="keyword">FOR</span> <span class="keyword">PUBLIC</span> <span class="keyword">server</span> pg_117_56 options (<span class="keyword">user</span> <span class="string">'xdb'</span>,<span class="keyword">password</span> <span class="string">'test'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="keyword">MAPPING</span></span><br><span class="line">fdw=# \deu+</span><br><span class="line">                  <span class="keyword">List</span> <span class="keyword">of</span> <span class="keyword">user</span> mappings</span><br><span class="line">  <span class="keyword">Server</span>   | <span class="keyword">User</span> <span class="keyword">name</span> |           FDW options           </span><br><span class="line"><span class="comment">-----------+-----------+---------------------------------</span></span><br><span class="line"> pg_117_56 | <span class="keyword">public</span>    | (<span class="string">"user"</span> <span class="string">'xdb'</span>, <span class="keyword">password</span> <span class="string">'test'</span>)</span><br><span class="line">(<span class="number">1</span> <span class="keyword">row</span>)</span><br><span class="line">fdw=# <span class="comment">-- 创建外部表</span></span><br><span class="line"><span class="keyword">create</span> foreign <span class="keyword">table</span> t_fdw(<span class="keyword">id</span> <span class="built_in">int</span>, c1 <span class="built_in">char</span>(<span class="number">10</span>),c2 <span class="built_in">varchar</span>(<span class="number">10</span>)) <span class="keyword">server</span> pg_117_56 options(schema_name <span class="string">'public'</span>,table_name <span class="string">'t_fdw'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> FOREIGN <span class="keyword">TABLE</span></span><br><span class="line">fdw=# \d</span><br><span class="line">           <span class="keyword">List</span> <span class="keyword">of</span> relations</span><br><span class="line"> <span class="keyword">Schema</span> | <span class="keyword">Name</span>  |     <span class="keyword">Type</span>      | Owner </span><br><span class="line"><span class="comment">--------+-------+---------------+-------</span></span><br><span class="line"> <span class="keyword">public</span> | t_fdw | foreign <span class="keyword">table</span> | <span class="keyword">xdb</span></span><br><span class="line">(<span class="number">1</span> <span class="keyword">row</span>)</span><br></pre></td></tr></table></figure><h2 id="跟踪分析"><a href="#跟踪分析" class="headerlink" title="跟踪分析"></a>跟踪分析</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fdw=# select pg_backend_pid();</span><br><span class="line"> pg_backend_pid </span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line">           2382</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><p>使用gdb跟踪查询过程：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># gdb -p 2382</span></span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-110.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-redhat-linux-gnu"</span>.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Attaching to process 2382</span><br><span class="line">...</span><br><span class="line">(gdb) </span><br><span class="line"><span class="comment"># 设置断点</span></span><br><span class="line">(gdb) b postgresGetForeignRelSize</span><br><span class="line">Function <span class="string">"postgresGetForeignRelSize"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 1 (postgresGetForeignRelSize) pending.</span><br><span class="line">(gdb) b postgresGetForeignPaths</span><br><span class="line">Function <span class="string">"postgresGetForeignPaths"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 2 (postgresGetForeignPaths) pending.</span><br><span class="line">(gdb) b postgresGetForeignPlan</span><br><span class="line">Function <span class="string">"postgresGetForeignPlan"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 3 (postgresGetForeignPlan) pending.</span><br><span class="line">(gdb) b postgresBeginForeignScan</span><br><span class="line">Function <span class="string">"postgresBeginForeignScan"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 4 (postgresBeginForeignScan) pending.</span><br><span class="line">(gdb) b postgresIterateForeignScan</span><br><span class="line">Function <span class="string">"postgresIterateForeignScan"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 5 (postgresIterateForeignScan) pending.</span><br><span class="line">(gdb) b postgresReScanForeignScan</span><br><span class="line">Function <span class="string">"postgresReScanForeignScan"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 6 (postgresReScanForeignScan) pending.</span><br><span class="line">(gdb) b postgresEndForeignScan</span><br><span class="line">Function <span class="string">"postgresEndForeignScan"</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 7 (postgresEndForeignScan) pending.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到psql，执行查询语句</span></span><br><span class="line">fdw=<span class="comment"># select * from t_fdw;</span></span><br><span class="line"><span class="comment"># （挂起状态）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换回gdb</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, postgresGetForeignRelSize (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:522</span><br><span class="line">522&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresGetForeignRelSize (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:522</span></span><br><span class="line"><span class="comment">#1  0x000000000065fde5 in set_foreign_size (rte=0x130f778, rel=0x13349e8, root=0x13342e8) at allpaths.c:839</span></span><br><span class="line"><span class="comment">#2  set_rel_size (root=root@entry=0x13342e8, rel=rel@entry=0x13349e8, rti=rti@entry=1, rte=0x130f778) at allpaths.c:351</span></span><br><span class="line"><span class="comment">#3  0x000000000066097d in set_base_rel_sizes (root=&lt;optimized out&gt;) at allpaths.c:281</span></span><br><span class="line"><span class="comment">#4  make_one_rel (root=root@entry=0x13342e8, joinlist=joinlist@entry=0x1334e50) at allpaths.c:179</span></span><br><span class="line"><span class="comment">#5  0x000000000067de9e in query_planner (root=root@entry=0x13342e8, tlist=tlist@entry=0x1334788, qp_callback=qp_callback@entry=0x67f290 &lt;standard_qp_callback&gt;, qp_extra=qp_extra@entry=0x7fff8c772f00) at planmain.c:259</span></span><br><span class="line"><span class="comment">#6  0x0000000000681f43 in grouping_planner (root=root@entry=0x13342e8, inheritance_update=inheritance_update@entry=false, tuple_fraction=&lt;optimized out&gt;, tuple_fraction@entry=0) at planner.c:1897</span></span><br><span class="line"><span class="comment">#7  0x0000000000684218 in subquery_planner (glob=glob@entry=0x130fc38, parse=parse@entry=0x130f668, parent_root=parent_root@entry=0x0, hasRecursion=hasRecursion@entry=false, tuple_fraction=tuple_fraction@entry=0) at planner.c:966</span></span><br><span class="line"><span class="comment">#8  0x0000000000685236 in standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:405</span></span><br><span class="line"><span class="comment">#9  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x130f668, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#10 0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#11 0x0000000000721cda in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#12 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#13 0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#14 BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#15 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#16 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#17 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line"></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresGetForeignRelSize (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:535</span></span><br><span class="line">set_foreign_size (rte=0x130f778, rel=0x13349e8, root=0x13342e8) at allpaths.c:842</span><br><span class="line">842rel-&gt;rows = clamp_row_est(rel-&gt;rows);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  set_foreign_size (rte=0x130f778, rel=0x13349e8, root=0x13342e8) at allpaths.c:842</span></span><br><span class="line">415&#125;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  set_rel_size (root=root@entry=0x13342e8, rel=rel@entry=0x13349e8, rti=rti@entry=1, rte=&lt;optimized out&gt;)</span></span><br><span class="line">    at allpaths.c:415</span><br><span class="line">set_base_rel_sizes (root=&lt;optimized out&gt;) at allpaths.c:253</span><br><span class="line">253<span class="keyword">for</span> (rti = 1; rti &lt; root-&gt;simple_rel_array_size; rti++)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  set_base_rel_sizes (root=&lt;optimized out&gt;) at allpaths.c:253</span></span><br><span class="line">180set_base_rel_pathlists(root);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  make_one_rel (root=root@entry=0x13342e8, joinlist=joinlist@entry=0x1334e50) at allpaths.c:180</span></span><br><span class="line"></span><br><span class="line">Breakpoint 2, postgresGetForeignPaths (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:921</span><br><span class="line">921&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresGetForeignPaths (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:921</span></span><br><span class="line"><span class="comment">#1  0x0000000000660452 in set_foreign_pathlist (rte=0x130f778, rel=0x13349e8, root=0x13342e8) at allpaths.c:853</span></span><br><span class="line"><span class="comment">#2  set_rel_pathlist (root=root@entry=0x13342e8, rel=0x13349e8, rti=rti@entry=1, rte=0x130f778) at allpaths.c:442</span></span><br><span class="line"><span class="comment">#3  0x0000000000660a30 in set_base_rel_pathlists (root=&lt;optimized out&gt;) at allpaths.c:310</span></span><br><span class="line"><span class="comment">#4  make_one_rel (root=root@entry=0x13342e8, joinlist=joinlist@entry=0x1334e50) at allpaths.c:180</span></span><br><span class="line"><span class="comment">#5  0x000000000067de9e in query_planner (root=root@entry=0x13342e8, tlist=tlist@entry=0x1334788, qp_callback=qp_callback@entry=0x67f290 &lt;standard_qp_callback&gt;, qp_extra=qp_extra@entry=0x7fff8c772f00) at planmain.c:259</span></span><br><span class="line"><span class="comment">#6  0x0000000000681f43 in grouping_planner (root=root@entry=0x13342e8, inheritance_update=inheritance_update@entry=false, tuple_fraction=&lt;optimized out&gt;, tuple_fraction@entry=0) at planner.c:1897</span></span><br><span class="line"><span class="comment">#7  0x0000000000684218 in subquery_planner (glob=glob@entry=0x130fc38, parse=parse@entry=0x130f668, parent_root=parent_root@entry=0x0, hasRecursion=hasRecursion@entry=false, tuple_fraction=tuple_fraction@entry=0) at planner.c:966</span></span><br><span class="line"><span class="comment">#8  0x0000000000685236 in standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:405</span></span><br><span class="line"><span class="comment">#9  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x130f668, cursorOptions=cursorOptions@entry=256,  boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#10 0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#11 0x0000000000721cda in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#12 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw",   username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#13 0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#14 BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#15 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#16 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#17 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresGetForeignPaths (root=0x13342e8, baserel=0x13349e8, foreigntableid=16392) at postgres_fdw.c:921</span></span><br><span class="line">0x0000000000660452 <span class="keyword">in</span> set_foreign_pathlist (rte=0x130f778, rel=0x13349e8, root=0x13342e8) at allpaths.c:853</span><br><span class="line">853rel-&gt;fdwroutine-&gt;GetForeignPaths(root, rel, rte-&gt;relid);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000660452 in set_foreign_pathlist (rte=0x130f778, rel=0x13349e8, root=0x13342e8)</span></span><br><span class="line">    at allpaths.c:853</span><br><span class="line">495<span class="keyword">if</span> (rel-&gt;reloptkind == RELOPT_BASEREL &amp;&amp;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  set_rel_pathlist (root=root@entry=0x13342e8, rel=0x13349e8, rti=rti@entry=1, rte=0x130f778)</span></span><br><span class="line">    at allpaths.c:495</span><br><span class="line">0x0000000000660a30 <span class="keyword">in</span> set_base_rel_pathlists (root=&lt;optimized out&gt;) at allpaths.c:310</span><br><span class="line">310set_rel_pathlist(root, rel, rti, root-&gt;simple_rte_array[rti]);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000660a30 in set_base_rel_pathlists (root=&lt;optimized out&gt;) at allpaths.c:310</span></span><br><span class="line">185rel = make_rel_from_joinlist(root, joinlist);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  make_one_rel (root=root@entry=0x13342e8, joinlist=joinlist@entry=0x1334e50) at allpaths.c:185</span></span><br><span class="line">query_planner (root=root@entry=0x13342e8, tlist=tlist@entry=0x1334788, </span><br><span class="line">    qp_callback=qp_callback@entry=0x67f290 &lt;standard_qp_callback&gt;, qp_extra=qp_extra@entry=0x7fff8c772f00) at planmain.c:262</span><br><span class="line">262<span class="keyword">if</span> (!final_rel || !final_rel-&gt;cheapest_total_path ||</span><br><span class="line">Value returned is <span class="variable">$3</span> = (RelOptInfo *) 0x13349e8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  query_planner (root=root@entry=0x13342e8, tlist=tlist@entry=0x1334788, </span></span><br><span class="line">    qp_callback=qp_callback@entry=0x67f290 &lt;standard_qp_callback&gt;, qp_extra=qp_extra@entry=0x7fff8c772f00) at planmain.c:262</span><br><span class="line">grouping_planner (root=root@entry=0x13342e8, inheritance_update=inheritance_update@entry=<span class="literal">false</span>, tuple_fraction=&lt;optimized out&gt;, </span><br><span class="line">    tuple_fraction@entry=0) at planner.c:1907</span><br><span class="line">1907final_target = create_pathtarget(root, tlist);</span><br><span class="line">Value returned is <span class="variable">$4</span> = (RelOptInfo *) 0x13349e8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  grouping_planner (root=root@entry=0x13342e8, inheritance_update=inheritance_update@entry=false, </span></span><br><span class="line">    tuple_fraction=&lt;optimized out&gt;, tuple_fraction@entry=0) at planner.c:1907</span><br><span class="line">subquery_planner (glob=glob@entry=0x130fc38, parse=parse@entry=0x130f668, parent_root=parent_root@entry=0x0, </span><br><span class="line">    hasRecursion=hasRecursion@entry=<span class="literal">false</span>, tuple_fraction=tuple_fraction@entry=0) at planner.c:972</span><br><span class="line">972SS_identify_outer_params(root);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  subquery_planner (glob=glob@entry=0x130fc38, parse=parse@entry=0x130f668, </span></span><br><span class="line">    parent_root=parent_root@entry=0x0, hasRecursion=hasRecursion@entry=<span class="literal">false</span>, tuple_fraction=tuple_fraction@entry=0)</span><br><span class="line">    at planner.c:972</span><br><span class="line">standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:409</span><br><span class="line">409final_rel = fetch_upper_rel(root, UPPERREL_FINAL, NULL);</span><br><span class="line">Value returned is <span class="variable">$5</span> = (PlannerInfo *) 0x13342e8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:409</span></span><br><span class="line"></span><br><span class="line">Breakpoint 3, postgresGetForeignPlan (root=0x13342e8, foreignrel=0x13349e8, foreigntableid=16392, best_path=0x1334dc0, </span><br><span class="line">    tlist=0x13cbdd8, scan_clauses=0x0, outer_plan=0x0) at postgres_fdw.c:1131</span><br><span class="line">1131&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresGetForeignPlan (root=0x13342e8, foreignrel=0x13349e8, foreigntableid=16392, best_path=0x1334dc0, tlist=0x13cbdd8, scan_clauses=0x0, outer_plan=0x0) at postgres_fdw.c:1131</span></span><br><span class="line"><span class="comment">#1  0x000000000067a0c1 in create_foreignscan_plan (scan_clauses=&lt;optimized out&gt;, tlist=0x13cbdd8, best_path=0x1334dc0, root=0x13342e8) at createplan.c:3597</span></span><br><span class="line"><span class="comment">#2  create_scan_plan (root=root@entry=0x13342e8, best_path=best_path@entry=0x1334dc0, flags=&lt;optimized out&gt;, flags@entry=1)  at createplan.c:714</span></span><br><span class="line"><span class="comment">#3  0x0000000000677557 in create_plan_recurse (root=root@entry=0x13342e8, best_path=0x1334dc0, flags=flags@entry=1) at createplan.c:390</span></span><br><span class="line"><span class="comment">#4  0x0000000000679dc9 in create_plan (root=root@entry=0x13342e8, best_path=&lt;optimized out&gt;) at createplan.c:327</span></span><br><span class="line"><span class="comment">#5  0x0000000000685264 in standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:412</span></span><br><span class="line"><span class="comment">#6  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x130f668, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#7  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#8  0x0000000000721cda in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresGetForeignPlan (root=0x13342e8, foreignrel=0x13349e8, foreigntableid=16392, best_path=0x1334dc0, </span></span><br><span class="line">    tlist=0x13cbdd8, scan_clauses=0x0, outer_plan=0x0) at postgres_fdw.c:1131</span><br><span class="line">create_foreignscan_plan (scan_clauses=&lt;optimized out&gt;, tlist=0x13cbdd8, best_path=0x1334dc0, root=0x13342e8) at createplan.c:3603</span><br><span class="line">3603copy_generic_path_info(&amp;scan_plan-&gt;scan.plan, &amp;best_path-&gt;path);</span><br><span class="line">Value returned is <span class="variable">$6</span> = (ForeignScan *) 0x13105b0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_foreignscan_plan (scan_clauses=&lt;optimized out&gt;, tlist=0x13cbdd8, best_path=0x1334dc0, </span></span><br><span class="line">    root=0x13342e8) at createplan.c:3603</span><br><span class="line">718<span class="built_in">break</span>;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_scan_plan (root=root@entry=0x13342e8, best_path=best_path@entry=0x1334dc0, flags=&lt;optimized out&gt;, </span></span><br><span class="line">    flags@entry=1) at createplan.c:718</span><br><span class="line">0x0000000000677557 <span class="keyword">in</span> create_plan_recurse (root=root@entry=0x13342e8, best_path=0x1334dc0, flags=flags@entry=1)</span><br><span class="line">    at createplan.c:390</span><br><span class="line">390plan = create_scan_plan(root, best_path, flags);</span><br><span class="line">Value returned is <span class="variable">$7</span> = (Plan *) 0x13105b0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000677557 in create_plan_recurse (root=root@entry=0x13342e8, best_path=0x1334dc0, </span></span><br><span class="line">    flags=flags@entry=1) at createplan.c:390</span><br><span class="line">create_plan (root=root@entry=0x13342e8, best_path=&lt;optimized out&gt;) at createplan.c:336</span><br><span class="line">336<span class="keyword">if</span> (!IsA(plan, ModifyTable))</span><br><span class="line">Value returned is <span class="variable">$8</span> = (Plan *) 0x13105b0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_plan (root=root@entry=0x13342e8, best_path=&lt;optimized out&gt;) at createplan.c:336</span></span><br><span class="line">standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:418</span><br><span class="line">418<span class="keyword">if</span> (cursorOptions &amp; CURSOR_OPT_SCROLL)</span><br><span class="line">Value returned is <span class="variable">$9</span> = (Plan *) 0x13105b0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_planner (parse=0x130f668, cursorOptions=256, boundParams=0x0) at planner.c:418</span></span><br><span class="line">pg_plan_query (querytree=querytree@entry=0x130f668, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0)</span><br><span class="line">    at postgres.c:811</span><br><span class="line">811<span class="keyword">if</span> (log_planner_stats)</span><br><span class="line">Value returned is <span class="variable">$10</span> = (PlannedStmt *) 0x130f8d8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  pg_plan_query (querytree=querytree@entry=0x130f668, cursorOptions=cursorOptions@entry=256, </span></span><br><span class="line">    boundParams=boundParams@entry=0x0) at postgres.c:811</span><br><span class="line">0x000000000072186e <span class="keyword">in</span> pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, </span><br><span class="line">    boundParams=boundParams@entry=0x0) at postgres.c:875</span><br><span class="line">875stmt = pg_plan_query(query, cursorOptions, boundParams);</span><br><span class="line">Value returned is <span class="variable">$11</span> = (PlannedStmt *) 0x130f8d8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, </span></span><br><span class="line">    boundParams=boundParams@entry=0x0) at postgres.c:875</span><br><span class="line">0x0000000000721cda <span class="keyword">in</span> exec_simple_query (query_string=0x130e810 <span class="string">"select * from t_fdw;"</span>) at postgres.c:1050</span><br><span class="line">1050plantree_list = pg_plan_queries(querytree_list,</span><br><span class="line">Value returned is <span class="variable">$12</span> = (List *) 0x13cc7d8</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000721cda in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1050</span></span><br><span class="line"></span><br><span class="line">Breakpoint 4, postgresBeginForeignScan (node=0x13bf120, eflags=16) at postgres_fdw.c:1314</span><br><span class="line">1314&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresBeginForeignScan (node=0x13bf120, eflags=16) at postgres_fdw.c:1314</span></span><br><span class="line"><span class="comment">#1  0x00000000006190fc in ExecInitForeignScan (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, eflags=eflags@entry=16) at nodeForeignscan.c:229</span></span><br><span class="line"><span class="comment">#2  0x00000000005f6694 in ExecInitNode (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, eflags=eflags@entry=16) at execProcnode.c:277</span></span><br><span class="line"><span class="comment">#3  0x00000000005f11c5 in InitPlan (eflags=16, queryDesc=&lt;optimized out&gt;) at execMain.c:1049</span></span><br><span class="line"><span class="comment">#4  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=16) at execMain.c:264</span></span><br><span class="line"><span class="comment">#5  0x00000000007255e2 in PortalStart (portal=portal@entry=0x1373f50, params=params@entry=0x0, eflags=eflags@entry=0, snapshot=snapshot@entry=0x0) at pquery.c:520</span></span><br><span class="line"><span class="comment">#6  0x0000000000721b42 in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1083</span></span><br><span class="line"><span class="comment">#7  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#8  0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#9  BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#10 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#11 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#12 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresBeginForeignScan (node=0x13bf120, eflags=16) at postgres_fdw.c:1314</span></span><br><span class="line">0x00000000006190fc <span class="keyword">in</span> ExecInitForeignScan (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, eflags=eflags@entry=16)</span><br><span class="line">    at nodeForeignscan.c:229</span><br><span class="line">229fdwroutine-&gt;BeginForeignScan(scanstate, eflags);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x00000000006190fc in ExecInitForeignScan (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, </span></span><br><span class="line">    eflags=eflags@entry=16) at nodeForeignscan.c:229</span><br><span class="line">0x00000000005f6694 <span class="keyword">in</span> ExecInitNode (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, eflags=eflags@entry=16)</span><br><span class="line">    at execProcnode.c:277</span><br><span class="line">277result = (PlanState *) ExecInitForeignScan((ForeignScan *) node,</span><br><span class="line">Value returned is <span class="variable">$13</span> = (ForeignScanState *) 0x13bf120</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x00000000005f6694 in ExecInitNode (node=node@entry=0x13105b0, estate=estate@entry=0x13bef10, </span></span><br><span class="line">    eflags=eflags@entry=16) at execProcnode.c:277</span><br><span class="line">InitPlan (eflags=16, queryDesc=&lt;optimized out&gt;) at execMain.c:1054</span><br><span class="line">1054tupType = ExecGetResultType(planstate);</span><br><span class="line">Value returned is <span class="variable">$14</span> = (PlanState *) 0x13bf120</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  InitPlan (eflags=16, queryDesc=&lt;optimized out&gt;) at execMain.c:1054</span></span><br><span class="line">266MemoryContextSwitchTo(oldcontext);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=16) at execMain.c:266</span></span><br><span class="line">PortalStart (portal=portal@entry=0x1373f50, params=params@entry=0x0, eflags=eflags@entry=0, snapshot=snapshot@entry=0x0)</span><br><span class="line">    at pquery.c:525</span><br><span class="line">525portal-&gt;queryDesc = queryDesc;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  PortalStart (portal=portal@entry=0x1373f50, params=params@entry=0x0, eflags=eflags@entry=0, </span></span><br><span class="line">    snapshot=snapshot@entry=0x0) at pquery.c:525</span><br><span class="line">exec_simple_query (query_string=0x130e810 <span class="string">"select * from t_fdw;"</span>) at postgres.c:1092</span><br><span class="line">1092<span class="keyword">if</span> (IsA(parsetree-&gt;stmt, FetchStmt))</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1092</span></span><br><span class="line"></span><br><span class="line">Breakpoint 5, postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span><br><span class="line">1418&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span></span><br><span class="line"><span class="comment">#1  0x0000000000618f6b in ForeignNext (node=node@entry=0x13bf120) at nodeForeignscan.c:54</span></span><br><span class="line"><span class="comment">#2  0x00000000005f7b2a in ExecScanFetch (recheckMtd=0x618e40 &lt;ForeignRecheck&gt;, accessMtd=0x618ed0 &lt;ForeignNext&gt;, node=0x13bf120) at execScan.c:95</span></span><br><span class="line"><span class="comment">#3  ExecScan (node=0x13bf120, accessMtd=0x618ed0 &lt;ForeignNext&gt;, recheckMtd=0x618e40 &lt;ForeignRecheck&gt;) at execScan.c:145</span></span><br><span class="line"><span class="comment">#4  0x00000000005f000a in ExecProcNode (node=0x13bf120) at ../../../src/include/executor/executor.h:237</span></span><br><span class="line"><span class="comment">#5  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x1335d78, direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=true, operation=CMD_SELECT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x13bf120, estate=0x13bef10) at execMain.c:1726</span></span><br><span class="line"><span class="comment">#6  standard_ExecutorRun (queryDesc=0x1330130, direction=&lt;optimized out&gt;, count=0, execute_once=&lt;optimized out&gt;) at execMain.c:363</span></span><br><span class="line"><span class="comment">#7  0x00000000007247fb in PortalRunSelect (portal=portal@entry=0x1373f50, forward=forward@entry=true, count=0, count@entry=9223372036854775807, dest=dest@entry=0x1335d78) at pquery.c:932</span></span><br><span class="line"><span class="comment">#8  0x0000000000725b10 in PortalRun (portal=portal@entry=0x1373f50, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x1335d78, altdest=altdest@entry=0x1335d78, completionTag=completionTag@entry=0x7fff8c773240 "") at pquery.c:773</span></span><br><span class="line"><span class="comment">#9  0x0000000000721bb7 in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#10 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#11 0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#12 BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#13 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#14 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#15 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span></span><br><span class="line">0x0000000000618f6b <span class="keyword">in</span> ForeignNext (node=node@entry=0x13bf120) at nodeForeignscan.c:54</span><br><span class="line">54slot = node-&gt;fdwroutine-&gt;IterateForeignScan(node);</span><br><span class="line">Value returned is <span class="variable">$15</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000618f6b in ForeignNext (node=node@entry=0x13bf120) at nodeForeignscan.c:54</span></span><br><span class="line">0x00000000005f7b2a <span class="keyword">in</span> ExecScanFetch (recheckMtd=0x618e40 &lt;ForeignRecheck&gt;, accessMtd=0x618ed0 &lt;ForeignNext&gt;, node=0x13bf120)</span><br><span class="line">    at execScan.c:95</span><br><span class="line">95<span class="built_in">return</span> (*accessMtd) (node);</span><br><span class="line">Value returned is <span class="variable">$16</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x00000000005f7b2a in ExecScanFetch (recheckMtd=0x618e40 &lt;ForeignRecheck&gt;, </span></span><br><span class="line">    accessMtd=0x618ed0 &lt;ForeignNext&gt;, node=0x13bf120) at execScan.c:95</span><br><span class="line">219&#125;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecScan (node=&lt;optimized out&gt;, accessMtd=0x618ed0 &lt;ForeignNext&gt;, recheckMtd=0x618e40 &lt;ForeignRecheck&gt;)</span></span><br><span class="line">    at execScan.c:219</span><br><span class="line">ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x1335d78, direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=<span class="literal">true</span>, </span><br><span class="line">    operation=CMD_SELECT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x13bf120, estate=0x13bef10) at execMain.c:1732</span><br><span class="line">1732<span class="keyword">if</span> (TupIsNull(slot))</span><br><span class="line">Value returned is <span class="variable">$17</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x1335d78, direction=&lt;optimized out&gt;, numberTuples=0, </span></span><br><span class="line">    sendTuples=<span class="literal">true</span>, operation=CMD_SELECT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x13bf120, estate=0x13bef10)</span><br><span class="line">    at execMain.c:1732</span><br><span class="line">363ExecutePlan(estate,</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorRun (queryDesc=0x1330130, direction=&lt;optimized out&gt;, count=0, </span></span><br><span class="line">    execute_once=&lt;optimized out&gt;) at execMain.c:363</span><br><span class="line"></span><br><span class="line">Breakpoint 5, postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span><br><span class="line">1418&#123;</span><br><span class="line"><span class="comment"># 再次进入postgresIterateForeignScan.后续跳过中间的8次，</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Breakpoint 5, postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span><br><span class="line">1418&#123;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresIterateForeignScan (node=0x13bf120) at postgres_fdw.c:1418</span></span><br><span class="line">0x0000000000618f6b <span class="keyword">in</span> ForeignNext (node=node@entry=0x13bf120) at nodeForeignscan.c:54</span><br><span class="line">54slot = node-&gt;fdwroutine-&gt;IterateForeignScan(node);</span><br><span class="line">Value returned is <span class="variable">$45</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000618f6b in ForeignNext (node=node@entry=0x13bf120) at nodeForeignscan.c:54</span></span><br><span class="line">0x00000000005f7b2a <span class="keyword">in</span> ExecScanFetch (recheckMtd=0x618e40 &lt;ForeignRecheck&gt;, accessMtd=0x618ed0 &lt;ForeignNext&gt;, node=0x13bf120)</span><br><span class="line">    at execScan.c:95</span><br><span class="line">95<span class="built_in">return</span> (*accessMtd) (node);</span><br><span class="line">Value returned is <span class="variable">$46</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x00000000005f7b2a in ExecScanFetch (recheckMtd=0x618e40 &lt;ForeignRecheck&gt;, </span></span><br><span class="line">    accessMtd=0x618ed0 &lt;ForeignNext&gt;, node=0x13bf120) at execScan.c:95</span><br><span class="line">219&#125;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecScan (node=&lt;optimized out&gt;, accessMtd=0x618ed0 &lt;ForeignNext&gt;, recheckMtd=0x618e40 &lt;ForeignRecheck&gt;)</span></span><br><span class="line">    at execScan.c:219</span><br><span class="line">ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x1335d78, direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=<span class="literal">true</span>, </span><br><span class="line">    operation=CMD_SELECT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x13bf120, estate=0x13bef10) at execMain.c:1732</span><br><span class="line">1732<span class="keyword">if</span> (TupIsNull(slot))</span><br><span class="line">Value returned is <span class="variable">$47</span> = (TupleTableSlot *) 0x13bf730</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x1335d78, direction=&lt;optimized out&gt;, numberTuples=0, </span></span><br><span class="line">    sendTuples=<span class="literal">true</span>, operation=CMD_SELECT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x13bf120, estate=0x13bef10)</span><br><span class="line">    at execMain.c:1732</span><br><span class="line">377<span class="keyword">if</span> (sendTuples)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorRun (queryDesc=0x1330130, direction=&lt;optimized out&gt;, count=0, </span></span><br><span class="line">    execute_once=&lt;optimized out&gt;) at execMain.c:377</span><br><span class="line">PortalRunSelect (portal=portal@entry=0x1373f50, forward=forward@entry=<span class="literal">true</span>, count=0, count@entry=9223372036854775807, </span><br><span class="line">    dest=dest@entry=0x1335d78) at pquery.c:934</span><br><span class="line">934nprocessed = queryDesc-&gt;estate-&gt;es_processed;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  PortalRunSelect (portal=portal@entry=0x1373f50, forward=forward@entry=true, count=0, </span></span><br><span class="line">    count@entry=9223372036854775807, dest=dest@entry=0x1335d78) at pquery.c:934</span><br><span class="line">PortalRun (portal=portal@entry=0x1373f50, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=<span class="literal">true</span>, </span><br><span class="line">    run_once=run_once@entry=<span class="literal">true</span>, dest=dest@entry=0x1335d78, altdest=altdest@entry=0x1335d78, </span><br><span class="line">    completionTag=completionTag@entry=0x7fff8c773240 <span class="string">""</span>) at pquery.c:780</span><br><span class="line">780<span class="keyword">if</span> (completionTag &amp;&amp; portal-&gt;commandTag)</span><br><span class="line">Value returned is <span class="variable">$48</span> = 10</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  PortalRun (portal=portal@entry=0x1373f50, count=count@entry=9223372036854775807, </span></span><br><span class="line">    isTopLevel=isTopLevel@entry=<span class="literal">true</span>, run_once=run_once@entry=<span class="literal">true</span>, dest=dest@entry=0x1335d78, altdest=altdest@entry=0x1335d78, </span><br><span class="line">    completionTag=completionTag@entry=0x7fff8c773240 <span class="string">""</span>) at pquery.c:780</span><br><span class="line">exec_simple_query (query_string=0x130e810 <span class="string">"select * from t_fdw;"</span>) at postgres.c:1130</span><br><span class="line">1130receiver-&gt;rDestroy(receiver);</span><br><span class="line">Value returned is <span class="variable">$49</span> = <span class="literal">true</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1130</span></span><br><span class="line"></span><br><span class="line">Breakpoint 7, postgresEndForeignScan (node=0x13bf120) at postgres_fdw.c:1515</span><br><span class="line">1515&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresEndForeignScan (node=0x13bf120) at postgres_fdw.c:1515</span></span><br><span class="line"><span class="comment">#1  0x0000000000619173 in ExecEndForeignScan (node=0x13bf120) at nodeForeignscan.c:249</span></span><br><span class="line"><span class="comment">#2  0x00000000005f16ad in ExecEndPlan (estate=0x13bef10, planstate=&lt;optimized out&gt;) at execMain.c:1612</span></span><br><span class="line"><span class="comment">#3  standard_ExecutorEnd (queryDesc=0x1330130) at execMain.c:495</span></span><br><span class="line"><span class="comment">#4  0x00000000005abfc4 in PortalCleanup (portal=&lt;optimized out&gt;) at portalcmds.c:301</span></span><br><span class="line"><span class="comment">#5  0x000000000084445a in PortalDrop (portal=0x1373f50, isTopCommit=&lt;optimized out&gt;) at portalmem.c:499</span></span><br><span class="line"><span class="comment">#6  0x0000000000721bc8 in exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1132</span></span><br><span class="line"><span class="comment">#7  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#8  0x000000000047a861 in BackendRun (port=0x1330430) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#9  BackendStartup (port=0x1330430) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#10 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#11 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x13093c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#12 0x000000000047b2a1 in main (argc=3, argv=0x13093c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresEndForeignScan (node=0x13bf120) at postgres_fdw.c:1515</span></span><br><span class="line">0x0000000000619173 <span class="keyword">in</span> ExecEndForeignScan (node=0x13bf120) at nodeForeignscan.c:249</span><br><span class="line">249node-&gt;fdwroutine-&gt;EndForeignScan(node);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000619173 in ExecEndForeignScan (node=0x13bf120) at nodeForeignscan.c:249</span></span><br><span class="line">ExecEndPlan (estate=0x13bef10, planstate=&lt;optimized out&gt;) at execMain.c:1617</span><br><span class="line">1617foreach(l, estate-&gt;es_subplanstates)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecEndPlan (estate=0x13bef10, planstate=&lt;optimized out&gt;) at execMain.c:1617</span></span><br><span class="line">498UnregisterSnapshot(estate-&gt;es_snapshot);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorEnd (queryDesc=0x1330130) at execMain.c:498</span></span><br><span class="line">PortalCleanup (portal=&lt;optimized out&gt;) at portalcmds.c:302</span><br><span class="line">302FreeQueryDesc(queryDesc);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  PortalCleanup (portal=&lt;optimized out&gt;) at portalcmds.c:302</span></span><br><span class="line">PortalDrop (portal=0x1373f50, isTopCommit=&lt;optimized out&gt;) at portalmem.c:500</span><br><span class="line">500portal-&gt;cleanup = NULL;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  PortalDrop (portal=0x1373f50, isTopCommit=&lt;optimized out&gt;) at portalmem.c:500</span></span><br><span class="line">exec_simple_query (query_string=0x130e810 <span class="string">"select * from t_fdw;"</span>) at postgres.c:1134</span><br><span class="line">1134<span class="keyword">if</span> (lnext(parsetree_item) == NULL)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  exec_simple_query (query_string=0x130e810 "select * from t_fdw;") at postgres.c:1134</span></span><br><span class="line">0x0000000000722e62 <span class="keyword">in</span> PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, dbname=0x1338450 <span class="string">"fdw"</span>, </span><br><span class="line">    username=&lt;optimized out&gt;) at postgres.c:4153</span><br><span class="line">4153exec_simple_query(query_string);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1338568, </span></span><br><span class="line">    dbname=0x1338450 <span class="string">"fdw"</span>, username=&lt;optimized out&gt;) at postgres.c:4153</span><br><span class="line"></span><br><span class="line"><span class="comment"># 说明，postgresIterateForeignScan一共调用了11次，因为外部表总行数是10行，postgresIterateForeignScan最后一次调用返回NULL，用于结束迭代。</span></span><br><span class="line">fdw=<span class="comment"># insert into t_test values(2,'1');</span></span><br><span class="line">INSERT 0 1</span><br><span class="line">fdw=<span class="comment"># select * from t_fdw;</span></span><br><span class="line"> id |     c1     | c2 </span><br><span class="line">----+------------+----</span><br><span class="line">  1 | 1          | 2</span><br><span class="line">  2 | 1          | 2</span><br><span class="line">  3 | 1          | 2</span><br><span class="line">  4 | 1          | 2</span><br><span class="line">  5 | 1          | 2</span><br><span class="line">  6 | 1          | 2</span><br><span class="line">  7 | 1          | 2</span><br><span class="line">  8 | 1          | 2</span><br><span class="line">  9 | 1          | 2</span><br><span class="line"> 10 | 1          | 2</span><br><span class="line">(10 rows)</span><br></pre></td></tr></table></figure><p>根据以上的代码跟踪，可以更好的理解实现FDW的7个必须回调函数的调用时机，如果对PostgreSQL的查询机制更加熟悉的话，或许对于如何实现这个7个回调函数跟有帮助。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;上篇大概介绍了FDW必须实现的7个回调函数&lt;a href=&quot;https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/&quot;&gt;学习PostgreSQL的FDW(#1)&lt;/a&gt;，本篇将从源码跟踪，这7个回调函数的调用时机，以P
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
      <category term="gdb" scheme="https://oyo-byte.github.io/tags/gdb/"/>
    
  </entry>
  
  <entry>
    <title>学习PostgreSQL的查询机制</title>
    <link href="https://oyo-byte.github.io/2018/08/03/learn_about_pg_query_processing/"/>
    <id>https://oyo-byte.github.io/2018/08/03/learn_about_pg_query_processing/</id>
    <published>2018-08-03T10:10:45.600Z</published>
    <updated>2018-08-07T17:24:35.167Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在PostgreSQL中，查询语句经过以下5个子系统处理：</p><ol><li><p>Parser<br>用于将文本式的SQL命令转换成解析树</p></li><li><p>Analyzer/Analyser<br>用于执行解析树的语义分析并生成查询树</p></li><li>Rewriter<br>重写器用于根据规则系统中已存在的规则转换查询树</li><li>Planner<br>规划器生成可以从查询树中最有效地执行的计划树</li><li>Executor<br>执行器通过按计划树创建的顺序访问表和索引来执行查询</li></ol><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180806173200.png" alt=""></p><h3 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a>Parser</h3><p>解析器把</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;在PostgreSQL中，查询语句经过以下5个子系统处理：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;Parser&lt;br&gt;用于将文本式的SQL命令转换
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>学习PostgreSQL的FDW(#1)</title>
    <link href="https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/"/>
    <id>https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/</id>
    <published>2018-08-03T07:52:42.563Z</published>
    <updated>2018-08-07T17:14:45.415Z</updated>
    
    <content type="html"><![CDATA[<p>实现一个FDW的核心是实现一组回调函数，有了这些回调函数的帮助, 在查询外部表对象的执行过程中就可以将运行逻辑切换至自定义的扩展代码中, 进而遵照PG的内部机制实现对外部数据源的访问。</p><p>目前PostgreSQL11 beta2，提供的FDW回调函数接口有39个。FDW的实现者需要根据外部数据源自身的能力（比如是否支持写操作，以及是否支持在外部数据源端执行join操作等等）对这些接口有选择地予以实现。</p><p>这些接口中, 最核心的接口有7个。无论外部数据源自身能力如何, 这7个接口是实现通过外部表对象访问该数据源的必须接口。它们的接口定义如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*GetForeignRelSize_function)</span> <span class="params">(PlannerInfo *root, RelOptInfo *baserel, Oid foreigntableid)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*GetForeignPaths_function)</span> <span class="params">(PlannerInfo *root, RelOptInfo *baserel, Oid foreigntableid)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ForeignScan *(*GetForeignPlan_function) (PlannerInfo *root, RelOptInfo *baserel,Oid foreigntableid, ForeignPath *best_path, List *tlist, List *scan_clauses, Plan *outer_plan);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*BeginForeignScan_function)</span> <span class="params">(ForeignScanState *node, <span class="keyword">int</span> eflags)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> TupleTableSlot *(*IterateForeignScan_function) (ForeignScanState *node);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*ReScanForeignScan_function)</span> <span class="params">(ForeignScanState *node)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*EndForeignScan_function)</span> <span class="params">(ForeignScanState *node)</span></span>;</span><br></pre></td></tr></table></figure><p>在PG中，查询语句经过以下5个子系统处理：</p><ol><li><p>Parser<br>用于将文本式的SQL命令转换成解析树</p></li><li><p>Analyzer/Analyser<br>用于执行解析树的语义分析并生成查询树</p></li><li>Rewriter<br>重写器用于根据规则系统中已存在的规则转换查询树</li><li>Planner<br>规划器生成可以从查询树中最有效地执行的计划树</li><li>Executor<br>执行器通过按计划树创建的顺序访问表和索引来执行查询</li></ol><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180806173200.png" alt=""></p><p>可以整合成三个大阶段：  </p><ul><li>Parser: 包含对SQL的语法解析，语义校验，查询重写</li><li>Optimizer：生成查询计划</li><li>Executor：按照火山模型执行查询计划的算子并向上返回数据</li></ul><p>PG的FDW所需的7个回调函数主要是在Optimizer和Executor阶段进行“介入”:<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180806173225.png" alt=""></p><p>这7个回调函数详细的调用时机以及作用：</p><table><thead><tr><th style="text-align:left">回调函数</th><th style="text-align:left">在PG中的调用时机</th><th style="text-align:left">作用</th><th style="text-align:left">详细描述</th></tr></thead><tbody><tr><td style="text-align:left">GetForeignRelSize</td><td style="text-align:left">优化器生成访问路径的过程中对外部表估算访问代价时</td><td style="text-align:left">提供外部表对于计算访问代价所需的基础数据，如表的元组数以及元组的平均长度,并将这些数据保存在输入参数baserel的字段”rows”以及”width”中</td><td style="text-align:left"><code>void GetForeignRelSize (PlannerInfo *root, RelOptInfo *baserel, Oid foreigntableid);</code>  <br>root是规划器的关于该查询的全局信息；baserel是规划器的关于该表的信息；foreigntableid是外部表在pg_class中的 OID （foreigntableid可以从规划器的数据结构中获得，但是为了减少工作量，这里直接显式地将它传递给函数）；<br>这个函数应该更新baserel-&gt;rows为表扫描根据限制条件完成了过滤后将返回的预期行数。baserel-&gt;rows的初始值只是一个常数的默认估计值，应该尽可能把它替换掉。如果该函数能够计算出一个平均结果行宽度的更好的估计值，该函数也可能选择更新baserel-&gt;width。</td></tr><tr><td style="text-align:left">GetForeignPaths</td><td style="text-align:left">生成对外部表的访问路径时</td><td style="text-align:left">生成对目标外部表的访问路径(通过PG中的接口createforeignscanpath()生成)</td><td style="text-align:left"><code>void GetForeignPaths (PlannerInfo *root, RelOptInfo *baserel, Oid foreigntableid);</code><br>参数和GetForeignRelSize相同；<br>这个函数必须为外部表上的扫描生成至少一个访问路径（ForeignPath节点），并且必须调用add_path把每一个这样的路径加入到baserel-&gt;pathlist中。我们推荐使用create_foreignscan_path来建立ForeignPath节点。该函数可以生成多个访问路径，例如一个具有合法pathkeys的路径表示一个预排序好的结果。每一个访问路径必须包含代价估计，并且能包含任何FDW的私有信息，这种信息被用来标识想要使用的指定扫描方法。</td></tr><tr><td style="text-align:left">GetForeignPlan</td><td style="text-align:left">优化器生成扫描外部表的查询计划节点时</td><td style="text-align:left">生成访问目标外部表的ForeignScan计划节点(通过PG中的接口make_foreignscan())</td><td style="text-align:left"><code>ForeignScan * GetForeignPlan (PlannerInfo *root, RelOptInfo *baserel, Oid foreigntableid, ForeignPath *best_path, List *tlist, List *scan_clauses, Plan *outer_plan);</code><br>参数和GetForeignRelSize的一样，外加选中的ForeignPath（在前面由GetForeignPaths、GetForeignJoinPaths或者GetForeignUpperPaths产生）、被计划节点发出的目标列表以及计划节点强制的限制子句以及被RecheckForeignScan执行的复查所使用的ForeignScan的外子计划（如果该路径是用于一个连接而非基本关系，则foreigntableid是InvalidOid）；<br>这个函数必须创建并返回一个ForeignScan计划节点，推荐使用make_foreignscan来建立ForeignScan节点。</td></tr><tr><td style="text-align:left">BeginForeignScan</td><td style="text-align:left">执行器即将开始执行ForeignScan算子，进行该算子相关的初始化时</td><td style="text-align:left">获取执行ForeignScan算子所需的信息，并将它们组织并保存在ForeignScanState中</td><td style="text-align:left"><code>void BeginForeignScan (ForeignScanState *node, int eflags);</code><br>它应该执行任何在扫描能够开始之前需要完成的初始化工作，但是并不开始执行真正的扫描（会在第一次调用IterateForeignScan时完成）。ForeignScanState节点已经被创建好了，但是它的fdw_state属性仍然为 NULL。关于要被扫描的表的信息可以通过ForeignScanState节点访问（特殊地，从底层的ForeignScan计划节点，它包含任何由GetForeignPlan提供的FDW私有信息）。eflags包含描述执行器对该计划节点操作模式的标志位。<br>注意当(eflags &amp; EXEC_FLAG_EXPLAIN_ONLY)为真时，这个函数不应该执行任何外部可见的动作；它应当只做最少的事情来创建对ExplainForeignScan 和EndForeignScan有效的节点状态</td></tr><tr><td style="text-align:left">IterateForeignScan</td><td style="text-align:left">执行ForeignScan算子过程中需要获取下一元组时</td><td style="text-align:left">读取外部数据源的一行数据，并将它组织为PG中的Tuple(即TupleTableSlot). 当该回调函数返回一个空的TupleTableSlot结构时, 迭代器停止迭代</td><td style="text-align:left"><code>TupleTableSlot * IterateForeignScan (ForeignScanState *node);</code><br>从外部源获得一行，将它放在一个元组表槽中返回（节点的ScanTupleSlot应当被用于此目的）。如果没有更多的行可用则返回 NULL。元组表槽设施允许一个物理的或者虚拟的元组被返回；在大部分情况下出于性能的考虑会倾向于选择后者。注意这是在一个短期存在的内存上下文中被调用的，该内存上下文会在调用之间被重置。如果需要长期存在的存储，需要在BeginForeignScan中创建内存上下文，或者使用节点的EState中的es_query_cxt。<br>如果提供了fdw_scan_tlist目标列表，被返回的行必须匹配它，如果没有提供则它们必须匹配被扫描的外部表的行类型。如果选择优化掉不需要的列，你应该在那些列的位置上插入控制或者生成一个忽略了那些列的fdw_scan_tlist列表。<br>注意PostgreSQL的执行器并不在乎被返回的行是否违背了定义在该外部表上的任何约束 — 但是规划器会在乎这一点，并且如果在外部表中有可见行不满足一个约束，规划器可能会错误地优化查询。如果当用户已经声明一个约束应该为真时它却被违背，最合适的处理可能是产生一个错误（就像在数据类型失配的情况下所作的那样）</td></tr><tr><td style="text-align:left">ReScanForeignScan</td><td style="text-align:left">执行Nested Loop过程中需要重置Inner Scan时(即Outter Scan需要向前推进一行时)</td><td style="text-align:left">将外部数据源的读取位置重置回最初的起始位置</td><td style="text-align:left"><code>void ReScanForeignScan (ForeignScanState *node);</code><br>注意扫描所依赖的任何参数可能已经改变了值，因此新扫描不一定会返回完全相同的行。</td></tr><tr><td style="text-align:left">EndForeignScan</td><td style="text-align:left">ForeignScan算子执行完成时</td><td style="text-align:left">释放整个ForeignScan算子执行过程中占用的外部资源或FDW中的资源</td><td style="text-align:left"><code>void EndForeignScan (ForeignScanState *node);</code><br>通常释放palloc过的内存并不重要，但是打开的文件和到远程服务器的连接等应该被清理。</td></tr></tbody></table><p>以上是必须实现的扫描相关的回调函数</p><p><br><br><br></p><p>参考：</p><p><a href="http://www.interdb.jp/pg/pgsql03.html" target="_blank" rel="noopener">http://www.interdb.jp/pg/pgsql03.html</a><br><a href="https://xiaowing.github.io/post/20180513_write_pgfdw_in_golang_part02/" target="_blank" rel="noopener">https://xiaowing.github.io/post/20180513_write_pgfdw_in_golang_part02/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;实现一个FDW的核心是实现一组回调函数，有了这些回调函数的帮助, 在查询外部表对象的执行过程中就可以将运行逻辑切换至自定义的扩展代码中, 进而遵照PG的内部机制实现对外部数据源的访问。&lt;/p&gt;
&lt;p&gt;目前PostgreSQL11 beta2，提供的FDW回调函数接口有39个
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
  </entry>
  
  <entry>
    <title>解读C语言声明</title>
    <link href="https://oyo-byte.github.io/2018/07/26/%E8%A7%A3%E8%AF%BBC%E8%AF%AD%E8%A8%80%E5%A3%B0%E6%98%8E/"/>
    <id>https://oyo-byte.github.io/2018/07/26/解读C语言声明/</id>
    <published>2018-07-26T03:18:23.922Z</published>
    <updated>2018-08-07T15:50:27.959Z</updated>
    
    <content type="html"><![CDATA[<p>C语言所有复杂的指针声明，都是由各种声明嵌套构成的。如何解读复杂指针声明呢？</p><p>右左法则（既著名又常用的方法 ）</p><p>右左法则英文原文：</p><blockquote><p>The right-left rule: Start reading the declaration from the innermost parentheses, go right, and then go left. When you encounter parentheses, the direction should be reversed. Once everything in the parentheses has been parsed, jump out of it. Continue till the whole declaration has been parsed.</p></blockquote><p>翻译如下：</p><p>右左法则：首先从最里面的圆括号看起，然后往右看，再往左看。每当遇到圆括号时，就应该掉转阅读方向。一旦解析完圆括号里面所有的东西，就跳出圆括号。重复这个过程直到整个声明解析完毕。</p><p>这时就会有个疑惑：怎样判断那个括号是最里面的呢？</p><p>因此需要对这个法则进行修改，结合《C专家编程》里提到的分析方法，应该是从未定义的标识符开始阅读，而不是从括号读起，之所以是未定义的标识符，是因为一个声明里面可能有多个标识符，但未定义的标识符只会有一个。</p><p>分析C语言的声明步骤：</p><ul><li>第1步：从左至右，找到第一个未定义的标识符。</li><li>第2步：查看标识符右边的符号，并确定是一个数组还是函数。</li><li>第3步：查看左边的符号。</li><li>第3步a：如果是左括号则将处理过的部分结合到一起直到遇到右括号作为标识符返回第2步。</li><li>第3步b：如果是<code>const</code>，<code>volatile</code>，<code>*</code>其中之一则继续向左直到不是这三个符号之一。</li><li>第4步：剩下的符号构成声明的基本类型。</li></ul><p>感觉还是有点晕？</p><p>结合例子说明：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> (*(*x[<span class="number">3</span>])())[<span class="number">5</span>];</span><br></pre></td></tr></table></figure><ul><li>第1步：从左到右找到第一个标识符x。</li><li>第2步：查看标识符右边的符号是<code>[</code>，说明x是一个具有3个元素的数组。</li><li>第3步：查看左边的符号是<code>*</code>，转至第3步b。</li><li>第3步b：说明数组中的元素都是指针，向左就是左括号了，将这个左括号结合到对应的右括号（也就是<code>(*x[3])</code>）作为新的标识符返回第2步 。</li><li>第2步：查看右边的符号是<code>(</code>，说明指针是指向参数列表为空的函数的指针。</li><li>查看左边的符号，是<code>*</code>, 转至第3步b。</li><li>说明函数的返回值是指针，向左是左括号，将这个左括号结合到对应的右括号（也就是<code>(*(*x[3])())</code>）作为新的标识符返回第2步。</li><li>第2步：查看右边的符号是<code>[</code>，所以是指向具有五个元素的数组的指针。</li><li>第3步：查看左边的括号，既不是a情况，也不是b情况，跳至第4步。</li><li>第4步：数组的类型为char。</li></ul><p>所以以上的声明表示的是x是一个具有3个元素的数组，数组的每个元素都是一个指向函数的指针，函数的参数列表为空，返回值是指向一个具有5个元素的指针，元素的类型为char。</p><p>来个程序验证一下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> *</span><br><span class="line">func()&#123;</span><br><span class="line">    <span class="keyword">char</span> arr[<span class="number">5</span>] = &#123;<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>&#125;;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> (*(*x[<span class="number">3</span>])())[<span class="number">5</span>]; <span class="comment">// x是一个长度为3的数组，元素是一个函数指针，函数的返回值是指向一个长度为5的char型数组指针。</span></span><br><span class="line"></span><br><span class="line">    x[<span class="number">0</span>] = &amp;func;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"x的总长度：%d \n"</span>,<span class="keyword">sizeof</span>(x));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"x元素的长度：%d \n"</span>,<span class="keyword">sizeof</span>(x[<span class="number">0</span>]));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"函数指针的长度：%d \n"</span>,<span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"x的元素个数：%d \n"</span>,<span class="keyword">sizeof</span>(x)/<span class="keyword">sizeof</span>(x[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> (*c)[<span class="number">5</span>] = (x[<span class="number">0</span>])();<span class="comment">//c是一个指向长度为5的char型数组的指针</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"c的总长度：%d \n"</span>,<span class="keyword">sizeof</span>(*c));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"c元素的长度：%d \n"</span>,<span class="keyword">sizeof</span>((*c)[<span class="number">0</span>]));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"char型的长度：%d \n"</span>,<span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"c的第4个元素是：%c \n"</span>,(*c)[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"整体调用，第4个元素是：%c \n"</span>,(*(x[<span class="number">0</span>])())[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">x的总长度：24</span><br><span class="line">x元素的长度：8</span><br><span class="line">函数指针的长度：8</span><br><span class="line">x的元素个数：3</span><br><span class="line">c的总长度：5</span><br><span class="line">c元素的长度：1</span><br><span class="line">chart性的长度：1</span><br><span class="line">c的第4个元素是：4</span><br><span class="line">整体调用，结果的第4个元素是：4</span><br></pre></td></tr></table></figure></p><p>Try:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="keyword">char</span> *(*c[<span class="number">10</span>])(<span class="keyword">int</span> **p)</span><br></pre></td></tr></table></figure><p><br></p><p><br></p><p>Clockwise/Spiral Rule（顺时针/螺旋法则）</p><p>三步：</p><ol><li><p>从未定义标识符开始，以顺时针方向移动，当遇到以下元素时，用相应的语言陈述替换它们：</p><p>​    <code>[X]</code> or <code>[]</code> =&gt;  Array X size of… or Array undefined size of…</p><p>​    <code>(type1, type2)</code> =&gt; function passing type1 and type2 returning…</p><p>​    <code>*</code> =&gt;  pointer(s) to…</p></li><li><p>继续以上步骤，直至覆盖所有的字符。</p></li><li><p>首先解决括号中的内容。</p></li></ol><p>例1：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *str[<span class="number">10</span>];</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">     +-------+</span><br><span class="line">     | +-+   |</span><br><span class="line">     | ^ |   |</span><br><span class="line"><span class="keyword">char</span> *str[<span class="number">10</span>];</span><br><span class="line"> ^   ^   |   |</span><br><span class="line"> |   +---+   |</span><br><span class="line"> +-----------+</span><br></pre></td></tr></table></figure><ul><li><p>str是什么？</p><p>“str是一个……</p></li><li><p>从str开始以顺时针方向移动，遇到<code>[</code>，这意味着是一个数组</p><p>“str是一个长度为10的数组，元素是……</p></li><li><p>继续移动，遇到<code>*</code>,说明是指针</p><p>“str是一个长度为10的数组，元素是指向……的指针</p></li><li><p>继续遇到了<code>;</code>，然后继续移动，遇到<code>char</code></p><p>“str是一个长度为10的数组，元素是指向char的指针”</p></li><li><p>遍历完所有字符，解析完毕</p></li></ul><p>以上的<code>char (*(*x[3])())[5];</code>亦可这样去处理<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">      +----------+</span><br><span class="line">      | +-----+  |</span><br><span class="line">      | |++   |  |</span><br><span class="line">      | |^|   |  |</span><br><span class="line"><span class="keyword">char</span> (*(*x[<span class="number">3</span>])())[<span class="number">5</span>];</span><br><span class="line"> ^    ^ ^ |   |  |</span><br><span class="line"> |    | +-+   |  |</span><br><span class="line"> |    +-------+  |</span><br><span class="line"> +---------------+</span><br></pre></td></tr></table></figure></p><ul><li>x是什么？<br>“x是一个……</li><li>从x开始以顺时针方向移动，遇到<code>[</code>，这意味着是一个数组<br>“x是一个长度为3的数组，元素是……</li><li>继续移动，遇到<code>*</code>,说明是指针<br>“x是一个长度为3的数组，元素是指向……的指针</li><li>继续遇到<code>(</code>,说明是函数<br>“x是一个长度为3的数组，元素是指向函数的指针，函数是……</li><li>继续遇到<code>*</code>，说明是指针<br>“x是一个长度为3的数组，元素是指向函数的指针，函数是参数列表为空，返回值是指向……的指针</li><li>继续遇到<code>[</code>，说明是数组<br>“x是一个长度为3的数组，元素是指向函数的指针，函数是参数列表为空，返回值是指向长度为5的……类型元素的数组的指针</li><li>继续遇到<code>char</code>,说明元素是char型<br>“x是一个长度为3的数组，元素是指向函数的指针，函数是参数列表为空，返回值是指向长度为5的char类型元素的数组的指针”</li><li>遍历完毕</li></ul><p>Try:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span>  <span class="keyword">char</span> *(*fp)( <span class="keyword">int</span>, <span class="keyword">float</span> *);</span><br><span class="line"><span class="number">3.</span>  <span class="keyword">void</span> (*signal(<span class="keyword">int</span>, <span class="keyword">void</span> (*fp)(<span class="keyword">int</span>)))(<span class="keyword">int</span>);</span><br></pre></td></tr></table></figure><p> <br> <br> <br> <br> <br> <br> <br> <br></p><p>Answer：</p><ol><li>c是一个具有10个元素的数组，数组的元素都是函数指针，其所指向的函数是接受一个指向整型指针的指针，返回值是指向char的指针。</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">     +-----------------+</span><br><span class="line">     | +------+     +-+|</span><br><span class="line">     | |++    |     |++|</span><br><span class="line">     | |^|    |     |^||</span><br><span class="line"><span class="keyword">char</span> *(*c[<span class="number">10</span>])(<span class="keyword">int</span> **p);</span><br><span class="line">  ^  ^ ^ |    |    ^^ ||</span><br><span class="line">  |  | +-+    |    |+-+|</span><br><span class="line">  |  +--------+    +--+|</span><br><span class="line">  +--------------------+</span><br></pre></td></tr></table></figure><ol start="2"><li>fp是一个函数指针，该函数接受一个整型和一个浮点型指针入参，返回值是指向char的指针。</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">     +--------------------+</span><br><span class="line">     | +---+              |</span><br><span class="line">     | |+-+|              |</span><br><span class="line">     | |^ ||              |</span><br><span class="line"><span class="keyword">char</span> *(*fp)( <span class="keyword">int</span>, <span class="keyword">float</span> *);</span><br><span class="line"> ^   ^ ^  ||              |</span><br><span class="line"> |   | +--+|              |</span><br><span class="line"> |   +-----+              |</span><br><span class="line"> +------------------------+</span><br></pre></td></tr></table></figure><ol start="3"><li>signal是一个函数，该函数值一个接受一个整型和一个函数指针（该函数是入参是整型，返回值为空void），返回值是指向一个入参是整型，返回值是空void的函数指针。</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">      +-----------------------------+</span><br><span class="line">      |                  +---+      |</span><br><span class="line">      |  +---+           |+-+|      |</span><br><span class="line">      |  ^   |           |^ ||      |</span><br><span class="line"><span class="keyword">void</span> (*signal(<span class="keyword">int</span>, <span class="keyword">void</span> (*fp)(<span class="keyword">int</span>)))(<span class="keyword">int</span>);</span><br><span class="line"> ^    ^      |      ^    ^  ||      |</span><br><span class="line"> |    +------+      |    +--+|      |</span><br><span class="line"> |                  +--------+      |</span><br><span class="line"> +----------------------------------+</span><br></pre></td></tr></table></figure><p><br><br><br></p><p>参考：</p><p><a href="https://blog.csdn.net/wangweixaut061/article/details/6549768" target="_blank" rel="noopener">C语言复杂声明解析</a></p><p><a href="https://blog.csdn.net/jixuxjixu3/article/details/5824431" target="_blank" rel="noopener">c语言声明的分析方法</a></p><p><a href="http://c-faq.com/decl/spiral.anderson.html" target="_blank" rel="noopener">The Clockwise/Spiral Rule</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;C语言所有复杂的指针声明，都是由各种声明嵌套构成的。如何解读复杂指针声明呢？&lt;/p&gt;
&lt;p&gt;右左法则（既著名又常用的方法 ）&lt;/p&gt;
&lt;p&gt;右左法则英文原文：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The right-left rule: Start reading th
      
    
    </summary>
    
      <category term="C" scheme="https://oyo-byte.github.io/categories/C/"/>
    
    
  </entry>
  
  <entry>
    <title>PostgreSQL使用oracle_fdw与Oracle查询性能对比</title>
    <link href="https://oyo-byte.github.io/2018/07/25/PostgreSQL%E4%BD%BF%E7%94%A8oracle_fdw%E4%B8%8EOracle%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94/"/>
    <id>https://oyo-byte.github.io/2018/07/25/PostgreSQL使用oracle_fdw与Oracle查询性能对比/</id>
    <published>2018-07-25T03:29:52.892Z</published>
    <updated>2018-08-07T17:24:14.317Z</updated>
    
    <content type="html"><![CDATA[<h3 id="在PostgreSQL中使用oracle-fdw"><a href="#在PostgreSQL中使用oracle-fdw" class="headerlink" title="在PostgreSQL中使用oracle_fdw"></a>在PostgreSQL中使用oracle_fdw</h3><h4 id="安装oracle-fdw插件"><a href="#安装oracle-fdw插件" class="headerlink" title="安装oracle_fdw插件"></a>安装oracle_fdw插件</h4><ol><li>安装前要求：</li></ol><ul><li>全部功能要求PostgreSQL9.3及以上</li><li>Oracle client要求10.1以上</li><li>确保PostgreSQL配置了<code>--without-ldap</code></li><li>确保<code>pg_config</code>在PATH中(用 <code>pg_config --pgxs</code>测试)</li><li>设置了ORACLE_HOME环境变量</li></ul><p><a href="https://github.com/laurenz/oracle_fdw" target="_blank" rel="noopener">下载oracle_fdw源代码</a>,<br>并解压到某个目录下，进入文件目录，执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make install</span></span><br></pre></td></tr></table></figure><p>安装完毕后，使用psql连接到PostgreSQL；<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> psql -d testdb;</span></span><br></pre></td></tr></table></figure></p><p>使用PostgreSQL的超级用户配置oralce_fdw:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">testdb=# create extension oracle_fdw;</span><br><span class="line">testdb=# create server oracle_121_56 foreign data wrapper oracle_fdw options (dbserver '//192.168.121.56:1521/orcl');</span><br><span class="line">testdb=# create user mapping for public server oracle_121_56 options (user 'dbuser' password 'test');</span><br></pre></td></tr></table></figure><h3 id="简单查询，无索引"><a href="#简单查询，无索引" class="headerlink" title="简单查询，无索引"></a>简单查询，无索引</h3><p>生成测试数据，创建一个表，并同时添加1百万条数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_table <span class="keyword">as</span> <span class="keyword">select</span> <span class="keyword">rownum</span> <span class="keyword">as</span> <span class="keyword">id</span>,to_char(<span class="keyword">sysdate</span> + <span class="keyword">rownum</span>/<span class="number">24</span>/<span class="number">3600</span>, <span class="string">'yyyy-mm-dd hh24:mi:ss'</span>) <span class="keyword">as</span> inc_datetime,trunc(dbms_random.value(<span class="number">0</span>, <span class="number">100</span>)) <span class="keyword">as</span> random_id,dbms_random.string(<span class="string">'x'</span>, <span class="number">20</span>) random_string <span class="keyword">from</span> dual <span class="keyword">connect</span> <span class="keyword">by</span> <span class="keyword">level</span> &lt;= <span class="number">1000000</span>;</span><br></pre></td></tr></table></figure><p>创建完表后，在原来表的基础上追加记录<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_table (<span class="keyword">ID</span>, INC_DATETIME,RANDOM_ID,RANDOM_STRING) <span class="keyword">select</span> <span class="keyword">rownum</span> <span class="keyword">as</span> <span class="keyword">id</span>,  to_char(<span class="keyword">sysdate</span> + <span class="keyword">rownum</span>, <span class="string">'yyyy-mm-dd hh24:mi:ss'</span>) <span class="keyword">as</span> inc_datetime,trunc(dbms_random.value(<span class="number">0</span>, <span class="number">100</span>)) <span class="keyword">as</span> random_id, dbms_random.string(<span class="string">'x'</span>, <span class="number">20</span>) random_string  <span class="keyword">from</span> dual  <span class="keyword">connect</span> <span class="keyword">by</span> <span class="keyword">level</span> &lt;= <span class="number">1000000</span>;</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure></p><p>上面SQL是利用了Oracle数据库语法的几个实用小技巧实现的:</p><ol><li><p>利用Oracle特有的“connect by”树形连接语法生成测试记录，“level &lt;= 10”表示要生成10记录；</p></li><li><p>利用rownum虚拟列生成递增的整数数据；</p></li><li><p>利用sysdate函数加一些简单运算来生成日期数据，本例中是每条记录的时间加1秒；</p></li><li><p>利用dbms_random.value函数生成随机的数值型数据，本例中是生成0到100之间的随机整数；</p></li><li><p>利用dbms_random.string函数生成随机的字符型数据，本例中是生成长度为20的随机字符串，字符串中可以包括字符或数字。</p></li><li><p>to_char(sysdate + rownum, ‘yyyy-mm-dd hh24:mi:ss’) 这里是转换为字符串，如果该字段的类型为TimeStamp时间戳，那这里可以改写一下方法，转换为时间戳 to_timestamp(sysdate + rownum, ‘yyyy-mm-dd hh24:mi:ss’)</p></li></ol><p>PostgreSQL 创建相应的外部表</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testdb=# create foreign table test_table(id int, inc_datetime varchar(19), random_id int, random_string varchar(4000)) server oracle_121_56 options (schema 'DBUSER', table 'TEST_TABLE');</span><br></pre></td></tr></table></figure><ol><li>查询表的行数</li></ol><ul><li>sqlplus</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sqlplus dbuser/<span class="built_in">test</span>@//192.168.121.56:1521/orcl</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select count(*) from test_table;</span><br><span class="line"> COUNT(*)</span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">2000000</span><br><span class="line">Elapsed: 00:00:00.13</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select count(*) from test_table;</span><br><span class="line">count</span><br><span class="line"><span class="comment">---------</span></span><br><span class="line">2000000</span><br><span class="line">(1 row)</span><br><span class="line">Time: 5264.299 ms (00:05.264)</span><br></pre></td></tr></table></figure><p>查看oracle session中真正执行的sql语句，红框为oracle_fdw执行时，oracle session中执行的sql：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731143023.png" alt=""></p><p>在psql中查看<code>select count(*) from test_table;</code>的执行计划：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731143351.png" alt=""></p><p>可见oracle处理的sql即是查询计划中的oracle query后面的sql</p><p>查看网络流量<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731114417.png" alt=""><br>oracle_fdw的网络流量明显比sqlplus要高出很多。</p><ol start="2"><li>查询某条记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table where id= 50;</span><br><span class="line"></span><br><span class="line">ID  INC_DATETIME   RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">-------- -------------------- ------------ -----------------------------</span></span><br><span class="line">50  2018-07-25 01:13:38       212VMPGE0K6Y293T9WRT7G</span><br><span class="line">50  2018-09-13 01:49:31       51RGUV1BJJNSTNXDMXMVRL</span><br><span class="line">Elapsed: 00:00:00.05</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table where id= 50;</span><br><span class="line"> id |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">----+---------------------+-----------+----------------------</span></span><br><span class="line"> 50 | 2018-07-25 01:13:38 |        21 | 2VMPGE0K6Y293T9WRT7G</span><br><span class="line"> 50 | 2018-09-13 01:49:31 |        51 | RGUV1BJJNSTNXDMXMVRL</span><br><span class="line">(2 rows)</span><br><span class="line"></span><br><span class="line">Time: 56.811 ms</span><br></pre></td></tr></table></figure><ol start="3"><li>使用orderby id获取前5行记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table order by id offset 0 rows fetch next 5 rows only;</span><br><span class="line"></span><br><span class="line">ID  INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">-------- ------------------- ---------- ----------------------</span></span><br><span class="line"> 1  2018-07-25 01:12:49       175SPF1INUG6S2L1ZSTU7R</span><br><span class="line"> 1  2018-07-26 01:49:31       63BIO3ZOV104VLNKZWGDZN</span><br><span class="line"> 2  2018-07-25 01:12:50       95HJFAWH9L7SF85YSPNDHV</span><br><span class="line"> 2  2018-07-27 01:49:31       862PNXP02ZYWYYUZQFWVVN</span><br><span class="line"> 3  2018-07-25 01:12:51       86T3UQBBMP3O02LGO6ONPF</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.32</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table order by id offset 0 rows fetch next 5 rows only;</span><br><span class="line"> id |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">----+---------------------+-----------+----------------------</span></span><br><span class="line">  1 | 2018-07-25 01:12:49 |        17 | 5SPF1INUG6S2L1ZSTU7R</span><br><span class="line">  1 | 2018-07-26 01:49:31 |        63 | BIO3ZOV104VLNKZWGDZN</span><br><span class="line">  2 | 2018-07-27 01:49:31 |        86 | 2PNXP02ZYWYYUZQFWVVN</span><br><span class="line">  2 | 2018-07-25 01:12:50 |        95 | HJFAWH9L7SF85YSPNDHV</span><br><span class="line">  3 | 2018-07-25 01:12:51 |        86 | T3UQBBMP3O02LGO6ONPF</span><br><span class="line">(5 rows)</span><br><span class="line"></span><br><span class="line">Time: 1169.874 ms (00:01.170)</span><br></pre></td></tr></table></figure><ol start="4"><li>使用orderby random_string获取前5行记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test_table <span class="keyword">order</span> <span class="keyword">by</span> random_string <span class="keyword">offset</span> <span class="number">0</span> <span class="keyword">rows</span> <span class="keyword">fetch</span> <span class="keyword">next</span> <span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">only</span>;</span><br><span class="line"></span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- --------------------------------</span></span><br><span class="line">    938145 2018-08-04 21:48:33       8600008E7XPHROOHEPUYRC</span><br><span class="line">    686337 2018-08-01 23:51:45       3100008JW9S5PXE19F4W4M</span><br><span class="line">     19954 2073-03-12 01:49:31       690000G3A2KNDLVN61WOSH</span><br><span class="line">    382404 3065-07-20 01:49:31       410000JDLZP2J8VZFOJ44J</span><br><span class="line">    234567 2660-10-14 01:49:31       78000142EWU0B3GMIPA2AL</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.33</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table order by random_string offset 0 rows fetch next 5 rows only;</span><br><span class="line">   id   |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">--------+---------------------+-----------+----------------------</span></span><br><span class="line"> 938145 | 2018-08-04 21:48:33 |        86 | 00008E7XPHROOHEPUYRC</span><br><span class="line"> 686337 | 2018-08-01 23:51:45 |        31 | 00008JW9S5PXE19F4W4M</span><br><span class="line">  19954 | 2073-03-12 01:49:31 |        69 | 0000G3A2KNDLVN61WOSH</span><br><span class="line"> 382404 | 3065-07-20 01:49:31 |        41 | 0000JDLZP2J8VZFOJ44J</span><br><span class="line"> 234567 | 2660-10-14 01:49:31 |        78 | 000142EWU0B3GMIPA2AL</span><br><span class="line">(5 rows)</span><br><span class="line"></span><br><span class="line">Time: 13275.162 ms (00:13.275)</span><br></pre></td></tr></table></figure><p>oracle_fdw执行时,oracle session中执行的sql</p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731145032.png" alt=""></p><p>psql中查看执行计划<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731145127.png" alt=""></p><p>网络流量对比<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180731144752.png" alt=""></p><h3 id="简单查询，带索引"><a href="#简单查询，带索引" class="headerlink" title="简单查询，带索引"></a>简单查询，带索引</h3><p>创建id索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> test_id <span class="keyword">on</span> test_table(<span class="keyword">id</span>);</span><br></pre></td></tr></table></figure><ol><li>查询某条记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table where id = 8222;</span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- -----------------------------</span></span><br><span class="line">      8222 2018-07-25 03:29:50       680VJJSTBAN6RAINSTWQAB</span><br><span class="line">      8222 2041-01-27 01:49:31       423SAYJV50LNDHURP5FU0K</span><br><span class="line">Elapsed: 00:00:00.07</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table where id = 8222;</span><br><span class="line">  id  |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">------+---------------------+-----------+----------------------</span></span><br><span class="line"> 8222 | 2018-07-25 03:29:50 |        68 | 0VJJSTBAN6RAINSTWQAB</span><br><span class="line"> 8222 | 2041-01-27 01:49:31 |        42 | 3SAYJV50LNDHURP5FU0K</span><br><span class="line">(2 rows)</span><br><span class="line">Time: 6.565 ms</span><br></pre></td></tr></table></figure><ol start="2"><li>使用orderby id获取前5行记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table order by id offset 0 rows fetch next 5 rows only;</span><br><span class="line"></span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- ----------------------------</span></span><br><span class="line"> 1 2018-07-25 01:12:49       175SPF1INUG6S2L1ZSTU7R</span><br><span class="line"> 1 2018-07-26 01:49:31       63BIO3ZOV104VLNKZWGDZN</span><br><span class="line"> 2 2018-07-25 01:12:50       95HJFAWH9L7SF85YSPNDHV</span><br><span class="line"> 2 2018-07-27 01:49:31       862PNXP02ZYWYYUZQFWVVN</span><br><span class="line"> 3 2018-07-25 01:12:51       86T3UQBBMP3O02LGO6ONPF</span><br><span class="line">Elapsed: 00:00:00.33</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table order by id offset 0 rows fetch next 5 rows only;</span><br><span class="line"> id |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">----+---------------------+-----------+----------------------</span></span><br><span class="line">  1 | 2018-07-25 01:12:49 |        17 | 5SPF1INUG6S2L1ZSTU7R</span><br><span class="line">  1 | 2018-07-26 01:49:31 |        63 | BIO3ZOV104VLNKZWGDZN</span><br><span class="line">  2 | 2018-07-27 01:49:31 |        86 | 2PNXP02ZYWYYUZQFWVVN</span><br><span class="line">  2 | 2018-07-25 01:12:50 |        95 | HJFAWH9L7SF85YSPNDHV</span><br><span class="line">  3 | 2018-07-25 01:12:51 |        86 | T3UQBBMP3O02LGO6ONPF</span><br><span class="line">(5 rows)</span><br><span class="line">Time: 1345.988 ms (00:01.346)</span><br></pre></td></tr></table></figure><p>创建random_string索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> test_string <span class="keyword">on</span> test_table(random_string);</span><br></pre></td></tr></table></figure><ol><li>查询某条记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table where random_string='GMX0VD9WY4YPN8T4XDML';</span><br><span class="line"></span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- -------------------------------</span></span><br><span class="line">       871 2018-07-25 01:27:19       45GMX0VD9WY4YPN8T4XDML</span><br><span class="line">Elapsed: 00:00:00.01</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table where random_string='GMX0VD9WY4YPN8T4XDML';</span><br><span class="line"> id  |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">-----+---------------------+-----------+----------------------</span></span><br><span class="line"> 871 | 2018-07-25 01:27:19 |        45 | GMX0VD9WY4YPN8T4XDML</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 118.376 ms</span><br></pre></td></tr></table></figure><ol start="2"><li>使用order by random_string获取前5条记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table order by random_string offset 0 rows fetch next 5 rows only;</span><br><span class="line"></span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- ----------------------------------</span></span><br><span class="line">    938145 2018-08-04 21:48:33       8600008E7XPHROOHEPUYRC</span><br><span class="line">    686337 2018-08-01 23:51:45       3100008JW9S5PXE19F4W4M</span><br><span class="line">     19954 2073-03-12 01:49:31       690000G3A2KNDLVN61WOSH</span><br><span class="line">    382404 3065-07-20 01:49:31       410000JDLZP2J8VZFOJ44J</span><br><span class="line">    234567 2660-10-14 01:49:31       78000142EWU0B3GMIPA2AL</span><br><span class="line">Elapsed: 00:00:00.36</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table order by random_string offset 0 rows fetch next 5 rows only;</span><br><span class="line">   id   |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">--------+---------------------+-----------+----------------------</span></span><br><span class="line"> 938145 | 2018-08-04 21:48:33 |        86 | 00008E7XPHROOHEPUYRC</span><br><span class="line"> 686337 | 2018-08-01 23:51:45 |        31 | 00008JW9S5PXE19F4W4M</span><br><span class="line">  19954 | 2073-03-12 01:49:31 |        69 | 0000G3A2KNDLVN61WOSH</span><br><span class="line"> 382404 | 3065-07-20 01:49:31 |        41 | 0000JDLZP2J8VZFOJ44J</span><br><span class="line"> 234567 | 2660-10-14 01:49:31 |        78 | 000142EWU0B3GMIPA2AL</span><br><span class="line">(5 rows)</span><br><span class="line">Time: 12848.595 ms (00:12.849)</span><br></pre></td></tr></table></figure><p>创建random_id,random_string复合索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> test_id_string <span class="keyword">on</span> test_table(random_id,random_string);</span><br></pre></td></tr></table></figure><ol><li>查询某条记录</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table where random_id=74 and random_string='6PP2R3M0K4ARK411VFC3';</span><br><span class="line"></span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- -------------------------------------</span></span><br><span class="line">      4067 2018-07-25 02:20:35       746PP2R3M0K4ARK411VFC3</span><br><span class="line">Elapsed: 00:00:00.00</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table where random_id=74 and random_string='6PP2R3M0K4ARK411VFC3';</span><br><span class="line">  id  |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">------+---------------------+-----------+----------------------</span></span><br><span class="line"> 4067 | 2018-07-25 02:20:35 |        74 | 6PP2R3M0K4ARK411VFC3</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 10.488 ms</span><br></pre></td></tr></table></figure><ol start="2"><li>orderby</li></ol><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from test_table order by random_id,random_string offset 0 rows fetch next 5 rows only;</span><br><span class="line">ID INC_DATETIME RANDOM_IDRANDOM_STRING</span><br><span class="line"><span class="comment">---------- ------------------- ---------- ------------------------------</span></span><br><span class="line">    231792 2018-07-27 17:36:000000LENLB2SJ8M8AZKTOD</span><br><span class="line">    691626 2018-08-02 01:19:540003GODBKGMRMZC3LTK8Z</span><br><span class="line">    582719 3613-12-29 01:49:3100052V1U6439AGAAAW3QZ</span><br><span class="line">    762898 2018-08-02 21:07:4600081R0VHHHJTRTPTL8RG</span><br><span class="line">    141007 2404-08-17 01:49:310008PFJM81W6NR83WFNXQ</span><br><span class="line">Elapsed: 00:00:00.33</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select * from test_table order by random_id,random_string offset 0 rows fetch next 5 rows only;</span><br><span class="line">   id   |    inc_datetime     | random_id |    random_string</span><br><span class="line"><span class="comment">--------+---------------------+-----------+----------------------</span></span><br><span class="line"> 231792 | 2018-07-27 17:36:00 |         0 | 000LENLB2SJ8M8AZKTOD</span><br><span class="line"> 691626 | 2018-08-02 01:19:54 |         0 | 003GODBKGMRMZC3LTK8Z</span><br><span class="line"> 582719 | 3613-12-29 01:49:31 |         0 | 0052V1U6439AGAAAW3QZ</span><br><span class="line"> 762898 | 2018-08-02 21:07:46 |         0 | 0081R0VHHHJTRTPTL8RG</span><br><span class="line"> 141007 | 2404-08-17 01:49:31 |         0 | 008PFJM81W6NR83WFNXQ</span><br><span class="line">(5 rows)</span><br><span class="line"></span><br><span class="line">Time: 12857.763 ms (00:12.858)</span><br></pre></td></tr></table></figure><h3 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h3><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.user_name,b.fee <span class="keyword">from</span> <span class="keyword">users</span> a,phone_fee b <span class="keyword">where</span> a.user_id=b.user_id <span class="keyword">and</span> a.user_id=<span class="number">4999998</span>;</span><br><span class="line"></span><br><span class="line">USER_NAME  FEE</span><br><span class="line"><span class="comment">-------------------------------------------------- ----------</span></span><br><span class="line">C58IV8Z0HKYO       297.78</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.27</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select a.user_name,b.fee from users a,phone_fee b where a.user_id=b.user_id and a.user_id=4999998;</span><br><span class="line">  user_name   |  fee</span><br><span class="line"><span class="comment">--------------+--------</span></span><br><span class="line"> C58IV8Z0HKYO | 297.78</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">Time: 139.633 ms</span><br></pre></td></tr></table></figure><p>psql的执行计划<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">testdb=# explain select a.user_name,b.fee from users a,phone_fee b where a.user_id=b.user_id and a.user_id=4999998;</span><br><span class="line">                                                                         QUERY PLAN</span><br><span class="line"></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-------------------------------------------------------------</span></span><br><span class="line"> Nested Loop  (cost=20000.00..52502.50 rows=1000000 width=134)</span><br><span class="line">   -&gt;  Foreign Scan on users a  (cost=10000.00..20000.00 rows=1000 width=134)</span><br><span class="line">         Oracle query: <span class="keyword">SELECT</span> <span class="comment">/*f121f12a8cbc233ce7f3a1c56794af92*/</span> r1.<span class="string">"USER_ID"</span>, r1.<span class="string">"USER_NAME"</span></span><br><span class="line"> <span class="keyword">FROM</span> <span class="string">"DBUSER"</span>.<span class="string">"USERS"</span> r1 <span class="keyword">WHERE</span> (r1.<span class="string">"USER_ID"</span> = <span class="number">4999998</span>)</span><br><span class="line">   -&gt;  Materialize  (<span class="keyword">cost</span>=<span class="number">10000.00</span>.<span class="number">.20005</span><span class="number">.00</span> <span class="keyword">rows</span>=<span class="number">1000</span> width=<span class="number">32</span>)</span><br><span class="line">         -&gt;  Foreign <span class="keyword">Scan</span> <span class="keyword">on</span> phone_fee b  (<span class="keyword">cost</span>=<span class="number">10000.00</span>.<span class="number">.20000</span><span class="number">.00</span> <span class="keyword">rows</span>=<span class="number">1000</span> width=<span class="number">32</span>)</span><br><span class="line">               <span class="keyword">Oracle</span> <span class="keyword">query</span>: <span class="keyword">SELECT</span> <span class="comment">/*d1bc90927d98c625ddda179fef4df315*/</span> r2.<span class="string">"USER_ID"</span>, r2.<span class="string">"FEE"</span></span><br><span class="line"> <span class="keyword">FROM</span> <span class="string">"DBUSER"</span>.<span class="string">"PHONE_FEE"</span> r2 <span class="keyword">WHERE</span> (r2.<span class="string">"USER_ID"</span> = <span class="number">4999998</span>)</span><br><span class="line">(<span class="number">6</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure></p><p>orderby</p><ul><li>sqlplus</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select users.user_id,phone_fee.fee,phone_fee.fee_date from users ,phone_fee where users.user_id=phone_fee.user_id order by users.user_id desc  offset 0 rows fetch next 5 rows only;</span><br><span class="line"></span><br><span class="line">   USER_ID  FEE FEE_DATE</span><br><span class="line"><span class="comment">---------- ---------- ---------</span></span><br><span class="line">   4999998     297.78 30-APR-15</span><br><span class="line">   4999997     243.36 31-MAY-15</span><br><span class="line">   499999669.79 29-JAN-12</span><br><span class="line">   499999291.03 07-OCT-17</span><br><span class="line">   4999992     268.93 01-FEB-15</span><br><span class="line"></span><br><span class="line">Elapsed: 00:00:00.71</span><br></pre></td></tr></table></figure><ul><li>oracle_fdw</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">testdb=# select users.user_id,phone_fee.fee,phone_fee.fee_date from users ,phone_fee where users.user_id=phone_fee.user_id order by users.user_id desc  offset 0 rows fetch next 5 rows only;</span><br><span class="line"> user_id |  fee   |  fee_date</span><br><span class="line"><span class="comment">---------+--------+------------</span></span><br><span class="line"> 4999998 | 297.78 | 2015-04-30</span><br><span class="line"> 4999997 | 243.36 | 2015-05-31</span><br><span class="line"> 4999996 |  69.79 | 2012-01-29</span><br><span class="line"> 4999992 |  91.03 | 2017-10-07</span><br><span class="line"> 4999992 | 268.93 | 2015-02-01</span><br><span class="line">(5 rows)</span><br><span class="line"></span><br><span class="line">Time: 27477.661 ms (00:27.478)</span><br></pre></td></tr></table></figure><p>psql的执行计划<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">testdb=# explain select users.user_id,phone_fee.fee,phone_fee.fee_date from users ,phone_fee where users.user_id=phone_fee.user_id order by users.user_id desc  offset 0 rows fetch next 5 rows only;</span><br><span class="line"></span><br><span class="line">   QUERY PLAN</span><br><span class="line"></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line"> Limit  (cost=20016.61..20016.62 rows=5 width=36)</span><br><span class="line">   -&gt;  Sort  (cost=20016.61..20019.11 rows=1000 width=36)</span><br><span class="line">         Sort Key: users.user_id DESC</span><br><span class="line">         -&gt;  Foreign Scan  (cost=10000.00..20000.00 rows=1000 width=36)</span><br><span class="line">               Oracle query: <span class="keyword">SELECT</span> <span class="comment">/*c6de86645f2edcce90957e3283ade08d*/</span> r1.<span class="string">"USER_ID"</span>, r2.<span class="string">"FEE"</span></span><br><span class="line">, r2.<span class="string">"FEE_DATE"</span> <span class="keyword">FROM</span> (<span class="string">"DBUSER"</span>.<span class="string">"USERS"</span> r1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="string">"DBUSER"</span>.<span class="string">"PHONE_FEE"</span> r2 <span class="keyword">ON</span> (r1.<span class="string">"USER_ID"</span> =</span><br><span class="line"> r2.<span class="string">"USER_ID"</span>))</span><br><span class="line">(<span class="number">5</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure></p><p>oracle session中执行的sql</p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180802105716.png" alt=""></p><p>流量情况</p><p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180802105550.png" alt=""></p><p>可见oracle_fdw实质上发送的是连接sql，拿到oracle返回的结果，再进行排序的。因此中间消耗的时间里，网络传输数据的消耗是占很大部分的。</p><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>oracle_fdw的查询效率主要受发送给oracle的sql查询结果集的数据量影响的，结果集越大，网络IO消耗越多，对查询的影响越大。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;在PostgreSQL中使用oracle-fdw&quot;&gt;&lt;a href=&quot;#在PostgreSQL中使用oracle-fdw&quot; class=&quot;headerlink&quot; title=&quot;在PostgreSQL中使用oracle_fdw&quot;&gt;&lt;/a&gt;在PostgreSQL中使用
      
    
    </summary>
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/categories/PostgreSQL/"/>
    
    
      <category term="PostgreSQL" scheme="https://oyo-byte.github.io/tags/PostgreSQL/"/>
    
      <category term="FDW" scheme="https://oyo-byte.github.io/tags/FDW/"/>
    
      <category term="oracle" scheme="https://oyo-byte.github.io/tags/oracle/"/>
    
  </entry>
  
</feed>
