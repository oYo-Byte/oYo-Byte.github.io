<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    PostgreSQL FDE加密 | oYo-Byte
  </title>
  <meta name="description" content="oYo-Byte&#39;s blog">
  
  <meta name="keywords" content="
  PostgreSQL,加密
  ">
  
  <meta name="author" content="oYo-Byte">

  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp">

  <link rel="icon" type="image/x-icon" href="https://assets-cdn.github.com/favicon.ico">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  

  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
</head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">This website</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/archives">Archives</a></li>
        
        
        <li><a href="/categories">Categories</a></li>
        
        
        <li><a href="/tags">Tags</a></li>
        
        
        <li class="desktop-only"><a href="/atom.xml" target="_blank">RSS</a></li>
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="https://avatars2.githubusercontent.com/u/8343269?s=460&amp;v=4"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/archives"
           class="header-toolbar-right"> 17 </a>
      </li>
      <li>
        <a href="/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/tags"
           class="header-toolbar-right"> 20 </a>
      </li>
      <li>
        <a href="/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/categories"
           class="header-toolbar-right"> 7 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/">oYo-Byte</a>
      
      
    </h2>
  </div>

  <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div>
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    oYo-Byte

    <span class="post-date float-right" title="{{moment(1540439748239).format('MMM DD, YYYY, h:mm:ss A')}}">
      <i class="fa fa-pencil-square-o"></i>
      {{moment(1540439748239).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>PostgreSQL FDE加密</h1>
    <h3 id="FDE原理："><a href="#FDE原理：" class="headerlink" title="FDE原理："></a>FDE原理：</h3><p><img src="https://www.cybertec-postgresql.com/wp-content/uploads/2017/11/PostgreSQL-instance-level-encryption2.jpg" alt=""></p>
<p>FDE全称Full database encryption，是全数据库加密，FDE加密对客户端完全透明，当数据从Shared buffer中写入到磁盘的时候，先进行加密，再写进磁盘，反之，读取磁盘，再进行解密，加解密的单位是一个page。</p>
<p>下面根据cybertec开源的一个PostgreSQL版本，进行简单的源码解读，看看是如何实现的，<a href="http://www.cybertec-postgresql.com/wp-content/uploads/2017/11/postgresql-9.6.0-fde.tar.zip" target="_blank" rel="noopener">PostgreSQL FDE版本源码</a></p>
<h3 id="XTS加密模式"><a href="#XTS加密模式" class="headerlink" title="XTS加密模式"></a>XTS加密模式</h3><p>PosgtreSQL-fde版本采用Industry standard 128-bit XTS-AES block cipher进行加密<br>XTS模式是一种适用于AES加密算法的加密模式。有如下的特点：<br>1、明文被分成固定长度的cipher block(如AES-128的128bit)<br>FDE中，以page为单位加密，把一个page分成多个128bit的cipher block；<br>2、每个cipher block之间相互独立<br>3、以cipher block为单位进行加密，加密时使用该cipher block的index信息(即Tweak，通常为位置信息)作为输入，使得同样的明文，在同样的算法和秘钥之下，得到的密文不相同，增加加密的安全性。</p>
<p>在FDE加密中，Tweak为page的位置信息，由page所在的文件和page在文件中的位置计算而来。</p>
<p>XTS加密的原理如下：<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20181025182830.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/165259_mERh_2910723.png" alt=""></p>
<p>对于每个ciper block，都按照以上方式加密<br>使用SHA256加密密钥后的key，分成key1和key2，分别用来加密tweak和page。<br>用key1加密后的tweak(128位)，在每一个cipher block加密时与之进行两次异或运算，即：明文→与tweak密文异或→用key2加密→再与tweak密文异或→密文。</p>
<h3 id="部署测试："><a href="#部署测试：" class="headerlink" title="部署测试："></a>部署测试：</h3><p>下载<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://www.cybertec-postgresql.com/wp-content/uploads/2017/11/postgresql-9.6.0-fde.tar.zip</span><br><span class="line"></span><br><span class="line">$ unzip postgresql-9.6.0-fde.tar.zip </span><br><span class="line"></span><br><span class="line">$ tar -jxvf postgresql-9.6.0-fde.tar.bz2</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> postgresql-9.6.0-fde</span><br><span class="line"></span><br><span class="line">$ ll</span><br><span class="line">total 688</span><br><span class="line">-rw-r--r--.  1 appusr appusr    384 Sep 27  2016 aclocal.m4</span><br><span class="line">-rw-rw-r--.  1 appusr appusr   5357 Oct 24  2016 brg_endian.h</span><br><span class="line">-rw-rw-r--.  1 appusr appusr   7855 Oct 24  2016 brg_types.h</span><br><span class="line">drwxrwxr-x.  2 appusr appusr   4096 Sep 27  2016 config</span><br><span class="line">-rwxr-xr-x.  1 appusr appusr 471157 Sep 27  2016 configure</span><br><span class="line">-rw-r--r--.  1 appusr appusr  75195 Sep 27  2016 configure.in</span><br><span class="line">drwxrwxr-x. 55 appusr appusr   4096 Sep 27  2016 contrib</span><br><span class="line">-rw-r--r--.  1 appusr appusr   1192 Sep 27  2016 COPYRIGHT</span><br><span class="line">drwxrwxr-x.  3 appusr appusr    107 Sep 27  2016 doc</span><br><span class="line">-rw-r--r--.  1 appusr appusr   3638 Sep 27  2016 GNUmakefile.in</span><br><span class="line">-rw-r--r--.  1 appusr appusr    283 Sep 27  2016 HISTORY</span><br><span class="line">-rw-r--r--.  1 appusr appusr  75065 Sep 27  2016 INSTALL</span><br><span class="line">-rw-rw-r--.  1 appusr appusr    676 Oct 24  2016 Makefile.rej</span><br><span class="line">-rw-rw-r--.  1 appusr appusr  11026 Oct 24  2016 mode_hdr.h</span><br><span class="line">-rw-r--r--.  1 appusr appusr   1209 Sep 27  2016 README</span><br><span class="line">-rw-rw-r--.  1 appusr appusr   4455 Oct 24  2016 README.encryption</span><br><span class="line">drwxrwxr-x. 16 appusr appusr   4096 Sep 27  2016 src</span><br></pre></td></tr></table></figure></p>
<p>编译安装<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./configure --prefix=/appdb/pgfde --with-readline</span><br><span class="line"></span><br><span class="line">$ make world -j 32</span><br><span class="line"></span><br><span class="line">$ make install-world</span><br></pre></td></tr></table></figure></p>
<p>设置加密密钥，并初始化数据库集群<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">read</span> -sp <span class="string">"Postgres passphrase: "</span> PGENCRYPTIONKEY</span><br><span class="line">$ <span class="built_in">export</span> PGENCRYPTIONKEY</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$PGENCRYPTIONKEY</span></span><br><span class="line">$ initdb --data-encryption pgcrypto --data-checksums -D /data/fde -E UTF8 --locale=C -U xdb</span><br></pre></td></tr></table></figure></p>
<p>启动数据库<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /appdb/pgfde/bin/pg_ctl -D /data/fde -l /data/fde/pg-fde.log start</span><br></pre></td></tr></table></figure></p>
<p>必须设置好PGENCRYPTIONKEY这个环境变量,否则数据库启动不起来<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ tail -f /data/fde/pg-fde.log</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">LOG:  encryption key not provided</span><br><span class="line">DETAIL:  The database cluster was initialized with encryption but the server was started without an encryption key.</span><br><span class="line">HINT:  Set the key using PGENCRYPTIONKEY environment variable.</span><br><span class="line">FATAL:  data encryption could not be initialized</span><br><span class="line">LOG:  database system is shut down</span><br></pre></td></tr></table></figure></p>
<p>正常启动<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ /appdb/pgfde/bin/pg_ctl -D /data/fde -l /data/fde/serverlog status</span><br><span class="line">pg_ctl: server is running (PID: 1471)</span><br><span class="line">/appdb/pgfde/bin/postgres <span class="string">"-D"</span> <span class="string">"/data/fde"</span></span><br></pre></td></tr></table></figure></p>
<p>测试<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d testdb -p 5433</span><br><span class="line">psql (9.6.9, server 9.6.0)</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> <span class="built_in">help</span>.</span><br><span class="line"></span><br><span class="line">testdb=<span class="comment"># create table test(id int, c1 char(8),c2 varchar(16));</span></span><br><span class="line">CREATE TABLE</span><br><span class="line">testdb=<span class="comment"># select pg_relation_filepath('test');</span></span><br><span class="line"> pg_relation_filepath </span><br><span class="line">----------------------</span><br><span class="line"> base/16384/16388</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">testdb=<span class="comment"># --插入2条数据</span></span><br><span class="line">testdb=<span class="comment"># insert into test values (1,'1','1');</span></span><br><span class="line">INSERT 0 1</span><br><span class="line">testdb=<span class="comment"># insert into test values (2,'2','2');</span></span><br><span class="line">INSERT 0 1</span><br><span class="line">testdb=<span class="comment"># insert into test values (3,'c','c');</span></span><br><span class="line">INSERT 0 1</span><br><span class="line">testdb=<span class="comment"># --执行checkpoint，使Shared Buufer的数据刷入到磁盘中</span></span><br><span class="line">testdb=<span class="comment"># checkpoint ;</span></span><br><span class="line">CHECKPOINT</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ hexdump -C /data/fde/base/16384/16388</span><br><span class="line">00000000  6d dd 05 a6 b0 98 59 73  30 63 86 cc 8d 8c 7e b5  |m.....Ys0c....~.|</span><br><span class="line">00000010  e8 cc 7b 9c 92 d8 53 8f  be cc c2 d9 19 db c7 d8  |..&#123;...S.........|</span><br><span class="line">00000020  da d6 b4 30 fe a3 24 4d  aa 5b 6e ee 61 f4 99 a8  |...0..<span class="variable">$M</span>.[n.a...|</span><br><span class="line">00000030  a1 f3 1e 40 2c fd e5 6e  4d 77 41 be 15 b3 0e e9  |...@,..nMwA.....|</span><br><span class="line">00000040  45 98 44 ba ec 19 2f ac  fd 0c db 67 02 69 31 73  |E.D.../....g.i1s|</span><br><span class="line">00000050  18 b7 74 fe 58 26 d4 6c  1f 94 02 db 48 2d 03 34  |..t.X&amp;.l....H-.4|</span><br><span class="line">00000060  17 07 90 9b db 43 12 3f  18 5a ae b8 1f 69 0f b7  |.....C.?.Z...i..|</span><br><span class="line">00000070  e5 <span class="built_in">cd</span> dd 07 4f 0b 39 01  16 29 92 5a 04 66 e6 ef  |....O.9..).Z.f..|</span><br><span class="line">00000080  ff 68 5c de aa 76 76 5f  b7 29 cc <span class="built_in">cd</span> a1 d5 5e 7e  |.h\..vv_.)....^~|</span><br><span class="line">00000090  a5 e2 22 0f 6c 8f da c6  1f 58 f5 52 e6 5a 97 a8  |..<span class="string">".l....X.R.Z..|</span></span><br><span class="line"><span class="string">000000a0  5b c2 df ad 7f 5e bf 9c  2e 99 e1 34 29 ad 47 59  |[....^.....4).GY|</span></span><br><span class="line"><span class="string">000000b0  53 7f 71 e5 a5 ee bc ae  df 2b bc 27 11 fa 9d 16  |S.q......+.'....|</span></span><br><span class="line"><span class="string">000000c0  17 a6 97 e0 58 43 44 f5  08 03 bc 03 05 6d c1 aa  |....XCD......m..|</span></span><br><span class="line"><span class="string">000000d0  13 c4 f2 28 45 d5 e8 bc  09 70 17 d0 b3 16 ad 8f  |...(E....p......|</span></span><br><span class="line"><span class="string">000000e0  9c c6 44 0b 42 ef 69 72  78 6b e2 86 c2 12 06 ec  |..D.B.irxk......|</span></span><br><span class="line"><span class="string">000000f0  a4 44 4c 3b c5 d3 51 85  b6 27 74 8a 6c ad 35 b8  |.DL;..Q..'t.l.5.|</span></span><br><span class="line"><span class="string"># 中间太长，不全贴了</span></span><br><span class="line"><span class="string">00001f10  3b 73 89 f3 a4 5a b7 e1  be b2 f0 40 88 76 ad cd  |;s...Z.....@.v..|</span></span><br><span class="line"><span class="string">00001f20  9a 62 13 83 31 2b 77 bf  8f bf 06 82 04 e0 ae 60  |.b..1+w........`|</span></span><br><span class="line"><span class="string">00001f30  4d cd f2 9c 55 ca ff 41  83 e1 7b cd c9 5b c1 91  |M...U..A..&#123;..[..|</span></span><br><span class="line"><span class="string">00001f40  9c 68 3e 3f d1 2b 00 13  f5 86 9f f4 09 ba 4c 49  |.h&gt;?.+........LI|</span></span><br><span class="line"><span class="string">00001f50  9c 26 42 ba 08 59 0b 5a  85 48 9c 73 d1 d2 3e 43  |.&amp;B..Y.Z.H.s..&gt;C|</span></span><br><span class="line"><span class="string">00001f60  30 51 47 96 5e 99 fe 60  4e e3 db 8d 2e 5a 2e 77  |0QG.^..`N....Z.w|</span></span><br><span class="line"><span class="string">00001f70  72 45 8f 70 5f 04 ce 67  35 dc 33 7c 84 46 45 8d  |rE.p_..g5.3|.FE.|</span></span><br><span class="line"><span class="string">00001f80  c2 f0 9c 6b 77 a4 e9 e4  e4 c7 73 91 ec 27 aa 4c  |...kw.....s..'.L|</span></span><br><span class="line"><span class="string">00001f90  b4 68 0e d9 d8 e4 8a 3b  79 5d 19 17 48 32 fa 7d  |.h.....;y]..H2.&#125;|</span></span><br><span class="line"><span class="string">00001fa0  7d d0 0f fa d2 c6 65 1a  b2 17 34 0a 4c 6d 86 aa  |&#125;.....e...4.Lm..|</span></span><br><span class="line"><span class="string">00001fb0  ae f5 47 6c fc 5a 6b ab  68 cd 52 2c 61 a8 74 94  |..Gl.Zk.h.R,a.t.|</span></span><br><span class="line"><span class="string">00001fc0  f4 e1 c5 ae 6a f4 e3 b7  a8 a3 b4 60 e0 ce 53 da  |....j......`..S.|</span></span><br><span class="line"><span class="string">00001fd0  70 d2 41 f6 3a 4d c4 7b  f1 30 4c 17 ee fa 71 8f  |p.A.:M.&#123;.0L...q.|</span></span><br><span class="line"><span class="string">00001fe0  38 ff 6e a7 d3 ad a3 d4  4a 3a eb e1 23 73 a4 7b  |8.n.....J:..#s.&#123;|</span></span><br><span class="line"><span class="string">00001ff0  0f c5 eb 5b f5 4f 5a 20  bd 62 34 df 22 6c 0e 66  |...[.OZ .b4."</span>l.f|</span><br><span class="line">00002000</span><br></pre></td></tr></table></figure></p>
<p>使用非加密版本PostgreSQL<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ psql -d testdb -p 5432</span><br><span class="line">psql (9.6.9)</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> <span class="built_in">help</span>.</span><br><span class="line"></span><br><span class="line">testdb=<span class="comment"># create table test(id int, c1 char(8),c2 varchar(16));</span></span><br><span class="line">CREATE TABLE</span><br><span class="line">testdb=<span class="comment"># select pg_relation_filepath('test');</span></span><br><span class="line"> pg_relation_filepath </span><br><span class="line">----------------------</span><br><span class="line"> base/16384/16391</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">testdb=<span class="comment"># insert into test values (1,'1','1');</span></span><br><span class="line">INSERT 0 1</span><br><span class="line">testdb=<span class="comment"># insert into test values (2,'2','2');</span></span><br><span class="line">INSERT 0 1</span><br><span class="line">testdb=<span class="comment"># insert into test values (3,'c','c');</span></span><br><span class="line">INSERT 0 1</span><br><span class="line">testdb=<span class="comment"># checkpoint ;</span></span><br><span class="line">CHECKPOINT</span><br></pre></td></tr></table></figure></p>
<p>查看数据文件<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C /data/utf8db/base/16384/16391</span><br><span class="line">00000000  00 00 00 00 30 82 5a 01  00 00 00 00 24 00 88 1f  |....0.Z.....$...|</span><br><span class="line">00000010  00 20 04 20 00 00 00 00  d8 9f 4e 00 b0 9f 4e 00  |. . ......N...N.|</span><br><span class="line">00000020  88 9f 4e 00 00 00 00 00  00 00 00 00 00 00 00 00  |..N.............|</span><br><span class="line">00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00001f80  00 00 00 00 00 00 00 00  eb 06 00 00 00 00 00 00  |................|</span><br><span class="line">00001f90  00 00 00 00 00 00 00 00  03 00 03 00 02 08 18 00  |................|</span><br><span class="line">00001fa0  03 00 00 00 13 63 20 20  20 20 20 20 20 05 63 00  |.....c       .c.|</span><br><span class="line">00001fb0  ea 06 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00001fc0  02 00 03 00 02 09 18 00  02 00 00 00 13 32 20 20  |.............2  |</span><br><span class="line">00001fd0  20 20 20 20 20 05 32 00  e9 06 00 00 00 00 00 00  |     .2.........|</span><br><span class="line">00001fe0  00 00 00 00 00 00 00 00  01 00 03 00 02 09 18 00  |................|</span><br><span class="line">00001ff0  01 00 00 00 13 31 20 20  20 20 20 20 20 05 31 00  |.....1       .1.|</span><br><span class="line">00002000</span><br></pre></td></tr></table></figure></p>
<p>可看到，非加密的PostgreSQL数据文件是明文的，插入的数据都能在数据文件中清楚看到内容，但是加密的数据文件看到的是一堆乱码</p>
<h3 id="查看源码"><a href="#查看源码" class="headerlink" title="查看源码"></a>查看源码</h3><p>PostgreSQL-fde针对加密功能，对PostgreSQL自带的加密插件pgcrypto，以及PostgreSQL的Shared Buffer写入到磁盘的代码进行了修改。</p>
<p>其中最主要的代码文件是：<br>src/backend/storage/smgr/encryption.c<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * encryption.c</span></span><br><span class="line"><span class="comment"> *	  This code handles encryption and decryption of data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Encryption is done by extension modules loaded by encryption_library GUC.</span></span><br><span class="line"><span class="comment"> * The extension module must register itself and provide a cryptography</span></span><br><span class="line"><span class="comment"> * implementation. Key setup is left to the extension module.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2016, PostgreSQL Global Development Group</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * IDENTIFICATION</span></span><br><span class="line"><span class="comment"> *	  src/backend/storage/smgr/encryption.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"postgres.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"catalog/pg_control.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"storage/bufpage.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"storage/encryption.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"miscadmin.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"fmgr.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"port.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> encryption_enabled = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">bool</span> have_encryption_provider = <span class="literal">false</span>;</span><br><span class="line">EncryptionRoutines encryption_hooks;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Hook function for encryption providers. The first library to call this</span></span><br><span class="line"><span class="comment"> * function gets to provide encryption capability.</span></span><br><span class="line"><span class="comment"> * 注册加密模块，在pgcrypto.c文件中的_PG_init方法调用，用于加载加解密的函数钩子</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">register_encryption_module(<span class="keyword">char</span> *name, EncryptionRoutines *enc)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!have_encryption_provider)</span><br><span class="line">	&#123;</span><br><span class="line">		elog(DEBUG1, <span class="string">"Registering encryption module %s"</span>, name);</span><br><span class="line">		encryption_hooks = *enc;</span><br><span class="line">		have_encryption_provider = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Encrypts a fixed value into *buf to verify that encryption key is correct.</span></span><br><span class="line"><span class="comment"> * Caller provided buf needs to be able to hold at least ENCRYPTION_SAMPLE_SIZE</span></span><br><span class="line"><span class="comment"> * bytes.</span></span><br><span class="line"><span class="comment"> * 加密一个固定值用于校验加密密钥是否正确</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">sample_encryption(<span class="keyword">char</span> *buf)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> tweak[TWEAK_SIZE];</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; TWEAK_SIZE; i++)</span><br><span class="line">		tweak[i] = i;</span><br><span class="line"></span><br><span class="line">	encrypt_block(<span class="string">"postgresqlcrypt"</span>, buf, ENCRYPTION_SAMPLE_SIZE, tweak);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Encrypts one block of data with a specified tweak value. Input and output</span></span><br><span class="line"><span class="comment"> * buffer may point to the same location. Size of input must be at least</span></span><br><span class="line"><span class="comment"> * ENCRYPTION_BLOCK bytes. Tweak value must be TWEAK_SIZE bytes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * All zero blocks are not encrypted or decrypted to correctly handle relation</span></span><br><span class="line"><span class="comment"> * extension.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Must only be called when encryption_enabled is true.</span></span><br><span class="line"><span class="comment"> * 加密函数，用于加密数据，此处会调用了pgcrypto里面的加密方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">encrypt_block(<span class="keyword">const</span> <span class="keyword">char</span> *input, <span class="keyword">char</span> *output, Size size, <span class="keyword">const</span> <span class="keyword">char</span> *tweak)</span><br><span class="line">&#123;</span><br><span class="line">	Assert(size &gt;= ENCRYPTION_BLOCK);</span><br><span class="line">	Assert(encryption_enabled);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IsAllZero(input, size))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (input != output)</span><br><span class="line">			<span class="built_in">memset</span>(output, <span class="number">0</span>, size);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		encryption_hooks.EncryptBlock(input, output, size, tweak);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Decrypts one block of data with a specified tweak value. Input and output</span></span><br><span class="line"><span class="comment"> * buffer may point to the same location. Tweak value must match the one used</span></span><br><span class="line"><span class="comment"> * when encrypting.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Must only be called when encryption_enabled is true.</span></span><br><span class="line"><span class="comment"> * 解密函数，用于解密从文件中读取的数据，此处会调用了pgcrypto里面的解密方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">decrypt_block(<span class="keyword">const</span> <span class="keyword">char</span> *input, <span class="keyword">char</span> *output, Size size, <span class="keyword">const</span> <span class="keyword">char</span> *tweak)</span><br><span class="line">&#123;</span><br><span class="line">	Assert(size &gt;= ENCRYPTION_BLOCK);</span><br><span class="line">	Assert(encryption_enabled);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IsAllZero(input, size))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (input != output)</span><br><span class="line">			<span class="built_in">memset</span>(output, <span class="number">0</span>, size);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		encryption_hooks.DecryptBlock(input, output, size, tweak);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Initialize encryption subsystem for use. Must be called before any</span></span><br><span class="line"><span class="comment"> * encryptable data is read from or written to data directory.</span></span><br><span class="line"><span class="comment"> * 初始化加密程序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">setup_encryption()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *filename;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (encryption_library_string == <span class="literal">NULL</span> || encryption_library_string[<span class="number">0</span>] == <span class="string">'\0'</span>)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Try to load encryption library */</span></span><br><span class="line">	filename = pstrdup(encryption_library_string);</span><br><span class="line"></span><br><span class="line">	canonicalize_path(filename);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Make encryption libraries loading behave as if loaded via s_p_l */</span></span><br><span class="line">	process_shared_preload_libraries_in_progress = <span class="literal">true</span>;</span><br><span class="line">	load_file(filename, <span class="literal">false</span>);</span><br><span class="line">	process_shared_preload_libraries_in_progress = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	ereport(DEBUG1,</span><br><span class="line">			(errmsg(<span class="string">"loaded library \"%s\" for encryption"</span>, filename)));</span><br><span class="line">	pfree(filename);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (have_encryption_provider)</span><br><span class="line">	&#123;</span><br><span class="line">		encryption_enabled = encryption_hooks.SetupEncryption();</span><br><span class="line">		<span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (!IsBootstrapProcessingMode())</span><br><span class="line">				elog(LOG, <span class="string">"data encryption performed by %s"</span>, encryption_library_string);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			elog(FATAL, <span class="string">"data encryption could not be initialized"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		elog(ERROR, <span class="string">"Specified encryption library %s did not provide encryption hooks."</span>, encryption_library_string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>pgcrypto.c<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// 此处只贴了新增的代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* encryptionkey_prefix = <span class="string">"encryptionkey="</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> encryption_key_length = <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">/ *</span><br><span class="line">  * 支持使用命令设置密钥</span><br><span class="line">  */</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">pgcrypto_run_keysetup_command</span><span class="params">(uint8 *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FILE *fp;</span><br><span class="line">	<span class="keyword">char</span> buf[encryption_key_length*<span class="number">2</span>+<span class="number">1</span>];</span><br><span class="line">	<span class="keyword">int</span> bytes_read;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pgcrypto_keysetup_command == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">strlen</span>(pgcrypto_keysetup_command))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	elog(INFO, <span class="string">"Executing \"%s\" to set up encryption key"</span>, pgcrypto_keysetup_command);</span><br><span class="line"></span><br><span class="line">	fp = popen(pgcrypto_keysetup_command, <span class="string">"r"</span>);</span><br><span class="line">	<span class="keyword">if</span> (fp == <span class="literal">NULL</span>)</span><br><span class="line">		elog(ERROR, <span class="string">"Failed to execute pgcrypto.keysetup_command \"%s\""</span>,</span><br><span class="line">			pgcrypto_keysetup_command);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fread(buf, <span class="number">1</span>, <span class="built_in">strlen</span>(encryptionkey_prefix), fp) != <span class="built_in">strlen</span>(encryptionkey_prefix))</span><br><span class="line">		elog(ERROR, <span class="string">"Not enough data received from pgcrypto.keysetup_command"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strncmp</span>(buf, encryptionkey_prefix, <span class="built_in">strlen</span>(encryptionkey_prefix)) != <span class="number">0</span>)</span><br><span class="line">		elog(ERROR, <span class="string">"Unknown data received from pgcrypto.keysetup_command"</span>);</span><br><span class="line"></span><br><span class="line">	bytes_read = fread(buf, <span class="number">1</span>, encryption_key_length*<span class="number">2</span> + <span class="number">1</span>, fp);</span><br><span class="line">	<span class="keyword">if</span> (bytes_read &lt; encryption_key_length*<span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (feof(fp))</span><br><span class="line">			elog(ERROR, <span class="string">"Encryption key provided by pgcrypto.keysetup_command too short"</span>);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			elog(ERROR, <span class="string">"pgcrypto.keysetup_command returned error code %d"</span>, ferror(fp));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; encryption_key_length; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">sscanf</span>(buf+<span class="number">2</span>*i, <span class="string">"%2hhx"</span>, key + i) == <span class="number">0</span>)</span><br><span class="line">			elog(ERROR, <span class="string">"Invalid character in encryption key at position %d"</span>, <span class="number">2</span>*i);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (bytes_read &gt; encryption_key_length*<span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (buf[encryption_key_length*<span class="number">2</span>] != <span class="string">'\n'</span>)</span><br><span class="line">			elog(ERROR, <span class="string">"Encryption key too long '%s' %d."</span>, buf, buf[encryption_key_length*<span class="number">2</span>]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (fread(buf, <span class="number">1</span>, <span class="keyword">sizeof</span>(buf), fp) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/* Discard rest of the output */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pclose(fp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Pgcrypto module does AES-128-XTS encryption.</span></span><br><span class="line"><span class="comment"> * 初始化使用AES-128-XTS加密上下文</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">pgcrypto_encryption_setup()</span><br><span class="line">&#123;</span><br><span class="line">	uint8 key[encryption_key_length];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pgcrypto_run_keysetup_command(key))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> *passphrase = getenv(<span class="string">"PGENCRYPTIONKEY"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Empty or missing passphrase means that encryption is not configured */</span></span><br><span class="line">		<span class="keyword">if</span> (passphrase == <span class="literal">NULL</span> || passphrase[<span class="number">0</span>] == <span class="string">'\0'</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			ereport(LOG,</span><br><span class="line">					(errmsg(<span class="string">"encryption key not provided"</span>),</span><br><span class="line">					errdetail(<span class="string">"The database cluster was initialized with encryption"</span></span><br><span class="line">							  <span class="string">" but the server was started without an encryption key."</span>),</span><br><span class="line">							 errhint(<span class="string">"Set the key using PGENCRYPTIONKEY environment variable."</span>)));</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* <span class="doctag">TODO:</span> replace with PBKDF2 or scrypt */</span></span><br><span class="line">		&#123;</span><br><span class="line">			SHA256_CTX sha_ctx;</span><br><span class="line">			SHA256_Init(&amp;sha_ctx);</span><br><span class="line">			SHA256_Update(&amp;sha_ctx, (uint8*) passphrase, <span class="built_in">strlen</span>(passphrase));</span><br><span class="line">			SHA256_Final(key, &amp;sha_ctx);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (xts_encrypt_key(key, encryption_key_length, db_key.enc_ctx) != EXIT_SUCCESS ||</span><br><span class="line">		xts_decrypt_key(key, encryption_key_length, db_key.dec_ctx) != EXIT_SUCCESS)</span><br><span class="line">	&#123;</span><br><span class="line">		elog(ERROR, <span class="string">"Encryption key setup failed."</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 使用AES-128-XTS的加密函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">pgcrypto_encrypt_block(<span class="keyword">const</span> <span class="keyword">char</span> *input, <span class="keyword">char</span> *output, Size size,</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> *tweak)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (input != output)</span><br><span class="line">		<span class="built_in">memcpy</span>(output, input, size);</span><br><span class="line"></span><br><span class="line">	xts_encrypt_block((uint8*) output, (<span class="keyword">const</span> uint8*) tweak, size, db_key.enc_ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 使用AES-128-XTS的解密函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">pgcrypto_decrypt_block(<span class="keyword">const</span> <span class="keyword">char</span> *input, <span class="keyword">char</span> *output, Size size,</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> *tweak)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (input != output)</span><br><span class="line">		<span class="built_in">memcpy</span>(output, input, size);</span><br><span class="line"></span><br><span class="line">	xts_decrypt_block((uint8*) output, (<span class="keyword">const</span> uint8*) tweak, size, db_key.dec_ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">_PG_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	EncryptionRoutines routines;</span><br><span class="line">	routines.SetupEncryption = &amp;pgcrypto_encryption_setup;</span><br><span class="line">	routines.EncryptBlock = &amp;pgcrypto_encrypt_block;</span><br><span class="line">	routines.DecryptBlock = &amp;pgcrypto_decrypt_block;</span><br><span class="line"></span><br><span class="line">	register_encryption_module(<span class="string">"pgcrypto"</span>, &amp;routines);</span><br><span class="line"></span><br><span class="line">	DefineCustomStringVariable(<span class="string">"pgcrypto.keysetup_command"</span>,</span><br><span class="line">			   <span class="string">"Command to fetch database encryption key"</span>,</span><br><span class="line">			   <span class="string">"This command will be run at database startup to set up database"</span></span><br><span class="line">			   <span class="string">" encryption key."</span>,</span><br><span class="line">			   &amp;pgcrypto_keysetup_command,</span><br><span class="line">			   <span class="string">""</span>,</span><br><span class="line">			   PGC_POSTMASTER,</span><br><span class="line">			   <span class="number">0</span>,</span><br><span class="line">			   <span class="literal">NULL</span>,</span><br><span class="line">			   <span class="literal">NULL</span>,</span><br><span class="line">			   <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	EmitWarningsOnPlaceholders(<span class="string">"pgcrypto"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从encryption.c提供的函数入手，查看PostgreSQL是什么时候调用的。</p>
<p>先看<code>setup_encryption</code>函数<br>在 postmaster.c中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Postmaster main entry point</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">PostmasterMain(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">        CreateDataDirLockFile(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Initialize SSL library, if specified.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_SSL</span></span><br><span class="line">	<span class="keyword">if</span> (EnableSSL)</span><br><span class="line">		secure_initialize();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	setup_encryption();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * process any libraries that should be preloaded at postmaster start</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	process_shared_preload_libraries();</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 bootstrap.c中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *	 AuxiliaryProcessMain</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *	 The main entry point for auxiliary processes, such as the bgwriter,</span></span><br><span class="line"><span class="comment"> *	 walwriter, walreceiver, bootstrapper and the shared memory checker code.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *	 This code is here just because of historical reasons.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">AuxiliaryProcessMain(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">        <span class="comment">/* Initialize MaxBackends (if under postmaster, was done already) */</span></span><br><span class="line">	<span class="keyword">if</span> (!IsUnderPostmaster)</span><br><span class="line">		InitializeMaxBackends();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!IsUnderPostmaster)</span><br><span class="line">		setup_encryption();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">	&#123;</span><br><span class="line">		bootstrap_data_encrypted = <span class="literal">true</span>;</span><br><span class="line">		bootstrap_encryption_sample = palloc0(ENCRYPTION_SAMPLE_SIZE);</span><br><span class="line">		sample_encryption(bootstrap_encryption_sample);</span><br><span class="line">	&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在postgres.c中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ----------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * PostgresMain</span></span><br><span class="line"><span class="comment"> *	   postgres main loop -- all backends, interactive or otherwise start here</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * argc/argv are the command line arguments to be used.  (When being forked</span></span><br><span class="line"><span class="comment"> * by the postmaster, these are not the original argv array of the process.)</span></span><br><span class="line"><span class="comment"> * dbname is the name of the database to connect to, or NULL if the database</span></span><br><span class="line"><span class="comment"> * name should be extracted from the command line arguments or defaulted.</span></span><br><span class="line"><span class="comment"> * username is the PostgreSQL user name to be used for the session.</span></span><br><span class="line"><span class="comment"> * ----------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">PostgresMain(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[],</span><br><span class="line">			 <span class="keyword">const</span> <span class="keyword">char</span> *dbname,</span><br><span class="line">			 <span class="keyword">const</span> <span class="keyword">char</span> *username)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">        <span class="keyword">if</span> (!IsUnderPostmaster)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Validate we have been given a reasonable-looking DataDir (if under</span></span><br><span class="line"><span class="comment">		 * postmaster, assume postmaster did this already).</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		Assert(DataDir);</span><br><span class="line">		ValidatePgVersion(DataDir);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Change into DataDir (if under postmaster, was done already) */</span></span><br><span class="line">		ChangeToDataDir();</span><br><span class="line"></span><br><span class="line">		setup_encryption();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Create lockfile for data directory.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		CreateDataDirLockFile(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Initialize MaxBackends (if under postmaster, was done already) */</span></span><br><span class="line">		InitializeMaxBackends();</span><br><span class="line">	&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>setup_encryption</code> 在几个关键进程启动是即调用</p>
<p>再看<code>encrypt_block</code><br>在 slru.c<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Physical write of a page from a buffer slot</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * On failure, we cannot just ereport(ERROR) since caller has put state in</span></span><br><span class="line"><span class="comment"> * shared memory that must be undone.  So, we return FALSE and save enough</span></span><br><span class="line"><span class="comment"> * info in static variables to let SlruReportIOError make the report.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For now, assume it's not worth keeping a file pointer open across</span></span><br><span class="line"><span class="comment"> * independent read/write operations.  We do batch operations during</span></span><br><span class="line"><span class="comment"> * SimpleLruFlush, though.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * fdata is NULL for a standalone write, pointer to open-file info during</span></span><br><span class="line"><span class="comment"> * SimpleLruFlush.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">SlruPhysicalWritePage(SlruCtl ctl, <span class="keyword">int</span> pageno, <span class="keyword">int</span> slotno, SlruFlush fdata)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  wbuf = shared-&gt;page_buffer[slotno];</span><br><span class="line">	<span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">	&#123;</span><br><span class="line">		SlruEncryptionTweak(slru_encryption_tweak, pageno);</span><br><span class="line">		encrypt_block(wbuf, slru_encryption_buf, BLCKSZ, slru_encryption_tweak);</span><br><span class="line">		wbuf = slru_encryption_buf;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	errno = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (write(fd, wbuf, BLCKSZ) != BLCKSZ)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/* if write didn't set errno, assume problem is no disk space */</span></span><br><span class="line">		<span class="keyword">if</span> (errno == <span class="number">0</span>)</span><br><span class="line">			errno = ENOSPC;</span><br><span class="line">		slru_errcause = SLRU_WRITE_FAILED;</span><br><span class="line">		slru_errno = errno;</span><br><span class="line">		<span class="keyword">if</span> (!fdata)</span><br><span class="line">			CloseTransientFile(fd);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在xlog.c中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Write and/or fsync the log at least as far as WriteRqst indicates.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If flexible == TRUE, we don't have to write as far as WriteRqst, but</span></span><br><span class="line"><span class="comment"> * may stop at any convenient boundary (such as a cache or logfile boundary).</span></span><br><span class="line"><span class="comment"> * This option allows us to avoid uselessly issuing multiple writes when a</span></span><br><span class="line"><span class="comment"> * single one would do.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Must be called with WALWriteLock held. WaitXLogInsertionsToFinish(WriteRqst)</span></span><br><span class="line"><span class="comment"> * must be called before grabbing the lock, to make sure the data is ready to</span></span><br><span class="line"><span class="comment"> * write.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">XLogWrite(XLogwrtRqst WriteRqst, <span class="keyword">bool</span> flexible)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">/* OK to write the page(s) */</span></span><br><span class="line">	from = XLogCtl-&gt;pages + startidx * (Size) XLOG_BLCKSZ;</span><br><span class="line">	nbytes = npages * (Size) XLOG_BLCKSZ;</span><br><span class="line">	<span class="keyword">if</span> (encryption_enabled) &#123;</span><br><span class="line">		<span class="keyword">int</span> i;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">XXX:</span> use larger encryption buffer to enable larger writes</span></span><br><span class="line"><span class="comment">		 * and reduce number of syscalls?</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; npages; i++) &#123;</span><br><span class="line">			<span class="keyword">char</span> buf[XLOG_BLCKSZ];</span><br><span class="line">			<span class="keyword">char</span> tweak[TWEAK_SIZE];</span><br><span class="line">			XLogEncryptionTweak(tweak, ThisTimeLineID, openLogSegNo, openLogOff);</span><br><span class="line">			encrypt_block(from, buf, XLOG_BLCKSZ, tweak);</span><br><span class="line"></span><br><span class="line">			XLogWritePages(buf, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">			from += XLOG_BLCKSZ;</span><br><span class="line">			openLogOff += XLOG_BLCKSZ;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		XLogWritePages(from, npages);</span><br><span class="line">		openLogOff += nbytes;</span><br><span class="line">	&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This func must be called ONCE on system install.  It creates pg_control</span></span><br><span class="line"><span class="comment"> * and the initial XLOG segment.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">BootStrapXLOG(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> tweak[TWEAK_SIZE];</span><br><span class="line">		XLogEncryptionTweak(tweak, ThisTimeLineID, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">		encrypt_block((<span class="keyword">char</span>*)page, (<span class="keyword">char</span>*)page, XLOG_BLCKSZ, tweak);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Write the first page with the initial record */</span></span><br><span class="line">	errno = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (write(openLogFile, page, XLOG_BLCKSZ) != XLOG_BLCKSZ)</span><br><span class="line">	&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在写wal日志时先加密，后写入磁盘</p>
<p>在buffile.c中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * BufFileDumpBuffer</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Dump buffer contents starting at curOffset.</span></span><br><span class="line"><span class="comment"> * At call, should have dirty = true, nbytes &gt; 0.</span></span><br><span class="line"><span class="comment"> * On exit, dirty is cleared if successful write, and curOffset is advanced.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">BufFileDumpBuffer(BufFile *file)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> tweak[TWEAK_SIZE];</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 *  <span class="doctag">FIXME:</span> figure out how to handle nbytes &lt; smallest encryption block</span></span><br><span class="line"><span class="comment">		 * size</span></span><br><span class="line"><span class="comment">		 **/</span></span><br><span class="line">		BufFileTweak(tweak, file, file-&gt;curFile, file-&gt;curOffset);</span><br><span class="line">		encrypt_block(file-&gt;buffer, writeBuffer, file-&gt;nbytes, tweak);</span><br><span class="line">		writePtr = writeBuffer;</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		writePtr = file-&gt;buffer;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在md.c中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">mddecrypt(SMgrRelation reln, ForkNumber forknum, BlockNumber blocknum, <span class="keyword">char</span> *dest)</span><br><span class="line">&#123;</span><br><span class="line">	mdtweak(md_encryption_tweak, &amp;(reln-&gt;smgr_rnode.node), forknum, blocknum);</span><br><span class="line">	decrypt_block(md_encryption_buffer, dest, BLCKSZ, md_encryption_tweak);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BlockNumber</span><br><span class="line">ReencryptBlock(<span class="keyword">char</span> *buffer, <span class="keyword">int</span> blocks,</span><br><span class="line">		RelFileNode *srcNode, RelFileNode *dstNode,</span><br><span class="line">		ForkNumber srcForkNum, ForkNumber dstForkNum,</span><br><span class="line">		BlockNumber blockNum)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *cur;</span><br><span class="line">	<span class="keyword">char</span> srcTweak[<span class="number">16</span>];</span><br><span class="line">	<span class="keyword">char</span> dstTweak[<span class="number">16</span>];</span><br><span class="line">	<span class="keyword">for</span> (cur = buffer; cur &lt; buffer + blocks * BLCKSZ; cur += BLCKSZ)</span><br><span class="line">	&#123;</span><br><span class="line">		mdtweak(srcTweak, srcNode, srcForkNum, blockNum);</span><br><span class="line">		mdtweak(dstTweak, dstNode, dstForkNum, blockNum);</span><br><span class="line">		decrypt_block(cur, cur, BLCKSZ, srcTweak);</span><br><span class="line">		encrypt_block(cur, cur, BLCKSZ, dstTweak);</span><br><span class="line">		blockNum++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> blockNum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *	mdextend() -- Add a block to the specified relation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *		The semantics are nearly the same as mdwrite(): write at the</span></span><br><span class="line"><span class="comment"> *		specified position.  However, this is to be used for the case of</span></span><br><span class="line"><span class="comment"> *		extending a relation (i.e., blocknum is at or beyond the current</span></span><br><span class="line"><span class="comment"> *		EOF).  Note that we assume writing a block beyond current EOF</span></span><br><span class="line"><span class="comment"> *		causes intervening file space to become filled with zeroes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">mdextend(SMgrRelation reln, ForkNumber forknum, BlockNumber blocknum,</span><br><span class="line">		 <span class="keyword">char</span> *buffer, <span class="keyword">bool</span> skipFsync)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">		mdencrypt(reln, forknum, blocknum, buffer);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((nbytes = FileWrite(v-&gt;mdfd_vfd, encryption_enabled ? md_encryption_buffer : buffer, BLCKSZ)) != BLCKSZ)</span><br><span class="line">	&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *	mdwrite() -- Write the supplied block at the appropriate location.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *		This is to be used only for updating already-existing blocks of a</span></span><br><span class="line"><span class="comment"> *		relation (ie, those before the current EOF).  To extend a relation,</span></span><br><span class="line"><span class="comment"> *		use mdextend().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">mdwrite(SMgrRelation reln, ForkNumber forknum, BlockNumber blocknum,</span><br><span class="line">		<span class="keyword">char</span> *buffer, <span class="keyword">bool</span> skipFsync)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">		mdencrypt(reln, forknum, blocknum, buffer);</span><br><span class="line">	nbytes = FileWrite(v-&gt;mdfd_vfd, encryption_enabled ? md_encryption_buffer : buffer, BLCKSZ);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查找<code>decrypt_block</code><br>在slru.c中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Physical read of a (previously existing) page into a buffer slot</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * On failure, we cannot just ereport(ERROR) since caller has put state in</span></span><br><span class="line"><span class="comment"> * shared memory that must be undone.  So, we return FALSE and save enough</span></span><br><span class="line"><span class="comment"> * info in static variables to let SlruReportIOError make the report.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For now, assume it's not worth keeping a file pointer open across</span></span><br><span class="line"><span class="comment"> * read/write operations.  We could cache one virtual file pointer ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">SlruPhysicalReadPage(SlruCtl ctl, <span class="keyword">int</span> pageno, <span class="keyword">int</span> slotno)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">	&#123;</span><br><span class="line">		SlruEncryptionTweak(slru_encryption_tweak, pageno);</span><br><span class="line">		decrypt_block(slru_encryption_buf, shared-&gt;page_buffer[slotno],</span><br><span class="line">				BLCKSZ, slru_encryption_tweak);</span><br><span class="line">	&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在xlog.c中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Read the XLOG page containing RecPtr into readBuf (if not read already).</span></span><br><span class="line"><span class="comment"> * Returns number of bytes read, if the page is read successfully, or -1</span></span><br><span class="line"><span class="comment"> * in case of errors.  When errors occur, they are ereport'ed, but only</span></span><br><span class="line"><span class="comment"> * if they have not been previously reported.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This is responsible for restoring files from archive as needed, as well</span></span><br><span class="line"><span class="comment"> * as for waiting for the requested WAL record to arrive in standby mode.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 'emode' specifies the log level used for reporting "file not found" or</span></span><br><span class="line"><span class="comment"> * "end of WAL" situations in archive recovery, or in standby mode when a</span></span><br><span class="line"><span class="comment"> * trigger file is found. If set to WARNING or below, XLogPageRead() returns</span></span><br><span class="line"><span class="comment"> * false in those situations, on higher log levels the ereport() won't</span></span><br><span class="line"><span class="comment"> * return.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * In standby mode, if after a successful return of XLogPageRead() the</span></span><br><span class="line"><span class="comment"> * caller finds the record it's interested in to be broken, it should</span></span><br><span class="line"><span class="comment"> * ereport the error with the level determined by</span></span><br><span class="line"><span class="comment"> * emode_for_corrupt_record(), and then set lastSourceFailed</span></span><br><span class="line"><span class="comment"> * and call XLogPageRead() again with the same arguments. This lets</span></span><br><span class="line"><span class="comment"> * XLogPageRead() to try fetching the record from another source, or to</span></span><br><span class="line"><span class="comment"> * sleep and retry.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">XLogPageRead(XLogReaderState *xlogreader, XLogRecPtr targetPagePtr, <span class="keyword">int</span> reqLen,</span><br><span class="line">			 XLogRecPtr targetRecPtr, <span class="keyword">char</span> *readBuf, TimeLineID *readTLI)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> tweak[TWEAK_SIZE];</span><br><span class="line">		XLogEncryptionTweak(tweak, curFileTLI, readSegNo, readOff);</span><br><span class="line">		decrypt_block(readBuf, readBuf, XLOG_BLCKSZ, tweak);</span><br><span class="line">	&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在xlogutils.c中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Read 'count' bytes from WAL into 'buf', starting at location 'startptr'</span></span><br><span class="line"><span class="comment"> * in timeline 'tli'.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Will open, and keep open, one WAL segment stored in the static file</span></span><br><span class="line"><span class="comment"> * descriptor 'sendFile'. This means if XLogRead is used once, there will</span></span><br><span class="line"><span class="comment"> * always be one descriptor left open until the process ends, but never</span></span><br><span class="line"><span class="comment"> * more than one.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * XXX This is very similar to pg_xlogdump's XLogDumpXLogRead and to XLogRead</span></span><br><span class="line"><span class="comment"> * in walsender.c but for small differences (such as lack of elog() in</span></span><br><span class="line"><span class="comment"> * frontend).  Probably these should be merged at some point.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">XLogRead(<span class="keyword">char</span> *buf, TimeLineID tli, XLogRecPtr startptr, Size count)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">/* Decrypt completed blocks */</span></span><br><span class="line">		<span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">while</span> (decrypt_p + XLOG_BLCKSZ &lt;= p)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">char</span> tweak[TWEAK_SIZE];</span><br><span class="line">				XLogEncryptionTweak(tweak, tli, sendSegNo, decryptOff);</span><br><span class="line">				decrypt_block(decrypt_p, decrypt_p, XLOG_BLCKSZ, tweak);</span><br><span class="line"></span><br><span class="line">				decrypt_p += XLOG_BLCKSZ;</span><br><span class="line">				decryptOff += XLOG_BLCKSZ;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在buffile.c中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * BufFileLoadBuffer</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Load some data into buffer, if possible, starting from curOffset.</span></span><br><span class="line"><span class="comment"> * At call, must have dirty = false, nbytes = 0.</span></span><br><span class="line"><span class="comment"> * On exit, nbytes is number of bytes loaded.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">BufFileLoadBuffer(BufFile *file)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> tweak[TWEAK_SIZE];</span><br><span class="line">		BufFileTweak(tweak, file, file-&gt;curFile, file-&gt;curOffset);</span><br><span class="line">		decrypt_block(file-&gt;buffer, file-&gt;buffer, file-&gt;nbytes, tweak);</span><br><span class="line">	&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在md.c中<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">mddecrypt(SMgrRelation reln, ForkNumber forknum, BlockNumber blocknum, <span class="keyword">char</span> *dest)</span><br><span class="line">&#123;</span><br><span class="line">	mdtweak(md_encryption_tweak, &amp;(reln-&gt;smgr_rnode.node), forknum, blocknum);</span><br><span class="line">	decrypt_block(md_encryption_buffer, dest, BLCKSZ, md_encryption_tweak);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *	mdread() -- Read the specified block from a relation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">mdread(SMgrRelation reln, ForkNumber forknum, BlockNumber blocknum,</span><br><span class="line">	   <span class="keyword">char</span> *buffer)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (nbytes != BLCKSZ)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>)</span><br><span class="line">			ereport(ERROR,</span><br><span class="line">					(errcode_for_file_access(),</span><br><span class="line">					 errmsg(<span class="string">"could not read block %u in file \"%s\": %m"</span>,</span><br><span class="line">							blocknum, FilePathName(v-&gt;mdfd_vfd))));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (zero_damaged_pages || InRecovery)</span><br><span class="line">			MemSet(buffer, <span class="number">0</span>, BLCKSZ);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			ereport(ERROR,</span><br><span class="line">					(errcode(ERRCODE_DATA_CORRUPTED),</span><br><span class="line">					 errmsg(<span class="string">"could not read block %u in file \"%s\": read only %d of %d bytes"</span>,</span><br><span class="line">							blocknum, FilePathName(v-&gt;mdfd_vfd),</span><br><span class="line">							nbytes, BLCKSZ)));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (encryption_enabled)</span><br><span class="line">		mddecrypt(reln, forknum, blocknum, buffer);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中<code>ReencryptBlock</code>在copydir.c中有调用<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * copy one file. If decryption and reencryption is needed specify</span></span><br><span class="line"><span class="comment"> * relfilenodes for source and target.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">copy_file(<span class="keyword">char</span> *fromfile, <span class="keyword">char</span> *tofile, RelFileNode *fromNode,</span><br><span class="line">		RelFileNode *toNode, ForkNumber fromForkNum, ForkNumber toForkNum,</span><br><span class="line">		<span class="keyword">int</span> segment)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If the database is encrypted we need to decrypt the data here</span></span><br><span class="line"><span class="comment">		 * and reencrypt it to adjust the tweak values of blocks.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (fromNode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Assert(toNode != <span class="literal">NULL</span>);</span><br><span class="line">			blockNum = ReencryptBlock(buffer, nbytes/BLCKSZ,</span><br><span class="line">					fromNode, toNode, fromForkNum, toForkNum, blockNum);</span><br><span class="line">		&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上基本知道了PostgreSQL-FDE对数据文件进行加密的过程，当然里面还有一些细节的问题还需要后续研究。</p>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><p><a href="https://github.com/digoal/blog/blob/master/201610/20161031_01.md" target="_blank" rel="noopener">PostgreSQL 透明加密(TDE,FDE) - 块级加密</a></p>
<p><a href="https://my.oschina.net/ashnah/blog/872297" target="_blank" rel="noopener">postgresSQL的FDE加密</a></p>

  </article>
</div>


    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="/js/md5.min.js"></script>
<div class='container' id="gitalk-container"></div>
<script>
    var gitalk = new Gitalk({
        clientID: '0f95488e2c5e12bc2a2a',
        clientSecret: 'b01836c08c02e727359d1c8df682e8b65fe41de1',
        repo: 'blog_gitalk',
        owner: 'oYo-Byte',
        admin: ['oYo-Byte'],
		id: md5(location.pathname),
        distractionFreeMode: true,
    })
    gitalk.render('gitalk-container')
</script>




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <a href="https://oyo-byte.github.io" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2018 oYo-Byte</li>
      <li><a href="https://oyo-byte.github.io">Home</a></li>
      
      <li><a href="https://github.com/oYo-Byte">Github</a></li>
      
    </ul>
    <div class="footer-theme-info">
      Theme <a href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
    </div>
  </footer>
</div>




<script src="/js/main.js"></script>

</body>
</html>
