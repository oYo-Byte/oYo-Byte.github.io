<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    学习PostgreSQL的FDW(#3)-其他函数说明 I | oYo-Byte
  </title>
  <meta name="description" content="oYo-Byte&#39;s blog">
  
  <meta name="keywords" content="
  PostgreSQL,FDW
  ">
  
  <meta name="author" content="oYo-Byte">

  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp">

  <link rel="icon" type="image/x-icon" href="https://assets-cdn.github.com/favicon.ico">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  

  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
</head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">This website</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/archives">Archives</a></li>
        
        
        <li><a href="/categories">Categories</a></li>
        
        
        <li><a href="/tags">Tags</a></li>
        
        
        <li class="desktop-only"><a href="/atom.xml" target="_blank">RSS</a></li>
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="https://avatars2.githubusercontent.com/u/8343269?s=460&amp;v=4"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/archives"
           class="header-toolbar-right"> 13 </a>
      </li>
      <li>
        <a href="/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/tags"
           class="header-toolbar-right"> 9 </a>
      </li>
      <li>
        <a href="/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/categories"
           class="header-toolbar-right"> 3 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/">oYo-Byte</a>
      
      
    </h2>
  </div>

  <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div>
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    oYo-Byte

    <span class="post-date float-right" title="{{moment(1533635241871).format('MMM DD, YYYY, h:mm:ss A')}}">
      <i class="fa fa-pencil-square-o"></i>
      {{moment(1533635241871).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>学习PostgreSQL的FDW(#3)-其他函数说明 I</h1>
    <p>上两篇文章主要介绍了实现FDW的7个必须实现的扫描相关的回调函数，<a href="https://oyo-byte.github.io/2018/08/03/learn_about_pgfdw/">学习PostgreSQL的FDW(#1)</a>，<br><a href="https://oyo-byte.github.io/2018/08/07/learn_about_pgfdw_part2/">学习PostgreSQL的FDW(#2)-源码跟踪</a>，这边就继续说说其余32个回调函数</p>
<h2 id="用于扫描外部连接的回调函数"><a href="#用于扫描外部连接的回调函数" class="headerlink" title="用于扫描外部连接的回调函数"></a>用于扫描外部连接的回调函数</h2><p>如果一个 FDW 支持远程执行外部连接（而不是先把两个表的数据取到本地然后做本地连接），它应该提供这个回调函数:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">GetForeignJoinPaths (PlannerInfo *root,</span><br><span class="line">                     RelOptInfo *joinrel,</span><br><span class="line">                     RelOptInfo *outerrel,</span><br><span class="line">                     RelOptInfo *innerrel,</span><br><span class="line">                     JoinType jointype,</span><br><span class="line">                     JoinPathExtraData *extra);</span><br></pre></td></tr></table></figure></p>
<p>它为两个（或更多）同属于一台外部服务器的外部表的连接创建可能的访问路径。这个可选的函数会在查询规划过程中被调用。和<code>GetForeignPaths</code>一样，这个函数应该为提供的joinrel生成ForeignPath路径，并且调用add_path把这些路径加入到该连接应该考虑的路径集合中。但是和<code>GetForeignPaths</code>不一样的是，不需要这个函数产生最少一个路径，因为涉及本地连接的路径总是可用的。</p>
<p>注意的是，对于相同的连接关系，将会重复调用此函数来生成内外关系的不同组合。FDW需要负责最小化其中重复的工作。</p>
<p>如果一个ForeignPath路径被选中用于该连接，它将在整个连接处理中存在，为其中的成分表和子连接产生的路径将不会被使用。后续对该连接路径的处理大部分和扫描单个外部表的路径一样。一点不同是ForeignScan计划节点的scanrelid应该被设置为零，因为它表示的不是单个关系，而是用ForeignScan节点的fs_relids属性来表示被连接的关系集合（fs_relids会被核心规划器代码自动设置，不需要由 FDW 填充）。另一点不同是，由于一个远程连接的列的列表无法在系统目录中找到，FDW必须用一个合适的TargetEntry节点列表来填充fdw_scan_tlist，表示运行时它返回的元组中提供的列的集合。</p>
<h2 id="用于规划扫描-连接-后处理的回调函数"><a href="#用于规划扫描-连接-后处理的回调函数" class="headerlink" title="用于规划扫描/连接 后处理的回调函数"></a>用于规划扫描/连接 后处理的回调函数</h2><p>如果一个FDW支持执行远程的扫描/连接 后处理，例如远程聚集，应该事先这个回调函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">GetForeignUpperPaths(PlannerInfo *root,</span><br><span class="line">                     UpperRelationKind stage,</span><br><span class="line">                     RelOptInfo *input_rel,</span><br><span class="line">                     RelOptInfo *output_rel,</span><br><span class="line">                     <span class="keyword">void</span> *extra);</span><br></pre></td></tr></table></figure></p>
<p>为<em>上层关系</em>处理创建可能的访问路径，这是规划器针对所有扫描/连接后查询处理的术语，例如聚集、窗口函数、排序和表更新。在查询规划期间会调用这个可选的函数。当前，只有当该查询中涉及的所有基本关系都属于同一个 FDW 时才会调用这个函数。这个函数应该让 FDW 知道如何远程执行的任何扫描/连接 后处理生成ForeignPath路径，并且调用add_path把这些路径加入到上层关系中。就GetForeignJoinPaths来说，并不要求这个函数在创建任何路径时都能成功，因为涉及本地处理的路径总是可行的。</p>
<p>stage参数表示当前正在考虑的是哪一个扫描/连接后处理步骤。output_rel是接收表示这一个步骤的路径的上层关系，而input_rel是表示这个步骤输入的关系。extra参数提供了其他详细信息。目前，它仅能设置成UPPERREL_PARTIAL_GROUP_AGG或UPPERREL_GROUP_AGG，在这种情况下，它指向的是GroupPathExtraData结构体。（注意被加入到output_rel中的ForeignPath路径通常对input_rel的路径没有直接的依赖，因为它们的处理被认为是在外部处理的。不过，检查为前一个处理步骤生成的路径有助于避免冗余的规划工作）。</p>
<p>使用gdb追踪调用情况<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b postgresGetForeignUpperPaths</span><br><span class="line">Breakpoint 1 at 0x7f2cea563a20: file postgres_fdw.c, line 5437.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, postgresGetForeignUpperPaths (root=0xf7ce50, stage=UPPERREL_GROUP_AGG, </span><br><span class="line">    input_rel=0xf7d3d0, output_rel=0x1063910, extra=0x7ffc84ff94e0) at postgres_fdw.c:5437</span><br><span class="line">5437		<span class="keyword">if</span> (!input_rel-&gt;fdw_private ||</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresGetForeignUpperPaths (root=0xf7ce50, stage=UPPERREL_GROUP_AGG, input_rel=0xf7d3d0, output_rel=0x1063910, extra=0x7ffc84ff94e0) at postgres_fdw.c:5437</span></span><br><span class="line"><span class="comment">#1  0x00000000006807bf in create_ordinary_grouping_paths (root=root@entry=0xf7ce50, input_rel=input_rel@entry=0xf7d3d0, grouped_rel=grouped_rel@entry=0x1063910, agg_costs=agg_costs@entry=0x7ffc84ff94b0, gd=gd@entry=0x0, extra=extra@entry=0x7ffc84ff94e0, partially_grouped_rel_p=partially_grouped_rel_p@entry=0x7ffc84ff9488) at planner.c:4059</span></span><br><span class="line"><span class="comment">#2  0x00000000006831e9 in create_grouping_paths (gd=0x0, agg_costs=0x7ffc84ff94b0, target_parallel_safe=true, target=0x1063768, input_rel=0xf7d3d0, root=0xf7ce50) at planner.c:3783</span></span><br><span class="line"><span class="comment">#3  grouping_planner (root=root@entry=0xf7ce50, inheritance_update=inheritance_update@entry=false, tuple_fraction=&lt;optimized out&gt;, tuple_fraction@entry=0) at planner.c:2037</span></span><br><span class="line"><span class="comment">#4  0x0000000000684218 in subquery_planner (glob=glob@entry=0xf7cdc0, parse=parse@entry=0xf7c6a8, parent_root=parent_root@entry=0x0, hasRecursion=hasRecursion@entry=false, tuple_fraction=tuple_fraction@entry=0) at planner.c:966</span></span><br><span class="line"><span class="comment">#5  0x0000000000685236 in standard_planner (parse=0xf7c6a8, cursorOptions=256, boundParams=0x0) at planner.c:405</span></span><br><span class="line"><span class="comment">#6  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0xf7c6a8, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#7  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#8  0x0000000000721cda in exec_simple_query (query_string=0xf7b810 "select count(*) from t_fdw ;") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0xfa5528, dbname=0xfa5410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0xf9d3f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0xf9d3f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0xf763c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0xf763c0) at main.c:228</span></span><br></pre></td></tr></table></figure></p>
<h2 id="更新外部表的回调函数"><a href="#更新外部表的回调函数" class="headerlink" title="更新外部表的回调函数"></a>更新外部表的回调函数</h2><table>
<thead>
<tr>
<th style="text-align:left">回调函数</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">AddForeignUpdateTargets</td>
<td style="text-align:left">保证FDW能够找到要更新或删除的准确行</td>
</tr>
<tr>
<td style="text-align:left">PlanForeignModify</td>
<td style="text-align:left">执行外部表上插入、更新或删除所需的任何附加规划动作</td>
</tr>
<tr>
<td style="text-align:left">BeginForeignModify</td>
<td style="text-align:left">开始执行一个外部表修改操作，执行任何先于实际表修改的初始化工作</td>
</tr>
<tr>
<td style="text-align:left">ExecForeignInsert</td>
<td style="text-align:left">插入一个元组到外部表</td>
</tr>
<tr>
<td style="text-align:left">ExecForeignUpdate</td>
<td style="text-align:left">更新外部表中的一个元组</td>
</tr>
<tr>
<td style="text-align:left">ExecForeignDelete</td>
<td style="text-align:left">从外部表删除一个元组</td>
</tr>
<tr>
<td style="text-align:left">EndForeignModify</td>
<td style="text-align:left">结束表更新并释放资源</td>
</tr>
<tr>
<td style="text-align:left">BeginForeignInsert</td>
<td style="text-align:left">开始在外表上执行插入操作(分区表或COPY FROM命令)，在实际插入之前执行所需的任何初始化</td>
</tr>
<tr>
<td style="text-align:left">EndForeignInsert</td>
<td style="text-align:left">结束表插入并释放资源(分区表或COPY FROM命令)</td>
</tr>
<tr>
<td style="text-align:left">IsForeignRelUpdatable</td>
<td style="text-align:left">报告指定的外部表支持哪些更新操作</td>
</tr>
<tr>
<td style="text-align:left">PlanDirectModify</td>
<td style="text-align:left">决定在远程服务器上执行直接修改是否安全</td>
</tr>
<tr>
<td style="text-align:left">BeginDirectModify</td>
<td style="text-align:left">准备在远程服务器上执行一次直接修改，执行直接修改所需的任何初始化工作</td>
</tr>
<tr>
<td style="text-align:left">IterateDirectModify</td>
<td style="text-align:left">执行直接修改操作</td>
</tr>
<tr>
<td style="text-align:left">EndDirectModify</td>
<td style="text-align:left">在远程服务器上的直接修改后进行清理</td>
</tr>
</tbody>
</table>
<p><br><br>如果一个FDW支持可写的外部表，根据FDW的需要和功能，应该提供以下某些或者全部回调函数：</p>
<ul>
<li>AddForeignUpdateTargets  </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">AddForeignUpdateTargets(Query *parsetree,</span><br><span class="line">                        RangeTblEntry *target_rte,</span><br><span class="line">                        Relation target_relation);</span><br></pre></td></tr></table></figure>
<p>UPDATE和DELETE操作是在之前由表扫描函数取出的行上被执行的。FDW可能需要额外的信息（例如一个行ID或主键列的值）来保证它能够找到要更新或删除的准确行。要支持这些要求，这个函数可以向列列表中增加额外的隐藏或“junk”的目标列，它们在一个UPDATE或DELETE期间会被从外部表中获取。</p>
<p>要做到这一点，向parsetree-&gt;targetList中增加TargetEntry项，它们包含要被获取的额外值的表达式。每一个这样的项必须被标记为resjunk = true，并且必须有一个可区分的resname用于在执行期间标识它。请避免使用匹配ctidN、wholerow或wholerowN的名字，因为核心系统可能会生成使用这些名字的junk列。如果额外的表达式比简单的Vars更复杂，在将它们添加到目标列表之前，必须通过eval_const_expressions运行它们。</p>
<p>这个函数在重写器中被调用，而不是在规划器中，因此可用的信息与在规划例程中的有点区别。parsetree是UPDATE或DELETE命令的分析树，而target_rte和target_relation描述目标外部表。</p>
<p>如果<code>AddForeignUpdateTargets</code>指针被设置为NULL，则不会有额外的目标表达式被加入（这将使得我们不可能实现DELETE操作，而UPDATE则还有可能是可行的，前提是FDW依赖一个未改变的主键来标识行）。</p>
<ul>
<li>PlanForeignModify  </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List *</span><br><span class="line">PlanForeignModify(PlannerInfo *root,</span><br><span class="line">                  ModifyTable *plan,</span><br><span class="line">                  Index resultRelation,</span><br><span class="line">                  <span class="keyword">int</span> subplan_index);</span><br></pre></td></tr></table></figure>
<p>执行外部表上插入、更新或删除所需的任何附加规划动作。这个函数生成FDW私有信息，该信息将被附加到执行该更新动作的ModifyTable计划节点。这个私有信息的形式必须是一个List，并将会在执行阶段被传递给BeginForeignModify。</p>
<p>root是规划器关于该查询的全局信息。plan是ModifyTable计划节点，它除了fdwPrivLists属性之外是完整的。resultRelation通过目标外部表的范围表索引来标识它。subplan_index标识这是ModifyTable计划节点的哪个目标，从零开始计数；如果你希望索引到plan-&gt;plans或其他plan节点的子结构中，请使用它。</p>
<p>如果<code>PlanForeignModify</code>指针被设置为NULL，则不会有额外的计划时动作被执行，并且传递给BeginForeignModify的fdw_private列表也将为 NIL。</p>
<ul>
<li>BeginForeignModify  </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">BeginForeignModify (ModifyTableState *mtstate,</span><br><span class="line">                    ResultRelInfo *rinfo,</span><br><span class="line">                    List *fdw_private,</span><br><span class="line">                    <span class="keyword">int</span> subplan_index,</span><br><span class="line">                    <span class="keyword">int</span> eflags);</span><br></pre></td></tr></table></figure>
<p>开始执行一个外部表修改操作。这个函数在执行器启动期间被调用。它应该执行任何先于实际表修改的初始化工作。随后，<code>ExecForeignInsert</code>、<code>ExecForeignUpdate</code>或<code>ExecForeignDelete</code>将被为每一个将被插入、更新或删除的元组调用。</p>
<p>mtstate是要被执行的ModifyTable计划节点的状态信息；通过这个结构可以得到关于规划和执行阶段的全局数据。rinfo是描述目标外部表的ResultRelInfo结构（ResultRelInfo的ri_FdwState属性用于FDW来存储它在此操作中需要的任何私有状态）。fdw_private包含<code>PlanForeignModify</code>生成的私有数据。subplan_index标识这是ModifyTable计划节点的哪个目标。eflags包含描述执行器对该计划节点操作模式的标志位。</p>
<p>注意当(eflags &amp; EXEC_FLAG_EXPLAIN_ONLY)为真，这个函数不应执行任何外部可见的动作；它只应该做最少的工作来创建<code>ExplainForeignModify</code>和<code>EndForeignModify</code>可用的节点状态。</p>
<p>如果<code>BeginForeignModify</code>指针被设置为NULL，在执行器启动期间将不会采取任何动作。</p>
<ul>
<li>ExecForeignInsert</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">ExecForeignInsert(EState *estate,</span><br><span class="line">                  ResultRelInfo *rinfo,</span><br><span class="line">                  TupleTableSlot *slot,</span><br><span class="line">                  TupleTableSlot *planSlot);</span><br></pre></td></tr></table></figure>
<p>插入一个元组到外部表。estate是查询的全局执行状态。rinfo是描述目标外部表的ResultRelInfo结构。slot包含要被插入的元组；它将匹配外部表的行类型定义。planSlot包含由ModifyTable计划节点的子计划生成的元组；它与slot不同，它可能包含额外的“junk”列（INSERT情况通常不关心planSlot，但是为了完整性还是在这里提供它）。</p>
<p>返回值可以是一个包含实际被插入的数据的槽（这可能会和所提供的数据不同，例如一个触发器动作的结果），或者为 NULL 表示实际没有插入行（还是触发器的结果）。被传入的slot可以被重用于这个目的。</p>
<p>在返回槽中的数据只有在INSERT查询具有一个RETURNING子句或者外部表具有一个AFTER ROW触发器时才被使用。触发器要求所有的列，但是 FDW 应该选择优化成根据RETURNING子句的内容返回某些或全部列。不管怎样，某些槽必须被返回来指示成功，否则查询报告的行计数将会是错误的。</p>
<p>如果<code>ExecForeignInsert</code>指针被设置为NULL，尝试向外部表插入将会失败并报告一个错误消息。</p>
<ul>
<li>ExecForeignUpdate</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">ExecForeignUpdate(EState *estate,</span><br><span class="line">                  ResultRelInfo *rinfo,</span><br><span class="line">                  TupleTableSlot *slot,</span><br><span class="line">                  TupleTableSlot *planSlot);</span><br></pre></td></tr></table></figure>
<p>更新外部表中的一个元组。estate是查询的全局执行状态。rinfo是描述目标外部表的ResultRelInfo结构。slot包含元组的新数据；它将匹配外部表的行类型定义。planSlot包含由ModifyTable计划节点的子计划生成的元组；它与slot不同，它可能包含额外的“junk”列。特殊地，任何<code>AddForeignUpdateTargets</code>所要求的junk列在这个槽中都是有效的。</p>
<p>返回值可以是一个包含实际被更新的数据的槽（这可能会和所提供的数据不同，例如一个触发器动作的结果），或者为 NULL 表示实际没有更新行（还是触发器的结果）。被传入的slot可以被重用于这个目的。</p>
<p>在返回槽中的数据只有在UPDATE查询具有一个RETURNING子句或者外部表具有一个AFTER ROW触发器时才被使用。触发器要求所有的列，但是 FDW 应该选择优化成根据RETURNING子句的内容返回某些或全部列。不管怎样，某些槽必须被返回来指示成功，否则查询报告的行计数将会是错误的。</p>
<p>如果<code>ExecForeignUpdate</code>指针被设置为NULL，尝试更新外部表将会失败并报告一个错误消息。</p>
<ul>
<li>ExecForeignDelete </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">ExecForeignDelete(EState *estate,</span><br><span class="line">                  ResultRelInfo *rinfo,</span><br><span class="line">                  TupleTableSlot *slot,</span><br><span class="line">                  TupleTableSlot *planSlot);</span><br></pre></td></tr></table></figure>
<p>从外部表删除一个元组。estate是查询的全局执行状态。rinfo是描述目标外部表的ResultRelInfo结构。slot在调用时不包含任何有用的东西，但是可以被用于保持被返回的元组。planSlot包含由ModifyTable计划节点的子计划生成的元组；特殊地，它将携带AddForeignUpdateTargets所要求的任意junk列。junk列被用来标识要被删除的元组。</p>
<p>返回值可以是一个包含实际被删除的数据的槽，或者为 NULL 表示实际没有删除行（还是触发器的结果）。被传入的slot可以被重用于这个目的。</p>
<p>在返回槽中的数据只有在DELETE查询具有一个RETURNING子句或者外部表具有一个AFTER ROW触发器时才被使用。触发器要求所有的列，但是 FDW 应该选择优化成根据RETURNING子句的内容返回某些或全部列。不管怎样，某些槽必须被返回来指示成功，否则查询报告的行计数将会是错误的。</p>
<p>如果<code>ExecForeignDelete</code>指针被设置为NULL，尝试从外部表中删除将会失败并报告一个错误消息。</p>
<ul>
<li>EndForeignModify</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">EndForeignModify(EState *estate,</span><br><span class="line">                 ResultRelInfo *rinfo);</span><br></pre></td></tr></table></figure>
<p>结束表更新并释放资源。通常释放palloc的内存并不重要，但是打开的文件和到远程服务器的连接等应当被清除。</p>
<p>如果<code>EndForeignModify</code>指针被设置为NULL，在执行器关闭期间不会采取任何动作。</p>
<p><br><br>通过INSERT或COPY FROM插入分区表的元组将路由到分区。如果FDW支持可路由的外表分区，它还应提供以下回调函数。在外部表上执行COPY FROM时也会调用这些函数：</p>
<ul>
<li>BeginForeignInsert</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">BeginForeignInsert(ModifyTableState *mtstate,</span><br><span class="line">                   ResultRelInfo *rinfo);</span><br></pre></td></tr></table></figure>
<p>开始在外表上执行插入操作。在将第一个元组插入到外表中之前，当它是为元组路由选择的分区和在COPY FROM命令中指定的目标时，就会调用此例程。它应该在实际插入之前执行所需的任何初始化。随后，将调用<code>ExecForeignInsert</code>以将每个元组插入到外表中。</p>
<p>mtstate是要被执行的ModifyTable计划节点的状态信息；通过这个结构可以得到关于规划和执行阶段的全局数据。rinfo是描述目标外部表的ResultRelInfo结构（ResultRelInfo的ri_FdwState属性用于FDW来存储它在此操作中需要的任何私有状态）。</p>
<p>当通过COPY FROM命令调用此方法时，不提供mtstate中与计划相关的全局数据，并且随后为每个插入的元组调用的<code>ExecForeignInsert</code>的planSlot参数为NULL，无论外表是为元组路由选择的分区还是在命令中指定的目标。</p>
<p>如果<code>BeginForeignInsert</code>指针设置为NULL，则不会对初始化执行任何操作。</p>
<ul>
<li>EndForeignInsert</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">EndForeignInsert(EState *estate,</span><br><span class="line">                 ResultRelInfo *rinfo);</span><br></pre></td></tr></table></figure>
<p>结束表插入并释放资源。通常释放palloc的内存并不重要，但是打开的文件和到远程服务器的连接等应当被清除。</p>
<p>如果<code>EndForeignInsert</code>指针被设置为NULL，在执行器关闭期间不会采取任何动作。</p>
<p><br></p>
<ul>
<li>IsForeignRelUpdatable</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">IsForeignRelUpdatable(Relation rel);</span><br></pre></td></tr></table></figure>
<p>报告指定的外部表支持哪些更新操作。返回值应该是一个规则事件编号的位掩码，它指示了哪些操作被外部表支持，它使用CmdType枚举，即：(1 &lt;&lt; CMD_UPDATE) = 4表示UPDATE、 (1 &lt;&lt; CMD_INSERT) = 8表示INSERT以及 (1 &lt;&lt; CMD_DELETE) = 16表示DELETE。</p>
<p>如果<code>IsForeignRelUpdatable</code>指针被设置为NULL，而FDW提供了<code>ExecForeignInsert</code>、<code>ExecForeignUpdate</code>或<code>ExecForeignDelete</code>，则外部表分别被假定为可插入、可更新或可删除。</p>
<p><br><br>一些对于外部表的插入、更新和删除可以通过实现另一组接口来优化。普通的插入、更新和删除接口会从远程服务器取得行，然后一次修改其中一行。在某些情况下，这种逐行的方式是必要的，但是可能效率不高。如果有可能让外部服务器判断哪些行可以直接修改而无需先检索它们并且没有本地触发器会影响该操作，那么可以让整个操作在远程服务器上执行。下面介绍的接口能让这种做法变成可能。</p>
<ul>
<li>PlanDirectModify</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span></span><br><span class="line">PlanDirectModify(PlannerInfo *root,</span><br><span class="line">                 ModifyTable *plan,</span><br><span class="line">                 Index resultRelation,</span><br><span class="line">                 <span class="keyword">int</span> subplan_index);</span><br></pre></td></tr></table></figure>
<p>决定在远程服务器上执行直接修改是否安全。如果安全，执行所需的规划动作然后返回true,否则返回false。这个可选的函数在查询规划期间被调用。如果这个函数成功，在执行阶段将会调用<code>BeginDirectModify</code>、<code>IterateDirectModify</code>和<code>EndDirectModify</code>。否则，对表的修改将采用上文描述的表更新函数来执行。参数和<code>PlanForeignModify</code>的相同。</p>
<p>要在远程服务器上执行直接修改，这个函数必须用一个ForeignScan计划节点（它在远程服务器上执行直接修改）重写目标子计划。ForeignScan的operation域必须被合适地设置为CmdType枚举值，即CMD_UPDATE表示UPDATE、CMD_INSERT表示INSERT而CMD_DELETE表示DELETE。</p>
<p>如果<code>PlanDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p>
<ul>
<li>BeginDirectModify </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">BeginDirectModify(ForeignScanState *node,</span><br><span class="line">                  <span class="keyword">int</span> eflags);</span><br></pre></td></tr></table></figure>
<p>准备在远程服务器上执行一次直接修改。这个函数会在执行器启动时被调用。它应该执行直接修改所需的任何初始化工作（应该在第一次<code>IterateDirectModify</code>调用之前完成）。ForeignScanState节点已经被创建，但是它的fdw_state属性仍然为 NULL。有关要被修改的表的信息可以访问ForeignScanState节点（具体地，从底层的ForeignScan计划节点，它包含了PlanDirectModify提供的 FDW-私有信息）。eflags包含描述执行器对于这个计划节点操作模式的标志位。</p>
<p>注意当(eflags &amp; EXEC_FLAG_EXPLAIN_ONLY)为真时，这个函数不应该执行任何外部可见的动作。它应当只做最少的工作让该节点状态对<code>ExplainDirectModify</code>和<code>EndDirectModify</code>有效。</p>
<p>如果<code>BeginDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p>
<ul>
<li>IterateDirectModify</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line">IterateDirectModify(ForeignScanState *node);</span><br></pre></td></tr></table></figure>
<p>当INSERT、UPDATE或者DELETE查询没有RETURNING子句时，完成远程服务器上的直接修改后返回 NULL。当查询有该子句时，取出一个包含RETURNING计算所需数据的结果，用一个元组表槽返回它（节点的ScanTupleSlot应被用于这一目的）。实际被插入、更新或者删除的数据必须被存储在该节点的EState的es_result_relation_info-&gt;ri_projectReturning-&gt;pi_exprContext-&gt;ecxt_scantuple中。如果没有更多行可用，则返回 NULL。注意这个函数会在一个短期生存的内存上下文中被调用，该上下文会在两次调用之间被重置。如果需要一个长期存在的存储，可以在<code>BeginDirectModify</code>中创建一个内存上下文，或者使用该节点的EState中的es_query_cxt。</p>
<p>如果提供了fdw_scan_tlist目标列表，则被返回的行必须匹配它。否则，被返回的行必须匹配被更新的外部表的行类型。如果选择优化掉RETURNING计算不需要的列，应该在这些列的位置上插入空值，或者生成一个忽略这些列的fdw_scan_tlist列表。</p>
<p>不管该查询是否具有RETURNING子句，查询所报告的行计数必须由 FDW 本身增加。当查询没有该子句时，FDW 还必须为EXPLAIN ANALYZE情况下的ForeignScanState节点增加行计数。</p>
<p>如果<code>IterateDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p>
<ul>
<li>EndDirectModify </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">EndDirectModify(ForeignScanState *node);</span><br></pre></td></tr></table></figure>
<p>在远程服务器上的直接修改后进行清理。通常释放用 palloc 分配的内存并不重要，但是诸如打开的文件和到远程服务器的连接应该被清除。</p>
<p>如果<code>EndDirectModify</code>指针被设置为NULL，不会尝试在远程服务器上执行直接修改。</p>
<p><br><br><br><br>在外部表插入一条数据<code>insert into t_fdw values(11,&#39;1&#39;,&#39;2&#39;);</code><br>执行insert语句的调用顺序<br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180809144759.png" alt=""></p>
<p>使用gdb追踪<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b postgresAddForeignUpdateTargets</span><br><span class="line">Breakpoint 1 at 0x7fee88320260: file postgres_fdw.c, line 1541.</span><br><span class="line">(gdb) b postgresPlanForeignModify</span><br><span class="line">Breakpoint 2 at 0x7fee883203a0: file postgres_fdw.c, line 1579.</span><br><span class="line">(gdb) b postgresBeginForeignModify</span><br><span class="line">Breakpoint 3 at 0x7fee88321e20: file postgres_fdw.c, line 1698.</span><br><span class="line">(gdb) b postgresExecForeignInsert</span><br><span class="line">Breakpoint 4 at 0x7fee88323000: file postgres_fdw.c, line 1750.</span><br><span class="line">(gdb) b postgresExecForeignUpdate</span><br><span class="line">Breakpoint 5 at 0x7fee88322e40: file postgres_fdw.c, line 1814.</span><br><span class="line">(gdb) b postgresExecForeignDelete</span><br><span class="line">Breakpoint 6 at 0x7fee88322c80: file postgres_fdw.c, line 1890.</span><br><span class="line">(gdb) b postgresEndForeignModify</span><br><span class="line">Breakpoint 7 at 0x7fee88321010: file postgres_fdw.c, line 1965.</span><br><span class="line">(gdb) b postgresBeginForeignInsert</span><br><span class="line">Breakpoint 8 at 0x7fee88321c10: file postgres_fdw.c, line 1982.</span><br><span class="line">(gdb) b postgresEndForeignInsert</span><br><span class="line">Breakpoint 9 at 0x7fee88320ff0: file postgres_fdw.c, line 2074.</span><br><span class="line">(gdb) b postgresIsForeignRelUpdatable</span><br><span class="line">Breakpoint 10 at 0x7fee8831e900: file postgres_fdw.c, line 2089.</span><br><span class="line">(gdb) b postgresPlanDirectModify</span><br><span class="line">Breakpoint 11 at 0x7fee883213b0: file postgres_fdw.c, line 2167.</span><br><span class="line">(gdb) b postgresBeginDirectModify</span><br><span class="line">Breakpoint 12 at 0x7fee8831fd80: file postgres_fdw.c, line 2360.</span><br><span class="line">(gdb) b postgresIterateDirectModify</span><br><span class="line">Breakpoint 13 at 0x7fee883227f0: file postgres_fdw.c, line 2479.</span><br><span class="line">(gdb) b postgresEndDirectModify</span><br><span class="line">Breakpoint 14 at 0x7fee8831fb60: file postgres_fdw.c, line 2523.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换至psql，执行插入语句</span></span><br><span class="line">fdw=<span class="comment"># insert into t_fdw values(11,'1','2');</span></span><br><span class="line"><span class="comment"># （挂起）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换回gdb</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 11, postgresPlanDirectModify (root=0x2113f08, plan=0x2115680, resultRelation=1, </span><br><span class="line">    subplan_index=0) at postgres_fdw.c:2167</span><br><span class="line">2167	&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresPlanDirectModify (root=0x2113f08, plan=0x2115680, resultRelation=1, subplan_index=0) at postgres_fdw.c:2167</span></span><br><span class="line"><span class="comment">#1  0x00000000006790a1 in make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;) at createplan.c:6680</span></span><br><span class="line"><span class="comment">#2  create_modifytable_plan (best_path=0x20635e0, root=&lt;optimized out&gt;) at createplan.c:2479</span></span><br><span class="line"><span class="comment">#3  create_plan_recurse (root=root@entry=0x2113f08, best_path=0x20635e0, flags=flags@entry=1) at createplan.c:492</span></span><br><span class="line"><span class="comment">#4  0x0000000000679dc9 in create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;) at createplan.c:327</span></span><br><span class="line"><span class="comment">#5  0x0000000000685264 in standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0) at planner.c:412</span></span><br><span class="line"><span class="comment">#6  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x20636f0, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#7  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#8  0x0000000000721cda in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(11,'1','2');") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0)</span></span><br><span class="line">    at postmaster.c:1379</span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresPlanDirectModify (root=0x2113f08, plan=0x2115680, </span></span><br><span class="line">    resultRelation=1, subplan_index=0) at postgres_fdw.c:2167</span><br><span class="line">make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, </span><br><span class="line">    rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6681</span><br><span class="line">6681			<span class="keyword">if</span> (direct_modify)</span><br><span class="line">Value returned is <span class="variable">$15</span> = <span class="literal">false</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, </span></span><br><span class="line">    rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6681</span><br><span class="line"></span><br><span class="line">Breakpoint 2, postgresPlanForeignModify (root=0x2113f08, plan=plan@entry=0x2115680, </span><br><span class="line">    resultRelation=1, subplan_index=subplan_index@entry=0) at postgres_fdw.c:1579</span><br><span class="line">1579	&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresPlanForeignModify (root=0x2113f08, plan=plan@entry=0x2115680, resultRelation=1, subplan_index=subplan_index@entry=0) at postgres_fdw.c:1579</span></span><br><span class="line"><span class="comment">#1  0x0000000000677001 in make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;) at createplan.c:6687</span></span><br><span class="line"><span class="comment">#2  create_modifytable_plan (best_path=0x20635e0, root=&lt;optimized out&gt;) at createplan.c:2479</span></span><br><span class="line"><span class="comment">#3  create_plan_recurse (root=root@entry=0x2113f08, best_path=0x20635e0, flags=flags@entry=1) at createplan.c:492</span></span><br><span class="line"><span class="comment">#4  0x0000000000679dc9 in create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;) at createplan.c:327</span></span><br><span class="line"><span class="comment">#5  0x0000000000685264 in standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0) at planner.c:412</span></span><br><span class="line"><span class="comment">#6  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x20636f0, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#7  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span></span><br><span class="line"><span class="comment">#8  0x0000000000721cda in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1050</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresPlanForeignModify (root=0x2113f08, plan=plan@entry=0x2115680, </span></span><br><span class="line">    resultRelation=1, subplan_index=subplan_index@entry=0) at postgres_fdw.c:1579</span><br><span class="line">0x0000000000677001 <span class="keyword">in</span> make_modifytable (epqParam=&lt;optimized out&gt;, onconflict=&lt;optimized out&gt;, </span><br><span class="line">    rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6687</span><br><span class="line">6687				fdw_private = fdwroutine-&gt;PlanForeignModify(subroot, node, rti, i);</span><br><span class="line">Value returned is <span class="variable">$16</span> = (List *) 0x218b810</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000677001 in make_modifytable (epqParam=&lt;optimized out&gt;, </span></span><br><span class="line">    onconflict=&lt;optimized out&gt;, rowMarks=&lt;optimized out&gt;, returningLists=&lt;optimized out&gt;, </span><br><span class="line">    withCheckOptionLists=&lt;optimized out&gt;, subroots=&lt;optimized out&gt;, subplans=&lt;optimized out&gt;, </span><br><span class="line">    resultRelations=&lt;optimized out&gt;, partColsUpdated=&lt;optimized out&gt;, </span><br><span class="line">    partitioned_rels=&lt;optimized out&gt;, nominalRelation=&lt;optimized out&gt;, </span><br><span class="line">    canSetTag=&lt;optimized out&gt;, operation=&lt;optimized out&gt;, root=&lt;optimized out&gt;)</span><br><span class="line">    at createplan.c:6687</span><br><span class="line">create_plan_recurse (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;, flags=flags@entry=1)</span><br><span class="line">    at createplan.c:492</span><br><span class="line">492				plan = (Plan *) create_modifytable_plan(root,</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_plan_recurse (root=root@entry=0x2113f08, </span></span><br><span class="line">    best_path=&lt;optimized out&gt;, flags=flags@entry=1) at createplan.c:492</span><br><span class="line">create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;) at createplan.c:336</span><br><span class="line">336		<span class="keyword">if</span> (!IsA(plan, ModifyTable))</span><br><span class="line">Value returned is <span class="variable">$17</span> = (Plan *) 0x2115680</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  create_plan (root=root@entry=0x2113f08, best_path=&lt;optimized out&gt;)</span></span><br><span class="line">    at createplan.c:336</span><br><span class="line">standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0) at planner.c:418</span><br><span class="line">418		<span class="keyword">if</span> (cursorOptions &amp; CURSOR_OPT_SCROLL)</span><br><span class="line">Value returned is <span class="variable">$18</span> = (Plan *) 0x2115680</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_planner (parse=0x20636f0, cursorOptions=256, boundParams=0x0)</span></span><br><span class="line">    at planner.c:418</span><br><span class="line">pg_plan_query (querytree=querytree@entry=0x20636f0, cursorOptions=cursorOptions@entry=256, </span><br><span class="line">    boundParams=boundParams@entry=0x0) at postgres.c:811</span><br><span class="line">811		<span class="keyword">if</span> (log_planner_stats)</span><br><span class="line">Value returned is <span class="variable">$19</span> = (PlannedStmt *) 0x218bb60</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  pg_plan_query (querytree=querytree@entry=0x20636f0, </span></span><br><span class="line">    cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:811</span><br><span class="line">0x000000000072186e <span class="keyword">in</span> pg_plan_queries (querytrees=&lt;optimized out&gt;, </span><br><span class="line">    cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span><br><span class="line">875				stmt = pg_plan_query(query, cursorOptions, boundParams);</span><br><span class="line">Value returned is <span class="variable">$20</span> = (PlannedStmt *) 0x218bb60</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x000000000072186e in pg_plan_queries (querytrees=&lt;optimized out&gt;, </span></span><br><span class="line">    cursorOptions=cursorOptions@entry=256, boundParams=boundParams@entry=0x0) at postgres.c:875</span><br><span class="line">0x0000000000721cda <span class="keyword">in</span> exec_simple_query (</span><br><span class="line">    query_string=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>) at postgres.c:1050</span><br><span class="line">1050			plantree_list = pg_plan_queries(querytree_list,</span><br><span class="line">Value returned is <span class="variable">$21</span> = (List *) 0x218bc90</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000721cda in exec_simple_query (</span></span><br><span class="line">    query_string=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>) at postgres.c:1050</span><br><span class="line"></span><br><span class="line">Breakpoint 10, postgresIsForeignRelUpdatable (rel=0x7feed1ad1358) at postgres_fdw.c:2089</span><br><span class="line">2089	&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresIsForeignRelUpdatable (rel=0x7feed1ad1358) at postgres_fdw.c:2089</span></span><br><span class="line"><span class="comment">#1  0x00000000005f0820 in CheckValidResultRel (resultRelInfo=resultRelInfo@entry=0x20885c0, operation=operation@entry=CMD_INSERT) at execMain.c:1187</span></span><br><span class="line"><span class="comment">#2  0x00000000006123a8 in ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2242</span></span><br><span class="line"><span class="comment">#3  0x00000000005f6838 in ExecInitNode (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at execProcnode.c:174</span></span><br><span class="line"><span class="comment">#4  0x00000000005f11c5 in InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1049</span></span><br><span class="line"><span class="comment">#5  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=0) at execMain.c:264</span></span><br><span class="line"><span class="comment">#6  0x0000000000724d26 in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(12,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "") at pquery.c:156</span></span><br><span class="line"><span class="comment">#7  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#8  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:799</span></span><br><span class="line"><span class="comment">#9  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#10 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#11 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#12 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#13 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#14 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#15 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresIsForeignRelUpdatable (rel=0x7feed1ad1358) at postgres_fdw.c:2089</span></span><br><span class="line">CheckValidResultRel (resultRelInfo=resultRelInfo@entry=0x20885c0, </span><br><span class="line">    operation=operation@entry=CMD_INSERT) at execMain.c:1186</span><br><span class="line">1186						<span class="keyword">if</span> (fdwroutine-&gt;IsForeignRelUpdatable != NULL &amp;&amp;</span><br><span class="line">Value returned is <span class="variable">$22</span> = 28</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  CheckValidResultRel (resultRelInfo=resultRelInfo@entry=0x20885c0, </span></span><br><span class="line">    operation=operation@entry=CMD_INSERT) at execMain.c:1186</span><br><span class="line">ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, </span><br><span class="line">    eflags=eflags@entry=0) at nodeModifyTable.c:2253</span><br><span class="line">2253			<span class="keyword">if</span> (resultRelInfo-&gt;ri_RelationDesc-&gt;rd_rel-&gt;relhasindex &amp;&amp;</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecInitModifyTable (node=node@entry=0x2115680, </span></span><br><span class="line">    estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2253</span><br><span class="line"></span><br><span class="line">Breakpoint 3, postgresBeginForeignModify (mtstate=0x20888e0, resultRelInfo=0x20885c0, </span><br><span class="line">    fdw_private=0x218b810, subplan_index=0, eflags=0) at postgres_fdw.c:1698</span><br><span class="line">1698	&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresBeginForeignModify (mtstate=0x20888e0, resultRelInfo=0x20885c0, fdw_private=0x218b810, subplan_index=0, eflags=0) at postgres_fdw.c:1698</span></span><br><span class="line"><span class="comment">#1  0x0000000000612458 in ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2280</span></span><br><span class="line"><span class="comment">#2  0x00000000005f6838 in ExecInitNode (node=node@entry=0x2115680, estate=estate@entry=0x2088380, eflags=eflags@entry=0) at execProcnode.c:174</span></span><br><span class="line"><span class="comment">#3  0x00000000005f11c5 in InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1049</span></span><br><span class="line"><span class="comment">#4  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=0) at execMain.c:264</span></span><br><span class="line"><span class="comment">#5  0x0000000000724d26 in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(13,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "") at pquery.c:156</span></span><br><span class="line"><span class="comment">#6  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#7  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:799</span></span><br><span class="line"><span class="comment">#8  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(13,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#9  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#10 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#11 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#12 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#13 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#14 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresBeginForeignModify (mtstate=0x20888e0, resultRelInfo=0x20885c0, </span></span><br><span class="line">    fdw_private=0x218b810, subplan_index=0, eflags=0) at postgres_fdw.c:1698</span><br><span class="line">ExecInitModifyTable (node=node@entry=0x2115680, estate=estate@entry=0x2088380, </span><br><span class="line">    eflags=eflags@entry=0) at nodeModifyTable.c:2231</span><br><span class="line">2231		foreach(l, node-&gt;plans)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecInitModifyTable (node=node@entry=0x2115680, </span></span><br><span class="line">    estate=estate@entry=0x2088380, eflags=eflags@entry=0) at nodeModifyTable.c:2231</span><br><span class="line">0x00000000005f6838 <span class="keyword">in</span> ExecInitNode (node=node@entry=0x2115680, estate=estate@entry=0x2088380, </span><br><span class="line">    eflags=eflags@entry=0) at execProcnode.c:174</span><br><span class="line">174				result = (PlanState *) ExecInitModifyTable((ModifyTable *) node,</span><br><span class="line">Value returned is <span class="variable">$23</span> = (ModifyTableState *) 0x20888e0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x00000000005f6838 in ExecInitNode (node=node@entry=0x2115680, </span></span><br><span class="line">    estate=estate@entry=0x2088380, eflags=eflags@entry=0) at execProcnode.c:174</span><br><span class="line">InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1054</span><br><span class="line">1054		tupType = ExecGetResultType(planstate);</span><br><span class="line">Value returned is <span class="variable">$24</span> = (PlanState *) 0x20888e0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  InitPlan (eflags=0, queryDesc=&lt;optimized out&gt;) at execMain.c:1054</span></span><br><span class="line">266		MemoryContextSwitchTo(oldcontext);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorStart (queryDesc=&lt;optimized out&gt;, eflags=0)</span></span><br><span class="line">    at execMain.c:266</span><br><span class="line">ProcessQuery (plan=&lt;optimized out&gt;, </span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:161</span><br><span class="line">161		ExecutorRun(queryDesc, ForwardScanDirection, 0L, <span class="literal">true</span>);</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ProcessQuery (plan=&lt;optimized out&gt;, </span></span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:161</span><br><span class="line"></span><br><span class="line">Breakpoint 4, postgresExecForeignInsert (estate=0x2088380, resultRelInfo=0x20885c0, </span><br><span class="line">    slot=0x2089628, planSlot=0x2089628) at postgres_fdw.c:1750</span><br><span class="line">1750	&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresExecForeignInsert (estate=0x2088380, resultRelInfo=0x20885c0, slot=0x2089628, planSlot=0x2089628) at postgres_fdw.c:1750</span></span><br><span class="line"><span class="comment">#1  0x0000000000610d8b in ExecInsert (mtstate=mtstate@entry=0x20888e0, slot=0x2089628, planSlot=planSlot@entry=0x2089628, estate=estate@entry=0x2088380, canSetTag=&lt;optimized out&gt;) at nodeModifyTable.c:346</span></span><br><span class="line"><span class="comment">#2  0x0000000000612119 in ExecModifyTable (pstate=0x20888e0) at nodeModifyTable.c:2126</span></span><br><span class="line"><span class="comment">#3  0x00000000005f000a in ExecProcNode (node=0x20888e0) at ../../../src/include/executor/executor.h:237</span></span><br><span class="line"><span class="comment">#4  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x218bcc0, direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=false, operation=CMD_INSERT, use_parallel_mode=&lt;optimized out&gt;, planstate=0x20888e0, estate=0x2088380) at execMain.c:1726</span></span><br><span class="line"><span class="comment">#5  standard_ExecutorRun (queryDesc=0x21413a0, direction=&lt;optimized out&gt;, count=0, execute_once=&lt;optimized out&gt;) at execMain.c:363</span></span><br><span class="line"><span class="comment">#6  0x0000000000724d3a in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(12,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "") at pquery.c:161</span></span><br><span class="line"><span class="comment">#7  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#8  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "") at pquery.c:799</span></span><br><span class="line"><span class="comment">#9  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#10 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#11 0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#12 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#13 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#14 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#15 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  postgresExecForeignInsert (estate=0x2088380, resultRelInfo=0x20885c0, </span></span><br><span class="line">    slot=0x2089628, planSlot=0x2089628) at postgres_fdw.c:1750</span><br><span class="line">ExecInsert (mtstate=mtstate@entry=0x20888e0, slot=0x2089628, planSlot=planSlot@entry=0x2089628, </span><br><span class="line">    estate=estate@entry=0x2088380, canSetTag=&lt;optimized out&gt;) at nodeModifyTable.c:351</span><br><span class="line">351			<span class="keyword">if</span> (slot == NULL)		/* <span class="string">"do nothing"</span> */</span><br><span class="line">Value returned is <span class="variable">$25</span> = (TupleTableSlot *) 0x2089628</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecInsert (mtstate=mtstate@entry=0x20888e0, slot=0x2089628, </span></span><br><span class="line">    planSlot=planSlot@entry=0x2089628, estate=estate@entry=0x2088380, canSetTag=&lt;optimized out&gt;)</span><br><span class="line">    at nodeModifyTable.c:351</span><br><span class="line">0x0000000000612119 <span class="keyword">in</span> ExecModifyTable (pstate=0x20888e0) at nodeModifyTable.c:2126</span><br><span class="line">2126					slot = ExecInsert(node, slot, planSlot,</span><br><span class="line">Value returned is <span class="variable">$26</span> = (TupleTableSlot *) 0x0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  0x0000000000612119 in ExecModifyTable (pstate=0x20888e0)</span></span><br><span class="line">    at nodeModifyTable.c:2126</span><br><span class="line">ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x218bcc0, direction=&lt;optimized out&gt;, </span><br><span class="line">    numberTuples=0, sendTuples=<span class="literal">false</span>, operation=CMD_INSERT, use_parallel_mode=&lt;optimized out&gt;, </span><br><span class="line">    planstate=0x20888e0, estate=0x2088380) at execMain.c:1732</span><br><span class="line">1732			<span class="keyword">if</span> (TupIsNull(slot))</span><br><span class="line">Value returned is <span class="variable">$27</span> = (TupleTableSlot *) 0x0</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ExecutePlan (execute_once=&lt;optimized out&gt;, dest=0x218bcc0, </span></span><br><span class="line">    direction=&lt;optimized out&gt;, numberTuples=0, sendTuples=<span class="literal">false</span>, operation=CMD_INSERT, </span><br><span class="line">    use_parallel_mode=&lt;optimized out&gt;, planstate=0x20888e0, estate=0x2088380) at execMain.c:1732</span><br><span class="line">377		<span class="keyword">if</span> (sendTuples)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  standard_ExecutorRun (queryDesc=0x21413a0, direction=&lt;optimized out&gt;, </span></span><br><span class="line">    count=0, execute_once=&lt;optimized out&gt;) at execMain.c:377</span><br><span class="line">ProcessQuery (plan=&lt;optimized out&gt;, </span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:166</span><br><span class="line">166		<span class="keyword">if</span> (completionTag)</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till <span class="built_in">exit</span> from <span class="comment">#0  ProcessQuery (plan=&lt;optimized out&gt;, </span></span><br><span class="line">    sourceText=0x2062810 <span class="string">"insert into t_fdw values(12,'1','2');"</span>, params=0x0, queryEnv=0x0, </span><br><span class="line">    dest=0x218bcc0, completionTag=0x7ffd2229fcd0 <span class="string">""</span>) at pquery.c:166</span><br><span class="line"></span><br><span class="line">Breakpoint 7, postgresEndForeignModify (estate=0x2088380, resultRelInfo=0x20885c0)</span><br><span class="line">    at postgres_fdw.c:1965</span><br><span class="line">1965		PgFdwModifyState *fmstate = (PgFdwModifyState *) resultRelInfo-&gt;ri_FdwState;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  postgresEndForeignModify (estate=0x2088380, resultRelInfo=0x20885c0) at postgres_fdw.c:1965</span></span><br><span class="line"><span class="comment">#1  0x0000000000612c7b in ExecEndModifyTable (node=0x20888e0) at nodeModifyTable.c:2664</span></span><br><span class="line"><span class="comment">#2  0x00000000005f16ad in ExecEndPlan (estate=0x2088380, planstate=&lt;optimized out&gt;) at execMain.c:1612</span></span><br><span class="line"><span class="comment">#3  standard_ExecutorEnd (queryDesc=0x21413a0) at execMain.c:495</span></span><br><span class="line"><span class="comment">#4  0x0000000000724d90 in ProcessQuery (plan=&lt;optimized out&gt;, sourceText=0x2062810 "insert into t_fdw values(12,'1','2');", params=0x0, queryEnv=0x0, dest=0x218bcc0, completionTag=0x7ffd2229fcd0 "INSERT 0 1") at pquery.c:206</span></span><br><span class="line"><span class="comment">#5  0x0000000000724f61 in PortalRunMulti (portal=portal@entry=0x20c7f10, isTopLevel=isTopLevel@entry=true, setHoldSnapshot=setHoldSnapshot@entry=false, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "INSERT 0 1") at pquery.c:1286</span></span><br><span class="line"><span class="comment">#6  0x0000000000725a1c in PortalRun (portal=portal@entry=0x20c7f10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x218bcc0, altdest=altdest@entry=0x218bcc0, completionTag=completionTag@entry=0x7ffd2229fcd0 "INSERT 0 1") at pquery.c:799</span></span><br><span class="line"><span class="comment">#7  0x0000000000721bb7 in exec_simple_query (query_string=0x2062810 "insert into t_fdw values(12,'1','2');") at postgres.c:1122</span></span><br><span class="line"><span class="comment">#8  0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x208c528, dbname=0x208c410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#9  0x000000000047a861 in BackendRun (port=0x20843f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#10 BackendStartup (port=0x20843f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#11 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#12 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x205d3c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#13 0x000000000047b2a1 in main (argc=3, argv=0x205d3c0) at main.c:228</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 后续执行结束</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>在外部表更新数据 <code>update t_fdw set c1=&#39;11&#39; where id=11;</code><br><img src="https://raw.githubusercontent.com/oYo-Byte/img_libs/master/blog/20180809152932.png" alt=""></p>
<p>在外部表删除数据，使用gdb跟踪调用流程，发现和update语句的流程是一样的，查看相关代码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * postgresIterateDirectModify</span></span><br><span class="line"><span class="comment"> *		Execute a direct foreign table modification</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> TupleTableSlot *</span><br><span class="line">postgresIterateDirectModify(ForeignScanState *node)</span><br><span class="line">&#123;</span><br><span class="line">	PgFdwDirectModifyState *dmstate = (PgFdwDirectModifyState *) node-&gt;fdw_state;</span><br><span class="line">	EState	   *estate = node-&gt;ss.ps.state;</span><br><span class="line">	ResultRelInfo *resultRelInfo = estate-&gt;es_result_relation_info;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If this is the first call after Begin, execute the statement.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (dmstate-&gt;num_tuples == <span class="number">-1</span>)</span><br><span class="line">		execute_dml_stmt(node);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If the local query doesn't specify RETURNING, just clear tuple slot.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!resultRelInfo-&gt;ri_projectReturning)</span><br><span class="line">	&#123;</span><br><span class="line">		TupleTableSlot *slot = node-&gt;ss.ss_ScanTupleSlot;</span><br><span class="line">		Instrumentation *instr = node-&gt;ss.ps.instrument;</span><br><span class="line"></span><br><span class="line">		Assert(!dmstate-&gt;has_returning);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Increment the command es_processed count if necessary. */</span></span><br><span class="line">		<span class="keyword">if</span> (dmstate-&gt;set_processed)</span><br><span class="line">			estate-&gt;es_processed += dmstate-&gt;num_tuples;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Increment the tuple count for EXPLAIN ANALYZE if necessary. */</span></span><br><span class="line">		<span class="keyword">if</span> (instr)</span><br><span class="line">			instr-&gt;tuplecount += dmstate-&gt;num_tuples;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> ExecClearTuple(slot);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Get the next RETURNING tuple.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> get_returning_data(node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Execute a direct UPDATE/DELETE statement.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">execute_dml_stmt(ForeignScanState *node)</span><br><span class="line">&#123;</span><br><span class="line">	PgFdwDirectModifyState *dmstate = (PgFdwDirectModifyState *) node-&gt;fdw_state;</span><br><span class="line">	ExprContext *econtext = node-&gt;ss.ps.ps_ExprContext;</span><br><span class="line">	<span class="keyword">int</span>			numParams = dmstate-&gt;numParams;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> **values = dmstate-&gt;param_values;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Construct array of query parameter values in text format.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (numParams &gt; <span class="number">0</span>)</span><br><span class="line">		process_query_params(econtext,</span><br><span class="line">							 dmstate-&gt;param_flinfo,</span><br><span class="line">							 dmstate-&gt;param_exprs,</span><br><span class="line">							 values);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Notice that we pass NULL for paramTypes, thus forcing the remote server</span></span><br><span class="line"><span class="comment">	 * to infer types for all parameters.  Since we explicitly cast every</span></span><br><span class="line"><span class="comment">	 * parameter (see deparse.c), the "inference" is trivial and will produce</span></span><br><span class="line"><span class="comment">	 * the desired result.  This allows us to avoid assuming that the remote</span></span><br><span class="line"><span class="comment">	 * server has the same OIDs we do for the parameters' types.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!PQsendQueryParams(dmstate-&gt;conn, dmstate-&gt;query, numParams,</span><br><span class="line">						   <span class="literal">NULL</span>, values, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">		pgfdw_report_error(ERROR, <span class="literal">NULL</span>, dmstate-&gt;conn, <span class="literal">false</span>, dmstate-&gt;query);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Get the result, and check for success.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * We don't use a PG_TRY block here, so be careful not to throw error</span></span><br><span class="line"><span class="comment">	 * without releasing the PGresult.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	dmstate-&gt;result = pgfdw_get_result(dmstate-&gt;conn, dmstate-&gt;query);</span><br><span class="line">	<span class="keyword">if</span> (PQresultStatus(dmstate-&gt;result) !=</span><br><span class="line">		(dmstate-&gt;has_returning ? PGRES_TUPLES_OK : PGRES_COMMAND_OK))</span><br><span class="line">		pgfdw_report_error(ERROR, dmstate-&gt;result, dmstate-&gt;conn, <span class="literal">true</span>,</span><br><span class="line">						   dmstate-&gt;query);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get the number of rows affected. */</span></span><br><span class="line">	<span class="keyword">if</span> (dmstate-&gt;has_returning)</span><br><span class="line">		dmstate-&gt;num_tuples = PQntuples(dmstate-&gt;result);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		dmstate-&gt;num_tuples = atoi(PQcmdTuples(dmstate-&gt;result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，<code>postgresIterateDirectModify</code> 调用了<code>execute_dml_stmt</code>执行直接UPDATE/DELETE语句的。</p>

  </article>
</div>


    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="/js/md5.min.js"></script>
<div class='container' id="gitalk-container"></div>
<script>
    var gitalk = new Gitalk({
        clientID: '0f95488e2c5e12bc2a2a',
        clientSecret: 'b01836c08c02e727359d1c8df682e8b65fe41de1',
        repo: 'blog_gitalk',
        owner: 'oYo-Byte',
        admin: ['oYo-Byte'],
		id: md5(location.pathname),
        distractionFreeMode: true,
    })
    gitalk.render('gitalk-container')
</script>




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <a href="https://oyo-byte.github.io" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2018 oYo-Byte</li>
      <li><a href="https://oyo-byte.github.io">Home</a></li>
      
      <li><a href="https://github.com/oYo-Byte">Github</a></li>
      
    </ul>
    <div class="footer-theme-info">
      Theme <a href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
    </div>
  </footer>
</div>




<script src="/js/main.js"></script>

</body>
</html>
