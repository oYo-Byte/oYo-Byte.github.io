<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    学习PostgreSQL的FDW(#6)-file_fdw源码分析 | oYo-Byte
  </title>
  <meta name="description" content="oYo-Byte&#39;s blog">
  
  <meta name="keywords" content="
  PostgreSQL,FDW,file_fdw
  ">
  
  <meta name="author" content="oYo-Byte">

  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp">

  <link rel="icon" type="image/x-icon" href="https://assets-cdn.github.com/favicon.ico">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  

  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
</head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">This website</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/archives">Archives</a></li>
        
        
        <li><a href="/categories">Categories</a></li>
        
        
        <li><a href="/tags">Tags</a></li>
        
        
        <li class="desktop-only"><a href="/atom.xml" target="_blank">RSS</a></li>
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="https://avatars2.githubusercontent.com/u/8343269?s=460&amp;v=4"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/archives"
           class="header-toolbar-right"> 11 </a>
      </li>
      <li>
        <a href="/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/tags"
           class="header-toolbar-right"> 7 </a>
      </li>
      <li>
        <a href="/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/categories"
           class="header-toolbar-right"> 2 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/">oYo-Byte</a>
      
      
    </h2>
  </div>

  <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div>
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    oYo-Byte

    <span class="post-date float-right" title="{{moment(1533882703897).format('MMM DD, YYYY, h:mm:ss A')}}">
      <i class="fa fa-pencil-square-o"></i>
      {{moment(1533882703897).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>学习PostgreSQL的FDW(#6)-file_fdw源码分析</h1>
    <p>之前文章介绍了实现FDW的函数，现在来看看PostgreSQL实现的文件的FDW是怎么的吧。<br>PostgreSQL实现的file_fdw的源码可以在PostgreSQL的源码目录下contrib目录下找到。</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>file_fdw支持的数据文件必须是<code>COPY FROM</code>可读格式（text,csv[逗号分隔值],binary）.<br>用这个包装器创建的一个外部表可以有下列选项：</p>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">filename</td>
<td style="text-align:left">指定要被读取的文件。必须是一个绝对路径名。 必须指定filename或program， 但不能同时指定两个。</td>
</tr>
<tr>
<td style="text-align:left">program</td>
<td style="text-align:left">指定要执行的命令。该命令的标准输出将被读取， 就像使用COPY FROM PROGRAM一样。必须指定program 或filename，但不能同时指定两个。</td>
</tr>
<tr>
<td style="text-align:left">format</td>
<td style="text-align:left">指定数据的格式，和COPY的FORMAT选项相同。即text,csv（逗号分隔值）,binary</td>
</tr>
<tr>
<td style="text-align:left">header</td>
<td style="text-align:left">指定文件包含标题行，其中有每一列的名称。在输出时，第一行包含 来自表的列名。在输入时，第一行会被忽略。只有使用 CSV格式时才允许这个选项。</td>
</tr>
<tr>
<td style="text-align:left">delimiter</td>
<td style="text-align:left">指定分隔文件每行中各列的字符。文本格式中默认是一个制表符， 而CSV格式中默认是一个逗号。这必须是一个单一 的单字节字符。使用binary格式时不允许这个选项。</td>
</tr>
<tr>
<td style="text-align:left">quote</td>
<td style="text-align:left">指定一个数据值被引用时使用的引用字符。默认是双引号。 这必须是一个单一的单字节字符。只有使用 CSV格式时才允许这个选项。</td>
</tr>
<tr>
<td style="text-align:left">escape</td>
<td style="text-align:left">指定应该出现在一个匹配quote值的数据字符之前 的字符。默认和quote值一样（这样如果引用字符 出现在数据中，它会被双写）。这必须是一个单一的单字节字符。 只有使用CSV格式时才允许这个选项。</td>
</tr>
<tr>
<td style="text-align:left">null</td>
<td style="text-align:left">指定表示一个空值的字符串。文本格式中默认是 \N（反斜线-N），CSV格式中默认 是一个未加引用的空串。在你不想区分空值和空串的情况下，即使在文本 格式中你也可能更喜欢空串。使用binary格式时不允许这 个选项。</td>
</tr>
<tr>
<td style="text-align:left">encoding</td>
<td style="text-align:left">指定文件被以encoding_name编码。如果省略这个选项，将使用当前的客户端编码。</td>
</tr>
</tbody>
</table>
<h3 id="添加file-fdw扩展"><a href="#添加file-fdw扩展" class="headerlink" title="添加file_fdw扩展"></a>添加file_fdw扩展</h3><p>检查PG安装目录的lib/postgresql目录下是否存在file_fdw.so文件，确保安装时已经编译安装了file_fdw扩展。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fdw=# create extension file_fdw ;</span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION</span><br><span class="line">fdw=# \dx</span><br><span class="line">                               <span class="keyword">List</span> <span class="keyword">of</span> installed extensions</span><br><span class="line">     <span class="keyword">Name</span>     | <span class="keyword">Version</span> |   <span class="keyword">Schema</span>   |                    Description                     </span><br><span class="line"><span class="comment">--------------+---------+------------+----------------------------------------------------</span></span><br><span class="line"> file_fdw     | <span class="number">1.0</span>     | <span class="keyword">public</span>     | foreign-<span class="keyword">data</span> wrapper <span class="keyword">for</span> flat <span class="keyword">file</span> <span class="keyword">access</span></span><br><span class="line"> plpgsql      | <span class="number">1.0</span>     | pg_catalog | PL/pgSQL <span class="keyword">procedural</span> <span class="keyword">language</span></span><br><span class="line"> postgres_fdw | <span class="number">1.0</span>     | <span class="keyword">public</span>     | foreign-<span class="keyword">data</span> wrapper <span class="keyword">for</span> remote PostgreSQL servers</span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>
<h3 id="测试file-fdw"><a href="#测试file-fdw" class="headerlink" title="测试file_fdw"></a>测试file_fdw</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">fdw=# --创建测试表，并添加数据</span><br><span class="line">fdw=# create table tb1(id int,name varchar,password varchar);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">fdw=# <span class="keyword">insert</span> <span class="keyword">into</span> tb1 <span class="keyword">select</span> generate_series(<span class="number">1</span>,<span class="number">50</span>),<span class="string">'oYo'</span>,<span class="keyword">md5</span>(random()::<span class="built_in">text</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">50</span></span><br><span class="line">fdw=# <span class="comment">--通过copy拷贝数据到文件</span></span><br><span class="line">fdw=# copy tb1 <span class="keyword">to</span> <span class="string">'/data/file_fdw/tb1.csv'</span>;</span><br><span class="line">COPY 50</span><br><span class="line">fdw=# --创建外部服务器</span><br><span class="line">fdw=# create server file_fdw_server foreign data wrapper file_fdw ;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">SERVER</span></span><br><span class="line">fdw=# \des</span><br><span class="line">            <span class="keyword">List</span> <span class="keyword">of</span> foreign servers</span><br><span class="line">      <span class="keyword">Name</span>       | Owner | Foreign-<span class="keyword">data</span> wrapper </span><br><span class="line"><span class="comment">-----------------+-------+----------------------</span></span><br><span class="line"> file_fdw_server | <span class="keyword">xdb</span>   | file_fdw</span><br><span class="line"> pg_117_56       | <span class="keyword">xdb</span>   | postgres_fdw</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br><span class="line">fdw=# <span class="comment">--创建外部表</span></span><br><span class="line">fdw=# <span class="keyword">create</span> foreign <span class="keyword">table</span> tb1_fdw(<span class="keyword">id</span> <span class="built_in">int</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>,<span class="keyword">password</span> <span class="built_in">varchar</span>) <span class="keyword">server</span> file_fdw_server options(filename <span class="string">'/data/file_fdw/tb1.csv'</span>);</span><br><span class="line"><span class="keyword">CREATE</span> FOREIGN <span class="keyword">TABLE</span></span><br><span class="line">fdw=# \d tb1_fdw </span><br><span class="line">                       Foreign <span class="keyword">table</span> <span class="string">"public.tb1_fdw"</span></span><br><span class="line">  <span class="keyword">Column</span>  |       <span class="keyword">Type</span>        | <span class="keyword">Collation</span> | Nullable | <span class="keyword">Default</span> | FDW options </span><br><span class="line"><span class="comment">----------+-------------------+-----------+----------+---------+-------------</span></span><br><span class="line"> <span class="keyword">id</span>       | <span class="built_in">integer</span>           |           |          |         | </span><br><span class="line"> <span class="keyword">name</span>     | <span class="built_in">character</span> <span class="built_in">varying</span> |           |          |         | </span><br><span class="line"> <span class="keyword">password</span> | <span class="built_in">character</span> <span class="built_in">varying</span> |           |          |         | </span><br><span class="line"><span class="keyword">Server</span>: file_fdw_server</span><br><span class="line">FDW options: (filename <span class="string">'/data/file_fdw/tb1.csv'</span>)</span><br><span class="line"></span><br><span class="line">fdw=# <span class="keyword">select</span> * <span class="keyword">from</span> tb1_fdw <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">limit</span> <span class="number">10</span>;</span><br><span class="line"> id | name |             password             </span><br><span class="line"><span class="comment">----+------+----------------------------------</span></span><br><span class="line">  1 | oYo  | 99c0aa4a3ad2128e6ea55522012d8806</span><br><span class="line">  2 | oYo  | a126e01cfdfd4717a1d79b45a42a3bb6</span><br><span class="line">  3 | oYo  | f031835b6c57d4a8781309e05542eb18</span><br><span class="line">  4 | oYo  | 7bea90889b4aa3d0fe67ddbdba68be8e</span><br><span class="line">  5 | oYo  | 01e38c84d7ca2e140f00efc9a9d7a767</span><br><span class="line">  6 | oYo  | 28269e1942431e7970c638023953f43b</span><br><span class="line">  7 | oYo  | fcf45570efa8616e4081b81e6d514433</span><br><span class="line">  8 | oYo  | 5c90103b272cc172d052d7fabb748188</span><br><span class="line">  9 | oYo  | cb8b46761425c64390f77cf1557bb1ae</span><br><span class="line"> 10 | oYo  | 634404bf272dd5610e1b7caf7e1a1542</span><br><span class="line">(10 rows)</span><br><span class="line"></span><br><span class="line">fdw=# --执行计划</span><br><span class="line">fdw=# explain select * from tb1_fdw order by id limit 10;</span><br><span class="line">                               QUERY PLAN                                </span><br><span class="line"><span class="comment">-------------------------------------------------------------------------</span></span><br><span class="line"> Limit  (cost=3.55..3.58 rows=10 width=68)</span><br><span class="line">   -&gt;  Sort  (cost=3.55..3.61 rows=21 width=68)</span><br><span class="line">         Sort Key: id</span><br><span class="line">         -&gt;  Foreign Scan on tb1_fdw  (cost=0.00..3.10 rows=21 width=68)</span><br><span class="line">               Foreign File: /data/file_fdw/tb1.csv</span><br><span class="line">               Foreign File Size: 1991 b</span><br><span class="line">(6 rows)</span><br></pre></td></tr></table></figure>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><ul>
<li>FileFdwOption</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Describes the valid options for objects that use this wrapper.</span></span><br><span class="line"><span class="comment"> *  此外部器可用的选项对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FileFdwOption</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *optname;</span><br><span class="line">	Oid			optcontext;		<span class="comment">/* Oid of catalog in which option may appear */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Valid options for file_fdw.</span></span><br><span class="line"><span class="comment"> * 可以的选项</span></span><br><span class="line"><span class="comment"> * These options are based on the options for the COPY FROM command.</span></span><br><span class="line"><span class="comment"> * But note that force_not_null and force_null are handled as boolean options</span></span><br><span class="line"><span class="comment"> * attached to a column, not as table options.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">Note:</span> If you are adding new option for user mapping, you need to modify</span></span><br><span class="line"><span class="comment">        * fileGetOptions(), which currently doesn't bother to look at user mappings.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">FileFdwOption</span> <span class="title">valid_options</span>[] = &#123;</span></span><br><span class="line">        <span class="comment">/* Data source options */</span></span><br><span class="line">        &#123;<span class="string">"filename"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"program"</span>, ForeignTableRelationId&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Format options */</span></span><br><span class="line">        <span class="comment">/* oids option is not supported */</span></span><br><span class="line">        &#123;<span class="string">"format"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"header"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"delimiter"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"quote"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"escape"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"null"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"encoding"</span>, ForeignTableRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"force_not_null"</span>, AttributeRelationId&#125;,</span><br><span class="line">        &#123;<span class="string">"force_null"</span>, AttributeRelationId&#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * force_quote is not supported by file_fdw because it's for COPY TO.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Sentinel */</span></span><br><span class="line">        &#123;<span class="literal">NULL</span>, InvalidOid&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>FileFdwPlanState</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * FDW-specific information for RelOptInfo.fdw_private.</span></span><br><span class="line"><span class="comment"> * 此FDW优化阶段的fdw_private的数据结构体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FileFdwPlanState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">char</span>	   *filename;		<span class="comment">/*需要读取的文件或程序 file or program to read from */</span></span><br><span class="line">	<span class="keyword">bool</span>		is_program;		<span class="comment">/*是否是程序 true if filename represents an OS command */</span></span><br><span class="line">	List	   *options;		<span class="comment">/*其他选项 merged COPY options, excluding filename and</span></span><br><span class="line"><span class="comment">								 * is_program */</span></span><br><span class="line">	BlockNumber pages;			<span class="comment">/*物理文件的估算大小 estimate of file's physical size */</span></span><br><span class="line">	<span class="keyword">double</span>		ntuples;		<span class="comment">/*数据行的估算数量 estimate of number of data rows */</span></span><br><span class="line">&#125; FileFdwPlanState;</span><br></pre></td></tr></table></figure>
<ul>
<li>FileFdwExecutionState</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * FDW-specific information for ForeignScanState.fdw_state.</span></span><br><span class="line"><span class="comment"> * 执行时的fdw_state的结构体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FileFdwExecutionState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">char</span>	   *filename;		<span class="comment">/* file or program to read from */</span></span><br><span class="line">	<span class="keyword">bool</span>		is_program;		<span class="comment">/* true if filename represents an OS command */</span></span><br><span class="line">	List	   *options;		<span class="comment">/* merged COPY options, excluding filename and</span></span><br><span class="line"><span class="comment">								 * is_program */</span></span><br><span class="line">	CopyState	cstate;			<span class="comment">/*COPY命令执行时的状态 COPY execution state */</span></span><br><span class="line">&#125; FileFdwExecutionState;</span><br></pre></td></tr></table></figure>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><ul>
<li>fileIsForeignScanParallelSafe</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * fileIsForeignScanParallelSafe</span></span><br><span class="line"><span class="comment"> *		Reading a file, or external program, in a parallel worker should work</span></span><br><span class="line"><span class="comment"> *		just the same as reading it in the leader, so mark scans safe.</span></span><br><span class="line"><span class="comment"> *    是否能多并发读取文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">fileIsForeignScanParallelSafe(PlannerInfo *root, RelOptInfo *rel,</span><br><span class="line">							  RangeTblEntry *rte)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>fileGetForeignRelSize</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * fileGetForeignRelSize</span></span><br><span class="line"><span class="comment"> *		Obtain relation size estimates for a foreign table</span></span><br><span class="line"><span class="comment"> *  获取外部表的估计大小</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">fileGetForeignRelSize(PlannerInfo *root,</span><br><span class="line">					  RelOptInfo *baserel,</span><br><span class="line">					  Oid foreigntableid)</span><br><span class="line">&#123;</span><br><span class="line">	FileFdwPlanState *fdw_private;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Fetch options.  We only need filename (or program) at this point, but</span></span><br><span class="line"><span class="comment">	 * we might as well get everything and not need to re-fetch it later in</span></span><br><span class="line"><span class="comment">	 * planning.</span></span><br><span class="line"><span class="comment">	 * 获取fdw的选项参数</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	fdw_private = (FileFdwPlanState *) palloc(<span class="keyword">sizeof</span>(FileFdwPlanState));</span><br><span class="line">	fileGetOptions(foreigntableid,</span><br><span class="line">				   &amp;fdw_private-&gt;filename,</span><br><span class="line">				   &amp;fdw_private-&gt;is_program,</span><br><span class="line">				   &amp;fdw_private-&gt;options);</span><br><span class="line">	baserel-&gt;fdw_private = (<span class="keyword">void</span> *) fdw_private;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*估算表大小 Estimate relation size */</span></span><br><span class="line">	estimate_size(root, baserel, fdw_private);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>estimate_size</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Estimate size of a foreign table.</span></span><br><span class="line"><span class="comment"> * 估算外部表大小</span></span><br><span class="line"><span class="comment"> * The main result is returned in baserel-&gt;rows.  We also set</span></span><br><span class="line"><span class="comment"> * fdw_private-&gt;pages and fdw_private-&gt;ntuples for later use in the cost</span></span><br><span class="line"><span class="comment"> * calculation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">estimate_size(PlannerInfo *root, RelOptInfo *baserel,</span><br><span class="line">			  FileFdwPlanState *fdw_private)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">stat_buf</span>;</span></span><br><span class="line">	BlockNumber pages;</span><br><span class="line">	<span class="keyword">double</span>		ntuples;</span><br><span class="line">	<span class="keyword">double</span>		nrows;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 如果是程序或者获取文件失败，则设置默认值</span></span><br><span class="line"><span class="comment">	 * Get size of the file.  It might not be there at plan time, though, in</span></span><br><span class="line"><span class="comment">	 * which case we have to use a default estimate.  We also have to fall</span></span><br><span class="line"><span class="comment">	 * back to the default if using a program as the input.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (fdw_private-&gt;is_program || stat(fdw_private-&gt;filename, &amp;stat_buf) &lt; <span class="number">0</span>)</span><br><span class="line">		stat_buf.st_size = <span class="number">10</span> * BLCKSZ;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 将大小转换成页数</span></span><br><span class="line"><span class="comment">	 * Convert size to pages for use in I/O cost estimate later.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	pages = (stat_buf.st_size + (BLCKSZ - <span class="number">1</span>)) / BLCKSZ;</span><br><span class="line">	<span class="keyword">if</span> (pages &lt; <span class="number">1</span>)</span><br><span class="line">		pages = <span class="number">1</span>;</span><br><span class="line">	fdw_private-&gt;pages = pages;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Estimate the number of tuples in the file.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (baserel-&gt;pages &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/* 如果已经执行过ANALYZE，则baserel-&gt;pages的值大于0，直接进行行数计算</span></span><br><span class="line"><span class="comment">		 * We have # of pages and # of tuples from pg_class (that is, from a</span></span><br><span class="line"><span class="comment">		 * previous ANALYZE), so compute a tuples-per-page estimate and scale</span></span><br><span class="line"><span class="comment">		 * that by the current file size.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">double</span>		density;</span><br><span class="line"></span><br><span class="line">		density = baserel-&gt;tuples / (<span class="keyword">double</span>) baserel-&gt;pages;# <span class="comment">// 计算每页的行数密度</span></span><br><span class="line">		ntuples = clamp_row_est(density * (<span class="keyword">double</span>) pages); <span class="comment">//估算行数</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Otherwise we have to fake it.  We back into this estimate using the</span></span><br><span class="line"><span class="comment">		 * planner's idea of the relation width; which is bogus if not all</span></span><br><span class="line"><span class="comment">		 * columns are being read, not to mention that the text representation</span></span><br><span class="line"><span class="comment">		 * of a row probably isn't the same size as its internal</span></span><br><span class="line"><span class="comment">		 * representation.  Possibly we could do something better, but the</span></span><br><span class="line"><span class="comment">		 * real answer to anyone who complains is "ANALYZE" ...</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">int</span>			tuple_width;</span><br><span class="line"></span><br><span class="line">		tuple_width = MAXALIGN(baserel-&gt;reltarget-&gt;width) +</span><br><span class="line">			MAXALIGN(SizeofHeapTupleHeader);<span class="comment">// 计算行宽</span></span><br><span class="line">		ntuples = clamp_row_est((<span class="keyword">double</span>) stat_buf.st_size /</span><br><span class="line">								(<span class="keyword">double</span>) tuple_width);<span class="comment">//数据量大小除行宽估算行数</span></span><br><span class="line">	&#125;</span><br><span class="line">	fdw_private-&gt;ntuples = ntuples;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 加上提供baserestrictinfo信息扫描后的结果估算行数</span></span><br><span class="line"><span class="comment">	 * Now estimate the number of rows returned by the scan after applying the</span></span><br><span class="line"><span class="comment">	 * baserestrictinfo quals.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	nrows = ntuples *</span><br><span class="line">		clauselist_selectivity(root,</span><br><span class="line">							   baserel-&gt;baserestrictinfo,</span><br><span class="line">							   <span class="number">0</span>,</span><br><span class="line">							   JOIN_INNER,</span><br><span class="line">							   <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	nrows = clamp_row_est(nrows);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Save the output-rows estimate for the planner */</span></span><br><span class="line">	baserel-&gt;rows = nrows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>fileGetForeignPaths</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * fileGetForeignPaths</span></span><br><span class="line"><span class="comment"> *		Create possible access paths for a scan on the foreign table</span></span><br><span class="line"><span class="comment"> *  创建扫描外部表的访问路径</span></span><br><span class="line"><span class="comment"> *		Currently we don't support any push-down feature, so there is only one</span></span><br><span class="line"><span class="comment"> *		possible access path, which simply returns all records in the order in</span></span><br><span class="line"><span class="comment"> *		the data file.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">fileGetForeignPaths(PlannerInfo *root,</span><br><span class="line">					RelOptInfo *baserel,</span><br><span class="line">					Oid foreigntableid)</span><br><span class="line">&#123;</span><br><span class="line">	FileFdwPlanState *fdw_private = (FileFdwPlanState *) baserel-&gt;fdw_private;</span><br><span class="line">	Cost		startup_cost;</span><br><span class="line">	Cost		total_cost;</span><br><span class="line">	List	   *columns;</span><br><span class="line">	List	   *coptions = NIL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 决定是否有选择地执行二进制转换 Decide whether to selectively perform binary conversion */</span></span><br><span class="line">	<span class="keyword">if</span> (check_selective_binary_conversion(baserel,</span><br><span class="line">										  foreigntableid,</span><br><span class="line">										  &amp;columns))</span><br><span class="line">		coptions = list_make1(makeDefElem(<span class="string">"convert_selectively"</span>,</span><br><span class="line">										  (Node *) columns, <span class="number">-1</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 估算代价 Estimate costs */</span></span><br><span class="line">	estimate_costs(root, baserel, fdw_private,</span><br><span class="line">				   &amp;startup_cost, &amp;total_cost);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 创建外部路径节点并添加到路径列表中</span></span><br><span class="line"><span class="comment">	 * Create a ForeignPath node and add it as only possible path.  We use the</span></span><br><span class="line"><span class="comment">	 * fdw_private list of the path to carry the convert_selectively option;</span></span><br><span class="line"><span class="comment">	 * it will be propagated into the fdw_private list of the Plan node.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	add_path(baserel, (Path *)</span><br><span class="line">			 create_foreignscan_path(root, baserel,</span><br><span class="line">									 <span class="literal">NULL</span>,	<span class="comment">/* default pathtarget */</span></span><br><span class="line">									 baserel-&gt;rows,</span><br><span class="line">									 startup_cost,</span><br><span class="line">									 total_cost,</span><br><span class="line">									 NIL,	<span class="comment">/* no pathkeys */</span></span><br><span class="line">									 <span class="literal">NULL</span>,	<span class="comment">/* no outer rel either */</span></span><br><span class="line">									 <span class="literal">NULL</span>,	<span class="comment">/* no extra plan */</span></span><br><span class="line">									 coptions));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If data file was sorted, and we knew it somehow, we could insert</span></span><br><span class="line"><span class="comment">	 * appropriate pathkeys into the ForeignPath node to tell the planner</span></span><br><span class="line"><span class="comment">	 * that.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>estimate_costs </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Estimate costs of scanning a foreign table.</span></span><br><span class="line"><span class="comment"> * 估算代价</span></span><br><span class="line"><span class="comment"> * Results are returned in *startup_cost and *total_cost.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">estimate_costs(PlannerInfo *root, RelOptInfo *baserel,</span><br><span class="line">			   FileFdwPlanState *fdw_private,</span><br><span class="line">			   Cost *startup_cost, Cost *total_cost)</span><br><span class="line">&#123;</span><br><span class="line">	BlockNumber pages = fdw_private-&gt;pages;</span><br><span class="line">	<span class="keyword">double</span>		ntuples = fdw_private-&gt;ntuples;</span><br><span class="line">	Cost		run_cost = <span class="number">0</span>;</span><br><span class="line">	Cost		cpu_per_tuple;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We estimate costs almost the same way as cost_seqscan(), thus assuming</span></span><br><span class="line"><span class="comment">	 * that I/O costs are equivalent to a regular table file of the same size.</span></span><br><span class="line"><span class="comment">	 * However, we take per-tuple CPU costs as 10x of a seqscan, to account</span></span><br><span class="line"><span class="comment">	 * for the cost of parsing records.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * In the case of a program source, this calculation is even more divorced</span></span><br><span class="line"><span class="comment">	 * from reality, but we have no good alternative; and it's not clear that</span></span><br><span class="line"><span class="comment">	 * the numbers we produce here matter much anyway, since there's only one</span></span><br><span class="line"><span class="comment">	 * access path for the rel.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	run_cost += seq_page_cost * pages;</span><br><span class="line"></span><br><span class="line">	*startup_cost = baserel-&gt;baserestrictcost.startup;</span><br><span class="line">	cpu_per_tuple = cpu_tuple_cost * <span class="number">10</span> + baserel-&gt;baserestrictcost.per_tuple;</span><br><span class="line">	run_cost += cpu_per_tuple * ntuples;</span><br><span class="line">	*total_cost = *startup_cost + run_cost;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>fileGetForeignPlan</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * fileGetForeignPlan</span></span><br><span class="line"><span class="comment"> *		Create a ForeignScan plan node for scanning the foreign table</span></span><br><span class="line"><span class="comment"> *  创建外部扫描计划</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> ForeignScan *</span><br><span class="line">fileGetForeignPlan(PlannerInfo *root,</span><br><span class="line">				   RelOptInfo *baserel,</span><br><span class="line">				   Oid foreigntableid,</span><br><span class="line">				   ForeignPath *best_path,</span><br><span class="line">				   List *tlist,</span><br><span class="line">				   List *scan_clauses,</span><br><span class="line">				   Plan *outer_plan)</span><br><span class="line">&#123;</span><br><span class="line">	Index		scan_relid = baserel-&gt;relid;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We have no native ability to evaluate restriction clauses, so we just</span></span><br><span class="line"><span class="comment">	 * put all the scan_clauses into the plan node's qual list for the</span></span><br><span class="line"><span class="comment">	 * executor to check.  So all we have to do here is strip RestrictInfo</span></span><br><span class="line"><span class="comment">	 * nodes from the clauses and ignore pseudoconstants (which will be</span></span><br><span class="line"><span class="comment">	 * handled elsewhere).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	scan_clauses = extract_actual_clauses(scan_clauses, <span class="literal">false</span>);<span class="comment">// 去掉约束语句</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*创建ForeignScan节点 Create the ForeignScan node */</span></span><br><span class="line">	<span class="keyword">return</span> make_foreignscan(tlist,</span><br><span class="line">							scan_clauses,</span><br><span class="line">							scan_relid,</span><br><span class="line">							NIL,	<span class="comment">/* no expressions to evaluate */</span></span><br><span class="line">							best_path-&gt;fdw_private,</span><br><span class="line">							NIL,	<span class="comment">/* no custom tlist */</span></span><br><span class="line">							NIL,	<span class="comment">/* no remote quals */</span></span><br><span class="line">							outer_plan);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p><em>未完待续</em></p>
<!--
根据file_fdw.c里实现了的回调函数，使用gdb去追踪执行情况：
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Datum</span><br><span class="line">file_fdw_handler(PG_FUNCTION_ARGS)</span><br><span class="line">&#123;</span><br><span class="line">	FdwRoutine *fdwroutine = makeNode(FdwRoutine);</span><br><span class="line"></span><br><span class="line">	fdwroutine-&gt;GetForeignRelSize = fileGetForeignRelSize;</span><br><span class="line">	fdwroutine-&gt;GetForeignPaths = fileGetForeignPaths;</span><br><span class="line">	fdwroutine-&gt;GetForeignPlan = fileGetForeignPlan;</span><br><span class="line">	fdwroutine-&gt;ExplainForeignScan = fileExplainForeignScan;</span><br><span class="line">	fdwroutine-&gt;BeginForeignScan = fileBeginForeignScan;</span><br><span class="line">	fdwroutine-&gt;IterateForeignScan = fileIterateForeignScan;</span><br><span class="line">	fdwroutine-&gt;ReScanForeignScan = fileReScanForeignScan;</span><br><span class="line">	fdwroutine-&gt;EndForeignScan = fileEndForeignScan;</span><br><span class="line">	fdwroutine-&gt;AnalyzeForeignTable = fileAnalyzeForeignTable;</span><br><span class="line">	fdwroutine-&gt;IsForeignScanParallelSafe = fileIsForeignScanParallelSafe;</span><br><span class="line"></span><br><span class="line">	PG_RETURN_POINTER(fdwroutine);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fdw=# select pg_backend_pid();</span><br><span class="line"> pg_backend_pid </span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line">           1421</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data]<span class="comment"># gdb -p 1421</span></span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-110.el7</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-redhat-linux-gnu"</span>.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Attaching to process 1421</span><br><span class="line">...</span><br><span class="line">(gdb) b fileGetForeignRelSize</span><br><span class="line">Breakpoint 1 at 0x7f223f2cc8a0: file file_fdw.c, line 506.</span><br><span class="line">(gdb) b fileGetForeignPaths</span><br><span class="line">Breakpoint 2 at 0x7f223f2cc600: file file_fdw.c, line 537.</span><br><span class="line">(gdb) b fileGetForeignPlan</span><br><span class="line">Breakpoint 3 at 0x7f223f2cc5b0: file file_fdw.c, line 590.</span><br><span class="line">(gdb) b fileExplainForeignScan</span><br><span class="line">Breakpoint 4 at 0x7f223f2cc500: file file_fdw.c, line 619.</span><br><span class="line">(gdb) b fileBeginForeignScan</span><br><span class="line">Breakpoint 5 at 0x7f223f2cc2f0: file file_fdw.c, line 651.</span><br><span class="line">(gdb) b fileIterateForeignScan</span><br><span class="line">Breakpoint 6 at 0x7f223f2cc480: file file_fdw.c, line 704.</span><br><span class="line">(gdb) b fileReScanForeignScan</span><br><span class="line">Breakpoint 7 at 0x7f223f2cbc50: file file_fdw.c, line 747.</span><br><span class="line">(gdb) b fileEndForeignScan</span><br><span class="line">Breakpoint 8 at 0x7f223f2cbc30: file file_fdw.c, line 768.</span><br><span class="line">(gdb) b fileAnalyzeForeignTable</span><br><span class="line">Breakpoint 9 at 0x7f223f2cc3a0: file file_fdw.c, line 783.</span><br><span class="line">(gdb) b fileIsForeignScanParallelSafe</span><br><span class="line">Breakpoint 10 at 0x7f223f2cbc20: file file_fdw.c, line 835.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先来看看这个sql语句的解析`explain select * from tb1_fdw order by id limit 10;`</span></span><br><span class="line"><span class="comment"># 切换至psql</span></span><br><span class="line">fdw=<span class="comment"># explain select * from tb1_fdw order by id limit 10;</span></span><br><span class="line"><span class="comment"># （挂起）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换会gdb</span></span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 10, fileIsForeignScanParallelSafe (root=0x16ea238, rel=0x1724fc8, rte=0x16e9958)</span><br><span class="line">    at file_fdw.c:835</span><br><span class="line">835	&#125;</span><br><span class="line">(gdb) bt</span><br><span class="line"><span class="comment">#0  fileIsForeignScanParallelSafe (root=0x16ea238, rel=0x1724fc8, rte=0x16e9958) at file_fdw.c:835</span></span><br><span class="line"><span class="comment">#1  0x000000000065df1b in set_rel_consider_parallel (root=root@entry=0x16ea238, rel=rel@entry=0x1724fc8, rte=rte@entry=0x16e9958) at allpaths.c:597</span></span><br><span class="line"><span class="comment">#2  0x00000000006609c3 in set_base_rel_sizes (root=&lt;optimized out&gt;) at allpaths.c:279</span></span><br><span class="line"><span class="comment">#3  make_one_rel (root=root@entry=0x16ea238, joinlist=joinlist@entry=0x1719a08) at allpaths.c:179</span></span><br><span class="line"><span class="comment">#4  0x000000000067de9e in query_planner (root=root@entry=0x16ea238, tlist=tlist@entry=0x16ea708, qp_callback=qp_callback@entry=0x67f290 &lt;standard_qp_callback&gt;, qp_extra=qp_extra@entry=0x7ffe9f3f4fc0) at planmain.c:259</span></span><br><span class="line"><span class="comment">#5  0x0000000000681f43 in grouping_planner (root=root@entry=0x16ea238, inheritance_update=inheritance_update@entry=false, tuple_fraction=&lt;optimized out&gt;, tuple_fraction@entry=0) at planner.c:1897</span></span><br><span class="line"><span class="comment">#6  0x0000000000684218 in subquery_planner (glob=glob@entry=0x16ea1a8, parse=parse@entry=0x17251d8, parent_root=parent_root@entry=0x0, hasRecursion=hasRecursion@entry=false, tuple_fraction=tuple_fraction@entry=0) at planner.c:966</span></span><br><span class="line"><span class="comment">#7  0x0000000000685236 in standard_planner (parse=0x17251d8, cursorOptions=256, boundParams=0x0)at planner.c:405</span></span><br><span class="line"><span class="comment">#8  0x000000000072178c in pg_plan_query (querytree=querytree@entry=0x17251d8, cursorOptions=&lt;optimized out&gt;, boundParams=boundParams@entry=0x0) at postgres.c:809</span></span><br><span class="line"><span class="comment">#9  0x0000000000595a0a in ExplainOneQuery (query=0x17251d8, cursorOptions=&lt;optimized out&gt;, into=0x0, es=0x1724f38, queryString=0x1627810 "explain select * from tb1_fdw order by id limit 10;", params=0x0, queryEnv=0x0) at explain.c:365</span></span><br><span class="line"><span class="comment">#10 0x0000000000595f54 in ExplainQuery (pstate=pstate@entry=0x1724db8, stmt=stmt@entry=0x16286f0, queryString=queryString@entry=0x1627810 "explain select * from tb1_fdw order by id limit 10;", params=params@entry=0x0, queryEnv=queryEnv@entry=0x0, dest=dest@entry=0x1724d28) at explain.c:254</span></span><br><span class="line"><span class="comment">#11 0x0000000000726ead in standard_ProcessUtility (pstmt=0x16287a0, queryString=0x1627810 "explain select * from tb1_fdw order by id limit 10;", context=PROCESS_UTILITY_TOPLEVEL, params=0x0, queryEnv=0x0, dest=0x1724d28, completionTag=0x7ffe9f3f5470 "") at utility.c:672</span></span><br><span class="line"><span class="comment">#12 0x0000000000724476 in PortalRunUtility (portal=0x168cf10, pstmt=0x16287a0, isTopLevel=&lt;optimized out&gt;, setHoldSnapshot=&lt;optimized out&gt;, dest=0x1724d28, completionTag=0x7ffe9f3f5470 "") at pquery.c:1178</span></span><br><span class="line"><span class="comment">#13 0x0000000000725182 in FillPortalStore (portal=portal@entry=0x168cf10, isTopLevel=isTopLevel@entry=true) at pquery.c:1038</span></span><br><span class="line"><span class="comment">#14 0x0000000000725b90 in PortalRun (portal=portal@entry=0x168cf10, count=count@entry=9223372036854775807, isTopLevel=isTopLevel@entry=true, run_once=run_once@entry=true, dest=dest@entry=0x1629528, altdest=altdest@entry=0x1629528, completionTag=completionTag@entry=0x7ffe9f3f5680 "") at pquery.c:768</span></span><br><span class="line"><span class="comment">#15 0x0000000000721bb7 in exec_simple_query (query_string=0x1627810 "explain select * from tb1_fdw order by id limit 10;")at postgres.c:1122</span></span><br><span class="line"><span class="comment">#16 0x0000000000722e62 in PostgresMain (argc=&lt;optimized out&gt;, argv=argv@entry=0x1651528, dbname=0x1651410 "fdw", username=&lt;optimized out&gt;) at postgres.c:4153</span></span><br><span class="line"><span class="comment">#17 0x000000000047a861 in BackendRun (port=0x16493f0) at postmaster.c:4361</span></span><br><span class="line"><span class="comment">#18 BackendStartup (port=0x16493f0) at postmaster.c:4033</span></span><br><span class="line"><span class="comment">#19 ServerLoop () at postmaster.c:1706</span></span><br><span class="line"><span class="comment">#20 0x00000000006babb9 in PostmasterMain (argc=argc@entry=3, argv=argv@entry=0x16223c0) at postmaster.c:1379</span></span><br><span class="line"><span class="comment">#21 0x000000000047b2a1 in main (argc=3, argv=0x16223c0) at main.c:228</span></span><br></pre></td></tr></table></figure>
<p>–&gt; </p>
-->
  </article>
</div>


    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="/js/md5.min.js"></script>
<div class='container' id="gitalk-container"></div>
<script>
    var gitalk = new Gitalk({
        clientID: '0f95488e2c5e12bc2a2a',
        clientSecret: 'b01836c08c02e727359d1c8df682e8b65fe41de1',
        repo: 'blog_gitalk',
        owner: 'oYo-Byte',
        admin: ['oYo-Byte'],
		id: md5(location.pathname),
        distractionFreeMode: true,
    })
    gitalk.render('gitalk-container')
</script>




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <a href="https://oyo-byte.github.io" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2018 oYo-Byte</li>
      <li><a href="https://oyo-byte.github.io">Home</a></li>
      
      <li><a href="https://github.com/oYo-Byte">Github</a></li>
      
    </ul>
    <div class="footer-theme-info">
      Theme <a href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
    </div>
  </footer>
</div>




<script src="/js/main.js"></script>

</body>
</html>
